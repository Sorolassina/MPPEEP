# üí∞ Syst√®me de Gestion Budg√©taire - Documentation Compl√®te

## üìã Vue d'Ensemble

Syst√®me complet de **gestion budg√©taire** int√©grant le suivi d'ex√©cution SIGOBE (Syst√®me d'Information de Gestion et d'Observation Budg√©taire) et les fiches techniques pour le MPPEEP (Minist√®re du Plan, de la Prosp√©rit√© √âconomique et de l'Emploi Public).

**Version :** 2.0  
**Derni√®re mise √† jour :** Octobre 2025  
**Statut :** Production

---

## üéØ Composantes Principales

### **1. Dashboard Budg√©taire** üìä
Tableau de bord principal avec suivi en temps r√©el :
- **URL :** `/api/v1/budget/`
- **KPIs** : Budget Actuel, Budget Vot√©, Engagements, Mandats, Disponible, Taux d'ex√©cution
- **Filtres** : Ann√©e, Trimestre, Programme, Nature de d√©pense
- **Visualisations** : Ex√©cution par programme, Nature de d√©penses, Variation N vs N-1

### **2. SIGOBE (Syst√®me d'Information de Gestion et d'Observation Budg√©taire)** üìà
Gestion des imports de donn√©es d'ex√©cution budg√©taire :
- **URL :** `/api/v1/budget/sigobe`
- **Import Excel** : Fichiers d'ex√©cution budg√©taire
- **Calcul KPIs** : Automatique par programme, nature, dimension globale
- **Historique** : Conservation de tous les chargements
- **Filtres** : Ann√©e, Trimestre

### **3. Fiches Techniques Budg√©taires** üìã
Documents structur√©s pour la pr√©paration budg√©taire :
- **URL :** `/api/v1/budget/fiches`
- **Cr√©ation** : Formulaire complet avec hi√©rarchie Programme ‚Üí Direction
- **D√©tails** : Lignes budg√©taires avec activit√©s et natures
- **Documents** : Upload de pi√®ces justificatives
- **Export** : PDF pour impression et archivage

---

## üèóÔ∏è Architecture de la Base de Donn√©es

### **1. Mod√®les SIGOBE (Ex√©cution Budg√©taire)**

#### **SigobeChargement**
Table historique des imports de fichiers SIGOBE.

```python
{
    "id": 1,
    "annee": 2025,
    "trimestre": 1,  # 1, 2, 3, 4 ou null pour annuel
    "periode_libelle": "T1 2025",
    
    # M√©tadonn√©es fichier
    "nom_fichier": "Situation execution.xlsx",
    "taille_octets": 2456789,
    "chemin_fichier": "uploads/sigobe/2025_T1_20251014_213506.xlsx",
    
    # R√©sum√© import
    "nb_lignes_importees": 388,
    "nb_programmes": 3,
    "nb_actions": 15,
    
    # Statut
    "statut": "Termin√©",  # En cours, Termin√©, Erreur
    "message_erreur": null,
    
    # Tra√ßabilit√©
    "uploaded_by_user_id": 1,
    "date_chargement": "2025-10-14 21:29:43"
}
```

**Relations :**
- `uploaded_by_user` ‚Üí User
- `executions` ‚Üí List[SigobeExecution]
- `kpis` ‚Üí List[SigobeKpi]

---

#### **SigobeExecution**
Lignes d√©taill√©es de l'ex√©cution budg√©taire.

```python
{
    "id": 1,
    "chargement_id": 1,
    "annee": 2025,
    "trimestre": 1,
    "periode": "2025-01-31",  # Date de la p√©riode
    
    # Classification SIGOBE
    "section": "DEPENSES",
    "categorie": "PERSONNEL",
    "type_credit": "AE",  # Autorisation d'Engagement
    
    # Hi√©rarchie budg√©taire
    "programmes": "Administration G√©n√©rale",
    "actions": "Coordination et animation du minist√®re",
    "rprog": "DRH",  # Responsable Programme
    "type_depense": "Biens et services",
    "activites": "Maintenance informatique",
    "taches": "Achat ordinateurs",
    
    # Montants (en FCFA)
    "budget_vote": 123849000000,
    "budget_actuel": 123849000000,
    "engagements_emis": 55094000000,
    "disponible_eng": 68756000000,
    "mandats_emis": 54232000000,
    "mandats_vise_cf": 50538000000,
    "mandats_pec": 50538000000,
    
    # M√©tadonn√©es
    "created_at": "2025-10-14 21:29:43"
}
```

**Index :**
- `idx_chargement` sur `chargement_id`
- `idx_programmes` sur `programmes`
- `idx_type_depense` sur `type_depense`

**Notes :**
- Un fichier SIGOBE peut contenir plusieurs centaines de lignes
- Chaque ligne repr√©sente un d√©tail d'ex√©cution
- Les montants sont en FCFA (Francs CFA)

---

#### **SigobeKpi**
KPIs agr√©g√©s calcul√©s automatiquement apr√®s import.

```python
{
    "id": 1,
    "annee": 2025,
    "trimestre": 1,
    "chargement_id": 1,
    
    # Dimension
    "dimension": "global",  # global, programme, nature
    "dimension_code": null,  # Code si dimension = programme ou nature
    "dimension_libelle": null,
    
    # Agr√©gats (en FCFA)
    "budget_vote_total": 123849000000,
    "budget_actuel_total": 123849000000,
    "engagements_total": 55094000000,
    "mandats_total": 50538000000,
    
    # Taux (en %)
    "taux_engagement": 44.48,
    "taux_mandatement": 91.73,
    "taux_execution": 40.79,
    
    # M√©tadonn√©es
    "date_calcul": "2025-10-14 21:30:15"
}
```

**Dimensions :**
- **global** : KPI pour tout le chargement
- **programme** : KPI par programme (ex: "Administration G√©n√©rale")
- **nature** : KPI par nature de d√©pense (ex: "Biens et services")

**Calculs :**
```python
# Taux d'engagement
taux_engagement = (engagements_total / budget_actuel_total) * 100

# Taux de mandatement
taux_mandatement = (mandats_total / engagements_total) * 100

# Taux d'ex√©cution
taux_execution = (mandats_total / budget_actuel_total) * 100
```

---

### **2. Mod√®les Fiches Techniques**

#### **FicheTechnique**
Document central de demande budg√©taire.

```python
{
    "id": 1,
    "numero_fiche": "FT-2026-P01-001",
    "annee_budget": 2026,
    
    # Hi√©rarchie
    "programme_id": 1,
    "direction_id": 2,
    
    # Montants budg√©taires (en FCFA)
    "budget_anterieur": 100000000,        # Budget N-1
    "enveloppe_demandee": 120000000,      # Base demand√©e
    "complement_demande": 15000000,       # Compl√©ments
    "engagement_etat": 5000000,           # Engagements
    "financement_bailleurs": 10000000,    # Bailleurs
    "budget_total_demande": 150000000,    # Calcul√© auto
    
    # Justification
    "note_justificative": "Modernisation des infrastructures...",
    "observations": "Priorit√© √©lev√©e",
    
    # Workflow
    "statut": "Brouillon",  # Brouillon, Soumis, Valid√©, Rejet√©, Approuv√©
    "phase": "Pr√©paration",
    
    # Dates
    "date_creation": "2025-10-13",
    "date_soumission": null,
    "date_validation": null,
    
    # Tra√ßabilit√©
    "created_by_user_id": 1,
    "created_at": "2025-10-13 10:30:00",
    "updated_at": "2025-10-13 15:45:00",
    "actif": true
}
```

**Calcul automatique :**
```python
budget_total_demande = (
    enveloppe_demandee +
    complement_demande +
    engagement_etat +
    financement_bailleurs
)
```

**Num√©rotation :**
Format : `FT-{annee}-P{programme}-{sequence}`
- `FT` = Fiche Technique
- `2026` = Ann√©e budget
- `P01` = Programme 01
- `001` = Num√©ro s√©quentiel

---

#### **LigneBudgetaire**
D√©tail des d√©penses par ligne.

```python
{
    "id": 1,
    "fiche_technique_id": 1,
    
    # Classification
    "nature_depense_id": 1,  # BS, P, I, T
    "activite_id": 5,
    
    "libelle": "Achat de 10 ordinateurs HP",
    
    # Montants (en FCFA)
    "budget_n_moins_1": 5000000,      # Budget N-1
    "budget_demande": 8000000,        # Demand√© N
    "budget_valide": 7000000,         # Valid√© apr√®s r√©vision
    
    # M√©tadonn√©es
    "justification": "Renouvellement parc obsol√®te",
    "priorite": "√âlev√©e",  # Basse, Normale, √âlev√©e, Critique
    "ordre": 1,
    
    # Tra√ßabilit√©
    "actif": true,
    "created_at": "2025-10-13 10:45:00"
}
```

**Relations :**
- `fiche_technique` ‚Üí FicheTechnique
- `nature_depense` ‚Üí NatureDepense
- `activite` ‚Üí Activite

---

#### **NatureDepense** (R√©f√©rentiel)
Classification des d√©penses.

```python
{
    "id": 1,
    "code": "BS",
    "libelle": "Biens et Services",
    "description": "Fournitures, entretien, services, consommables",
    "actif": true
}
```

**4 Natures :**
| Code | Libell√©              | Description                              |
|------|---------------------|------------------------------------------|
| BS   | Biens et Services   | Fournitures, entretien, services         |
| P    | Personnel           | Salaires, primes, charges sociales       |
| I    | Investissement      | √âquipements, constructions, immobilisations |
| T    | Transferts          | Subventions, bourses, aides              |

---

#### **Activite** (R√©f√©rentiel)
Activit√©s budg√©taires.

```python
{
    "id": 1,
    "code": "ACT001",
    "libelle": "Maintenance informatique",
    
    # Hi√©rarchie
    "programme_id": 1,
    "direction_id": 2,
    "nature_depense_id": 1,  # BS
    
    "description": "Entretien et maintenance du parc informatique",
    "actif": true
}
```

**Import Excel :**
- Format : Code, Libell√©, Programme, Direction, Nature, Description
- Mise √† jour automatique si code existe
- Cr√©ation si nouveau code

---

#### **DocumentBudget**
Pi√®ces jointes aux fiches.

```python
{
    "id": 1,
    "fiche_technique_id": 1,
    
    # Document
    "type_document": "Devis",  # Devis, Facture, Note, Rapport, Autre
    "nom_fichier": "devis_ordinateurs_2026.pdf",
    "file_path": "uploads/budget/fiches/1/devis_ordinateurs_2026.pdf",
    "taille_octets": 245678,
    
    # Tra√ßabilit√©
    "uploaded_by_user_id": 1,
    "uploaded_at": "2025-10-13 15:30:00",
    "actif": true
}
```

**Stockage :**
- Dossier : `uploads/budget/fiches/{fiche_id}/`
- Nom unique : `{timestamp}_{original_filename}`

---

#### **HistoriqueBudget**
Tra√ßabilit√© des modifications.

```python
{
    "id": 1,
    "fiche_technique_id": 1,
    
    # Action
    "action": "Modification",  # Cr√©ation, Modification, Suppression, Validation
    "ancien_statut": "Brouillon",
    "nouveau_statut": "Valid√©",
    
    # Montants
    "montant_avant": 100000000,
    "montant_apres": 120000000,
    
    "commentaire": "Augmentation apr√®s r√©vision",
    
    # Tra√ßabilit√©
    "user_id": 1,
    "date_action": "2025-10-13 16:00:00"
}
```

---

### **3. Mod√®les Personnel (R√©f√©rentiels)**

#### **Programme**
Programmes budg√©taires.

```python
{
    "id": 1,
    "code": "P01",
    "libelle": "Administration G√©n√©rale",
    "description": "Coordination et administration centrale",
    "actif": true
}
```

#### **Direction**
Directions rattach√©es aux programmes.

```python
{
    "id": 1,
    "code": "DAF",
    "libelle": "Direction des Affaires Financi√®res",
    "programme_id": 1,
    "actif": true
}
```

---

## üõ£Ô∏è Routes et Endpoints API

### **Dashboard Budg√©taire**

```
GET /api/v1/budget/
```

**Param√®tres :**
- `annee` (int, optionnel) : Ann√©e √† afficher (d√©faut : derni√®re ann√©e disponible)
- `trimestre` (int, optionnel) : Trimestre (1, 2, 3, 4)
- `programme_id` (int, optionnel) : Filtre par programme
- `nature` (str, optionnel) : Filtre par nature (BS, P, I, T)

**R√©ponse :**
- Template HTML avec KPIs, graphiques, filtres

**Exemple :**
```
/api/v1/budget/?annee=2025&trimestre=1&programme_id=1
```

---

### **SIGOBE**

#### Liste des chargements
```
GET /api/v1/budget/sigobe
```

**Param√®tres :**
- `annee` (int, optionnel) : Filtre par ann√©e
- `trimestre` (int, optionnel) : Filtre par trimestre

**R√©ponse :**
- Template HTML avec liste des chargements et formulaire d'upload

---

#### Upload fichier SIGOBE
```
POST /api/v1/budget/api/sigobe/upload
```

**Body (multipart/form-data) :**
```python
{
    "fichier": UploadFile,  # Fichier Excel
    "annee": 2025,
    "trimestre": 1  # Optionnel
}
```

**Processus :**
1. Lecture du fichier Excel (pandas)
2. Nettoyage des donn√©es (colonnes, lignes vides)
3. Extraction des m√©tadonn√©es (Section, Cat√©gorie, Type_credit)
4. Parsing des montants (Budget_Vote, Engagements, Mandats...)
5. Cr√©ation des lignes SigobeExecution
6. Calcul des KPIs (global, par programme, par nature)
7. Sauvegarde en base

**R√©ponse :**
```json
{
    "ok": true,
    "message": "Chargement termin√©",
    "chargement_id": 1,
    "nb_lignes": 388,
    "nb_programmes": 3,
    "nb_actions": 15
}
```

**Erreurs possibles :**
- Fichier invalide
- Format Excel incorrect
- Colonnes manquantes
- Erreur de parsing

---

#### Supprimer chargement
```
DELETE /api/v1/budget/api/sigobe/{chargement_id}
```

**R√©ponse :**
```json
{
    "ok": true,
    "message": "Chargement supprim√©"
}
```

**Cascade :**
- Supprime toutes les lignes SigobeExecution
- Supprime tous les KPIs SigobeKpi
- Supprime le fichier physique

---

#### R√©cup√©rer KPIs
```
GET /api/v1/budget/api/sigobe/{chargement_id}/kpis
```

**Param√®tres :**
- `dimension` (str, optionnel) : global, programme, nature

**R√©ponse :**
```json
{
    "ok": true,
    "kpis": [
        {
            "dimension": "global",
            "budget_actuel_total": 48808856296,
            "engagements_total": 18272066882,
            "mandats_total": 17929446968,
            "taux_engagement": 37.44,
            "taux_mandatement": 98.13,
            "taux_execution": 36.73
        }
    ]
}
```

---

### **Fiches Techniques**

#### Liste hi√©rarchique
```
GET /api/v1/budget/fiches
```

**Param√®tres :**
- `annee` (int, optionnel) : Ann√©e budget

**R√©ponse :**
- Template HTML avec arborescence Programme ‚Üí Direction ‚Üí Fiches

---

#### Formulaire nouvelle fiche
```
GET /api/v1/budget/fiches/nouveau
```

**R√©ponse :**
- Template HTML avec formulaire

---

#### D√©tail d'une fiche
```
GET /api/v1/budget/fiches/{fiche_id}
```

**R√©ponse :**
- Template HTML avec r√©capitulatif, lignes, documents, historique

---

#### Structure d'une fiche (√©dition avanc√©e)
```
GET /api/v1/budget/fiches/{fiche_id}/structure
```

**R√©ponse :**
- Template HTML avec gestion des lignes et documents

---

#### Cr√©er fiche
```
POST /api/v1/budget/api/fiches
```

**Body (form-data) :**
```python
{
    "annee_budget": 2026,
    "programme_id": 1,
    "direction_id": 2,
    "budget_anterieur": 100000000,
    "enveloppe_demandee": 120000000,
    "complement_demande": 15000000,
    "engagement_etat": 5000000,
    "financement_bailleurs": 10000000,
    "note_justificative": "...",
    "observations": "..."
}
```

**R√©ponse :**
```json
{
    "ok": true,
    "fiche_id": 1,
    "numero_fiche": "FT-2026-P01-001"
}
```

---

#### Modifier fiche
```
PUT /api/v1/budget/api/fiches/{fiche_id}
```

**Body :** Identique √† cr√©ation

**R√©ponse :**
```json
{
    "ok": true,
    "message": "Fiche mise √† jour"
}
```

---

#### Supprimer fiche
```
DELETE /api/v1/budget/api/fiches/{fiche_id}
```

**R√©ponse :**
```json
{
    "ok": true,
    "message": "Fiche supprim√©e"
}
```

**Cascade :**
- Supprime toutes les lignes budg√©taires
- Supprime tous les documents (fichiers + DB)
- Supprime l'historique

---

#### Ajouter ligne budg√©taire
```
POST /api/v1/budget/api/fiches/{fiche_id}/lignes
```

**Body (JSON) :**
```json
{
    "nature_depense_id": 1,
    "activite_id": 5,
    "libelle": "Achat ordinateurs",
    "budget_n_moins_1": 5000000,
    "budget_demande": 8000000,
    "justification": "Renouvellement parc",
    "priorite": "√âlev√©e"
}
```

**R√©ponse :**
```json
{
    "ok": true,
    "ligne_id": 1
}
```

---

#### Modifier ligne
```
PUT /api/v1/budget/api/fiches/{fiche_id}/lignes/{ligne_id}
```

---

#### Supprimer ligne
```
DELETE /api/v1/budget/api/fiches/{fiche_id}/lignes/{ligne_id}
```

---

#### Upload document
```
POST /api/v1/budget/api/fiches/{fiche_id}/documents
```

**Body (multipart/form-data) :**
```python
{
    "fichier": UploadFile,
    "type_document": "Devis"  # Devis, Facture, Note, Rapport, Autre
}
```

**R√©ponse :**
```json
{
    "ok": true,
    "document_id": 1,
    "nom_fichier": "devis_ordinateurs.pdf"
}
```

---

#### Supprimer document
```
DELETE /api/v1/budget/api/fiches/{fiche_id}/documents/{document_id}
```

---

#### Export PDF
```
GET /api/v1/budget/api/fiches/{fiche_id}/export/pdf
```

**R√©ponse :**
- Template HTML optimis√© pour impression (print CSS)
- Auto-ouverture de Ctrl+P

---

### **Import/Export**

#### Import activit√©s Excel
```
POST /api/v1/budget/api/import/activites
```

**Body (multipart/form-data) :**
```python
{
    "fichier": UploadFile  # Excel avec colonnes: Code, Libelle, Programme, Direction, Nature, Description
}
```

**R√©ponse :**
```json
{
    "ok": true,
    "nb_created": 15,
    "nb_updated": 3,
    "errors": []
}
```

---

## üìä Calculs et Formules

### **KPIs Dashboard**

#### Budget Actuel Total
```python
budget_actuel_total = sum(e.budget_actuel for e in executions)
```

#### Taux d'Engagement
```python
budg_select = budget_actuel_total or budget_vote_total
taux_engagement = (engagements_total / budg_select * 100) if budg_select > 0 else 0
```

**Formule DAX √©quivalente :**
```dax
_Tx_Eng = DIVIDE([Engagements], [Budget_Actuel])
```

#### Taux de Mandatement Vis√©
```python
taux_mandatement_vise = (mandats_vises_total / mandats_pec_total * 100) if mandats_pec_total > 0 else 0
```

**Formule DAX :**
```dax
_Tx_Mandat_Vise = DIVIDE([Mandats_Vise], [Mandats_PEC])
```

#### Taux de Mandatement PEC
```python
taux_mandatement_pec = (mandats_pec_total / mandats_emis_total * 100) if mandats_emis_total > 0 else 0
```

**Formule DAX :**
```dax
_Tx_Mandat_PEC = DIVIDE([Mandats_PEC], [Mandats_Emis])
```

#### Taux d'Ex√©cution Global
```python
taux_execution_global = (disponible_eng_total / budg_select * 100) if budg_select > 0 else 0
```

**Formule DAX :**
```dax
_Tx_Exe.Global = DIVIDE([Disponible], [Budget_Actuel])
```

---

### **Variation N vs N-1**

Pour comparer une ann√©e N avec l'ann√©e N-1 :

```python
# R√©cup√©rer les KPIs de N et N-1
kpi_n = get_kpi(annee=2025, trimestre=1, dimension="global")
kpi_n1 = get_kpi(annee=2024, trimestre=1, dimension="global")

# Calculer les variations (en points de pourcentage)
variation_engagement = kpi_n.taux_engagement - kpi_n1.taux_engagement
variation_mandatement = kpi_n.taux_mandatement - kpi_n1.taux_mandatement
variation_execution = kpi_n.taux_execution - kpi_n1.taux_execution
```

**Affichage :**
- Positif : Vert, fl√®che ‚Üë, "+X%"
- N√©gatif : Rouge, fl√®che ‚Üì, "-X%"
- Nul : Gris, "0.0%"

---

### **Ex√©cution par Programme**

```python
kpis_programmes = get_kpis(chargement_id, dimension="programme")

for kpi in kpis_programmes:
    code = kpi.dimension_code or kpi.dimension_libelle
    exec_par_programme[code] = {
        "libelle": kpi.dimension_libelle,
        "budget": float(kpi.budget_actuel_total),
        "engagements": float(kpi.engagements_total),
        "mandats": float(kpi.mandats_total),
        "taux": float(kpi.taux_execution)
    }
```

**Affichage :**
- Barre de progression horizontale
- Pourcentage d'ex√©cution
- Couleur selon taux (vert > 80%, jaune 50-80%, rouge < 50%)

---

## üîÑ Workflow Import SIGOBE

### **√âtape 1 : Upload Fichier**

1. Utilisateur acc√®de √† `/api/v1/budget/sigobe`
2. Clique sur "üì§ Charger des donn√©es"
3. Modal s'ouvre avec formulaire :
   - Ann√©e (obligatoire)
   - Trimestre (optionnel)
   - Fichier Excel (obligatoire)
4. Upload du fichier

---

### **√âtape 2 : Parsing Excel (Power Query Logic)**

Le syst√®me suit scrupuleusement la logique Power Query :

#### **A. Charger et Nettoyer**
```python
# 1. Charger Excel (premi√®re feuille)
Source = pd.ExcelFile(fichier)
Raw = pd.read_excel(Source, sheet_name=0, header=None)

# 2. Identifier les colonnes √† garder (celles contenant "_Budget" ou "_Engagements" etc.)
ColsToKeep = [col for col in Raw.columns if any(kw in str(Raw.iloc[0, col]) for kw in KEYWORDS)]

# 3. Filtrer colonnes
Filtered = Raw[ColsToKeep]

# 4. Promouvoir premi√®re ligne en en-t√™tes
Filtered.columns = Filtered.iloc[0]
Result = Filtered[1:].reset_index(drop=True)

# 5. Supprimer lignes vides
Result = Result.dropna(how='all')
```

#### **B. Extraire M√©tadonn√©es**
```python
# Chercher les lignes contenant "Section:", "Categorie:", "Type_credit:"
Metadatafile = {}
for col in Result.columns:
    for idx, val in Result[col].items():
        if "Section:" in str(val):
            Metadatafile['section'] = val.replace("Section:", "").strip()
        if "Categorie:" in str(val):
            Metadatafile['categorie'] = val.replace("Categorie:", "").strip()
        if "Type_credit:" in str(val):
            Metadatafile['type_credit'] = val.replace("Type_credit:", "").strip()

# Supprimer les lignes de m√©tadonn√©es
Result = Result[~Result.apply(lambda row: any("Section:" in str(v) or "Categorie:" in str(v) for v in row), axis=1)]
```

#### **C. Extraire les Montants**
```python
# Fonction pour parser un montant
def parse_montant(val):
    if pd.isna(val) or val == '':
        return 0.0
    try:
        # Nettoyer : enlever espaces, remplacer virgule par point
        clean = str(val).replace(' ', '').replace(',', '.')
        # Enlever symboles mon√©taires
        clean = re.sub(r'[^\d.-]', '', clean)
        return float(clean)
    except:
        return 0.0

# Pour chaque ligne, extraire les montants
for _, row in Result.iterrows():
    montants = {
        'budget_vote': parse_montant(row.get('Budget_Vote', 0)),
        'budget_actuel': parse_montant(row.get('Budget_Actuel', 0)),
        'engagements_emis': parse_montant(row.get('Engagements_Emis', 0)),
        'disponible_eng': parse_montant(row.get('Disponible_Eng', 0)),
        'mandats_emis': parse_montant(row.get('Mandats_Emis', 0)),
        'mandats_vise_cf': parse_montant(row.get('Mandats_Vise_CF', 0)),
        'mandats_pec': parse_montant(row.get('Mandats_PEC', 0))
    }
```

---

### **√âtape 3 : Sauvegarde en Base**

```python
# 1. Cr√©er SigobeChargement
chargement = SigobeChargement(
    annee=annee,
    trimestre=trimestre,
    periode_libelle=f"T{trimestre} {annee}" if trimestre else f"Annuel {annee}",
    nom_fichier=fichier.filename,
    taille_octets=len(fichier_bytes),
    chemin_fichier=save_path,
    nb_lignes_importees=0,
    nb_programmes=0,
    nb_actions=0,
    statut="En cours",
    uploaded_by_user_id=current_user.id
)
session.add(chargement)
session.commit()

# 2. Cr√©er les SigobeExecution
nb_lignes = 0
programmes_set = set()
actions_set = set()

for _, row in Result.iterrows():
    execution = SigobeExecution(
        chargement_id=chargement.id,
        annee=annee,
        trimestre=trimestre,
        section=Metadatafile.get('section'),
        categorie=Metadatafile.get('categorie'),
        type_credit=Metadatafile.get('type_credit'),
        programmes=row.get('Programmes'),
        actions=row.get('Actions'),
        rprog=row.get('Rprog'),
        type_depense=row.get('Type_depense'),
        activites=row.get('Activites'),
        taches=row.get('Taches'),
        budget_vote=montants['budget_vote'],
        budget_actuel=montants['budget_actuel'],
        engagements_emis=montants['engagements_emis'],
        disponible_eng=montants['disponible_eng'],
        mandats_emis=montants['mandats_emis'],
        mandats_vise_cf=montants['mandats_vise_cf'],
        mandats_pec=montants['mandats_pec']
    )
    session.add(execution)
    nb_lignes += 1
    
    if row.get('Programmes'):
        programmes_set.add(row.get('Programmes'))
    if row.get('Actions'):
        actions_set.add(row.get('Actions'))

# 3. Mettre √† jour le chargement
chargement.nb_lignes_importees = nb_lignes
chargement.nb_programmes = len(programmes_set)
chargement.nb_actions = len(actions_set)
chargement.statut = "Termin√©"
session.commit()
```

---

### **√âtape 4 : Calcul des KPIs**

```python
def calcul_kpis_sigobe(chargement_id, session):
    # R√©cup√©rer toutes les ex√©cutions
    executions = session.exec(
        select(SigobeExecution).where(SigobeExecution.chargement_id == chargement_id)
    ).all()
    
    # 1. KPI Global
    global_budget_vote = sum(e.budget_vote or 0 for e in executions)
    global_budget_actuel = sum(e.budget_actuel or 0 for e in executions)
    global_engagements = sum(e.engagements_emis or 0 for e in executions)
    global_mandats = sum(e.mandats_emis or 0 for e in executions)
    
    taux_engagement = (global_engagements / global_budget_actuel * 100) if global_budget_actuel > 0 else 0
    taux_mandatement = (global_mandats / global_engagements * 100) if global_engagements > 0 else 0
    taux_execution = (global_mandats / global_budget_actuel * 100) if global_budget_actuel > 0 else 0
    
    kpi_global = SigobeKpi(
        annee=chargement.annee,
        trimestre=chargement.trimestre,
        dimension="global",
        budget_vote_total=global_budget_vote,
        budget_actuel_total=global_budget_actuel,
        engagements_total=global_engagements,
        mandats_total=global_mandats,
        taux_engagement=taux_engagement,
        taux_mandatement=taux_mandatement,
        taux_execution=taux_execution,
        chargement_id=chargement_id
    )
    session.add(kpi_global)
    
    # 2. KPIs par Programme
    programmes_dict = defaultdict(lambda: {'budget_vote': 0, 'budget_actuel': 0, 'engagements': 0, 'mandats': 0})
    
    for e in executions:
        if e.programmes:
            programmes_dict[e.programmes]['budget_vote'] += e.budget_vote or 0
            programmes_dict[e.programmes]['budget_actuel'] += e.budget_actuel or 0
            programmes_dict[e.programmes]['engagements'] += e.engagements_emis or 0
            programmes_dict[e.programmes]['mandats'] += e.mandats_emis or 0
    
    for prog, data in programmes_dict.items():
        taux_eng = (data['engagements'] / data['budget_actuel'] * 100) if data['budget_actuel'] > 0 else 0
        taux_mand = (data['mandats'] / data['engagements'] * 100) if data['engagements'] > 0 else 0
        taux_exec = (data['mandats'] / data['budget_actuel'] * 100) if data['budget_actuel'] > 0 else 0
        
        code, libelle = split_code_libelle(prog)  # S√©pare "P01 - Administration G√©n√©rale"
        
        kpi_prog = SigobeKpi(
            annee=chargement.annee,
            trimestre=chargement.trimestre,
            dimension="programme",
            dimension_code=code,
            dimension_libelle=libelle,
            budget_vote_total=data['budget_vote'],
            budget_actuel_total=data['budget_actuel'],
            engagements_total=data['engagements'],
            mandats_total=data['mandats'],
            taux_engagement=taux_eng,
            taux_mandatement=taux_mand,
            taux_execution=taux_exec,
            chargement_id=chargement_id
        )
        session.add(kpi_prog)
    
    # 3. KPIs par Nature
    natures_dict = defaultdict(lambda: {'budget_vote': 0, 'budget_actuel': 0, 'engagements': 0, 'mandats': 0})
    
    for e in executions:
        if e.type_depense:
            natures_dict[e.type_depense]['budget_vote'] += e.budget_vote or 0
            natures_dict[e.type_depense]['budget_actuel'] += e.budget_actuel or 0
            natures_dict[e.type_depense]['engagements'] += e.engagements_emis or 0
            natures_dict[e.type_depense]['mandats'] += e.mandats_emis or 0
    
    for nature, data in natures_dict.items():
        taux_eng = (data['engagements'] / data['budget_actuel'] * 100) if data['budget_actuel'] > 0 else 0
        taux_mand = (data['mandats'] / data['engagements'] * 100) if data['engagements'] > 0 else 0
        taux_exec = (data['mandats'] / data['budget_actuel'] * 100) if data['budget_actuel'] > 0 else 0
        
        code_nature, libelle_nature = split_code_libelle(nature)
        
        # Si pas de code, utiliser abr√©viations
        if not code_nature or code_nature == libelle_nature:
            nature_lower = nature.lower()
            if 'bien' in nature_lower or 'service' in nature_lower:
                code_nature = 'BS'
            elif 'personnel' in nature_lower:
                code_nature = 'P'
            elif 'investissement' in nature_lower:
                code_nature = 'I'
            elif 'transfert' in nature_lower:
                code_nature = 'T'
            else:
                code_nature = nature[:3].upper()
            libelle_nature = nature
        
        kpi_nature = SigobeKpi(
            annee=chargement.annee,
            trimestre=chargement.trimestre,
            dimension="nature",
            dimension_code=code_nature,
            dimension_libelle=libelle_nature,
            budget_vote_total=data['budget_vote'],
            budget_actuel_total=data['budget_actuel'],
            engagements_total=data['engagements'],
            mandats_total=data['mandats'],
            taux_engagement=taux_eng,
            taux_mandatement=taux_mand,
            taux_execution=taux_exec,
            chargement_id=chargement_id
        )
        session.add(kpi_nature)
    
    session.commit()
    logger.info(f"‚úÖ KPIs calcul√©s : 1 global + {len(programmes_dict)} programmes + {len(natures_dict)} natures")
```

---

## üé® Interface Utilisateur

### **Dashboard Budg√©taire** (`/api/v1/budget/`)

**Sections :**

#### 1. En-t√™te
- Profil utilisateur (photo, nom, r√¥le)
- Titre : "üí∞ Suivi Budg√©taire {ann√©e} [- Trimestre {trimestre}]"
- Boutons actions :
  - "üìã Fiches Techniques"
  - "üìä SIGOBE"
  - "‚Üê Retour"

#### 2. Filtres
- **Ann√©e** : Dropdown avec ann√©es disponibles
- **Trimestre** : Dropdown (Annuel, T1, T2, T3, T4)
- **Programme** : Dropdown (Tous, P01, P02...)
- **Nature** : Dropdown (Toutes, BS, P, I, T)

**Comportement :**
- Changement de filtre ‚Üí Rechargement page avec param√®tres
- Overlay de chargement avec message

#### 3. KPIs (6 cartes)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Budget Actuel      ‚îÇ Budget Vot√©        ‚îÇ Engagements        ‚îÇ
‚îÇ 48.8 Mds FCFA      ‚îÇ 48.8 Mds FCFA      ‚îÇ 18.3 Mds FCFA      ‚îÇ
‚îÇ 100%               ‚îÇ 100%               ‚îÇ 37.44%             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Disponible Eng.    ‚îÇ Mandats Vis√©s      ‚îÇ Mandats PEC        ‚îÇ
‚îÇ 30.5 Mds FCFA      ‚îÇ 17.9 Mds FCFA      ‚îÇ 17.9 Mds FCFA      ‚îÇ
‚îÇ 62.56%             ‚îÇ 98.13%             ‚îÇ 100%               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Styles :**
- Gradients violets
- Box-shadow
- Animation au hover
- Compteur anim√© (CountUp.js)

#### 4. Ex√©cution par Programme
```
Administration G√©n√©rale           ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë 34.38%
Portefeuille de l'Etat           ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 47.95%
Gestion des EPN                  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë 23.43%
```

**Styles :**
- Barres horizontales anim√©es
- Couleur selon taux (vert/jaune/rouge)
- Initiales du programme (cercle color√©)

#### 5. Nature de D√©penses
```
BS  Biens & Services       26.2 Mds   64%
P   Personnel              15.5 Mds   76%
I   Investissement          25.8 Mds   35%
T   Transferts             56.4 Mds   55%
```

#### 6. Variation N vs N-1
```
Taux Eng.    ‚îÇ‚ñÅ‚ñÅ‚ñÅ +2.5%    (N-1: 35.0%)
Taux MV      ‚îÇ‚ñÜ‚ñÜ‚ñÜ +15.3%   (N-1: 82.8%)
Taux PEC     ‚îÇ‚ñÖ‚ñÖ‚ñÖ +10.0%   (N-1: 90.0%)
Taux Global  ‚îÇ‚ñÉ‚ñÉ‚ñÉ +5.7%    (N-1: 31.0%)
```

**Styles :**
- Barres verticales color√©es (vert = positif, rouge = n√©gatif)
- Valeur N-1 en gris
- L√©gende explicative

---

### **SIGOBE** (`/api/v1/budget/sigobe`)

**Sections :**

#### 1. En-t√™te
- Titre : "üìä SIGOBE"
- Sous-titre : "Syst√®me d'Information de Gestion et d'Observation Budg√©taire"
- Bouton "‚Üê Retour"

#### 2. Filtres
- **Ann√©e** : Dropdown
- **Trimestre** : Dropdown

#### 3. Chargements (Table)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ P√©riode     ‚îÇ Fichier    ‚îÇ Lignes       ‚îÇ Montants‚îÇ Statut   ‚îÇ Actions  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ T1 2025     ‚îÇ Situa...   ‚îÇ 388 lignes   ‚îÇ 48.8 M  ‚îÇ Termin√©  ‚îÇ üëÅÔ∏è üóëÔ∏è   ‚îÇ
‚îÇ 14/10/2025  ‚îÇ            ‚îÇ 3 prog       ‚îÇ         ‚îÇ          ‚îÇ          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### 4. Bouton "üì§ Charger des donn√©es"
- Ouvre modal avec formulaire
- Upload fichier Excel
- S√©lection ann√©e/trimestre

**Modal Upload :**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   üì§ Charger des Donn√©es SIGOBE           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Ann√©e* : [2025 ‚ñº]                       ‚îÇ
‚îÇ   Trimestre : [T1 ‚ñº]                      ‚îÇ
‚îÇ   Fichier* : [Choisir fichier...]         ‚îÇ
‚îÇ                                            ‚îÇ
‚îÇ   [Annuler]          [üì• Charger]         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### **Fiches Techniques** (`/api/v1/budget/fiches`)

**Vue Hi√©rarchique :**
```
üìÅ Programme P01 - Administration G√©n√©rale
  ‚îÇ
  ‚îú‚îÄ üìÇ Direction DAF - Affaires Financi√®res
  ‚îÇ   ‚îú‚îÄ FT-2026-P01-001  (150 M FCFA)  [Brouillon]  üëÅÔ∏è ‚úèÔ∏è üìÑ üóëÔ∏è
  ‚îÇ   ‚îî‚îÄ FT-2026-P01-002  (85 M FCFA)   [Valid√©]     üëÅÔ∏è ‚úèÔ∏è üìÑ üóëÔ∏è
  ‚îÇ
  ‚îî‚îÄ üìÇ Direction DRH - Ressources Humaines
      ‚îî‚îÄ FT-2026-P01-003  (120 M FCFA)  [Soumis]     üëÅÔ∏è ‚úèÔ∏è üìÑ üóëÔ∏è
```

**Actions :**
- **‚ûï Nouvelle Fiche** : Ouvre formulaire
- **üì• Importer Activit√©s** : Upload Excel

---

### **D√©tail Fiche** (`/api/v1/budget/fiches/{id}`)

**Sections :**

#### 1. R√©capitulatif
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FT-2026-P01-001                                    ‚îÇ
‚îÇ Budget 2026 - Administration G√©n√©rale              ‚îÇ
‚îÇ Direction: DAF                                     ‚îÇ
‚îÇ Statut: Brouillon                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Budget Ant√©rieur (2025)       100 000 000 FCFA    ‚îÇ
‚îÇ Enveloppe Demand√©e            120 000 000 FCFA    ‚îÇ
‚îÇ Compl√©ments Demand√©s           15 000 000 FCFA    ‚îÇ
‚îÇ Engagements √âtat                5 000 000 FCFA    ‚îÇ
‚îÇ Financement Bailleurs          10 000 000 FCFA    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ BUDGET TOTAL DEMAND√â          150 000 000 FCFA    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### 2. Lignes Budg√©taires (Table)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Nature ‚îÇ Activit√©       ‚îÇ Libell√©  ‚îÇ Budget   ‚îÇ Demand√©  ‚îÇ Priorit√©‚îÇ Act. ‚îÇ
‚îÇ        ‚îÇ                ‚îÇ          ‚îÇ N-1      ‚îÇ          ‚îÇ         ‚îÇ      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ BS     ‚îÇ Maintenance IT ‚îÇ Ordina...‚îÇ 5 M      ‚îÇ 8 M      ‚îÇ √âlev√©e  ‚îÇ ‚úèÔ∏è üóëÔ∏è‚îÇ
‚îÇ P      ‚îÇ Formation      ‚îÇ Forma... ‚îÇ 2 M      ‚îÇ 3 M      ‚îÇ Normale ‚îÇ ‚úèÔ∏è üóëÔ∏è‚îÇ
‚îÇ I      ‚îÇ R√©novation     ‚îÇ R√©nov... ‚îÇ 10 M     ‚îÇ 12 M     ‚îÇ Critique‚îÇ ‚úèÔ∏è üóëÔ∏è‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

TOTAL: 23 M FCFA
```

#### 3. Documents (Liste)
```
üìÑ devis_ordinateurs_2026.pdf     (245 KB)  [T√©l√©charger] [üóëÔ∏è]
üìÑ facture_proforma.pdf            (189 KB)  [T√©l√©charger] [üóëÔ∏è]
```

#### 4. Actions
- **‚úèÔ∏è Modifier** : Ouvre formulaire √©dition
- **üìÑ Exporter PDF** : G√©n√®re PDF
- **üóëÔ∏è Supprimer** : Avec confirmation

---

## üîí S√©curit√© et Bonnes Pratiques

### **Authentification**
```python
@router.get("/")
def budget_home(
    request: Request,
    current_user: User = Depends(get_current_user)
):
    # current_user est automatiquement v√©rifi√©
    # Si non connect√©, redirection vers /login
```

### **Autorisation**
```python
# V√©rifier que l'utilisateur peut supprimer
if fiche.created_by_user_id != current_user.id and current_user.user_type != UserType.ADMIN:
    raise HTTPException(403, "Non autoris√©")
```

### **Validation des Entr√©es**
```python
# V√©rifier l'ann√©e
if annee < 2020 or annee > 2050:
    raise HTTPException(400, "Ann√©e invalide")

# V√©rifier le trimestre
if trimestre and trimestre not in [1, 2, 3, 4]:
    raise HTTPException(400, "Trimestre invalide")
```

### **Gestion des Fichiers**
```python
# Limiter la taille
MAX_FILE_SIZE = 10 * 1024 * 1024  # 10 MB

if fichier.size > MAX_FILE_SIZE:
    raise HTTPException(400, "Fichier trop volumineux")

# V√©rifier l'extension
ALLOWED_EXTENSIONS = ['.xlsx', '.xls', '.pdf', '.doc', '.docx']
ext = Path(fichier.filename).suffix.lower()

if ext not in ALLOWED_EXTENSIONS:
    raise HTTPException(400, "Type de fichier non autoris√©")

# Nettoyer le nom de fichier
safe_filename = secure_filename(fichier.filename)

# G√©n√©rer nom unique
unique_filename = f"{timestamp}_{safe_filename}"
```

### **Soft Delete**
```python
# Ne jamais supprimer physiquement en production
fiche.actif = False
fiche.deleted_at = datetime.now()
fiche.deleted_by_user_id = current_user.id
session.commit()
```

### **Tra√ßabilit√©**
```python
# Logger toutes les actions importantes
logger.info(f"‚úÖ Fiche {numero} cr√©√©e par {current_user.email}")
logger.info(f"üìÑ Document {filename} upload√© pour fiche {id}")
logger.info(f"üóëÔ∏è Fiche {id} supprim√©e par {current_user.email}")

# Historique en base
historique = HistoriqueBudget(
    fiche_technique_id=fiche_id,
    action="Modification",
    ancien_statut="Brouillon",
    nouveau_statut="Valid√©",
    user_id=current_user.id,
    date_action=datetime.now()
)
session.add(historique)
```

### **Gestion des Erreurs**
```python
try:
    # Code m√©tier
    result = process_data()
    session.commit()
    return {"ok": True, "data": result}
    
except ValueError as e:
    logger.error(f"‚ùå Erreur de validation: {e}")
    raise HTTPException(400, f"Donn√©es invalides: {str(e)}")
    
except Exception as e:
    logger.error(f"‚ùå Erreur serveur: {e}")
    session.rollback()
    raise HTTPException(500, f"Erreur interne: {str(e)}")
```

---

## üöÄ Maintenance et √âvolution

### **Ajout d'un Nouveau KPI**

1. Ajouter le champ dans `SigobeKpi` :
```python
class SigobeKpi(SQLModel, table=True):
    # ... champs existants
    taux_disponible: Optional[float] = None  # Nouveau KPI
```

2. Mettre √† jour le calcul :
```python
def calcul_kpis_sigobe(chargement_id, session):
    # ... calculs existants
    taux_disponible = (disponible / budget_actuel * 100) if budget_actuel > 0 else 0
    
    kpi_global.taux_disponible = taux_disponible
```

3. Ajouter dans le template :
```html
<div class="kpi-card">
  <div class="kpi-label">üí∞ Disponible</div>
  <div class="kpi-value">{{ "{:,.0f}".format(disponible_eng_total) }}</div>
  <div class="kpi-percentage">{{ taux_disponible }}%</div>
</div>
```

---

### **Ajout d'un Nouveau Filtre**

1. Ajouter le param√®tre dans l'endpoint :
```python
@router.get("/")
def budget_home(
    annee: Optional[int] = None,
    trimestre: Optional[int] = None,
    direction_id: Optional[int] = None,  # Nouveau filtre
    ...
):
    # Appliquer le filtre
    if direction_id:
        query = query.where(SigobeExecution.direction_id == direction_id)
```

2. Ajouter dans le template :
```html
<div class="filter-group">
  <label>üè¢ Direction</label>
  <select name="direction_id" onchange="filtrerDashboard()">
    <option value="">Toutes</option>
    {% for dir in directions %}
    <option value="{{ dir.id }}">{{ dir.libelle }}</option>
    {% endfor %}
  </select>
</div>
```

3. Mettre √† jour le JavaScript :
```javascript
function filtrerDashboard() {
  const direction = document.getElementById('filter-direction').value;
  if (direction) url += `&direction_id=${direction}`;
}
```

---

### **Migration Base de Donn√©es**

Pour ajouter une colonne :

```python
# scripts/migrate_add_taux_disponible.py
import sqlite3
from pathlib import Path

DB_PATH = Path(__file__).parent.parent / "app.db"

def migrate():
    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()
    
    try:
        # Ajouter colonne
        cursor.execute("""
            ALTER TABLE sigobe_kpi 
            ADD COLUMN taux_disponible REAL
        """)
        
        conn.commit()
        print("‚úÖ Migration r√©ussie")
        
    except sqlite3.OperationalError as e:
        if "duplicate column" in str(e):
            print("‚ö†Ô∏è Colonne existe d√©j√†")
        else:
            raise
    
    finally:
        conn.close()

if __name__ == "__main__":
    migrate()
```

Ex√©cuter :
```bash
python scripts/migrate_add_taux_disponible.py
```

---

### **Tests et Validation**

#### Test d'Import SIGOBE
```python
import pytest
from app.api.v1.endpoints.budget import _parse_sigobe_file

def test_parse_sigobe_file():
    with open("tests/fixtures/sigobe_test.xlsx", "rb") as f:
        result, metadata, cols = _parse_sigobe_file(f, 2025, 1)
    
    assert len(result) > 0
    assert 'section' in metadata
    assert 'Budget_Vote' in result.columns
```

#### Test de Calcul KPI
```python
def test_calcul_taux_engagement():
    budget = 100000000
    engagements = 45000000
    
    taux = (engagements / budget * 100)
    
    assert taux == 45.0
```

---

### **Performance**

#### Indexation
```python
# Cr√©er des index pour les requ√™tes fr√©quentes
CREATE INDEX idx_sigobe_exec_chargement ON sigobe_execution(chargement_id);
CREATE INDEX idx_sigobe_exec_programmes ON sigobe_execution(programmes);
CREATE INDEX idx_sigobe_kpi_dimension ON sigobe_kpi(dimension);
```

#### Pagination
```python
@router.get("/api/executions")
def list_executions(
    skip: int = 0,
    limit: int = 100,
    session: Session = Depends(get_session)
):
    query = select(SigobeExecution).offset(skip).limit(limit)
    executions = session.exec(query).all()
    return {"items": executions, "skip": skip, "limit": limit}
```

#### Cache
```python
from functools import lru_cache

@lru_cache(maxsize=128)
def get_kpis_cached(chargement_id: int, dimension: str):
    # Mise en cache des KPIs
    return get_kpis(chargement_id, dimension)
```

---

## üìÅ Structure des Fichiers

```
mppeep/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ v1/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ endpoints/
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ budget.py                    # 3707 lignes
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ router.py
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ budget.py                            # 450 lignes
‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pages/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ budget_dashboard.html            # 1303 lignes
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ budget_sigobe.html               # 737 lignes
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ budget_fiches_hierarchique.html  # ~400 lignes
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ budget_fiche_form.html           # ~380 lignes
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ budget_fiche_detail.html         # ~480 lignes
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ budget_fiche_structure.html      # ~350 lignes
‚îÇ   ‚îî‚îÄ‚îÄ static/
‚îÇ       ‚îî‚îÄ‚îÄ images/
‚îÇ           ‚îî‚îÄ‚îÄ navbar/
‚îÇ               ‚îî‚îÄ‚îÄ budget.png
‚îú‚îÄ‚îÄ uploads/
‚îÇ   ‚îú‚îÄ‚îÄ budget/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ fiches/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ {fiche_id}/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ {document}
‚îÇ   ‚îî‚îÄ‚îÄ sigobe/
‚îÇ       ‚îî‚îÄ‚îÄ {annee}_T{trimestre}_{timestamp}.xlsx
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ (scripts de migration si n√©cessaire)
‚îî‚îÄ‚îÄ BUDGET_SYSTEM.md                             # Ce fichier

Total: ~7000 lignes de code + templates
```

---

## üéØ Checklist de Production

### **Avant D√©ploiement**

- [ ] Base de donn√©es sauvegard√©e
- [ ] Migrations test√©es en staging
- [ ] Import SIGOBE test√© avec fichiers r√©els
- [ ] KPIs valid√©s avec comptabilit√©
- [ ] Exports PDF v√©rifi√©s
- [ ] Permissions utilisateurs configur√©es
- [ ] Logs configur√©s correctement
- [ ] Stockage fichiers s√©curis√©
- [ ] Limites de taille fichiers d√©finies
- [ ] Backup automatique configur√©

### **Apr√®s D√©ploiement**

- [ ] Import d'un fichier SIGOBE de test
- [ ] V√©rification KPIs dashboard
- [ ] Cr√©ation d'une fiche technique test
- [ ] Export PDF test
- [ ] Test suppression/restauration
- [ ] V√©rification logs
- [ ] Test performance (temps de r√©ponse)
- [ ] Formation utilisateurs

---

## üìû Support et Contact

**Maintenance :**
- Documentation : `BUDGET_SYSTEM.md`
- Logs : `logs/app.log`, `logs/error.log`
- Base de donn√©es : `app.db` (SQLite)

**D√©veloppeur :**
- Code backend : `app/api/v1/endpoints/budget.py`
- Mod√®les : `app/models/budget.py`
- Templates : `app/templates/pages/budget_*.html`

---

**üí∞ Syst√®me de Gestion Budg√©taire - Production Ready**

Dashboard ‚úÖ | SIGOBE ‚úÖ | Fiches Techniques ‚úÖ | Export PDF ‚úÖ | Tra√ßabilit√© Compl√®te ‚úÖ

---

**Version :** 2.0  
**Derni√®re mise √† jour :** Octobre 2025  
**Statut :** ‚úÖ Production
