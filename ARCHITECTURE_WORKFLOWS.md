# ğŸ—ï¸ Workflows d'Architecture - MPPEEP Dashboard

## ğŸ“‹ Table des MatiÃ¨res

1. [Workflow de DÃ©marrage de l'Application](#-workflow-de-dÃ©marrage)
2. [Workflow d'une RequÃªte HTTP](#-workflow-dune-requÃªte-http)
3. [Workflow d'Authentification](#-workflow-dauthentification)
4. [Workflow de CrÃ©ation d'Utilisateur](#-workflow-de-crÃ©ation-dutilisateur)

---

## ğŸš€ Workflow de DÃ©marrage de l'Application

### Vue d'Ensemble

Voici **TOUT** ce qui se passe quand vous lancez `uvicorn app.main:app --reload` :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TERMINAL : uvicorn app.main:app --reload                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. UVICORN DÃ‰MARRE                                             â”‚
â”‚  - Charge le module Python : app.main                           â”‚
â”‚  - Cherche l'objet : app                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. IMPORT DE app.main                                          â”‚
â”‚  Fichier : app/main.py                                          â”‚
â”‚                                                                 â”‚
â”‚  from fastapi import FastAPI                                    â”‚
â”‚  from app.api.v1 import api_router          â† Import API        â”‚
â”‚  from app.core.config import settings        â† Import Config    â”‚
â”‚  from app.core.middleware import setup_middlewares              â”‚
â”‚  from app.templates import templates         â† Import Templates â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. CHARGEMENT DE app.core.config                               â”‚
â”‚  Fichier : app/core/config.py                                   â”‚
â”‚                                                                 â”‚
â”‚  class Settings(BaseSettings):                                  â”‚
â”‚      DEBUG = True                                               â”‚
â”‚      ENV = "dev"                                                â”‚
â”‚      DATABASE_URL = None                                        â”‚
â”‚      # ... autres configs                                       â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Lecture du fichier .env (si existe)              â”‚           â”‚
â”‚  â”‚ Sinon : utilise les valeurs par dÃ©faut           â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                 â”‚
â”‚  settings = Settings()          â† Instanciation                 â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ @property database_url:                          â”‚           â”‚
â”‚  â”‚   if DATABASE_URL:                               â”‚           â”‚
â”‚  â”‚       return DATABASE_URL                        â”‚           â”‚
â”‚  â”‚   if DEBUG or ENV=="dev":                        â”‚           â”‚
â”‚  â”‚       return "sqlite:///./app.db"  â† CHOIX ICI  â”‚            â”‚
â”‚  â”‚   else:                                          â”‚           â”‚
â”‚  â”‚       return "postgresql://..."                  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                 â”‚
â”‚  RÃ©sultat : database_url = "sqlite:///./app.db"                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. CHARGEMENT DE app.db.session                                â”‚
â”‚  Fichier : app/db/session.py                                    â”‚
â”‚                                                                 â”‚
â”‚  from app.core.config import settings  â† Utilise settings       â”‚
â”‚                                                                 â”‚
â”‚  engine = create_engine(                                        â”‚
â”‚      settings.database_url,  â† "sqlite:///./app.db"             â”‚
â”‚      echo=settings.DEBUG     â† True (affiche les SQL)           â”‚
â”‚  )                                                              â”‚
â”‚                                                                 â”‚
â”‚  âœ… Engine SQLite crÃ©Ã© et configurÃ©                             â”‚
â”‚                                                                 â”‚
â”‚  def get_session():                                             â”‚
â”‚      with Session(engine) as session:  â† Session SQLite         â”‚
â”‚          yield session                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. CHARGEMENT DES AUTRES MODULES                               â”‚
â”‚                                                                 â”‚
â”‚  app/api/v1/ â†’ Routes API                                       â”‚
â”‚  app/models/ â†’ ModÃ¨les SQLModel                                 â”‚
â”‚  app/services/ â†’ Services mÃ©tier                                â”‚
â”‚  app/templates/ â†’ Templates Jinja2                              â”‚
â”‚  app/core/middleware.py â†’ Middlewares                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. CRÃ‰ATION DE L'APPLICATION FASTAPI                           â”‚
â”‚  Fichier : app/main.py (ligne 9)                                â”‚
â”‚                                                                 â”‚
â”‚  app = FastAPI(title=settings.APP_NAME)                         â”‚
â”‚  âœ… Instance FastAPI crÃ©Ã©e                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. CONFIGURATION DES MIDDLEWARES                               â”‚
â”‚  Fichier : app/main.py (ligne 12)                               â”‚
â”‚                                                                 â”‚
â”‚  setup_middlewares(app, settings)                               â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ app/core/middleware.py - setup_middlewares()     â”‚           â”‚
â”‚  â”‚                                                   â”‚          â”‚
â”‚  â”‚ 1. HTTPS Redirect (si prod)                      â”‚          â”‚
â”‚  â”‚ 2. Trusted Hosts                                 â”‚          â”‚
â”‚  â”‚ 3. CORS                                          â”‚          â”‚
â”‚  â”‚ 4. Error Handling                                â”‚          â”‚
â”‚  â”‚ 5. Request Size Limit                            â”‚          â”‚
â”‚  â”‚ 6. IP Filter (optionnel)                         â”‚          â”‚
â”‚  â”‚ 7. User Agent Filter (optionnel)                 â”‚          â”‚
â”‚  â”‚ 8. Logging                                       â”‚          â”‚
â”‚  â”‚ 9. Request ID                                    â”‚          â”‚
â”‚  â”‚ 10. GZip Compression                             â”‚          â”‚
â”‚  â”‚ 11. Cache Control                                â”‚          â”‚
â”‚  â”‚ 12. Security Headers                             â”‚          â”‚
â”‚  â”‚ 13. CSP (Content Security Policy)                â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                  â”‚
â”‚  âœ… 13 middlewares configurÃ©s (selon flags dans settings)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  8. MONTAGE DES FICHIERS STATIQUES                              â”‚
â”‚  Fichier : app/main.py (ligne 15)                               â”‚
â”‚                                                                  â”‚
â”‚  app.mount("/static", StaticFiles(directory="app/static"))      â”‚
â”‚                                                                  â”‚
â”‚  âœ… /static/ â†’ app/static/                                     â”‚
â”‚     /static/css/theme.css â†’ app/static/css/theme.css           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  9. INCLUSION DES ROUTES API                                    â”‚
â”‚  Fichier : app/main.py (ligne 18)                               â”‚
â”‚                                                                  â”‚
â”‚  app.include_router(api_router, prefix="/api/v1")               â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ app/api/v1/router.py - api_router                â”‚          â”‚
â”‚  â”‚                                                   â”‚          â”‚
â”‚  â”‚ from endpoints import health, users, auth        â”‚          â”‚
â”‚  â”‚                                                   â”‚          â”‚
â”‚  â”‚ api_router.include_router(health.router)         â”‚          â”‚
â”‚  â”‚ api_router.include_router(users.router)          â”‚          â”‚
â”‚  â”‚ api_router.include_router(auth.router)           â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                  â”‚
â”‚  âœ… Routes enregistrÃ©es :                                      â”‚
â”‚     GET  /api/v1/ping                                           â”‚
â”‚     POST /api/v1/login                                          â”‚
â”‚     GET  /api/v1/users                                          â”‚
â”‚     ... etc                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  10. DÃ‰FINITION DES ROUTES RACINE                               â”‚
â”‚  Fichier : app/main.py (lignes 20-45)                           â”‚
â”‚                                                                  â”‚
â”‚  @app.get("/")                                                  â”‚
â”‚  def read_root(request):                                        â”‚
â”‚      return templates.TemplateResponse("login.html", ...)       â”‚
â”‚                                                                  â”‚
â”‚  @app.get("/accueil")                                           â”‚
â”‚  def accueil(request):                                          â”‚
â”‚      return templates.TemplateResponse("pages/accueil.html")    â”‚
â”‚                                                                  â”‚
â”‚  âœ… Routes racine enregistrÃ©es                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  11. Ã‰VÃ‰NEMENT STARTUP                                          â”‚
â”‚  Fichier : app/main.py (lignes 18-30)                           â”‚
â”‚                                                                  â”‚
â”‚  @app.on_event("startup")                                       â”‚
â”‚  async def startup_event():                                     â”‚
â”‚      from scripts.init_db import initialize_database            â”‚
â”‚      initialize_database()                                      â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ scripts/init_db.py - initialize_database()       â”‚          â”‚
â”‚  â”‚                                                   â”‚          â”‚
â”‚  â”‚ Ã‰tape 0 : CrÃ©er la base PostgreSQL si besoin     â”‚          â”‚
â”‚  â”‚   if "postgresql" in database_url:               â”‚          â”‚
â”‚  â”‚       Connexion serveur PostgreSQL               â”‚          â”‚
â”‚  â”‚       VÃ©rifier si base existe                    â”‚          â”‚
â”‚  â”‚       Si non â†’ CREATE DATABASE                   â”‚          â”‚
â”‚  â”‚   if "sqlite" in database_url:                   â”‚          â”‚
â”‚  â”‚       â†’ Rien (auto-crÃ©Ã©)                         â”‚          â”‚
â”‚  â”‚                                                  â”‚          â”‚
â”‚  â”‚ Ã‰tape 1 : CrÃ©er les tables                       â”‚          â”‚
â”‚  â”‚   SQLModel.metadata.create_all(engine)           â”‚          â”‚
â”‚  â”‚   â†’ Table user crÃ©Ã©e (si n'existe pas)           â”‚          â”‚
â”‚  â”‚                                                  â”‚          â”‚
â”‚  â”‚ Ã‰tape 2 : VÃ©rifier les admins                    â”‚          â”‚
â”‚  â”‚   admin_count = UserService.get_admin_count()    â”‚          â”‚
â”‚  â”‚                                                  â”‚          â”‚
â”‚  â”‚   if admin_count == 0:                           â”‚          â”‚
â”‚  â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚          â”‚
â”‚  â”‚       â”‚ CrÃ©er admin par dÃ©faut          â”‚        â”‚          â”‚
â”‚  â”‚       â”‚ - Email: admin@mppeep.com       â”‚        â”‚          â”‚
â”‚  â”‚       â”‚ - Password: admin123            â”‚        â”‚          â”‚
â”‚  â”‚       â”‚ - Type: ADMIN                   â”‚        â”‚          â”‚
â”‚  â”‚       â”‚ - is_superuser: True            â”‚        â”‚          â”‚
â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚          â”‚
â”‚  â”‚       UserService.create_user(...)               â”‚          â”‚
â”‚  â”‚       â†’ Admin crÃ©Ã© avec ID=1                     â”‚          â”‚
â”‚  â”‚       â†’ Affiche les identifiants                 â”‚          â”‚
â”‚  â”‚   else:                                          â”‚          â”‚
â”‚  â”‚       â†’ Skip (admin existe dÃ©jÃ )                 â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                  â”‚
â”‚  Console Output :                                               â”‚
â”‚  ================================                               â”‚
â”‚  ğŸš€ Initialisation de la base de donnÃ©es...                    â”‚
â”‚  ğŸ“‚ Type: SQLite                                                â”‚
â”‚  ğŸ“‚ URL: sqlite:///./app.db                                     â”‚
â”‚  --------------------------------------------------             â”‚
â”‚  ğŸ“ SQLite: Le fichier sera crÃ©Ã© automatiquement               â”‚
â”‚  âœ… Tables de la base de donnÃ©es crÃ©Ã©es/vÃ©rifiÃ©es              â”‚
â”‚  âœ… ADMINISTRATEUR CRÃ‰Ã‰                                         â”‚
â”‚     ğŸ“§ Email: admin@mppeep.com                                  â”‚
â”‚     ğŸ”‘ Password: admin123                                       â”‚
â”‚  âœ… Initialisation terminÃ©e avec succÃ¨s!                       â”‚
â”‚  ================================                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  12. APPLICATION PRÃŠTE                                          â”‚
â”‚                                                                  â”‚
â”‚  INFO: Uvicorn running on http://127.0.0.1:8000                â”‚
â”‚  INFO: Application startup complete.                            â”‚
â”‚                                                                  â”‚
â”‚  Ã‰tat de l'application :                                        â”‚
â”‚  âœ… FastAPI app crÃ©Ã©e                                          â”‚
â”‚  âœ… 13 middlewares configurÃ©s                                   â”‚
â”‚  âœ… Fichiers statiques montÃ©s (/static/)                       â”‚
â”‚  âœ… Routes API enregistrÃ©es (/api/v1/)                         â”‚
â”‚  âœ… Routes racine enregistrÃ©es (/, /accueil)                   â”‚
â”‚  âœ… Base de donnÃ©es initialisÃ©e (SQLite ou PostgreSQL)         â”‚
â”‚  âœ… Tables crÃ©Ã©es                                              â”‚
â”‚  âœ… Admin crÃ©Ã© (si base vide)                                  â”‚
â”‚  âœ… Serveur en Ã©coute sur port 8000                            â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“Š Base de donnÃ©es actuelle :                                 â”‚
â”‚     Type : SQLite (car DEBUG=true)                              â”‚
â”‚     Fichier : ./app.db                                          â”‚
â”‚     Tables : user (avec admin@mppeep.com)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸŒ Workflow d'une RequÃªte HTTP

### Vue d'Ensemble

Voici ce qui se passe quand un client envoie une requÃªte (exemple : `POST /api/v1/login`) :

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLIENT (Navigateur)                                            â”‚
â”‚  POST http://localhost:8000/api/v1/login                        â”‚
â”‚  Body: { username: "admin@mppeep.com", password: "admin123" }   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ RequÃªte HTTP
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SERVEUR : Uvicorn (Port 8000)                                  â”‚
â”‚  ReÃ§oit la connexion TCP                                        â”‚
â”‚  Parse la requÃªte HTTP                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ã‰TAPE 1 : PASSAGE DANS LES MIDDLEWARES (Ordre inverse)        â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ 13. CSP Middleware                                â”‚          â”‚
â”‚  â”‚     â†’ Ajoute Content-Security-Policy              â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ 12. Security Headers Middleware                   â”‚          â”‚
â”‚  â”‚     â†’ X-Frame-Options, X-Content-Type-Options     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ 11. Cache Control Middleware                      â”‚          â”‚
â”‚  â”‚     â†’ Ajoute headers de cache                     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ 10. GZip Middleware                               â”‚          â”‚
â”‚  â”‚     â†’ PrÃªt Ã  compresser la rÃ©ponse                â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ 9. Request ID Middleware                          â”‚          â”‚
â”‚  â”‚    â†’ GÃ©nÃ¨re X-Request-ID: abc-123-def             â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ 8. Logging Middleware                             â”‚          â”‚
â”‚  â”‚    â†’ Log: "POST /api/v1/login - Request ID: ..." â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ 7-6-5. Autres middlewares (IP, User-Agent, Size) â”‚          â”‚
â”‚  â”‚    â†’ VÃ©rifications de sÃ©curitÃ©                    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ 4. Error Handling Middleware                      â”‚          â”‚
â”‚  â”‚    â†’ Capture les erreurs Ã©ventuelles              â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ 3. CORS Middleware                                â”‚          â”‚
â”‚  â”‚    â†’ VÃ©rification des origines autorisÃ©es         â”‚          â”‚
â”‚  â”‚    â†’ Ajoute headers CORS                          â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ 2. Trusted Hosts Middleware                       â”‚          â”‚
â”‚  â”‚    â†’ VÃ©rifie Host header                          â”‚          â”‚
â”‚  â”‚    â†’ Bloque si host non autorisÃ©                  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ 1. HTTPS Redirect Middleware (si prod)            â”‚          â”‚
â”‚  â”‚    â†’ Redirige HTTP â†’ HTTPS                        â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   â†“                                              â”‚
â”‚                                                                  â”‚
â”‚  âœ… Tous les middlewares traversÃ©s                             â”‚
â”‚  âœ… RequÃªte validÃ©e et enrichie                                â”‚
â”‚  âœ… Headers ajoutÃ©s                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ã‰TAPE 2 : ROUTING FASTAPI                                      â”‚
â”‚                                                                  â”‚
â”‚  FastAPI cherche la route correspondante :                      â”‚
â”‚  POST /api/v1/login                                             â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Recherche dans :                                  â”‚          â”‚
â”‚  â”‚ 1. Routes racine (/, /accueil) â†’ Non             â”‚          â”‚
â”‚  â”‚ 2. Routes /api/v1/* â†’ OUI ! TrouvÃ©              â”‚          â”‚
â”‚  â”‚                                                   â”‚          â”‚
â”‚  â”‚ Match: POST /api/v1/login                        â”‚          â”‚
â”‚  â”‚ Handler: auth.login_post()                       â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                  â”‚
â”‚  âœ… Route trouvÃ©e : app/api/v1/endpoints/auth.py::login_post() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ã‰TAPE 3 : RÃ‰SOLUTION DES DÃ‰PENDANCES                           â”‚
â”‚                                                                  â”‚
â”‚  La fonction login_post a des paramÃ¨tres :                      â”‚
â”‚                                                                  â”‚
â”‚  async def login_post(                                          â”‚
â”‚      request: Request,               â† FastAPI inject          â”‚
â”‚      username: str = Form(...),      â† Parse du body           â”‚
â”‚      password: str = Form(...),      â† Parse du body           â”‚
â”‚      session: Session = Depends(get_session)  â† Inject session â”‚
â”‚  ):                                                              â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ RÃ©solution de Depends(get_session) :             â”‚          â”‚
â”‚  â”‚                                                   â”‚          â”‚
â”‚  â”‚ 1. Appel de get_session()                        â”‚          â”‚
â”‚  â”‚    Fichier: app/db/session.py                    â”‚          â”‚
â”‚  â”‚                                                   â”‚          â”‚
â”‚  â”‚    def get_session():                            â”‚          â”‚
â”‚  â”‚        with Session(engine) as session:          â”‚          â”‚
â”‚  â”‚            yield session                         â”‚          â”‚
â”‚  â”‚                                                   â”‚          â”‚
â”‚  â”‚ 2. Session crÃ©Ã©e depuis engine                   â”‚          â”‚
â”‚  â”‚    engine â†’ create_engine("sqlite:///./app.db")  â”‚          â”‚
â”‚  â”‚    session â†’ Session SQLite                      â”‚          â”‚
â”‚  â”‚                                                   â”‚          â”‚
â”‚  â”‚ 3. Session injectÃ©e dans login_post()            â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                  â”‚
â”‚  âœ… ParamÃ¨tres rÃ©solus :                                       â”‚
â”‚     request = Request object                                    â”‚
â”‚     username = "admin@mppeep.com"                               â”‚
â”‚     password = "admin123"                                       â”‚
â”‚     session = Session(engine SQLite)  â† Pointe vers SQLite     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ã‰TAPE 4 : EXÃ‰CUTION DE LA FONCTION ENDPOINT                    â”‚
â”‚  Fichier : app/api/v1/endpoints/auth.py::login_post()           â”‚
â”‚                                                                  â”‚
â”‚  # Utiliser le service pour authentifier                        â”‚
â”‚  user = UserService.authenticate(session, username, password)   â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ app/services/user_service.py - authenticate()    â”‚          â”‚
â”‚  â”‚                                                   â”‚          â”‚
â”‚  â”‚ 1. RÃ©cupÃ©rer l'utilisateur par email             â”‚          â”‚
â”‚  â”‚    user = UserService.get_by_email(session, email)â”‚          â”‚
â”‚  â”‚                                                   â”‚          â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚          â”‚
â”‚  â”‚    â”‚ SELECT * FROM user                 â”‚        â”‚          â”‚
â”‚  â”‚    â”‚ WHERE email = 'admin@mppeep.com'   â”‚        â”‚          â”‚
â”‚  â”‚    â”‚                                    â”‚        â”‚          â”‚
â”‚  â”‚    â”‚ âœ… ExÃ©cutÃ© dans SQLite (app.db)   â”‚        â”‚          â”‚
â”‚  â”‚    â”‚ âœ… User trouvÃ©                     â”‚        â”‚          â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚          â”‚
â”‚  â”‚                                                   â”‚          â”‚
â”‚  â”‚ 2. VÃ©rifier le mot de passe                      â”‚          â”‚
â”‚  â”‚    if verify_password(password, user.hashed_...):â”‚          â”‚
â”‚  â”‚        â†’ Bcrypt compare                           â”‚          â”‚
â”‚  â”‚        â†’ Match âœ…                                â”‚          â”‚
â”‚  â”‚                                                   â”‚          â”‚
â”‚  â”‚ 3. Retourner l'utilisateur                       â”‚          â”‚
â”‚  â”‚    return user                                    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                  â”‚
â”‚  if not user:                                                   â”‚
â”‚      â†’ Retourner erreur                                         â”‚
â”‚                                                                  â”‚
â”‚  if not user.is_active:                                         â”‚
â”‚      â†’ Retourner erreur                                         â”‚
â”‚                                                                  â”‚
â”‚  # Authentification rÃ©ussie                                     â”‚
â”‚  return RedirectResponse(url="/accueil", status_code=303)       â”‚
â”‚                                                                  â”‚
â”‚  âœ… RÃ©ponse prÃ©parÃ©e                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ã‰TAPE 5 : FERMETURE AUTOMATIQUE DE LA SESSION                 â”‚
â”‚                                                                  â”‚
â”‚  La session Ã©tait dans un context manager :                     â”‚
â”‚                                                                  â”‚
â”‚  with Session(engine) as session:                               â”‚
â”‚      yield session      â† Endpoint exÃ©cutÃ©                      â”‚
â”‚  # Ici : fermeture auto âœ…                                     â”‚
â”‚                                                                  â”‚
â”‚  Actions automatiques :                                         â”‚
â”‚  1. session.close() â†’ Ferme la connexion DB                     â”‚
â”‚  2. LibÃ¨re les ressources                                       â”‚
â”‚  3. Rollback si erreur non committÃ©e                            â”‚
â”‚                                                                  â”‚
â”‚  âœ… Pas de fuite de connexion                                  â”‚
â”‚  âœ… Pas de transaction pendante                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ã‰TAPE 6 : RETOUR DANS LES MIDDLEWARES (Ordre inverse)         â”‚
â”‚                                                                  â”‚
â”‚  La rÃ©ponse traverse les middlewares dans l'ordre inverse :     â”‚
â”‚                                                                  â”‚
â”‚  Response = RedirectResponse(url="/accueil", status=303)        â”‚
â”‚                   â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ 1. HTTPS Redirect â†’ Skip (dÃ©jÃ  HTTPS)            â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ 2. Trusted Hosts â†’ VÃ©rifiÃ© âœ…                    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ 3. CORS â†’ Ajoute headers Access-Control-*        â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   â†“                                              â”‚
â”‚  â”‚ ... middlewares 4-9 ...                          â”‚          â”‚
â”‚                   â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ 10. GZip â†’ Compresse la rÃ©ponse si > 1KB         â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ 11. Cache Control â†’ Cache-Control: no-cache      â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ 12. Security Headers                              â”‚          â”‚
â”‚  â”‚     â†’ X-Content-Type-Options: nosniff             â”‚          â”‚
â”‚  â”‚     â†’ X-Frame-Options: DENY                       â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   â†“                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ 13. CSP                                           â”‚          â”‚
â”‚  â”‚     â†’ Content-Security-Policy: default-src ...    â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   â†“                                              â”‚
â”‚                                                                  â”‚
â”‚  âœ… RÃ©ponse enrichie avec headers de sÃ©curitÃ©                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ã‰TAPE 7 : ENVOI AU CLIENT                                      â”‚
â”‚                                                                  â”‚
â”‚  HTTP/1.1 303 See Other                                         â”‚
â”‚  Location: /accueil                                             â”‚
â”‚  X-Request-ID: abc-123-def                                      â”‚
â”‚  Access-Control-Allow-Origin: *                                 â”‚
â”‚  X-Content-Type-Options: nosniff                                â”‚
â”‚  X-Frame-Options: DENY                                          â”‚
â”‚  Content-Security-Policy: default-src 'self'                    â”‚
â”‚  Cache-Control: no-cache                                        â”‚
â”‚  Content-Encoding: gzip                                         â”‚
â”‚                                                                  â”‚
â”‚  âœ… RÃ©ponse complÃ¨te envoyÃ©e                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚ RÃ©ponse HTTP
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLIENT (Navigateur)                                            â”‚
â”‚  ReÃ§oit 303 Redirect â†’ /accueil                                â”‚
â”‚  Navigue automatiquement vers /accueil                          â”‚
â”‚  âœ… Utilisateur authentifiÃ© et redirigÃ©                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” DÃ©tail : Flux Base de DonnÃ©es dans une RequÃªte

```
REQUÃŠTE : POST /api/v1/login
    â†“
ENDPOINT : auth.login_post(session)
    â”‚
    â”‚ session injectÃ©e par Depends(get_session)
    â”‚ â””â†’ Session liÃ©e Ã  engine
    â”‚    â””â†’ engine crÃ©Ã© avec settings.database_url
    â”‚       â””â†’ "sqlite:///./app.db" (car DEBUG=true)
    â”‚
    â†“
SERVICE : UserService.authenticate(session, email, password)
    â”‚
    â”‚ 1. get_by_email(session, email)
    â”‚    â”œâ†’ statement = select(User).where(User.email == email)
    â”‚    â”œâ†’ session.exec(statement)
    â”‚    â”‚  â””â†’ SQLAlchemy traduit en SQL
    â”‚    â”‚     â””â†’ SELECT * FROM user WHERE email = ?
    â”‚    â”‚        â””â†’ ExÃ©cutÃ© dans SQLite (app.db) âœ…
    â”‚    â””â†’ RÃ©sultat : User object
    â”‚
    â”‚ 2. verify_password(password, user.hashed_password)
    â”‚    â””â†’ Bcrypt compare
    â”‚       â””â†’ Match âœ…
    â”‚
    â†“
RETOUR Ã  l'endpoint
    â”‚
    â”‚ user trouvÃ© et vÃ©rifiÃ©
    â”‚ return RedirectResponse(...)
    â”‚
    â†“
RÃ‰PONSE au client
```

---

## ğŸ¯ Points ClÃ©s

### âœ… Le Service Ne Sait Pas OÃ¹ Il Ã‰crit

```python
# Service (agnostique)
def create_user(session, email, ...):
    user = User(...)
    session.add(user)     # â† Ne sait pas si SQLite ou PostgreSQL
    session.commit()      # â† Ã‰crit dans la base liÃ©e Ã  la session
    return user
```

**La session "sait" grÃ¢ce Ã  son engine**

---

### âœ… L'Engine Est ConfigurÃ© Au DÃ©marrage

```python
# session.py (ligne 6)
engine = create_engine(settings.database_url)
#                      â†‘
#                      Choix fait ICI au dÃ©marrage
#                      "sqlite:///./app.db" si DEBUG=true
#                      "postgresql://..." si DEBUG=false
```

**Une seule fois au dÃ©marrage, puis rÃ©utilisÃ© partout**

---

### âœ… Changement Transparent

```
Changer DEBUG=false dans .env
â†’ RedÃ©marrer l'application
â†’ Nouveau engine PostgreSQL crÃ©Ã©
â†’ Toutes les sessions pointent vers PostgreSQL
â†’ Tous les services Ã©crivent dans PostgreSQL
â†’ AUCUN changement de code nÃ©cessaire âœ…
```

---

## ğŸ“Š RÃ©sumÃ© Visuel

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   .env       â”‚
â”‚  DEBUG=true  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  config.py               â”‚
â”‚  @property database_url  â”‚
â”‚  â†’ "sqlite:///./app.db"  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  session.py              â”‚
â”‚  engine = create_engine  â”‚
â”‚  â†’ Engine SQLite         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  get_session()           â”‚
â”‚  â†’ Session SQLite        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Endpoint                â”‚
â”‚  session: Depends(...)   â”‚
â”‚  â†’ ReÃ§oit Session SQLite â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service                 â”‚
â”‚  session.add(user)       â”‚
â”‚  â†’ Ã‰crit dans SQLite âœ…  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Tout est automatique grÃ¢ce Ã  la cascade de configuration ! ğŸ¯**
