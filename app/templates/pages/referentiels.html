{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}Gestion des R√©f√©rentiels - {{ app_name }}{% endblock %}

{% block content %}
{{ page_header(
    title='‚öôÔ∏è Gestion des R√©f√©rentiels',
    breadcrumbs=[
        {'name': 'Accueil', 'url': url_for('accueil')},
        {'name': 'R√©f√©rentiels'}
    ],
    actions=[
        {'label': '‚ùì Aide', 'url': url_for('aide_referentiels'), 'primary': False},
        {'label': '‚Üê Retour Accueil', 'url': url_for('accueil'), 'primary': False}
    ]
) }}

<div class="referentials-page">

  <!-- Statistiques -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Programmes</div>
      <div class="stat-number">{{ nb_programmes }}</div>
    </div>
    
    <div class="stat-card success">
      <div class="stat-label">Directions</div>
      <div class="stat-number">{{ nb_directions }}</div>
    </div>
    
    <div class="stat-card secondary">
      <div class="stat-label">Services</div>
      <div class="stat-number">{{ nb_services }}</div>
    </div>
    
    <div class="stat-card warning">
      <div class="stat-label">Grades</div>
      <div class="stat-number">{{ nb_grades }}</div>
    </div>
  </div>

  <!-- Onglets -->
  <div class="card">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('programmes')">üìÅ Programmes</button>
      <button class="tab" onclick="switchTab('directions')">üè¢ Directions</button>
      <button class="tab" onclick="switchTab('services')">üìã Services</button>
      <button class="tab" onclick="switchTab('grades')">üéì Grades</button>
      <button class="tab" onclick="switchTab('categories')">üì¶ Cat√©gories</button>
    </div>

    <!-- TAB PROGRAMMES -->
    <div id="tab-programmes" class="tab-content active">
      <div class="table-header">
        <h3>üìÅ Programmes Budg√©taires</h3>
        <button class="btn btn-primary" onclick="openModal('programme')">‚ûï Nouveau Programme</button>
      </div>
      
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>Code</th>
              <th>Libell√©</th>
              <th>Responsable</th>
              <th>Description</th>
          <th>Statut</th>
          <th class="is-centered">Actions</th>
            </tr>
          </thead>
          <tbody id="programmes-tbody">
            <tr class="loading-row">
              <td colspan="6" class="table-placeholder">
                <div class="placeholder-icon">‚è≥</div>
                <p class="placeholder-text">Chargement...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- TAB DIRECTIONS -->
    <div id="tab-directions" class="tab-content">
      <div class="table-header">
        <h3>üè¢ Directions</h3>
        <button class="btn btn-primary" onclick="openModal('direction')">‚ûï Nouvelle Direction</button>
      </div>
      
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>Code</th>
              <th>Libell√©</th>
              <th>Programme</th>
          <th>Directeur</th>
          <th>Statut</th>
          <th class="is-centered">Actions</th>
            </tr>
          </thead>
          <tbody id="directions-tbody">
            <tr class="loading-row">
              <td colspan="6" class="table-placeholder">
                <div class="placeholder-icon">‚è≥</div>
                <p class="placeholder-text">Chargement...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- TAB SERVICES -->
    <div id="tab-services" class="tab-content">
      <div class="table-header">
        <h3>üìã Services</h3>
        <button class="btn btn-primary" onclick="openModal('service')">‚ûï Nouveau Service</button>
      </div>
      
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>Code</th>
              <th>Libell√©</th>
              <th>Direction</th>
              <th>Chef de Service</th>
          <th>Statut</th>
          <th class="is-centered">Actions</th>
            </tr>
          </thead>
          <tbody id="services-tbody">
            <tr class="loading-row">
              <td colspan="6" class="table-placeholder">
                <div class="placeholder-icon">‚è≥</div>
                <p class="placeholder-text">Chargement...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- TAB GRADES -->
    <div id="tab-grades" class="tab-content">
      <div class="table-header">
        <h3>üéì Grades</h3>
        <button class="btn btn-primary" onclick="openModal('grade')">‚ûï Nouveau Grade</button>
      </div>
      
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>Code</th>
              <th>Libell√©</th>
              <th>Cat√©gorie</th>
              <th>√âchelons</th>
          <th>Statut</th>
          <th class="is-centered">Actions</th>
            </tr>
          </thead>
          <tbody id="grades-tbody">
            <tr class="loading-row">
              <td colspan="6" class="table-placeholder">
                <div class="placeholder-icon">‚è≥</div>
                <p class="placeholder-text">Chargement...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- TAB CAT√âGORIES D'ARTICLES -->
    <div id="tab-categories" class="tab-content">
      <div class="table-header">
        <h3>üì¶ Cat√©gories d'Articles</h3>
        <button class="btn btn-primary" onclick="openModal('categorie')">‚ûï Nouvelle Cat√©gorie</button>
      </div>
      
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>Code</th>
              <th>Libell√©</th>
          <th>Description</th>
          <th class="is-centered">Actions</th>
            </tr>
          </thead>
          <tbody id="categories-tbody">
            <tr class="loading-row">
              <td colspan="4" class="table-placeholder">
                <div class="placeholder-icon">‚è≥</div>
                <p class="placeholder-text">Chargement...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Modal CRUD -->
<div id="crudModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modal-title">Titre</h2>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    
    <form id="crudForm" onsubmit="handleSubmit(event)">
      <div class="form-grid" id="modal-form-content">
        <!-- Contenu dynamique -->
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block styles %}{% endblock %}

{% block scripts %}
<script>
let currentType = '';
let editingId = null;
let agents = []; // Liste des agents pour les responsables
let programmes = []; // Liste des programmes pour les directions
let directions = []; // Liste des directions pour les services

// Charger les donn√©es au d√©marrage
document.addEventListener('DOMContentLoaded', function() {
  loadAgents(); // Charger la liste des agents
  loadProgrammes();
  loadDirections();
  loadServices();
  loadGrades();
  loadCategories();
});

// ============================================
// CHARGER LA LISTE DES AGENTS
// ============================================
async function loadAgents() {
  try {
    const response = await fetch('{{ url_for("list_agents_api") }}?limit=200&actif=true');
    agents = await response.json();
  } catch (error) {
    console.error('Erreur chargement agents:', error);
  }
}

// ============================================
// GESTION DES ONGLETS
// ============================================
function switchTab(tabName) {
  // D√©sactiver tous les onglets
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  
  // Activer l'onglet s√©lectionn√©
  event.target.classList.add('active');
  document.getElementById(`tab-${tabName}`).classList.add('active');
}

// ============================================
// CHARGEMENT DES DONN√âES
// ============================================

// Fonction helper pour recharger les donn√©es d'une table
async function reloadTableData(type) {
  switch(type) {
    case 'programme':
      await loadProgrammes();
      break;
    case 'direction':
      await loadDirections();
      break;
    case 'service':
      await loadServices();
      break;
    case 'grade':
      await loadGrades();
      break;
    case 'categorie':
      await loadCategories();
      break;
  }
}

async function loadProgrammes() {
  const response = await fetch("{{ url_for('api_list_programmes_ref') }}");
  programmes = await response.json(); // Stocker dans la variable globale
  
  const tbody = document.getElementById('programmes-tbody');
  
  // Si aucun programme, afficher le message vide
  if (programmes.length === 0) {
    tbody.innerHTML = `
      <tr class="empty-state">
        <td colspan="6">
          <div class="empty-state-card">
            <div class="empty-state-icon">üìÅ</div>
            <h4 class="empty-state-title">Aucun programme enregistr√©</h4>
            <p class="empty-state-text">
              Cliquez sur ¬´¬†‚ûï Nouveau Programme¬†¬ª pour cr√©er votre premier programme budg√©taire.
            </p>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  tbody.innerHTML = programmes.map(p => `
    <tr>
      <td><strong>${p.code}</strong></td>
      <td>${p.libelle}</td>
      <td>${p.responsable_nom || '<span class="text-muted">‚Äî</span>'}</td>
      <td>${p.description || '<span class="text-muted">‚Äî</span>'}</td>
      <td>
        <span class="badge ${p.actif ? 'badge-success' : 'badge-danger'}">
          ${p.actif ? 'Actif' : 'Inactif'}
        </span>
      </td>
      <td class="actions-cell">
        <div class="action-buttons">
          <button class="btn btn-sm btn-primary" onclick="openModal('programme', ${p.id})" title="Modifier">
            ‚úèÔ∏è
          </button>
          ${!p.actif ? `
            <button class="btn btn-sm btn-success" onclick="reactivateItem('programme', ${p.id})" title="R√©activer">
              ‚ôªÔ∏è
            </button>
          ` : `
            <button class="btn btn-sm btn-warning" onclick="deactivateItem('programme', ${p.id})" title="D√©sactiver">
              ‚è∏Ô∏è
            </button>
          `}
          <button class="btn btn-sm btn-danger" onclick="deleteItem('programme', ${p.id})" title="Supprimer d√©finitivement">
            üóëÔ∏è
          </button>
        </div>
      </td>
    </tr>
  `).join('');
}

async function loadDirections() {
  const response = await fetch("{{ url_for('api_list_directions_ref') }}");
  directions = await response.json(); // Stocker dans la variable globale
  
  const tbody = document.getElementById('directions-tbody');
  
  // Si aucune direction, afficher le message vide
  if (directions.length === 0) {
    tbody.innerHTML = `
      <tr class="empty-state">
        <td colspan="6">
          <div class="empty-state-card">
            <div class="empty-state-icon">üè¢</div>
            <h4 class="empty-state-title">Aucune direction enregistr√©e</h4>
            <p class="empty-state-text">
              Cliquez sur ¬´¬†‚ûï Nouvelle Direction¬†¬ª pour cr√©er votre premi√®re direction.
            </p>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  tbody.innerHTML = directions.map(d => `
      <tr>
        <td><strong>${d.code}</strong></td>
        <td>${d.libelle}</td>
        <td>${d.programme_libelle || '<span class="text-muted">‚Äî</span>'}</td>
        <td>${d.directeur_nom || '<span class="text-muted">‚Äî</span>'}</td>
        <td>
          <span class="badge ${d.actif ? 'badge-success' : 'badge-danger'}">
            ${d.actif ? 'Actif' : 'Inactif'}
          </span>
        </td>
        <td class="actions-cell">
          <div class="action-buttons">
            <button class="btn btn-sm btn-primary" onclick="openModal('direction', ${d.id})" title="Modifier">
              ‚úèÔ∏è
            </button>
            ${!d.actif ? `
              <button class="btn btn-sm btn-success" onclick="reactivateItem('direction', ${d.id})" title="R√©activer">
                ‚ôªÔ∏è
              </button>
            ` : `
              <button class="btn btn-sm btn-warning" onclick="deactivateItem('direction', ${d.id})" title="D√©sactiver">
                ‚è∏Ô∏è
              </button>
            `}
            <button class="btn btn-sm btn-danger" onclick="deleteItem('direction', ${d.id})" title="Supprimer d√©finitivement">
              üóëÔ∏è
            </button>
          </div>
        </td>
      </tr>
  `).join('');
}

async function loadServices() {
  const response = await fetch("{{ url_for('api_list_services_ref') }}" + "?_=" + Date.now(), {
    cache: 'no-cache',
    headers: {
      'Cache-Control': 'no-cache',
      'Pragma': 'no-cache'
    }
  });
  const services = await response.json();
  
  const tbody = document.getElementById('services-tbody');
  
  // Si aucun service, afficher le message vide
  if (services.length === 0) {
    tbody.innerHTML = `
      <tr class="empty-state">
        <td colspan="6">
          <div class="empty-state-card">
            <div class="empty-state-icon">üìã</div>
            <h4 class="empty-state-title">Aucun service enregistr√©</h4>
            <p class="empty-state-text">
              Cliquez sur ¬´¬†‚ûï Nouveau Service¬†¬ª pour cr√©er votre premier service.
            </p>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  tbody.innerHTML = services.map(s => `
      <tr>
        <td><strong>${s.code}</strong></td>
        <td>${s.libelle}</td>
        <td>${s.direction_libelle || '<span class="text-muted">‚Äî</span>'}</td>
        <td>${s.chef_service_nom || '<span class="text-muted">‚Äî</span>'}</td>
        <td>
          <span class="badge ${s.actif ? 'badge-success' : 'badge-danger'}">
            ${s.actif ? 'Actif' : 'Inactif'}
          </span>
        </td>
        <td class="actions-cell">
          <div class="action-buttons">
            <button class="btn btn-sm btn-primary" onclick="openModal('service', ${s.id})" title="Modifier">
              ‚úèÔ∏è
            </button>
            ${!s.actif ? `
              <button class="btn btn-sm btn-success" onclick="reactivateItem('service', ${s.id})" title="R√©activer">
                ‚ôªÔ∏è
              </button>
            ` : `
              <button class="btn btn-sm btn-warning" onclick="deactivateItem('service', ${s.id})" title="D√©sactiver">
                ‚è∏Ô∏è
              </button>
            `}
            <button class="btn btn-sm btn-danger" onclick="deleteItem('service', ${s.id})" title="Supprimer d√©finitivement">
              üóëÔ∏è
            </button>
          </div>
      </td>
    </tr>
  `).join('');
}

async function loadGrades() {
  const response = await fetch("{{ url_for('api_list_grades_ref') }}");
  const grades = await response.json();
  
  const tbody = document.getElementById('grades-tbody');
  
  // Si aucun grade, afficher le message vide
  if (grades.length === 0) {
    tbody.innerHTML = `
      <tr class="empty-state">
        <td colspan="6">
          <div class="empty-state-card">
            <div class="empty-state-icon">üéì</div>
            <h4 class="empty-state-title">Aucun grade enregistr√©</h4>
            <p class="empty-state-text">
              Cliquez sur ¬´¬†‚ûï Nouveau Grade¬†¬ª pour cr√©er votre premier grade de la fonction publique.
            </p>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  tbody.innerHTML = grades.map(g => `
    <tr>
      <td><strong>${g.code}</strong></td>
      <td>${g.libelle}</td>
      <td><span class="badge badge-info">${g.categorie}</span></td>
      <td>${g.echelon_min} - ${g.echelon_max}</td>
      <td>
        <span class="badge ${g.actif ? 'badge-success' : 'badge-danger'}">
          ${g.actif ? 'Actif' : 'Inactif'}
        </span>
      </td>
      <td class="actions-cell">
        <div class="action-buttons">
          <button class="btn btn-sm btn-primary" onclick="openModal('grade', ${g.id})" title="Modifier">
            ‚úèÔ∏è
          </button>
          ${!g.actif ? `
            <button class="btn btn-sm btn-success" onclick="reactivateItem('grade', ${g.id})" title="R√©activer">
              ‚ôªÔ∏è
            </button>
          ` : `
            <button class="btn btn-sm btn-warning" onclick="deactivateItem('grade', ${g.id})" title="D√©sactiver">
              ‚è∏Ô∏è
            </button>
          `}
          <button class="btn btn-sm btn-danger" onclick="deleteItem('grade', ${g.id})" title="Supprimer d√©finitivement">
            üóëÔ∏è
          </button>
        </div>
      </td>
    </tr>
  `).join('');
}

// ============================================
// MODAL
// ============================================
async function loadCategories() {
  const response = await fetch("{{ url_for('api_list_categories_ref') }}");
  const categories = await response.json();
  
  const tbody = document.getElementById('categories-tbody');
  
  // Si aucune cat√©gorie, afficher le message vide
  if (categories.length === 0) {
    tbody.innerHTML = `
      <tr class="empty-state">
        <td colspan="4">
          <div class="empty-state-card">
            <div class="empty-state-icon">üì¶</div>
            <h4 class="empty-state-title">Aucune cat√©gorie enregistr√©e</h4>
            <p class="empty-state-text">
              Cliquez sur ¬´¬†‚ûï Nouvelle Cat√©gorie¬†¬ª pour cr√©er votre premi√®re cat√©gorie d‚Äôarticle.
            </p>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  tbody.innerHTML = categories.map(c => `
    <tr>
      <td><strong>${c.code}</strong></td>
      <td>${c.libelle}</td>
      <td>${c.description || '<span class="text-muted">‚Äî</span>'}</td>
      <td class="actions-cell">
        <div class="action-buttons">
          <button class="btn btn-sm btn-primary" onclick="openModal('categorie', ${c.id})" title="Modifier">
            ‚úèÔ∏è
          </button>
          <button class="btn btn-sm btn-danger" onclick="deleteItem('categorie', ${c.id})" title="Supprimer">
            üóëÔ∏è
          </button>
        </div>
      </td>
    </tr>
  `).join('');
}

function openModal(type, id = null) {
  currentType = type;
  editingId = id;
  
  const modal = document.getElementById('crudModal');
  const title = document.getElementById('modal-title');
  const formContent = document.getElementById('modal-form-content');
  
  // D√©finir le titre
  const titles = {
    'programme': id ? 'Modifier Programme' : 'Nouveau Programme',
    'direction': id ? 'Modifier Direction' : 'Nouvelle Direction',
    'service': id ? 'Modifier Service' : 'Nouveau Service',
    'grade': id ? 'Modifier Grade' : 'Nouveau Grade',
    'categorie': id ? 'Modifier Cat√©gorie' : 'Nouvelle Cat√©gorie'
  };
  title.textContent = titles[type];
  
  // G√©n√©rer le formulaire selon le type
  if (type === 'programme') {
    formContent.innerHTML = `
      <div class="form-group">
        <label>Code *</label>
        <input type="text" name="code" id="field-code" required placeholder="Ex: P01" class="form-control">
      </div>
      <div class="form-group">
        <label>Libell√© *</label>
        <input type="text" name="libelle" id="field-libelle" required placeholder="Ex: Pilotage" class="form-control">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea name="description" id="field-description" rows="3" class="form-control"></textarea>
      </div>
      <div class="form-group">
        <label>Responsable du Programme</label>
        <select name="responsable_id" id="field-responsable_id" class="form-control">
          <option value="">-- Aucun responsable --</option>
          ${agents.map(a => `<option value="${a.id}">${a.nom} ${a.prenom} (${a.matricule})</option>`).join('')}
        </select>
      </div>
      ${id ? '<input type="hidden" name="actif" id="field-actif" value="true">' : ''}
    `;
  } else if (type === 'direction') {
    formContent.innerHTML = `
      <div class="form-group">
        <label>Code *</label>
        <input type="text" name="code" id="field-code" required placeholder="Ex: DAF" class="form-control">
      </div>
      <div class="form-group">
        <label>Libell√© *</label>
        <input type="text" name="libelle" id="field-libelle" required placeholder="Ex: Direction Administrative" class="form-control">
      </div>
      <div class="form-group">
        <label>Programme</label>
        <select name="programme_id" id="field-programme_id" class="form-control">
          <option value="">-- Aucun --</option>
          ${programmes.map(p => `<option value="${p.id}">${p.code} - ${p.libelle}</option>`).join('')}
        </select>
      </div>
      <div class="form-group">
        <label>Directeur</label>
        <select name="directeur_id" id="field-directeur_id" class="form-control">
          <option value="">-- Aucun directeur --</option>
          ${agents.map(a => `<option value="${a.id}">${a.nom} ${a.prenom} (${a.matricule})</option>`).join('')}
        </select>
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea name="description" id="field-description" rows="3" class="form-control"></textarea>
      </div>
      ${id ? '<input type="hidden" name="actif" id="field-actif" value="true">' : ''}
    `;
  } else if (type === 'service') {
    formContent.innerHTML = `
      <div class="form-group">
        <label>Code *</label>
        <input type="text" name="code" id="field-code" required placeholder="Ex: SCPT" class="form-control">
      </div>
      <div class="form-group">
        <label>Libell√© *</label>
        <input type="text" name="libelle" id="field-libelle" required placeholder="Ex: Service Comptabilit√©" class="form-control">
      </div>
      <div class="form-group">
        <label>Direction</label>
        <select name="direction_id" id="field-direction_id" class="form-control">
          <option value="">-- Aucune --</option>
          ${directions.map(d => `<option value="${d.id}">${d.code} - ${d.libelle}</option>`).join('')}
        </select>
      </div>
      <div class="form-group">
        <label>Chef de Service</label>
        <select name="chef_service_id" id="field-chef_service_id" class="form-control">
          <option value="">-- Aucun chef de service --</option>
          ${agents.map(a => `<option value="${a.id}">${a.nom} ${a.prenom} (${a.matricule})</option>`).join('')}
        </select>
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea name="description" id="field-description" rows="3" class="form-control"></textarea>
      </div>
      ${id ? '<input type="hidden" name="actif" id="field-actif" value="true">' : ''}
    `;
  } else if (type === 'grade') {
    formContent.innerHTML = `
      <div class="form-group">
        <label>Code *</label>
        <input type="text" name="code" id="field-code" required placeholder="Ex: A1" class="form-control">
      </div>
      <div class="form-group">
        <label>Libell√© *</label>
        <input type="text" name="libelle" id="field-libelle" required placeholder="Ex: Administrateur Civil" class="form-control">
      </div>
      <div class="form-group">
        <label>Cat√©gorie *</label>
        <select name="categorie" id="field-categorie" required class="form-control">
          <option value="A">A - Cadres sup√©rieurs</option>
          <option value="B">B - Cadres moyens</option>
          <option value="C">C - Agents d'ex√©cution</option>
          <option value="D">D - Personnel de soutien</option>
        </select>
      </div>
      <div class="form-group">
        <label>√âchelon Min *</label>
        <input type="number" name="echelon_min" id="field-echelon_min" required value="1" min="1" class="form-control">
      </div>
      <div class="form-group">
        <label>√âchelon Max *</label>
        <input type="number" name="echelon_max" id="field-echelon_max" required value="5" min="1" class="form-control">
      </div>
      ${id ? '<input type="hidden" name="actif" id="field-actif" value="true">' : ''}
    `;
  } else if (type === 'categorie') {
    formContent.innerHTML = `
      <div class="form-group">
        <label>Code *</label>
        <input type="text" name="code" id="field-code" required placeholder="Ex: FOUR" class="form-control">
      </div>
      <div class="form-group">
        <label>Libell√© *</label>
        <input type="text" name="libelle" id="field-libelle" required placeholder="Ex: Fournitures de bureau" class="form-control">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea name="description" id="field-description" rows="3" class="form-control"></textarea>
      </div>
    `;
  }
  
  // Si √©dition, charger les donn√©es
  if (id) {
    loadFormData(type, id);
  }
  
  modal.classList.add('show');
}

function closeModal() {
  const modal = document.getElementById('crudModal');
  modal.classList.remove('show');
  document.getElementById('crudForm').reset();
  editingId = null;
}

async function loadFormData(type, id) {
  const response = await fetch(`/api/v1/referentiels/api/${type}s`);
  const items = await response.json();
  const item = items.find(i => i.id === id);
  
  if (item) {
    Object.keys(item).forEach(key => {
      const field = document.getElementById(`field-${key}`);
      if (field && item[key] != null && item[key] !== '' && item[key] !== "None") {
        // Ne remplir que si la valeur existe (√©vite les probl√®mes de validation sur champs vides)
        field.value = item[key];
      }
    });
  }
}

// ============================================
// SOUMISSION DU FORMULAIRE
// ============================================
async function handleSubmit(event) {
  event.preventDefault();
  
  showGlobalLoading('Enregistrement...', 'Veuillez patienter');
  
  const formData = new FormData(event.target);
  
  // Construire l'URL avec url_for selon le type
  let url;
  if (editingId && editingId !== null && editingId !== 'null') {
    // Modification
    switch(currentType) {
      case 'programme':
        url = "{{ url_for('api_update_programme', programme_id=0) }}".replace('/0', `/${editingId}`);
        break;
      case 'direction':
        url = "{{ url_for('api_update_direction', direction_id=0) }}".replace('/0', `/${editingId}`);
        break;
      case 'service':
        url = "{{ url_for('api_update_service', service_id=0) }}".replace('/0', `/${editingId}`);
        break;
      case 'grade':
        url = "{{ url_for('api_update_grade', grade_id=0) }}".replace('/0', `/${editingId}`);
        break;
      case 'categorie':
        url = "{{ url_for('api_update_categorie', categorie_id=0) }}".replace('/0', `/${editingId}`);
        break;
    }
  } else {
    // Cr√©ation
    switch(currentType) {
      case 'programme':
        url = "{{ url_for('api_create_programme') }}";
        break;
      case 'direction':
        url = "{{ url_for('api_create_direction') }}";
        break;
      case 'service':
        url = "{{ url_for('api_create_service') }}";
        break;
      case 'grade':
        url = "{{ url_for('api_create_grade') }}";
        break;
      case 'categorie':
        url = "{{ url_for('api_create_categorie') }}";
        break;
    }
  }
  
  try {
    // Utiliser la fonction utilitaire en for√ßant FormData (les endpoints attendent Form(...))
    const response = await submitFormAsJson(url, formData, editingId ? 'PUT' : 'POST', true);
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      closeModal();
      showGlobalLoading('‚úÖ Enregistr√©', 'Actualisation des donn√©es...');
      
      // Recharger uniquement les donn√©es de la table concern√©e
      switch(currentType) {
        case 'programme':
          await loadProgrammes();
          break;
        case 'direction':
          await loadDirections();
          break;
        case 'service':
          await loadServices();
          break;
        case 'grade':
          await loadGrades();
          break;
        case 'categorie':
          await loadCategories();
          break;
      }
      
      hideGlobalLoading();
      showSuccess(result.message || 'Enregistr√© avec succ√®s');
    } else {
      hideGlobalLoading();
      await handleFetchError(response, 'Erreur lors de l\'enregistrement');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur r√©seau. V√©rifiez votre connexion.');
  }
}

// ============================================
// FONCTIONS D'√âDITION
// ============================================
function editProgramme(id) {
  openModal('programme', id);
}

function editDirection(id) {
  openModal('direction', id);
}

function editService(id) {
  openModal('service', id);
}

function editGrade(id) {
  openModal('grade', id);
}

// ============================================
// FONCTIONS DE R√âACTIVATION
// ============================================
async function reactivateProgramme(id) {
  if (!confirm('‚úÖ R√©activer ce programme ?\n\nIl redeviendra visible et utilisable.')) return;
  await reactivateItem('programme', id);
}

async function reactivateDirection(id) {
  if (!confirm('‚úÖ R√©activer cette direction ?\n\nElle redeviendra visible et utilisable.')) return;
  await reactivateItem('direction', id);
}

async function reactivateService(id) {
  if (!confirm('‚úÖ R√©activer ce service ?\n\nIl redeviendra visible et utilisable.')) return;
  await reactivateItem('service', id);
}

async function reactivateGrade(id) {
  if (!confirm('‚úÖ R√©activer ce grade ?\n\nIl redeviendra visible et utilisable.')) return;
  await reactivateItem('grade', id);
}

async function reactivateItem(type, id) {
  showGlobalLoading('R√©activation...', 'Veuillez patienter');
  
  // Construire l'URL avec url_for selon le type
  let url;
  switch(type) {
    case 'programme':
      url = "{{ url_for('api_reactivate_programme', programme_id=0) }}".replace('/0', `/${id}`);
      break;
    case 'direction':
      url = "{{ url_for('api_reactivate_direction', direction_id=0) }}".replace('/0', `/${id}`);
      break;
    case 'service':
      url = "{{ url_for('api_reactivate_service', service_id=0) }}".replace('/0', `/${id}`);
      break;
    case 'grade':
      url = "{{ url_for('api_reactivate_grade', grade_id=0) }}".replace('/0', `/${id}`);
      break;
  }
  
  try {
    const response = await fetch(url, {
      method: 'POST'
    });
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      showGlobalLoading('‚úÖ R√©activ√©', 'Actualisation des donn√©es...');
      
      // Recharger uniquement les donn√©es de la table concern√©e
      await reloadTableData(type);
      
      hideGlobalLoading();
      showSuccess(result.message || 'R√©activ√© avec succ√®s');
    } else {
      hideGlobalLoading();
      await handleFetchError(response, 'Erreur lors de la r√©activation');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur r√©seau. V√©rifiez votre connexion.');
  }
}

// ============================================
// FONCTIONS DE D√âSACTIVATION (Soft Delete)
// ============================================
async function deactivateProgramme(id) {
  if (!confirm('‚ö†Ô∏è D√©sactiver ce programme ?\n\nIl sera masqu√© mais restera en base de donn√©es.')) return;
  await deactivateItem('programme', id);
}

async function deactivateDirection(id) {
  if (!confirm('‚ö†Ô∏è D√©sactiver cette direction ?\n\nElle sera masqu√©e mais restera en base de donn√©es.')) return;
  await deactivateItem('direction', id);
}

async function deactivateService(id) {
  if (!confirm('‚ö†Ô∏è D√©sactiver ce service ?\n\nIl sera masqu√© mais restera en base de donn√©es.')) return;
  await deactivateItem('service', id);
}

async function deactivateGrade(id) {
  if (!confirm('‚ö†Ô∏è D√©sactiver ce grade ?\n\nIl sera masqu√© mais restera en base de donn√©es.')) return;
  await deactivateItem('grade', id);
}

async function deactivateItem(type, id) {
  showGlobalLoading('D√©sactivation...', 'Veuillez patienter');
  
  // Construire l'URL avec url_for selon le type
  let url;
  switch(type) {
    case 'programme':
      url = "{{ url_for('api_delete_programme', programme_id=0) }}".replace('/0', `/${id}`);
      break;
    case 'direction':
      url = "{{ url_for('api_delete_direction', direction_id=0) }}".replace('/0', `/${id}`);
      break;
    case 'service':
      url = "{{ url_for('api_delete_service', service_id=0) }}".replace('/0', `/${id}`);
      break;
    case 'grade':
      url = "{{ url_for('api_delete_grade', grade_id=0) }}".replace('/0', `/${id}`);
      break;
    case 'categorie':
      url = "{{ url_for('api_delete_categorie', categorie_id=0) }}".replace('/0', `/${id}`);
      break;
  }
  
  try {
    const response = await fetch(url, {
      method: 'DELETE'  // Soft delete par d√©faut (hard_delete=false)
    });
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      showGlobalLoading('‚úÖ D√©sactiv√©', 'Actualisation des donn√©es...');
      
      // Recharger uniquement les donn√©es de la table concern√©e
      await reloadTableData(type);
      
      hideGlobalLoading();
      showSuccess(result.message || 'D√©sactiv√© avec succ√®s');
    } else {
      hideGlobalLoading();
      await handleFetchError(response, 'Erreur lors de la d√©sactivation');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur r√©seau. V√©rifiez votre connexion.');
  }
}

// ============================================
// FONCTIONS DE SUPPRESSION (Hard Delete)
// ============================================
async function deleteProgramme(id) {
  if (!confirm('üóëÔ∏è SUPPRIMER D√âFINITIVEMENT ce programme ?\n\n‚ö†Ô∏è ATTENTION : Cette action est IRR√âVERSIBLE !\nToutes les donn√©es seront perdues.\n\nPr√©f√©rez "D√©sactiver" pour une suppression r√©versible.')) return;
  await deleteItem('programme', id);
}

async function deleteDirection(id) {
  if (!confirm('üóëÔ∏è SUPPRIMER D√âFINITIVEMENT cette direction ?\n\n‚ö†Ô∏è ATTENTION : Cette action est IRR√âVERSIBLE !\nToutes les donn√©es seront perdues.\n\nPr√©f√©rez "D√©sactiver" pour une suppression r√©versible.')) return;
  await deleteItem('direction', id);
}

async function deleteService(id) {
  if (!confirm('üóëÔ∏è SUPPRIMER D√âFINITIVEMENT ce service ?\n\n‚ö†Ô∏è ATTENTION : Cette action est IRR√âVERSIBLE !\nToutes les donn√©es seront perdues.\n\nPr√©f√©rez "D√©sactiver" pour une suppression r√©versible.')) return;
  await deleteItem('service', id);
}

async function deleteGrade(id) {
  if (!confirm('üóëÔ∏è SUPPRIMER D√âFINITIVEMENT ce grade ?\n\n‚ö†Ô∏è ATTENTION : Cette action est IRR√âVERSIBLE !\nToutes les donn√©es seront perdues.\n\nPr√©f√©rez "D√©sactiver" pour une suppression r√©versible.')) return;
  await deleteItem('grade', id);
}

async function deleteItem(type, id) {
  showGlobalLoading('Suppression...', 'Suppression d√©finitive en cours');
  
  // Construire l'URL avec url_for selon le type (avec hard_delete=true)
  let url;
  switch(type) {
    case 'programme':
      url = "{{ url_for('api_delete_programme', programme_id=0) }}".replace('/0', `/${id}`) + '?hard_delete=true';
      break;
    case 'direction':
      url = "{{ url_for('api_delete_direction', direction_id=0) }}".replace('/0', `/${id}`) + '?hard_delete=true';
      break;
    case 'service':
      url = "{{ url_for('api_delete_service', service_id=0) }}".replace('/0', `/${id}`) + '?hard_delete=true';
      break;
    case 'grade':
      url = "{{ url_for('api_delete_grade', grade_id=0) }}".replace('/0', `/${id}`) + '?hard_delete=true';
      break;
    case 'categorie':
      url = "{{ url_for('api_delete_categorie', categorie_id=0) }}".replace('/0', `/${id}`);
      break;
  }
  
  try {
    const response = await fetch(url, {
      method: 'DELETE'  // Hard delete avec param√®tre
    });
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      showGlobalLoading('‚úÖ Supprim√©', 'Actualisation des donn√©es...');
      
      // Recharger uniquement les donn√©es de la table concern√©e
      await reloadTableData(type);
      
      hideGlobalLoading();
      showSuccess(result.message || 'Supprim√© avec succ√®s');
    } else {
      hideGlobalLoading();
      await handleFetchError(response, 'Erreur lors de la suppression');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur r√©seau. V√©rifiez votre connexion.');
  }
}
</script>
</body>
{% endblock %}

