{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}Gestion des R√©f√©rentiels - {{ app_name }}{% endblock %}

{% block content %}
{{ page_header(
    title='‚öôÔ∏è Gestion des R√©f√©rentiels',
    breadcrumbs=[
        {'name': 'Accueil', 'url': url_for('accueil')},
        {'name': 'R√©f√©rentiels'}
    ],
    actions=[
        {'label': '‚Üê Retour Accueil', 'url': url_for('accueil'), 'primary': False}
    ]
) }}

<div class="page-grid">

  <!-- Statistiques -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Programmes</div>
      <div class="stat-number">{{ nb_programmes }}</div>
    </div>
    
    <div class="stat-card success">
      <div class="stat-label">Directions</div>
      <div class="stat-number">{{ nb_directions }}</div>
    </div>
    
    <div class="stat-card secondary">
      <div class="stat-label">Services</div>
      <div class="stat-number">{{ nb_services }}</div>
    </div>
    
    <div class="stat-card warning">
      <div class="stat-label">Grades</div>
      <div class="stat-number">{{ nb_grades }}</div>
    </div>
  </div>

  <!-- Onglets -->
  <div class="card">
    <div class="tabs">
      <button class="tab active" onclick="switchTab('programmes')">üìÅ Programmes</button>
      <button class="tab" onclick="switchTab('directions')">üè¢ Directions</button>
      <button class="tab" onclick="switchTab('services')">üìã Services</button>
      <button class="tab" onclick="switchTab('grades')">üéì Grades</button>
    </div>

    <!-- TAB PROGRAMMES -->
    <div id="tab-programmes" class="tab-content active">
      <div class="table-header">
        <h3>üìÅ Programmes Budg√©taires</h3>
        <button class="btn btn-primary" onclick="openModal('programme')">‚ûï Nouveau Programme</button>
      </div>
      
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>Code</th>
              <th>Libell√©</th>
              <th>Description</th>
              <th>Statut</th>
              <th style="text-align: center;">Actions</th>
            </tr>
          </thead>
          <tbody id="programmes-tbody">
            <tr><td colspan="5" style="text-align: center; padding: 2rem;">‚è≥ Chargement...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- TAB DIRECTIONS -->
    <div id="tab-directions" class="tab-content">
      <div class="table-header">
        <h3>üè¢ Directions</h3>
        <button class="btn btn-primary" onclick="openModal('direction')">‚ûï Nouvelle Direction</button>
      </div>
      
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>Code</th>
              <th>Libell√©</th>
              <th>Programme</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="directions-tbody">
            <tr><td colspan="5" style="text-align: center; padding: 2rem;">‚è≥ Chargement...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- TAB SERVICES -->
    <div id="tab-services" class="tab-content">
      <div class="table-header">
        <h3>üìã Services</h3>
        <button class="btn btn-primary" onclick="openModal('service')">‚ûï Nouveau Service</button>
      </div>
      
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>Code</th>
              <th>Libell√©</th>
              <th>Direction</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="services-tbody">
            <tr><td colspan="5" style="text-align: center; padding: 2rem;">‚è≥ Chargement...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- TAB GRADES -->
    <div id="tab-grades" class="tab-content">
      <div class="table-header">
        <h3>üéì Grades</h3>
        <button class="btn btn-primary" onclick="openModal('grade')">‚ûï Nouveau Grade</button>
      </div>
      
      <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>Code</th>
              <th>Libell√©</th>
              <th>Cat√©gorie</th>
              <th>√âchelons</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="grades-tbody">
            <tr><td colspan="6" style="text-align: center; padding: 2rem;">‚è≥ Chargement...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- Modal CRUD -->
<div id="crudModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modal-title">Titre</h2>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    
    <form id="crudForm" onsubmit="handleSubmit(event)">
      <div class="form-grid" id="modal-form-content">
        <!-- Contenu dynamique -->
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block styles %}
<style>
/* Styles sp√©cifiques pour la page R√©f√©rentiels */
.page-grid {
    max-width: 1400px;
    margin: 0 auto;
    padding: 1rem;
}

/* Tabs */
.tabs {
    display: flex;
    gap: 0.5rem;
    border-bottom: 2px solid var(--gray-200);
    margin-bottom: 2rem;
}

.tab {
    padding: 1rem 1.5rem;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-weight: 600;
    color: var(--gray-600);
    transition: all 0.3s;
}

.tab:hover {
    color: var(--primary-color);
}

.tab.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
}

/* Tab content */
.tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
}

.tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Table header */
.table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.table-header h3 {
    margin: 0;
    color: var(--secondary-color);
    font-size: 1.3rem;
}

/* Action icons dans les tables */
.action-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    margin: 0 0.25rem;
    border: none;
    background: var(--gray-200);
}

.action-icon:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.action-icon.edit {
    background: var(--primary-color);
    color: var(--white-color);
}

.action-icon.deactivate {
    background: var(--warning-color);
    color: var(--white-color);
}

.action-icon.reactivate {
    background: var(--success-color);
    color: var(--white-color);
}

.action-icon.delete {
    background: var(--danger-color);
    color: var(--white-color);
}

/* Form grid pour modals */
.modal .form-grid {
    grid-template-columns: 1fr !important;
    gap: 1rem;
}

@media (max-width: 768px) {
    .tabs {
        flex-wrap: wrap;
    }
    
    .table-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .table-header .btn {
        width: 100%;
    }
}

/* Action buttons spacing */
.action-buttons {
  display: flex;
  gap: 0.5rem;
  flex-wrap: nowrap;
  justify-content: center;
  align-items: center;
}

.action-buttons .btn {
  min-width: 40px;
  display: inline-flex;
  justify-content: center;
  align-items: center;
}

/* √âlargir la colonne Actions */
.data-table th:last-child,
.data-table td:last-child {
  min-width: 200px;
  text-align: center;
}
</style>
{% endblock %}

{% block scripts %}
<script>
let currentType = '';
let editingId = null;

// Charger les donn√©es au d√©marrage
document.addEventListener('DOMContentLoaded', function() {
  loadProgrammes();
  loadDirections();
  loadServices();
  loadGrades();
});

// ============================================
// GESTION DES ONGLETS
// ============================================
function switchTab(tabName) {
  // D√©sactiver tous les onglets
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  
  // Activer l'onglet s√©lectionn√©
  event.target.classList.add('active');
  document.getElementById(`tab-${tabName}`).classList.add('active');
}

// ============================================
// CHARGEMENT DES DONN√âES
// ============================================

// Fonction helper pour recharger les donn√©es d'une table
async function reloadTableData(type) {
  switch(type) {
    case 'programme':
      await loadProgrammes();
      break;
    case 'direction':
      await loadDirections();
      break;
    case 'service':
      await loadServices();
      break;
    case 'grade':
      await loadGrades();
      break;
  }
}

async function loadProgrammes() {
  const response = await fetch("{{ url_for('api_list_programmes_ref') }}");
  const programmes = await response.json();
  
  const tbody = document.getElementById('programmes-tbody');
  
  // Si aucun programme, afficher le message vide
  if (programmes.length === 0) {
    tbody.innerHTML = `
      <tr class="empty-state">
        <td colspan="5" style="text-align: center; padding: 3rem; color: var(--gray-600);">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üìÅ</div>
          <div style="font-size: 1.1rem; font-weight: 500; margin-bottom: 0.5rem;">Aucun programme enregistr√©</div>
          <div style="font-size: 0.9rem; color: var(--gray-500);">
            Cliquez sur "‚ûï Nouveau Programme" pour cr√©er votre premier programme budg√©taire
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  tbody.innerHTML = programmes.map(p => `
    <tr>
      <td><strong>${p.code}</strong></td>
      <td>${p.libelle}</td>
      <td>${p.description || '-'}</td>
      <td>
        <span class="badge ${p.actif ? 'badge-success' : 'badge-danger'}">
          ${p.actif ? 'Actif' : 'Inactif'}
        </span>
      </td>
      <td>
        <div class="action-buttons">
          <button class="btn btn-sm btn-primary" onclick="openModal('programme', ${p.id})" title="Modifier">
            ‚úèÔ∏è
          </button>
          ${!p.actif ? `
            <button class="btn btn-sm btn-success" onclick="reactivateItem('programme', ${p.id})" title="R√©activer">
              ‚è∏Ô∏è
            </button>
          ` : `
            <button class="btn btn-sm btn-warning" onclick="deactivateItem('programme', ${p.id})" title="D√©sactiver">
              ‚Ü©Ô∏è
            </button>
          `}
          <button class="btn btn-sm btn-danger" onclick="deleteItem('programme', ${p.id})" title="Supprimer d√©finitivement">
            üóëÔ∏è
          </button>
        </div>
      </td>
    </tr>
  `).join('');
}

async function loadDirections() {
  const response = await fetch("{{ url_for('api_list_directions_ref') }}");
  const directions = await response.json();
  
  const tbody = document.getElementById('directions-tbody');
  
  // Si aucune direction, afficher le message vide
  if (directions.length === 0) {
    tbody.innerHTML = `
      <tr class="empty-state">
        <td colspan="5" style="text-align: center; padding: 3rem; color: var(--gray-600);">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üè¢</div>
          <div style="font-size: 1.1rem; font-weight: 500; margin-bottom: 0.5rem;">Aucune direction enregistr√©e</div>
          <div style="font-size: 0.9rem; color: var(--gray-500);">
            Cliquez sur "‚ûï Nouvelle Direction" pour cr√©er votre premi√®re direction
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  tbody.innerHTML = directions.map(d => `
      <tr>
        <td><strong>${d.code}</strong></td>
        <td>${d.libelle}</td>
        <td>${d.programme_libelle || '-'}</td>
        <td>
          <span class="badge ${d.actif ? 'badge-success' : 'badge-danger'}">
            ${d.actif ? 'Actif' : 'Inactif'}
          </span>
        </td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-sm btn-primary" onclick="openModal('direction', ${d.id})" title="Modifier">
              ‚úèÔ∏è
            </button>
            ${!d.actif ? `
              <button class="btn btn-sm btn-success" onclick="reactivateItem('direction', ${d.id})" title="R√©activer">
                ‚è∏Ô∏è
              </button>
            ` : `
              <button class="btn btn-sm btn-warning" onclick="deactivateItem('direction', ${d.id})" title="D√©sactiver">
                ‚Ü©Ô∏è
              </button>
            `}
            <button class="btn btn-sm btn-danger" onclick="deleteItem('direction', ${d.id})" title="Supprimer d√©finitivement">
              üóëÔ∏è
            </button>
          </div>
        </td>
      </tr>
  `).join('');
}

async function loadServices() {
  const response = await fetch("{{ url_for('api_list_services_ref') }}" + "?_=" + Date.now(), {
    cache: 'no-cache',
    headers: {
      'Cache-Control': 'no-cache',
      'Pragma': 'no-cache'
    }
  });
  const services = await response.json();
  
  const tbody = document.getElementById('services-tbody');
  
  // Si aucun service, afficher le message vide
  if (services.length === 0) {
    tbody.innerHTML = `
      <tr class="empty-state">
        <td colspan="5" style="text-align: center; padding: 3rem; color: var(--gray-600);">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
          <div style="font-size: 1.1rem; font-weight: 500; margin-bottom: 0.5rem;">Aucun service enregistr√©</div>
          <div style="font-size: 0.9rem; color: var(--gray-500);">
            Cliquez sur "‚ûï Nouveau Service" pour cr√©er votre premier service
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  tbody.innerHTML = services.map(s => `
      <tr>
        <td><strong>${s.code}</strong></td>
        <td>${s.libelle}</td>
        <td>${s.direction_libelle || '-'}</td>
        <td>
          <span class="badge ${s.actif ? 'badge-success' : 'badge-danger'}">
            ${s.actif ? 'Actif' : 'Inactif'}
          </span>
        </td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-sm btn-primary" onclick="openModal('service', ${s.id})" title="Modifier">
              ‚úèÔ∏è
            </button>
            ${!s.actif ? `
              <button class="btn btn-sm btn-success" onclick="reactivateItem('service', ${s.id})" title="R√©activer">
                ‚è∏Ô∏è
              </button>
            ` : `
              <button class="btn btn-sm btn-warning" onclick="deactivateItem('service', ${s.id})" title="D√©sactiver">
                ‚Ü©Ô∏è
              </button>
            `}
            <button class="btn btn-sm btn-danger" onclick="deleteItem('service', ${s.id})" title="Supprimer d√©finitivement">
              üóëÔ∏è
            </button>
          </div>
      </td>
    </tr>
  `).join('');
}

async function loadGrades() {
  const response = await fetch("{{ url_for('api_list_grades_ref') }}");
  const grades = await response.json();
  
  const tbody = document.getElementById('grades-tbody');
  
  // Si aucun grade, afficher le message vide
  if (grades.length === 0) {
    tbody.innerHTML = `
      <tr class="empty-state">
        <td colspan="6" style="text-align: center; padding: 3rem; color: var(--gray-600);">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üéì</div>
          <div style="font-size: 1.1rem; font-weight: 500; margin-bottom: 0.5rem;">Aucun grade enregistr√©</div>
          <div style="font-size: 0.9rem; color: var(--gray-500);">
            Cliquez sur "‚ûï Nouveau Grade" pour cr√©er votre premier grade de la fonction publique
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  tbody.innerHTML = grades.map(g => `
    <tr>
      <td><strong>${g.code}</strong></td>
      <td>${g.libelle}</td>
      <td><span class="badge badge-info">${g.categorie}</span></td>
      <td>${g.echelon_min} - ${g.echelon_max}</td>
      <td>
        <span class="badge ${g.actif ? 'badge-success' : 'badge-danger'}">
          ${g.actif ? 'Actif' : 'Inactif'}
        </span>
      </td>
      <td>
        <div class="action-buttons">
          <button class="btn btn-sm btn-primary" onclick="openModal('grade', ${g.id})" title="Modifier">
            ‚úèÔ∏è
          </button>
          ${!g.actif ? `
            <button class="btn btn-sm btn-success" onclick="reactivateItem('grade', ${g.id})" title="R√©activer">
              ‚Ü©Ô∏è
            </button>
          ` : `
            <button class="btn btn-sm btn-warning" onclick="deactivateItem('grade', ${g.id})" title="D√©sactiver">
              ‚è∏Ô∏è
            </button>
          `}
          <button class="btn btn-sm btn-danger" onclick="deleteItem('grade', ${g.id})" title="Supprimer d√©finitivement">
            üóëÔ∏è
          </button>
        </div>
      </td>
    </tr>
  `).join('');
}

// ============================================
// MODAL
// ============================================
function openModal(type, id = null) {
  currentType = type;
  editingId = id;
  
  const modal = document.getElementById('crudModal');
  const title = document.getElementById('modal-title');
  const formContent = document.getElementById('modal-form-content');
  
  // D√©finir le titre
  const titles = {
    'programme': id ? 'Modifier Programme' : 'Nouveau Programme',
    'direction': id ? 'Modifier Direction' : 'Nouvelle Direction',
    'service': id ? 'Modifier Service' : 'Nouveau Service',
    'grade': id ? 'Modifier Grade' : 'Nouveau Grade'
  };
  title.textContent = titles[type];
  
  // G√©n√©rer le formulaire selon le type
  if (type === 'programme') {
    formContent.innerHTML = `
      <div class="form-group">
        <label>Code *</label>
        <input type="text" name="code" id="field-code" required placeholder="Ex: P01">
      </div>
      <div class="form-group">
        <label>Libell√© *</label>
        <input type="text" name="libelle" id="field-libelle" required placeholder="Ex: Pilotage">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea name="description" id="field-description" rows="3"></textarea>
      </div>
      ${id ? '<input type="hidden" name="actif" id="field-actif" value="true">' : ''}
    `;
  } else if (type === 'direction') {
    formContent.innerHTML = `
      <div class="form-group">
        <label>Code *</label>
        <input type="text" name="code" id="field-code" required placeholder="Ex: DAF">
      </div>
      <div class="form-group">
        <label>Libell√© *</label>
        <input type="text" name="libelle" id="field-libelle" required placeholder="Ex: Direction Administrative">
      </div>
      <div class="form-group">
        <label>Programme</label>
        <select name="programme_id" id="field-programme_id">
          <option value="">-- Aucun --</option>
          {% for prog in programmes %}
          <option value="{{ prog.id }}">{{ prog.code }} - {{ prog.libelle }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea name="description" id="field-description" rows="3"></textarea>
      </div>
      ${id ? '<input type="hidden" name="actif" id="field-actif" value="true">' : ''}
    `;
  } else if (type === 'service') {
    formContent.innerHTML = `
      <div class="form-group">
        <label>Code *</label>
        <input type="text" name="code" id="field-code" required placeholder="Ex: SCPT">
      </div>
      <div class="form-group">
        <label>Libell√© *</label>
        <input type="text" name="libelle" id="field-libelle" required placeholder="Ex: Service Comptabilit√©">
      </div>
      <div class="form-group">
        <label>Direction</label>
        <select name="direction_id" id="field-direction_id">
          <option value="">-- Aucune --</option>
          {% for dir in directions %}
          <option value="{{ dir.id }}">{{ dir.code }} - {{ dir.libelle }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea name="description" id="field-description" rows="3"></textarea>
      </div>
      ${id ? '<input type="hidden" name="actif" id="field-actif" value="true">' : ''}
    `;
  } else if (type === 'grade') {
    formContent.innerHTML = `
      <div class="form-group">
        <label>Code *</label>
        <input type="text" name="code" id="field-code" required placeholder="Ex: A1">
      </div>
      <div class="form-group">
        <label>Libell√© *</label>
        <input type="text" name="libelle" id="field-libelle" required placeholder="Ex: Administrateur Civil">
      </div>
      <div class="form-group">
        <label>Cat√©gorie *</label>
        <select name="categorie" id="field-categorie" required>
          <option value="A">A - Cadres sup√©rieurs</option>
          <option value="B">B - Cadres moyens</option>
          <option value="C">C - Agents d'ex√©cution</option>
          <option value="D">D - Personnel de soutien</option>
        </select>
      </div>
      <div class="form-group">
        <label>√âchelon Min *</label>
        <input type="number" name="echelon_min" id="field-echelon_min" required value="1" min="1">
      </div>
      <div class="form-group">
        <label>√âchelon Max *</label>
        <input type="number" name="echelon_max" id="field-echelon_max" required value="5" min="1">
      </div>
      ${id ? '<input type="hidden" name="actif" id="field-actif" value="true">' : ''}
    `;
  }
  
  // Si √©dition, charger les donn√©es
  if (id) {
    loadFormData(type, id);
  }
  
  modal.classList.add('show');
}

function closeModal() {
  const modal = document.getElementById('crudModal');
  modal.classList.remove('show');
  document.getElementById('crudForm').reset();
  editingId = null;
}

async function loadFormData(type, id) {
  const response = await fetch(`/api/v1/referentiels/api/${type}s`);
  const items = await response.json();
  const item = items.find(i => i.id === id);
  
  if (item) {
    Object.keys(item).forEach(key => {
      const field = document.getElementById(`field-${key}`);
      if (field) {
        field.value = item[key] || '';
      }
    });
  }
}

// ============================================
// SOUMISSION DU FORMULAIRE
// ============================================
async function handleSubmit(event) {
  event.preventDefault();
  
  showGlobalLoading('Enregistrement...', 'Veuillez patienter');
  
  const formData = new FormData(event.target);
  // Construire l'URL avec url_for selon le type
  let url;
  if (editingId && editingId !== null && editingId !== 'null') {
    // Modification
    switch(currentType) {
      case 'programme':
        url = "{{ url_for('api_update_programme', programme_id=0) }}".replace('/0', `/${editingId}`);
        break;
      case 'direction':
        url = "{{ url_for('api_update_direction', direction_id=0) }}".replace('/0', `/${editingId}`);
        break;
      case 'service':
        url = "{{ url_for('api_update_service', service_id=0) }}".replace('/0', `/${editingId}`);
        break;
      case 'grade':
        url = "{{ url_for('api_update_grade', grade_id=0) }}".replace('/0', `/${editingId}`);
        break;
    }
  } else {
    // Cr√©ation
    switch(currentType) {
      case 'programme':
        url = "{{ url_for('api_create_programme') }}";
        break;
      case 'direction':
        url = "{{ url_for('api_create_direction') }}";
        break;
      case 'service':
        url = "{{ url_for('api_create_service') }}";
        break;
      case 'grade':
        url = "{{ url_for('api_create_grade') }}";
        break;
    }
  }
  
  try {
    const response = await fetch(url, {
      method: editingId ? 'PUT' : 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      closeModal();
      showGlobalLoading('‚úÖ Enregistr√©', 'Actualisation des donn√©es...');
      
      // Recharger uniquement les donn√©es de la table concern√©e
      switch(currentType) {
        case 'programme':
          await loadProgrammes();
          break;
        case 'direction':
          await loadDirections();
          break;
        case 'service':
          await loadServices();
          break;
        case 'grade':
          await loadGrades();
          break;
      }
      
      hideGlobalLoading();
      showSuccess(result.message || 'Enregistr√© avec succ√®s');
    } else {
      hideGlobalLoading();
      await handleFetchError(response, 'Erreur lors de l\'enregistrement');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur r√©seau. V√©rifiez votre connexion.');
  }
}

// ============================================
// FONCTIONS D'√âDITION
// ============================================
function editProgramme(id) {
  openModal('programme', id);
}

function editDirection(id) {
  openModal('direction', id);
}

function editService(id) {
  openModal('service', id);
}

function editGrade(id) {
  openModal('grade', id);
}

// ============================================
// FONCTIONS DE R√âACTIVATION
// ============================================
async function reactivateProgramme(id) {
  if (!confirm('‚úÖ R√©activer ce programme ?\n\nIl redeviendra visible et utilisable.')) return;
  await reactivateItem('programme', id);
}

async function reactivateDirection(id) {
  if (!confirm('‚úÖ R√©activer cette direction ?\n\nElle redeviendra visible et utilisable.')) return;
  await reactivateItem('direction', id);
}

async function reactivateService(id) {
  if (!confirm('‚úÖ R√©activer ce service ?\n\nIl redeviendra visible et utilisable.')) return;
  await reactivateItem('service', id);
}

async function reactivateGrade(id) {
  if (!confirm('‚úÖ R√©activer ce grade ?\n\nIl redeviendra visible et utilisable.')) return;
  await reactivateItem('grade', id);
}

async function reactivateItem(type, id) {
  showGlobalLoading('R√©activation...', 'Veuillez patienter');
  
  // Construire l'URL avec url_for selon le type
  let url;
  switch(type) {
    case 'programme':
      url = "{{ url_for('api_reactivate_programme', programme_id=0) }}".replace('/0', `/${id}`);
      break;
    case 'direction':
      url = "{{ url_for('api_reactivate_direction', direction_id=0) }}".replace('/0', `/${id}`);
      break;
    case 'service':
      url = "{{ url_for('api_reactivate_service', service_id=0) }}".replace('/0', `/${id}`);
      break;
    case 'grade':
      url = "{{ url_for('api_reactivate_grade', grade_id=0) }}".replace('/0', `/${id}`);
      break;
  }
  
  try {
    const response = await fetch(url, {
      method: 'POST'
    });
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      showGlobalLoading('‚úÖ R√©activ√©', 'Actualisation des donn√©es...');
      
      // Recharger uniquement les donn√©es de la table concern√©e
      await reloadTableData(type);
      
      hideGlobalLoading();
      showSuccess(result.message || 'R√©activ√© avec succ√®s');
    } else {
      hideGlobalLoading();
      await handleFetchError(response, 'Erreur lors de la r√©activation');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur r√©seau. V√©rifiez votre connexion.');
  }
}

// ============================================
// FONCTIONS DE D√âSACTIVATION (Soft Delete)
// ============================================
async function deactivateProgramme(id) {
  if (!confirm('‚ö†Ô∏è D√©sactiver ce programme ?\n\nIl sera masqu√© mais restera en base de donn√©es.')) return;
  await deactivateItem('programme', id);
}

async function deactivateDirection(id) {
  if (!confirm('‚ö†Ô∏è D√©sactiver cette direction ?\n\nElle sera masqu√©e mais restera en base de donn√©es.')) return;
  await deactivateItem('direction', id);
}

async function deactivateService(id) {
  if (!confirm('‚ö†Ô∏è D√©sactiver ce service ?\n\nIl sera masqu√© mais restera en base de donn√©es.')) return;
  await deactivateItem('service', id);
}

async function deactivateGrade(id) {
  if (!confirm('‚ö†Ô∏è D√©sactiver ce grade ?\n\nIl sera masqu√© mais restera en base de donn√©es.')) return;
  await deactivateItem('grade', id);
}

async function deactivateItem(type, id) {
  showGlobalLoading('D√©sactivation...', 'Veuillez patienter');
  
  // Construire l'URL avec url_for selon le type
  let url;
  switch(type) {
    case 'programme':
      url = "{{ url_for('api_delete_programme', programme_id=0) }}".replace('/0', `/${id}`);
      break;
    case 'direction':
      url = "{{ url_for('api_delete_direction', direction_id=0) }}".replace('/0', `/${id}`);
      break;
    case 'service':
      url = "{{ url_for('api_delete_service', service_id=0) }}".replace('/0', `/${id}`);
      break;
    case 'grade':
      url = "{{ url_for('api_delete_grade', grade_id=0) }}".replace('/0', `/${id}`);
      break;
  }
  
  try {
    const response = await fetch(url, {
      method: 'DELETE'  // Soft delete par d√©faut (hard_delete=false)
    });
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      showGlobalLoading('‚úÖ D√©sactiv√©', 'Actualisation des donn√©es...');
      
      // Recharger uniquement les donn√©es de la table concern√©e
      await reloadTableData(type);
      
      hideGlobalLoading();
      showSuccess(result.message || 'D√©sactiv√© avec succ√®s');
    } else {
      hideGlobalLoading();
      await handleFetchError(response, 'Erreur lors de la d√©sactivation');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur r√©seau. V√©rifiez votre connexion.');
  }
}

// ============================================
// FONCTIONS DE SUPPRESSION (Hard Delete)
// ============================================
async function deleteProgramme(id) {
  if (!confirm('üóëÔ∏è SUPPRIMER D√âFINITIVEMENT ce programme ?\n\n‚ö†Ô∏è ATTENTION : Cette action est IRR√âVERSIBLE !\nToutes les donn√©es seront perdues.\n\nPr√©f√©rez "D√©sactiver" pour une suppression r√©versible.')) return;
  await deleteItem('programme', id);
}

async function deleteDirection(id) {
  if (!confirm('üóëÔ∏è SUPPRIMER D√âFINITIVEMENT cette direction ?\n\n‚ö†Ô∏è ATTENTION : Cette action est IRR√âVERSIBLE !\nToutes les donn√©es seront perdues.\n\nPr√©f√©rez "D√©sactiver" pour une suppression r√©versible.')) return;
  await deleteItem('direction', id);
}

async function deleteService(id) {
  if (!confirm('üóëÔ∏è SUPPRIMER D√âFINITIVEMENT ce service ?\n\n‚ö†Ô∏è ATTENTION : Cette action est IRR√âVERSIBLE !\nToutes les donn√©es seront perdues.\n\nPr√©f√©rez "D√©sactiver" pour une suppression r√©versible.')) return;
  await deleteItem('service', id);
}

async function deleteGrade(id) {
  if (!confirm('üóëÔ∏è SUPPRIMER D√âFINITIVEMENT ce grade ?\n\n‚ö†Ô∏è ATTENTION : Cette action est IRR√âVERSIBLE !\nToutes les donn√©es seront perdues.\n\nPr√©f√©rez "D√©sactiver" pour une suppression r√©versible.')) return;
  await deleteItem('grade', id);
}

async function deleteItem(type, id) {
  showGlobalLoading('Suppression...', 'Suppression d√©finitive en cours');
  
  // Construire l'URL avec url_for selon le type (avec hard_delete=true)
  let url;
  switch(type) {
    case 'programme':
      url = "{{ url_for('api_delete_programme', programme_id=0) }}".replace('/0', `/${id}`) + '?hard_delete=true';
      break;
    case 'direction':
      url = "{{ url_for('api_delete_direction', direction_id=0) }}".replace('/0', `/${id}`) + '?hard_delete=true';
      break;
    case 'service':
      url = "{{ url_for('api_delete_service', service_id=0) }}".replace('/0', `/${id}`) + '?hard_delete=true';
      break;
    case 'grade':
      url = "{{ url_for('api_delete_grade', grade_id=0) }}".replace('/0', `/${id}`) + '?hard_delete=true';
      break;
  }
  
  try {
    const response = await fetch(url, {
      method: 'DELETE'  // Hard delete avec param√®tre
    });
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      showGlobalLoading('‚úÖ Supprim√©', 'Actualisation des donn√©es...');
      
      // Recharger uniquement les donn√©es de la table concern√©e
      await reloadTableData(type);
      
      hideGlobalLoading();
      showSuccess(result.message || 'Supprim√© avec succ√®s');
    } else {
      hideGlobalLoading();
      await handleFetchError(response, 'Erreur lors de la suppression');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur r√©seau. V√©rifiez votre connexion.');
  }
}
</script>
</body>
{% endblock %}

