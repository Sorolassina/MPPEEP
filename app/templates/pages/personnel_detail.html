{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}{{ agent.prenom }} {{ agent.nom }} - {{ app_name }}
{% endblock %}

{% block styles %}{% endblock %}

{% block content %}
{{ page_header(
    title='ğŸ‘¤ ' + agent.prenom + ' ' + agent.nom + ' - ' + agent.matricule,
    breadcrumbs=[
        {'name': 'Accueil', 'url': url_for('accueil')},
        {'name': 'RH', 'url': url_for('rh_home')},
        {'name': 'Personnel', 'url': url_for('personnel_home')},
        {'name': agent.matricule}
    ],
    actions=[
        {'label': 'â† Retour Personnel', 'url': url_for('personnel_home'), 'primary': False},
        {'label': 'âœï¸ Modifier', 'url': url_for('personnel_edit', agent_id=agent.id), 'primary': True}
    ]
) }}

<div class="personnel-detail-page" data-agent-actif="{{ 1 if agent.actif else 0 }}">
  
  <section class="profile-summary">
    <div class="profile-header">
      <div class="profile-identity">
        <div class="profile-photo">
          <img src="{{ profile_picture_url(agent) }}" alt="{{ agent.prenom }} {{ agent.nom }}">
        </div>
        <div class="profile-main">
          <h1>{{ agent.prenom }} {{ agent.nom }}</h1>
          <p class="profile-matricule">Matricule â€¢ <strong>{{ agent.matricule }}</strong></p>
          <ul class="profile-meta">
            {% if grade %}
            <li>ğŸ“ {{ grade.libelle }} ({{ grade.code }})</li>
            {% endif %}
            {% if service %}
            <li>ğŸ“ {{ service.libelle }}</li>
            {% endif %}
            {% if agent.fonction %}
            <li>ğŸ’¼ {{ agent.fonction }}</li>
            {% endif %}
          </ul>
        </div>
      </div>
      <div class="profile-status">
        <span class="badge badge-{{ 'success' if agent.actif else 'danger' }}">{{ 'âœ… Actif' if agent.actif else 'âŒ Inactif' }}</span>
        <span class="badge badge-info">{{ agent.position_administrative or 'En service' }}</span>
      </div>
    </div>
  </section>

  <!-- Informations personnelles -->
  <section class="info-section">
    <header class="section-header">
      <div class="section-icon">ğŸ‘¤</div>
      <div>
        <h2>Informations personnelles</h2>
        <p>IdentitÃ©, Ã©tat civil et contact</p>
      </div>
    </header>

    <div class="info-panel-grid">
      <article class="info-panel">
        <div class="info-panel-icon">ğŸ‚</div>
        <div class="info-panel-body">
          <span class="info-panel-label">Date de naissance</span>
          <span class="info-panel-value">{{ agent.date_naissance or 'â€”' }}</span>
        </div>
      </article>

      <article class="info-panel">
        <div class="info-panel-icon">ğŸ“</div>
        <div class="info-panel-body">
          <span class="info-panel-label">Lieu de naissance</span>
          <span class="info-panel-value">{{ agent.lieu_naissance or 'â€”' }}</span>
        </div>
      </article>

      <article class="info-panel">
        <div class="info-panel-icon">ğŸŒ</div>
        <div class="info-panel-body">
          <span class="info-panel-label">NationalitÃ©</span>
          <span class="info-panel-value">{{ agent.nationalite or 'â€”' }}</span>
        </div>
      </article>

      <article class="info-panel">
        <div class="info-panel-icon">âš§ï¸</div>
        <div class="info-panel-body">
          <span class="info-panel-label">Sexe</span>
          <span class="info-panel-value">{{ agent.sexe or 'â€”' }}</span>
        </div>
      </article>

      <article class="info-panel">
        <div class="info-panel-icon">ğŸ‘ª</div>
        <div class="info-panel-body">
          <span class="info-panel-label">Situation familiale</span>
          <span class="info-panel-value">{{ agent.situation_familiale or 'â€”' }}</span>
        </div>
      </article>

      <article class="info-panel">
        <div class="info-panel-icon">ğŸ§’</div>
        <div class="info-panel-body">
          <span class="info-panel-label">Nombre d'enfants</span>
          <span class="info-panel-value">{{ agent.nombre_enfants or 0 }}</span>
        </div>
      </article>
    </div>

    <div class="info-subsection">
      <h3>ğŸ“ Contact</h3>
      <div class="info-panel-grid">
        <article class="info-panel">
          <div class="info-panel-icon">ğŸ’¼</div>
          <div class="info-panel-body">
            <span class="info-panel-label">Email professionnel</span>
            <span class="info-panel-value">{{ agent.email_professionnel or 'â€”' }}</span>
          </div>
        </article>

        <article class="info-panel">
          <div class="info-panel-icon">ğŸ </div>
          <div class="info-panel-body">
            <span class="info-panel-label">Email personnel</span>
            <span class="info-panel-value">{{ agent.email_personnel or 'â€”' }}</span>
          </div>
        </article>

        <article class="info-panel">
          <div class="info-panel-icon">ğŸ“±</div>
          <div class="info-panel-body">
            <span class="info-panel-label">TÃ©lÃ©phone 1</span>
            <span class="info-panel-value">{{ agent.telephone_1 or 'â€”' }}</span>
          </div>
        </article>

        <article class="info-panel">
          <div class="info-panel-icon">â˜ï¸</div>
          <div class="info-panel-body">
            <span class="info-panel-label">TÃ©lÃ©phone 2</span>
            <span class="info-panel-value">{{ agent.telephone_2 or 'â€”' }}</span>
          </div>
        </article>

        <article class="info-panel info-panel-wide">
          <div class="info-panel-icon">ğŸ“¬</div>
          <div class="info-panel-body">
            <span class="info-panel-label">Adresse</span>
            <span class="info-panel-value">{{ agent.adresse or 'â€”' }}</span>
            {% if agent.ville or agent.code_postal %}
            <span class="info-panel-meta">{{ agent.ville or '' }} {{ agent.code_postal or '' }}</span>
            {% endif %}
          </div>
        </article>
      </div>
    </div>
  </section>

  <!-- Informations professionnelles -->
  <section class="info-section">
    <header class="section-header">
      <div class="section-icon">ğŸ’¼</div>
      <div>
        <h2>Informations professionnelles</h2>
        <p>Parcours, affectation et statut</p>
      </div>
    </header>

    <div class="info-panel-grid">
      <article class="info-panel">
        <div class="info-panel-icon">ğŸ—“ï¸</div>
        <div class="info-panel-body">
          <span class="info-panel-label">Date de recrutement</span>
          <span class="info-panel-value">{{ agent.date_recrutement or 'â€”' }}</span>
        </div>
      </article>

      <article class="info-panel">
        <div class="info-panel-icon">ğŸš€</div>
        <div class="info-panel-body">
          <span class="info-panel-label">Prise de service</span>
          <span class="info-panel-value">{{ agent.date_prise_service or 'â€”' }}</span>
        </div>
      </article>

      <article class="info-panel">
        <div class="info-panel-icon">ğŸ“</div>
        <div class="info-panel-body">
          <span class="info-panel-label">Grade</span>
          <span class="info-panel-value">{{ grade.libelle if grade else 'â€”' }}</span>
        </div>
      </article>

      <article class="info-panel">
        <div class="info-panel-icon">ğŸ“ˆ</div>
        <div class="info-panel-body">
          <span class="info-panel-label">Ã‰chelon</span>
          <span class="info-panel-value">{{ agent.echelon or 'â€”' }}</span>
        </div>
      </article>

      <article class="info-panel">
        <div class="info-panel-icon">ğŸ’µ</div>
        <div class="info-panel-body">
          <span class="info-panel-label">Indice</span>
          <span class="info-panel-value">{{ agent.indice or 'â€”' }}</span>
        </div>
      </article>

      <article class="info-panel">
        <div class="info-panel-icon">ğŸ§“</div>
        <div class="info-panel-body">
          <span class="info-panel-label">DÃ©part retraite prÃ©vu</span>
          <span class="info-panel-value">{{ agent.date_depart_retraite_prevue or 'â€”' }}</span>
        </div>
      </article>
    </div>

    <div class="info-subsection">
      <h3>ğŸ¢ Affectation</h3>
      <div class="info-panel-grid">
        <article class="info-panel">
          <div class="info-panel-icon">ğŸ§­</div>
          <div class="info-panel-body">
            <span class="info-panel-label">Programme</span>
            <span class="info-panel-value">{{ programme.libelle if programme else 'â€”' }}</span>
          </div>
        </article>

        <article class="info-panel">
          <div class="info-panel-icon">ğŸ›ï¸</div>
          <div class="info-panel-body">
            <span class="info-panel-label">Direction</span>
            <span class="info-panel-value">{{ direction.libelle if direction else 'â€”' }}</span>
          </div>
        </article>

        <article class="info-panel">
          <div class="info-panel-icon">ğŸ¢</div>
          <div class="info-panel-body">
            <span class="info-panel-label">Service</span>
            <span class="info-panel-value">{{ service.libelle if service else 'â€”' }}</span>
          </div>
        </article>

        <article class="info-panel info-panel-wide">
          <div class="info-panel-icon">ğŸ’¼</div>
          <div class="info-panel-body">
            <span class="info-panel-label">Fonction</span>
            <span class="info-panel-value">{{ agent.fonction or 'â€”' }}</span>
          </div>
        </article>
      </div>
    </div>
  </section>

  <!-- CongÃ©s -->
  <section class="info-section">
    <header class="section-header">
      <div class="section-icon">ğŸ–ï¸</div>
      <div>
        <h2>Gestion des congÃ©s</h2>
        <p>Vision globale des droits et consommations</p>
      </div>
    </header>

    <div class="kpi-grid">
      <div class="kpi-card kpi-info">
        <span class="kpi-value">{{ agent.solde_conges_annuel or 0 }}</span>
        <span class="kpi-label">Solde annuel</span>
      </div>

      <div class="kpi-card kpi-warning">
        <span class="kpi-value">{{ agent.conges_annee_en_cours or 0 }}</span>
        <span class="kpi-label">Pris cette annÃ©e</span>
      </div>

      <div class="kpi-card kpi-success">
        <span class="kpi-value">{{ (agent.solde_conges_annuel or 0) - (agent.conges_annee_en_cours or 0) }}</span>
        <span class="kpi-label">Restant</span>
      </div>
    </div>
  </section>

  <!-- Documents, Historique, Ã‰valuations -->
  <section class="detail-grid">
    <article class="detail-card">
      <header class="detail-card-header">
        <span class="detail-icon">ğŸ“„</span>
        <div>
          <h3>Documents</h3>
          <p>PiÃ¨ces jointes et justificatifs</p>
        </div>
      </header>
      {% if documents %}
      <div class="document-list">
        {% for doc in documents %}
        <div class="document-item">
          <div class="document-meta">
            <span class="document-title">{{ doc.type_document }}</span>
            <span class="document-date">{{ doc.uploaded_at.strftime('%d/%m/%Y') }}</span>
          </div>
          <a href="{{ doc.file_path }}" target="_blank" class="btn-action btn-premium btn-primary btn-compact" title="TÃ©lÃ©charger">
            ğŸ“¥
          </a>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“­</div>
        <p class="empty-state-title">Aucun document</p>
        <p class="empty-state-message">Ajoutez les piÃ¨ces importantes pour suivre le dossier.</p>
      </div>
      {% endif %}
    </article>

    <article class="detail-card">
      <header class="detail-card-header">
        <span class="detail-icon">ğŸ“œ</span>
        <div>
          <h3>Historique de carriÃ¨re</h3>
          <p>Ã‰vÃ©nements rÃ©cents et affectations</p>
        </div>
      </header>
      {% if historique %}
      <div class="timeline">
        {% for h in historique[:5] %}
        <div class="timeline-item">
          <div class="timeline-marker"></div>
          <div class="timeline-content">
            <h4>{{ h.type_evenement }}</h4>
            <span class="timeline-date">{{ h.date_evenement.strftime('%d/%m/%Y') }}</span>
            {% if h.description %}
            <p>{{ h.description }}</p>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“­</div>
        <p class="empty-state-title">Aucun historique</p>
        <p class="empty-state-message">Les changements et Ã©vÃ©nements apparaÃ®tront ici.</p>
      </div>
      {% endif %}
    </article>

    <article class="detail-card detail-card-wide">
      <header class="detail-card-header">
        <span class="detail-icon">â­</span>
        <div>
          <h3>Ã‰valuations</h3>
          <p>Performances annuelles et apprÃ©ciations</p>
        </div>
      </header>
      {% if evaluations %}
      <div class="evaluation-list">
        {% for eval in evaluations[:5] %}
        <div class="evaluation-item">
          <div class="evaluation-header">
            <strong>AnnÃ©e {{ eval.annee }}</strong>
            <div class="evaluation-stars">
              {% for i in range(5) %}
              <span class="star {{ 'filled' if i < (eval.note or 0) else '' }}">â˜…</span>
              {% endfor %}
            </div>
          </div>
          {% if eval.commentaire %}
          <p>{{ eval.commentaire[:120] }}{% if eval.commentaire|length > 120 %}â€¦{% endif %}</p>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“­</div>
        <p class="empty-state-title">Aucune Ã©valuation</p>
        <p class="empty-state-message">Les Ã©valuations de performance seront listÃ©es ici.</p>
      </div>
      {% endif %}
    </article>
  </section>

  <!-- Notes -->
  {% if agent.notes %}
  <section class="info-section">
    <header class="section-header">
      <div class="section-icon">ğŸ“</div>
      <div>
        <h2>Notes internes</h2>
        <p>Informations complÃ©mentaires liÃ©es Ã  lâ€™agent</p>
      </div>
    </header>
    <div class="note-card">
      {{ agent.notes }}
    </div>
  </section>
  {% endif %}

  <!-- Actions -->
  <section class="info-section actions-section">
    <div class="action-buttons">
      <a href="{{ url_for('personnel_edit', agent_id=agent.id) }}" class="btn-action btn-premium btn-primary">
        âœï¸ Modifier
      </a>
      <button type="button" onclick="confirmerDesactivation()" class="btn-action btn-premium btn-accent">
        {{ 'ğŸ”“ RÃ©activer' if not agent.actif else 'ğŸ”’ DÃ©sactiver' }}
      </button>
    </div>
  </section>

</div>
</body>
{% endblock %}

{% block scripts %}
<script>
// Bouton retour avec overlay
document.addEventListener('DOMContentLoaded', function() {
  const btnBack = document.querySelector('.btn-back');
  if (btnBack) {
    btnBack.addEventListener('click', function(e) {
      e.preventDefault();
      showGlobalLoading('Retour au Personnel...', 'Veuillez patienter');
      setTimeout(() => {
        window.location.href = this.href;
      }, 300);
    });
  }
});

function confirmerDesactivation() {
  const detailContainer = document.querySelector('.personnel-detail-page');
  const isActif = detailContainer ? Boolean(Number(detailContainer.dataset.agentActif || 0)) : false;
  const action = isActif ? 'dÃ©sactiver' : 'rÃ©activer';
  
  if (confirm(`Voulez-vous vraiment ${action} cet agent ?`)) {
    showGlobalLoading(`${action.charAt(0).toUpperCase() + action.slice(1)}...`, 'Veuillez patienter');
    
    fetch("{{ url_for('delete_agent_api', agent_id=agent.id) }}", {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        actif: !isActif
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.ok) {
        showGlobalLoading(`âœ… Agent ${action}`, 'Actualisation de la page...');
        setTimeout(() => location.reload(), 500);
      } else {
        hideGlobalLoading();
        showError(`Erreur lors de la ${action}`);
      }
    })
    .catch(error => {
      console.error('Erreur:', error);
      hideGlobalLoading();
      showError('Erreur rÃ©seau. VÃ©rifiez votre connexion.');
    });
  }
}

console.log('âœ… Page dÃ©tail agent chargÃ©e');
</script>

{% endblock %}

