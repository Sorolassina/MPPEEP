{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}SIGOBE - {{ app_name }}
{% endblock %}

{% block styles %}
<style>
/* ========== SIGOBE PAGE STYLES ========== */
.sigobe-container {
    padding: 2rem 0;
    background: #f8f9fa;
    min-height: 100vh;
}

/* Filtres */
.filters-section {
    background: white;
    padding: 1.5rem;
    border-radius: 15px;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

/* Section Chargements */
.chargements-section {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
}

/* Table des chargements utilise maintenant les styles centralisés .data-table */

/* Badges de statut */
.badge-statut {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge-statut.en-cours {
    background: #d1fae5;
    color: #065f46;
}

.badge-statut.terminé {
    background: #dbeafe;
    color: #1e40af;
}

.badge-statut.erreur {
    background: #fee2e2;
    color: #991b1b;
}

/* Boutons d'action */
.action-icons {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
}

.btn-action {
    padding: 0.5rem 0.75rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1.1rem;
    transition: all 0.2s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    min-width: 40px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.btn-action:active {
    transform: translateY(0);
}

.btn-premium {
    font-weight: 600;
}

.btn-premium.btn-primary {
    background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
    color: white;
}

.btn-premium.btn-primary:hover {
    background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
}

.btn-premium.btn-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.btn-premium.btn-success:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
}

.btn-premium.btn-info {
    background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
    color: white;
}

.btn-premium.btn-info:hover {
    background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
}

.btn-premium.btn-danger {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
}

.btn-premium.btn-danger:hover {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
}

/* État vide */
.empty-state {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
}

.empty-state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.empty-state-text {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #000000;
}

/* Info box */
.info-box {
    background: #e0f2fe;
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1.5rem;
    border-left: 4px solid #0284c7;
    font-size: 0.9rem;
    line-height: 1.5;
}

/* Les boutons utilisent maintenant les classes centralisées .btn */

/* Accordéons */
.accordion-header:hover {
    background: #e9ecef !important;
}

.accordion-content {
    animation: slideDownContent 0.3s ease-out;
}

@keyframes slideDownContent {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 1000px;
    }
}
</style>
{% endblock %}

{% block content %}

{{ page_header(
    title='📊 SIGOBE - Syst. d\'Infor. de Gestion et d\'Obser. Budg.',
    breadcrumbs=[
        {'name': 'Accueil', 'url': url_for('accueil')},
        {'name': 'Budget', 'url': url_for('budget_home')},
        {'name': 'SIGOBE'}
    ],
    actions=[
        {'label': '← Retour Budget', 'url': url_for('budget_home'), 'primary': False},
        {'label': '📤 Charger des données', 'onclick': 'openUploadModal()', 'primary': True}
    ]
) }}

<div class="sigobe-container container">

  <!-- Filtres -->
  <div class="filters-section">
    <form method="get" action="{{ url_for('budget_sigobe') }}">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; align-items: end;">
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
          <label style="font-weight: 600; color: #2c3e50;">📅 Année</label>
          <select name="annee" onchange="submitFilterWithLoading()" style="
            padding: 0.75rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            font-size: 1rem;
            width: 100%;
            cursor: pointer;
          ">
            <option value="">Toutes les années</option>
            {% for a in annees %}
            <option value="{{ a }}" {{ 'selected' if annee_selected == a else '' }}>{{ a }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
          <label style="font-weight: 600; color: #2c3e50;">📆 Trimestre</label>
          <select name="trimestre" onchange="submitFilterWithLoading()" style="
            padding: 0.75rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            font-size: 1rem;
            width: 100%;
            cursor: pointer;
          ">
            <option value="">Tous les trimestres</option>
            <option value="1" {{ 'selected' if trimestre_selected == 1 else '' }}>T1</option>
            <option value="2" {{ 'selected' if trimestre_selected == 2 else '' }}>T2</option>
            <option value="3" {{ 'selected' if trimestre_selected == 3 else '' }}>T3</option>
            <option value="4" {{ 'selected' if trimestre_selected == 4 else '' }}>T4</option>
          </select>
        </div>
      </div>
    </form>
  </div>

  <!-- Chargements -->
  <div class="chargements-section">
    {% if chargements %}
    <div class="table-responsive">
      <table class="data-table chargements-table" style="font-size: 0.9rem;">
        <thead>
          <tr>
            <th>Période</th>
            <th>Fichier</th>
            <th>Date</th>
            <th>Lignes</th>
            <th>Programmes</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for c in chargements %}
          <tr data-annee="{{ c.annee }}" data-trimestre="{{ c.trimestre or '' }}" data-chargement-id="{{ c.id }}">
            <td><strong>{{ c.periode_libelle }}</strong></td>
            <td>{{ c.nom_fichier }}</td>
            <td>{{ c.date_chargement.strftime('%d/%m/%Y %H:%M') }}</td>
            <td>{{ "{:,}".format(c.nb_lignes_importees) }}</td>
            <td>{{ c.nb_programmes }}</td>
            <td>
              <span class="badge-statut {{ c.statut|lower|replace(' ', '-') }}">
                {{ c.statut }}
              </span>
            </td>
            <td>
              <div class="action-icons">
                <button onclick="voirTable({{ c.id }});" class="btn-action btn-premium btn-primary" title="Voir la table">
                  📋
                </button>
                <button onclick="exporterExcel({{ c.id }});" class="btn-action btn-premium btn-success" title="Exporter Excel">
                  📊
                </button>
                <button onclick="voirKPIs({{ c.id }});" class="btn-action btn-premium btn-info" title="Voir les KPIs">
                  📈
                </button>
                <button onclick="supprimerChargement({{ c.id }});" class="btn-action btn-premium btn-danger" title="Supprimer">
                  🗑️
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty-state">
      <div class="empty-state-icon">📂</div>
      <div class="empty-state-text">Aucun chargement SIGOBE</div>
      <p>Commencez par charger un fichier d'exécution budgétaire</p>
    </div>
    {% endif %}
  </div>

</div>

<!-- Modal Upload -->
<div id="modalUpload" class="modal-lg">
  <div class="modal-content">
    <div class="modal-header">
      <h2>📤 Charger des données SIGOBE</h2>
      <button class="modal-close" onclick="closeModal('modalUpload')">&times;</button>
    </div>
    
    <!-- Bouton pour télécharger le modèle -->
    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 1rem; margin-bottom: 1.5rem">
      <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; justify-content: space-between;">
        <div>
          <h4 style="margin: 0 0 0.25rem 0; color: #1976D2; font-size: 1rem;">📥 Besoin d'un modèle ?</h4>
          <p style="margin: 0; color: #424242; font-size: 0.9rem;">Téléchargez notre modèle Excel SIGOBE pré-formaté</p>
        </div>
        <button type="button"
           onclick="telechargerTemplateSigobe()" 
           class="btn btn-info" 
           style="white-space: nowrap;">
          📥 Télécharger le modèle Excel
        </button>
      </div>
    </div>
    
    <form id="formUpload" onsubmit="handleUpload(event)" enctype="multipart/form-data">
      <div class="form-group">
        <label class="form-label">📅 Année *</label>
        <select name="annee" class="form-select" required>
          <option value="">-- Sélectionner --</option>
          <option value="2024">2024</option>
          <option value="2025">2025</option>
          <option value="2026">2026</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">📆 Trimestre (optionnel)</label>
        <select name="trimestre" class="form-select" required>
          <option value="">Annuel</option>
          <option value="1">T1</option>
          <option value="2">T2</option>
          <option value="3">T3</option>
          <option value="4">T4</option>
        </select>
        <small>Laissez vide pour un chargement annuel</small>
      </div>
      
      <div class="form-group">
        <label class="form-label required">📎 Fichier Excel </label>
        <input type="file" name="fichier" class="form-control" accept=".xlsx,.xls" required>
        <small>Formats acceptés : .xlsx, .xls (max 50 MB)</small>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeModal('modalUpload')">Annuler</button>
        <button type="submit" class="btn btn-primary">📤 Charger et Analyser</button>
      </div>
    </form>
  </div>
</div>


{% endblock %}

{% block scripts %}
<script>
// Fermer l'overlay au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
  hideGlobalLoading();
});

// Gestion des accordéons de prévisualisation
function toggleAccordion(accordionId) {
  const content = document.getElementById(accordionId);
  const icon = document.getElementById(`icon-${accordionId}`);
  
  if (!content || !icon) return;
  
  const isOpen = content.style.display === 'block';
  
  if (isOpen) {
    content.style.display = 'none';
    icon.style.transform = 'rotate(0deg)';
    icon.textContent = '▼';
  } else {
    content.style.display = 'block';
    icon.style.transform = 'rotate(180deg)';
    icon.textContent = '▲';
  }
}

// Télécharger le template SIGOBE
function telechargerTemplateSigobe() {
  // Afficher l'overlay pendant le téléchargement
  showGlobalLoading('Génération du modèle...', 'Téléchargement en cours');
  
  // Créer un lien temporaire pour le téléchargement
  const link = document.createElement('a');
  link.href = "{{ url_for('api_telecharger_template_sigobe') }}";
  link.download = 'Modele_SIGOBE.xlsx';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);  
  
  // Recharger la page immédiatement pour fermer automatiquement les modals et l'overlay
  location.reload();
}

// Soumettre le formulaire de filtres avec indicateur de chargement
function submitFilterWithLoading() {
  showGlobalLoading('Filtrage...', 'Actualisation des chargements SIGOBE');
  // Ne pas cacher l'overlay pour permettre la redirection
  document.querySelector('form[action="{{ url_for("budget_sigobe") }}"]').submit();
}

function openUploadModal() {
  document.getElementById('modalUpload').classList.add('show');
  document.getElementById('formUpload').reset();
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('show');
}

let previewResult = null;  // Stocker les données de prévisualisation

async function handleUpload(event) {
  event.preventDefault();
  const formData = new FormData(event.target);
  
  showGlobalLoading('Analyse en cours...', 'Analyse du fichier SIGOBE');
  
  try {
    // Étape 1 : Prévisualisation
    const response = await submitFormAsJson("{{ url_for('api_sigobe_preview') }}", formData, 'POST');
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      hideGlobalLoading();
      previewResult = result;
      afficherPrevisualisation(result);
    } else {
      hideGlobalLoading();
      showError(result.detail || 'Erreur lors de l\'analyse');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur réseau. Vérifiez votre connexion.');
  }
}

function afficherPrevisualisation(result) {
  const stats = result.stats;
  const preview = result.preview;
  const totaux = result.totaux;
  
  let html = `
    <div style="margin-bottom: 1.5rem;">
      <h3 style="margin: 0 0 1.5rem 0; color: #2c3e50; font-size: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
        <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
          ✨ Analyse du fichier SIGOBE
        </span>
      </h3>
      
      <!-- Statistiques globales -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
        <div class="card" style="padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center;">
          <div style="font-size: 2rem; font-weight: bold;">${stats.nb_lignes.toLocaleString()}</div>
          <div style="font-size: 0.9rem; opacity: 0.9;">📄 Lignes détectées</div>
        </div>
        <div class="card" style="padding: 1rem; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; text-align: center;">
          <div style="font-size: 2rem; font-weight: bold;">${stats.nb_programmes}</div>
          <div style="font-size: 0.9rem; opacity: 0.9;">🎯 Programmes</div>
        </div>
        <div class="card" style="padding: 1rem; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; text-align: center;">
          <div style="font-size: 2rem; font-weight: bold;">${stats.nb_actions}</div>
          <div style="font-size: 0.9rem; opacity: 0.9;">📋 Actions</div>
        </div>
        <div class="card" style="padding: 1rem; background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; text-align: center;">
          <div style="font-size: 2rem; font-weight: bold;">${stats.nb_colonnes}</div>
          <div style="font-size: 0.9rem; opacity: 0.9;">📊 Colonnes</div>
        </div>
      </div>
      
      <!-- Accordéons -->
      <div style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 1.5rem;">
        
        <!-- Accordéon 1: Colonnes hiérarchiques -->
        <div class="accordion-item">
          <button class="accordion-header" onclick="toggleAccordion('acc-colonnes')" style="width: 100%; padding: 1rem; background: #f8f9fa; border: none; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.2s;">
            <span style="font-weight: 600; color: #2c3e50;">📋 Colonnes hiérarchiques détectées</span>
            <span id="icon-acc-colonnes" style="font-size: 1.2rem; transition: transform 0.3s;">▼</span>
          </button>
          <div id="acc-colonnes" class="accordion-content" style="padding: 1rem; display: none; background: white;">
            <code style="background: #f8f9fa; padding: 1rem; border-radius: 8px; display: block; font-family: 'Courier New', monospace; color: #0369a1; font-size: 0.95rem;">
              ${stats.colonnes_hierarchiques.join(' → ')}
            </code>
          </div>
        </div>
        
        <!-- Accordéon 2: Totaux financiers -->
        <div class="accordion-item">
          <button class="accordion-header" onclick="toggleAccordion('acc-totaux')" style="width: 100%; padding: 1rem; background: #f8f9fa; border: none; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.2s;">
            <span style="font-weight: 600; color: #2c3e50;">💰 Totaux financiers</span>
            <span id="icon-acc-totaux" style="font-size: 1.2rem; transition: transform 0.3s;">▼</span>
          </button>
          <div id="acc-totaux" class="accordion-content" style="padding: 1rem; display: none; background: white;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.75rem;">
              ${Object.entries(totaux).map(([key, val]) => 
                `<div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 1rem; border-radius: 8px; border-left: 4px solid #0369a1;">
                  <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 0.25rem;">${key.replace('_', ' ')}</div>
                  <div style="font-size: 1.25rem; font-weight: bold; color: #2c3e50;">${val.toLocaleString()} <span style="font-size: 0.85rem; font-weight: normal;">FCFA</span></div>
                </div>`
              ).join('')}
            </div>
          </div>
        </div>
        
        <!-- Accordéon 3: Aperçu des données -->
        <div class="accordion-item">
          <button class="accordion-header" onclick="toggleAccordion('acc-apercu')" style="width: 100%; padding: 1rem; background: #f8f9fa; border: none; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.2s;">
            <span style="font-weight: 600; color: #2c3e50;">👁️ Aperçu des 20 premières lignes</span>
            <span id="icon-acc-apercu" style="font-size: 1.2rem; transition: transform 0.3s;">▼</span>
          </button>
          <div id="acc-apercu" class="accordion-content" style="padding: 1rem; display: none; background: white;">
            <div style="max-height: 400px; overflow-x: auto; overflow-y: auto;">
              <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem; min-width: 1400px;">
                <thead style="position: sticky; top: 0; background: #f8f9fa; z-index: 10;">
                  <tr>
                    ${stats.colonnes.map(col => {
                      const isHierarchical = ['Programmes', 'Actions', 'Rprog', 'Type_depense', 'Activites', 'Taches'].includes(col);
                      const bgColor = isHierarchical ? '#FF8C00' : '#0369a1';
                      return `<th style="padding: 0.5rem; border: 1px solid #e0e0e0; text-align: left; background: ${bgColor}; color: white; white-space: nowrap;">${col}</th>`;
                    }).join('')}
                  </tr>
                </thead>
                <tbody>
                  ${preview.map((row, idx) => `
                    <tr style="${idx % 2 === 0 ? 'background: white;' : 'background: #f8f9fa;'}">
                      ${stats.colonnes.map(col => 
                        `<td style="padding: 0.5rem; border: 1px solid #e0e0e0; white-space: nowrap;">${row[col] || ''}</td>`
                      ).join('')}
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
      </div>
    </div>
    
    <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 1.5rem; border-radius: 10px; margin-bottom: 1rem; text-align: center; border: 2px solid #10b981;">
      <div style="font-size: 1.2rem; font-weight: bold; color: #065f46; margin-bottom: 0.5rem;">✅ Fichier conforme et prêt</div>
      <div style="color: #047857; font-size: 0.95rem;">Le fichier sera importé dans la base de données</div>
    </div>
    
    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
      <button type="button" class="btn btn-secondary" onclick="fermerPrevisualisation()">Annuler</button>
      <button type="button" class="btn btn-primary" onclick="confirmerImport()">💾 Confirmer et Importer</button>
    </div>
  `;
  
  // Afficher la prévisualisation dans le modal
  document.getElementById('formUpload').style.display = 'none';
  
  const previewContainer = document.createElement('div');
  previewContainer.id = 'previewContainer';
  previewContainer.innerHTML = html;
  document.querySelector('#modalUpload .modal-content').appendChild(previewContainer);
}

function fermerPrevisualisation() {
  const container = document.getElementById('previewContainer');
  if (container) {
    container.remove();
  }
  document.getElementById('formUpload').style.display = 'block';
  previewResult = null;
}

async function confirmerImport() {
  if (!previewResult) {
    showError('Aucune prévisualisation disponible');
    return;
  }
  
  showGlobalLoading('Import en cours...', 'Sauvegarde des données dans la base');
  
  // Récupérer les données du formulaire original
  const formData = new FormData(document.getElementById('formUpload'));
  
  try {
    const response = await submitFormAsJson("{{ url_for('api_sigobe_upload') }}", formData, 'POST');
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      closeModal('modalUpload');
      fermerPrevisualisation();
      showGlobalLoading(`✅ ${result.message}`, 'Actualisation de la page...');
      setTimeout(() => location.reload(), 1000);
    } else {
      hideGlobalLoading();
      showError(result.detail || 'Erreur lors de l\'import');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur réseau. Vérifiez votre connexion.');
  }
}

async function supprimerChargement(id) {
  if (!confirm('⚠️ Supprimer ce chargement SIGOBE ?\n\nToutes les données associées seront supprimées.')) return;
  
  showGlobalLoading('Suppression...', 'Suppression du chargement et de ses données');
  
  try {
    const response = await fetch("{{ url_for('api_delete_sigobe', chargement_id=0) }}".replace('/0', `/${id}`), {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      showGlobalLoading('✅ Chargement supprimé', 'Actualisation...');
      setTimeout(() => location.reload(), 500);
    } else {
      hideGlobalLoading();
      showError('Erreur lors de la suppression');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur réseau. Vérifiez votre connexion.');
  }
}

function voirTable(chargementId) {
  showGlobalLoading('Chargement...', 'Ouverture de la table SIGOBE');
  setTimeout(() => {
    window.location.href = "{{ url_for('budget_sigobe_table', chargement_id=0) }}".replace('/0', `/${chargementId}`);
  }, 300);
}

function exporterExcel(chargementId) {
  showGlobalLoading('Génération Excel...', 'Création du fichier Excel');
  
  // Créer un lien temporaire pour le téléchargement
  const link = document.createElement('a');
  link.href = "{{ url_for('api_export_sigobe_excel', chargement_id=0) }}".replace('/0', `/${chargementId}`);
  link.download = '';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  // Fermer l'overlay après 5 secondes
  setTimeout(() => {
    hideGlobalLoading();
  }, 5000);
}

function voirKPIs(chargementId) {
  // Trouver la ligne du chargement dans le tableau
  const row = document.querySelector(`tr[data-chargement-id="${chargementId}"]`);
  
  if (!row) {
    showError('Chargement non trouvé');
    return;
  }
  
  // Récupérer l'année et le trimestre depuis les attributs data-*
  const annee = row.dataset.annee;
  const trimestre = row.dataset.trimestre;
  
  if (!annee) {
    showError('Impossible de déterminer la période du chargement');
    return;
  }
  
  showGlobalLoading('Chargement du Dashboard...', 'Affichage des KPIs');
  
  // Construire l'URL vers le dashboard avec les filtres
  let url = `/api/v1/budget/?annee=${annee}`;
  if (trimestre) {
    url += `&trimestre=${trimestre}`;
  }
  
  // Redirection après un court délai
  setTimeout(() => {
    window.location.href = url;  // URL déjà générée avec url_for dans le HTML
  }, 300);
}
</script>

{% endblock %}

