{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}Fiches Techniques Budgétaires - {{ app_name }}
{% endblock %}

{% block content %}

{{ page_header(
    title='📋 Fiches Techniques Budgétaires',
    breadcrumbs=[
        {'name': 'Accueil', 'url': url_for('accueil')},
        {'name': 'Budget', 'url': url_for('budget_home')},
        {'name': 'Fiches Techniques'}
    ],
    actions=[
        {'label': '← Retour Budget', 'url': url_for('budget_home'), 'primary': False},
        {'label': '📂 Charger une Fiche', 'onclick': "openModal('chargerModal')", 'primary': True}
    ]
) }}

<div class="page-grid">

  <!-- Info fiches -->
  <div class="card" style="padding: 1rem;">
    <span style="color: #7f8c8d; font-size: 0.95rem; font-weight: 600;">{{ fiches|length }} fiche(s) chargée(s)</span>
  </div>

  <!-- Filtres -->
  <div class="card">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; align-items: end;">
      <!-- Filtre Année -->
      <div style="display: flex; flex-direction: column; gap: 0.5rem;">
        <label style="font-weight: 600; color: #2c3e50;">📅 Année</label>
        <select id="filter-annee" onchange="filtrerFiches()" style="
          padding: 0.75rem 1rem; 
          border: 2px solid #e0e0e0; 
          border-radius: 10px; 
          cursor: pointer; 
          font-weight: 500;
          background: white;
          font-size: 1rem;
          width: 100%;
        ">
          <option value="toutes" {{ 'selected' if annee == 'toutes' else '' }}>📋 Toutes</option>
          {% for a in annees_disponibles %}
          <option value="{{ a }}" {{ 'selected' if annee|string == a|string else '' }}>{{ a }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Filtre Programme -->
      <div style="display: flex; flex-direction: column; gap: 0.5rem;">
        <label style="font-weight: 600; color: #2c3e50;">📊 Programme</label>
        <select id="filter-programme" onchange="filtrerFiches()" style="
          padding: 0.75rem 1rem; 
          border: 2px solid #e0e0e0; 
          border-radius: 10px; 
          cursor: pointer; 
          font-weight: 500;
          background: white;
          font-size: 1rem;
          width: 100%;
        ">
          <option value="tous" {{ 'selected' if programme_id == 'tous' else '' }}>📋 Tous</option>
          {% for p in programmes_list %}
          <option value="{{ p.id }}" {{ 'selected' if programme_id|string == p.id|string else '' }}>{{ p.code }} - {{ p.libelle[:30] }}...</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <!-- Liste des fiches -->
  <div class="card">
    <h3 style="margin-bottom: 1.5rem;">📊 Fiches Techniques {% if annee == 'toutes' %}(Toutes années){% else %}{{ annee }}{% endif %}</h3>
    
    {% if fiches %}
    <div class="data-table" style="font-size: 0.9rem;">
      <table>
        <thead>
          <tr>
            <th>Numéro</th>
            <th>Année</th>
            <th>Programme</th>
            <th>Budget</th>
            <th>Phase</th>
            <th>Statut</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for f in fiches %}
          <tr>
            <td><strong>{{ f.numero_fiche }}</strong></td>
            <td><span class="badge badge-info">{{ f.annee_budget }}</span></td>
            <td>
              {% if f.programme_id in programmes %}
                <strong>{{ programmes[f.programme_id].libelle }}</strong><br>
                <small style="color: #6c757d;">({{ programmes[f.programme_id].code }})</small>
              {% else %}
                -
              {% endif %}
            </td>
            <td><strong style="color: #27ae60;">{{ "{:,.0f}".format(f.budget_total_demande) }} FCFA</strong></td>
            <td><span class="badge badge-info">{{ f.phase }}</span></td>
            <td>
              {% if f.statut == 'Brouillon' %}
                <span class="badge badge-secondary">{{ f.statut }}</span>
              {% elif f.statut == 'Soumis' %}
                <span class="badge badge-warning">{{ f.statut }}</span>
              {% elif f.statut == 'Validé' or f.statut == 'Approuvé' %}
                <span class="badge badge-success">{{ f.statut }}</span>
              {% else %}
                <span class="badge badge-danger">{{ f.statut }}</span>
              {% endif %}
            </td>
            <td>{{ f.date_creation.strftime('%d/%m/%Y') }}</td>
            <td>
              <div style="display: flex; gap: 0.5rem; justify-content: center;">
                <button onclick="voirFiche({{ f.id }})" class="btn-action" title="Voir structure">
                  👁️
                </button>
                <button onclick="exporterExcel({{ f.id }})" class="btn-action" title="Exporter Excel">
                  📊
                </button>
                <button onclick="exporterPDF({{ f.id }})" class="btn-action" title="Exporter PDF">
                  📄
                </button>
                <button onclick="gererDocumentsFiche({{ f.id }})" class="btn-action" title="Gérer documents">
                  📎
                </button>
                <button onclick="supprimerFiche({{ f.id }})" class="btn-action btn-action-danger" title="Supprimer">
                  🗑️
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty-state">
      <div class="empty-state-icon">📋</div>
      <p><strong>Aucune fiche technique {% if annee != 'toutes' %}pour {{ annee }}{% endif %}</strong></p>
      <p>Chargez une fiche existante ou créez votre première fiche technique</p>
    </div>
    {% endif %}
  </div>

</div>

<!-- Modal Charger Fiche -->
<div id="chargerModal" class="modal-xl">
  <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header">
      <h2>📂 Charger une Fiche Technique</h2>
      <button class="modal-close" onclick="closeChargerModal()">&times;</button>
    </div>
    
    <form id="chargerForm" onsubmit="handleChargerFiche(event)" enctype="multipart/form-data">
      
      <!-- Bouton pour télécharger le modèle -->
      <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; border-left: 4px solid #2196F3;">
        <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; justify-content: space-between;">
          <div>
            <h4 style="margin: 0 0 0.25rem 0; color: #1976D2; font-size: 1rem;">📥 Besoin d'un modèle ?</h4>
            <p style="margin: 0; color: #424242; font-size: 0.9rem;">Téléchargez notre modèle Excel pré-formaté avec des exemples</p>
          </div>
          <button type="button"
             onclick="telechargerTemplate()" 
             class="btn btn-info" 
             style="white-space: nowrap;">
            📥 Télécharger le modèle Excel
          </button>
        </div>
      </div>
      
      <div class="form-group">
        <label class="required">Programme</label>
        <select name="programme_id" required style="padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 10px; width: 100%;">
          <option value="">-- Sélectionner un programme --</option>
          {% for p in programmes_list %}
          <option value="{{ p.id }}">{{ p.code }} - {{ p.libelle }}</option>
          {% endfor %}
        </select>
        <small style="color: #6c757d; margin-top: 0.5rem; display: block;">
          Programme budgétaire auquel rattacher cette fiche
        </small>
      </div>
      
      <div class="form-group">
        <label class="required">Année budgétaire (N+1)</label>
        <input type="number" name="annee" min="2020" max="2050" required 
               value="{{ annee if annee != 'toutes' else '' }}" 
               placeholder="Ex: 2025"
               style="padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 10px; width: 100%;">
        <small style="color: #6c757d; margin-top: 0.5rem; display: block;">
          📅 Année du budget à préparer (N+1). Ex: Pour préparer le budget 2025, saisissez 2025
        </small>
      </div>
      
      <div class="form-group">
        <label>Fichier de la fiche technique (.xlsx, .xls, .pdf)</label>
        <input type="file" name="fichier" accept=".xlsx,.xls,.pdf" required>
        <small style="color: #6c757d; margin-top: 0.5rem; display: block;">
          Formats supportés : Excel (.xlsx, .xls) ou PDF (.pdf)<br>
          <strong>💡 Utilisez le modèle Excel ci-dessus pour garantir la conformité</strong>
        </small>
      </div>
      
      <div class="form-group">
        <label>Nom de la fiche (optionnel)</label>
        <input type="text" name="nom_fiche" placeholder="Ex: Fiche DOUANE 2025">
        <small style="color: #6c757d; margin-top: 0.5rem; display: block;">
          Si non renseigné, le nom sera généré automatiquement
        </small>
      </div>
      
      <div class="modal-actions" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 2px solid #e0e0e0;">
        <button type="button" class="btn btn-secondary" onclick="closeChargerModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">📂 Charger et Analyser</button>
      </div>
    </form>
    
    <div id="chargerResult" style="display: none; margin-top: 1rem; padding: 1rem; border-radius: 10px;"></div>
  </div>
</div>

<!-- Modal Gérer Documents Fiche -->
<div id="modalDocumentsFiche" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h2>📎 Documents de la Fiche Technique</h2>
      <button class="modal-close" onclick="closeModal('modalDocumentsFiche')">&times;</button>
    </div>
    
    <div style="padding: 1rem; background: #e3f2fd; border-radius: 10px; margin-bottom: 1rem;">
      <strong>ℹ️ Information :</strong> Gérez les documents attachés à cette fiche technique (justificatifs, annexes, etc.)
    </div>
    
    <!-- Formulaire Upload -->
    <form id="formUploadDocumentFiche" onsubmit="handleUploadDocumentFiche(event)" enctype="multipart/form-data" style="margin-bottom: 2rem;">
      <input type="hidden" id="doc_fiche_id" name="fiche_id">
      
      <div class="form-group">
        <label class="required">Fichier</label>
        <input type="file" name="fichier" required accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 10px;">
        <small style="color: #6c757d; display: block; margin-top: 0.5rem;">
          Formats acceptés : PDF, Word, Excel, Images (max 10 MB)
        </small>
      </div>
      
      <div class="form-group">
        <label>Description</label>
        <input type="text" name="description" placeholder="Description du document (optionnel)" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 10px;">
      </div>
      
      <button type="submit" class="btn btn-primary" style="width: 100%;">
        📤 Uploader le Document
      </button>
    </form>
    
    <!-- Liste des documents -->
    <div style="border-top: 2px solid #e0e0e0; padding-top: 1rem;">
      <h3 style="margin-bottom: 1rem;">📋 Documents existants</h3>
      <div id="listeDocumentsFiche" style="max-height: 400px; overflow-y: auto;">
        <!-- Sera rempli dynamiquement -->
      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block scripts %}
<script>
// Fermer l'overlay au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
  hideGlobalLoading();
});

function filtrerFiches() {
  const annee = document.getElementById('filter-annee').value;
  const programmeId = document.getElementById('filter-programme').value;
  
  // Construire l'URL avec les paramètres
  let url = "{{ url_for('budget_fiches_hierarchique') }}" + `?annee=${annee}`;
  if (programmeId !== 'tous') {
    url += `&programme_id=${programmeId}`;
  }
  
  showGlobalLoading('Filtrage...', 'Chargement des fiches');
  setTimeout(() => {
    window.location.href = url;
  }, 300);
}

function reinitialiserFiltres() {
  showGlobalLoading('Réinitialisation...', 'Chargement de toutes les fiches');
  setTimeout(() => {
    window.location.href = "{{ url_for('budget_fiches_hierarchique') }}" + '?annee=toutes';
  }, 300);
}

function voirFiche(ficheId) {
  showGlobalLoading('Chargement...', 'Ouverture de la fiche');
  setTimeout(() => {
    window.location.href = "{{ url_for('budget_fiche_structure', fiche_id=0) }}".replace('/0', `/${ficheId}`);
  }, 300);
}

function exporterExcel(ficheId) {
  showGlobalLoading('Génération Excel...', 'Création du fichier Excel');
  
  // Créer un lien temporaire pour le téléchargement
  const link = document.createElement('a');
  link.href = "{{ url_for('api_export_fiche_excel', fiche_id=0) }}".replace('/0', `/${ficheId}`);
  link.download = '';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  // Fermer l'overlay après 5 secondes
  setTimeout(() => {
    hideGlobalLoading();
  }, 5000);
}

function exporterPDF(ficheId) {
  showGlobalLoading('Génération PDF...', 'Veuillez patienter');
  
  // Créer un lien temporaire pour le téléchargement
  const link = document.createElement('a');
  link.href = "{{ url_for('api_export_fiche_pdf', fiche_id=0) }}".replace('/0', `/${ficheId}`);
  link.download = '';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  // Fermer l'overlay après 5 secondes
  setTimeout(() => {
    hideGlobalLoading();
  }, 5000);
}

async function gererDocumentsFiche(ficheId) {
  document.getElementById('doc_fiche_id').value = ficheId;
  document.getElementById('modalDocumentsFiche').classList.add('show');
  document.getElementById('formUploadDocumentFiche').reset();
  document.getElementById('doc_fiche_id').value = ficheId;
  
  // Charger les documents existants
  await chargerDocumentsFiche(ficheId);
}

async function chargerDocumentsFiche(ficheId) {
  try {
    const response = await fetch("{{ url_for('api_get_documents_fiche', fiche_id=0) }}".replace('/0', `/${ficheId}`));
    const result = await response.json();
    
    const listeDiv = document.getElementById('listeDocumentsFiche');
    
    if (response.ok && result.documents && result.documents.length > 0) {
      listeDiv.innerHTML = result.documents.map(doc => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f8f9fa; border-radius: 10px; margin-bottom: 0.5rem;">
          <div style="flex: 1;">
            <strong>📄 ${doc.filename || doc.nom_fichier || 'Document'}</strong>
            ${doc.description ? `<br><small style="color: #6c757d;">${doc.description}</small>` : ''}
            <br><small style="color: #6c757d;">Uploadé le ${new Date(doc.date_upload || doc.created_at).toLocaleDateString('fr-FR')}</small>
          </div>
          <div style="display: flex; gap: 0.5rem;">
            <button onclick="telechargerDocument(${ficheId}, ${doc.id})" class="btn btn-secondary" style="padding: 0.5rem 1rem;">
              📥 Télécharger
            </button>
            <button onclick="supprimerDocumentFiche(${ficheId}, ${doc.id})" class="btn btn-danger" style="padding: 0.5rem 1rem;">
              🗑️ Supprimer
            </button>
          </div>
        </div>
      `).join('');
    } else {
      listeDiv.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 2rem;">Aucun document attaché à cette fiche.</p>';
    }
  } catch (error) {
    console.error('Erreur chargement documents:', error);
    document.getElementById('listeDocumentsFiche').innerHTML = '<p style="text-align: center; color: #e74c3c; padding: 2rem;">Erreur lors du chargement des documents.</p>';
  }
}

async function handleUploadDocumentFiche(event) {
  event.preventDefault();
  const formData = new FormData(event.target);
  const ficheId = formData.get('fiche_id');
  
  showGlobalLoading('Upload...', 'Upload du document en cours');
  
  try {
    const response = await fetch("{{ url_for('api_upload_document', fiche_id=0) }}".replace('/0', `/${ficheId}`), {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      hideGlobalLoading();
      showSuccess('✅ Document uploadé avec succès');
      document.getElementById('formUploadDocumentFiche').reset();
      document.getElementById('doc_fiche_id').value = ficheId;
      await chargerDocumentsFiche(ficheId);
    } else {
      hideGlobalLoading();
      await handleFetchError(response, 'Erreur lors de l\'upload');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur réseau. Vérifiez votre connexion.');
  }
}

function telechargerDocument(ficheId, documentId) {
  window.open("{{ url_for('api_download_document_fiche', fiche_id=0, document_id=0) }}".replace('/0/documents/0', `/${ficheId}/documents/${documentId}`), '_blank');
}

async function supprimerDocumentFiche(ficheId, documentId) {
  if (!confirm('⚠️ Supprimer ce document ?')) return;
  
  showGlobalLoading('Suppression...', 'Suppression du document');
  
  try {
    const response = await fetch("{{ url_for('api_delete_document_fiche', fiche_id=0, document_id=0) }}".replace('/0/documents/0', `/${ficheId}/documents/${documentId}`), {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      hideGlobalLoading();
      showSuccess('✅ Document supprimé');
      await chargerDocumentsFiche(ficheId);
    } else {
      hideGlobalLoading();
      await handleFetchError(response, 'Erreur lors de la suppression');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur réseau. Vérifiez votre connexion.');
  }
}

async function supprimerFiche(ficheId) {
  if (!confirm('⚠️ Supprimer cette fiche technique ?\n\nCette action est irréversible.')) return;
  
  showGlobalLoading('Suppression...', 'Veuillez patienter');
  
  try {
    const response = await fetch("{{ url_for('api_delete_fiche', fiche_id=0) }}".replace('/0', `/${ficheId}`), {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      showGlobalLoading('✅ Fiche supprimée', 'Actualisation de la page...');
      setTimeout(() => location.reload(), 500);
    } else {
      hideGlobalLoading();
      await handleFetchError(response, 'Erreur lors de la suppression');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur réseau. Vérifiez votre connexion.');
  }
}

function telechargerTemplate() {
  // Récupérer l'année depuis le filtre (ou utiliser 2025 par défaut)
  const anneeFilter = document.getElementById('filter-annee');
  let annee = anneeFilter ? anneeFilter.value : '2025';
  
  // Si "toutes" est sélectionné, utiliser 2025
  if (annee === 'toutes') {
    annee = '2025';
  }
  
  // Afficher l'overlay pendant le téléchargement
  showGlobalLoading('Génération du modèle...', 'Téléchargement en cours');
  
  // Créer un lien temporaire pour le téléchargement
  const link = document.createElement('a');
  link.href = "{{ url_for('api_telecharger_template_fiche') }}" + `?annee=${annee}`;
  link.download = `Modele_Fiche_Technique_${annee}.xlsx`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  // Recharger la page immédiatement pour fermer automatiquement les modals et l'overlay
  location.reload();
}

async function handleChargerFiche(event) {
  event.preventDefault();
  
  showGlobalLoading('Analyse en cours...', 'Chargement et analyse du fichier');
  
  const formData = new FormData(event.target);
  
  try {
    const response = await fetch("{{ url_for('api_charger_fiche') }}", {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      const resultDiv = document.getElementById('chargerResult');
      resultDiv.style.display = 'block';
      resultDiv.style.background = '#d4edda';
      resultDiv.style.color = '#155724';
      resultDiv.innerHTML = `
        <strong>✅ Fiche chargée avec succès !</strong><br>
        <strong>Fiche créée :</strong> ${result.fiche_numero}<br>
        <strong>Actions :</strong> ${result.actions_count}<br>
        <strong>Services :</strong> ${result.services_count}<br>
        <strong>Activités :</strong> ${result.activites_count}<br>
        <strong>Lignes :</strong> ${result.lignes_count}<br>
        <strong>Budget total :</strong> ${result.budget_total.toLocaleString()} FCFA<br>
        ${result.errors.length > 0 ? '<br><strong>⚠️ Avertissements:</strong><br>' + result.errors.join('<br>') : ''}
      `;
      
      closeChargerModal();
      showGlobalLoading('✅ Fiche créée', 'Actualisation de la page...');
      setTimeout(() => location.reload(), 1000);
    } else {
      hideGlobalLoading();
      await handleFetchError(response, 'Erreur lors du chargement');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur réseau. Vérifiez votre connexion.');
  }
}

function closeChargerModal() {
  document.getElementById('chargerModal').classList.remove('show');
  document.getElementById('chargerForm').reset();
  document.getElementById('chargerResult').style.display = 'none';
}

function openModal(modalId) {
  document.getElementById(modalId).classList.add('show');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('show');
}

// Styles modal
const style = document.createElement('style');
style.textContent = `

  .modal-overlay.show {
    display: flex;
  }

  .modal-header h2 {
    margin: 0;
    color: #333;
  }

  .modal-close:hover {
    color: #dc3545;
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
  }
  
  .form-group label {
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  
  .form-group input[type="file"] {
    padding: 0.75rem;
    border: 2px dashed var(--secondary-color);
    border-radius: 10px;
    background: #f8f9fa;
  }
  
  .form-group input[type="text"] {
    padding: 0.75rem;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
  }
  
  .modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
  }
  
  /* Les styles de boutons sont centralisés dans buttons.css */
`;
document.head.appendChild(style);

console.log('✅ Page fiches techniques hiérarchiques chargée');
</script>

{% endblock %}
