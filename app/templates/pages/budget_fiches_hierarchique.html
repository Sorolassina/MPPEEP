{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}Fiches Techniques Budg√©taires - {{ app_name }}
{% endblock %}

{% block content %}

{{ page_header(
    title='üìã Fiches Techniques Budg√©taires',
    breadcrumbs=[
        {'name': 'Accueil', 'url': url_for('accueil')},
        {'name': 'Budget', 'url': url_for('budget_home')},
        {'name': 'Fiches Techniques'}
    ],
    actions=[
        {'label': '‚Üê Retour Budget', 'url': url_for('budget_home'), 'primary': False},
        {'label': 'üìÇ Charger une Fiche', 'onclick': "openModal('chargerModal')", 'primary': True}
    ]
) }}

<div class="page-grid budget-fiches-page">

  <!-- Info fiches -->
  <div class="card summary-card">
    <span class="summary-text">{{ fiches|length }} fiche(s) charg√©e(s)</span>
  </div>

  <!-- Filtres -->
  <div class="card filters-panel compact">
    <div class="filters-header">
      <div class="filters-heading">
        <span class="filters-icon">üß∞</span>
        <div class="filters-text">
          <h3>Filtres des fiches</h3>
          <p>Ajustez l'ann√©e budg√©taire et le programme pour affiner la liste.</p>
        </div>
      </div>
    </div>
    <div class="filters-row">
      <!-- Filtre Ann√©e -->
      <div class="filter-group">
        <label class="filter-label" for="filter-annee">üìÖ Ann√©e</label>
        <select id="filter-annee" class="filter-select" onchange="filtrerFiches()">
          <option value="toutes" {{ 'selected' if annee == 'toutes' else '' }}>üìã Toutes</option>
          {% for a in annees_disponibles %}
          <option value="{{ a }}" {{ 'selected' if annee|string == a|string else '' }}>{{ a }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Filtre Programme -->
      <div class="filter-group">
        <label class="filter-label" for="filter-programme">üìä Programme</label>
        <select id="filter-programme" class="filter-select" onchange="filtrerFiches()">
          <option value="tous" {{ 'selected' if programme_id == 'tous' else '' }}>üìã Tous</option>
          {% for p in programmes_list %}
          <option value="{{ p.id }}" {{ 'selected' if programme_id|string == p.id|string else '' }}>{{ p.code }} - {{ p.libelle[:30] }}...</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <!-- Liste des fiches -->
  <div class="card table-card">
    <h3 class="table-title">üìä Fiches Techniques {% if annee == 'toutes' %}(Toutes ann√©es){% else %}{{ annee }}{% endif %}</h3>
    
    {% if fiches %}
    <div class="table-container">
      <table class="data-table table-compact">
        <thead>
          <tr>
            <th>Num√©ro</th>
            <th>Ann√©e</th>
            <th>Programme</th>
            <th>Budget</th>
            <th>Phase</th>
            <th>Statut</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for f in fiches %}
          <tr>
            <td><strong>{{ f.numero_fiche }}</strong></td>
            <td><span class="badge badge-info">{{ f.annee_budget }}</span></td>
            <td>
              {% if f.programme_id in programmes %}
                <strong>{{ programmes[f.programme_id].libelle }}</strong><br>
                <span class="text-muted">({{ programmes[f.programme_id].code }})</span>
              {% else %}
                -
              {% endif %}
            </td>
            <td><strong class="text-success">{{ "{:,.0f}".format(f.budget_total_demande) }} FCFA</strong></td>
            <td><span class="badge badge-info">{{ f.phase }}</span></td>
            <td>
              {% if f.statut == 'Brouillon' %}
                <span class="badge badge-secondary">{{ f.statut }}</span>
              {% elif f.statut == 'Soumis' %}
                <span class="badge badge-warning">{{ f.statut }}</span>
              {% elif f.statut == 'Valid√©' or f.statut == 'Approuv√©' %}
                <span class="badge badge-success">{{ f.statut }}</span>
              {% else %}
                <span class="badge badge-danger">{{ f.statut }}</span>
              {% endif %}
            </td>
            <td>{{ f.date_creation.strftime('%d/%m/%Y') }}</td>
            <td>
              <div class="table-actions table-actions-compact">
                <button type="button" class="btn-action btn-premium btn-primary btn-compact" data-fiche-action="voir" data-fiche-id="{{ f.id }}" title="Voir structure">
                  üëÅÔ∏è
                </button>
                <button type="button" class="btn-action btn-premium btn-success btn-compact" data-fiche-action="excel" data-fiche-id="{{ f.id }}" title="Exporter Excel">
                  üìä
                </button>
                <button type="button" class="btn-action btn-premium btn-info btn-compact" data-fiche-action="pdf" data-fiche-id="{{ f.id }}" title="Exporter PDF">
                  üìÑ
                </button>
                <button type="button" class="btn-action btn-premium btn-secondary btn-compact" data-fiche-action="documents" data-fiche-id="{{ f.id }}" title="G√©rer documents">
                  üìé
                </button>
                <button type="button" class="btn-action btn-premium btn-danger btn-compact" data-fiche-action="supprimer" data-fiche-id="{{ f.id }}" title="Supprimer">
                  üóëÔ∏è
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty-state">
      <div class="empty-state-icon">üìã</div>
      <p><strong>Aucune fiche technique {% if annee != 'toutes' %}pour {{ annee }}{% endif %}</strong></p>
      <p>Chargez une fiche existante ou cr√©ez votre premi√®re fiche technique</p>
    </div>
    {% endif %}
  </div>

</div>

<!-- Modal Charger Fiche -->
<div id="chargerModal" class="modal-xl">
  <div class="modal-content modal-medium">
    <div class="modal-header">
      <h2>üìÇ Charger une Fiche Technique</h2>
      <button class="modal-close" onclick="closeChargerModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="chargerForm" onsubmit="handleChargerFiche(event)" enctype="multipart/form-data">
        <!-- Bouton pour t√©l√©charger le mod√®le -->
        <div class="info-banner">
          <div class="info-banner-content">
            <div>
              <h4>üì• Besoin d'un mod√®le ?</h4>
              <p>T√©l√©chargez notre mod√®le Excel pr√©-format√© avec des exemples</p>
            </div>
            <button type="button"
               onclick="telechargerTemplate()" 
               class="btn btn-info">
              üì• T√©l√©charger le mod√®le Excel
            </button>
          </div>
        </div>

        <div class="form-group">
          <label class="required" for="programme_upload">Programme</label>
          <select id="programme_upload" name="programme_id" required class="filter-select">
            <option value="">-- S√©lectionner un programme --</option>
            {% for p in programmes_list %}
            <option value="{{ p.id }}">{{ p.code }} - {{ p.libelle }}</option>
            {% endfor %}
          </select>
          <span class="form-help">Programme budg√©taire auquel rattacher cette fiche</span>
        </div>

        <div class="form-group">
          <label class="required" for="annee_upload">Ann√©e budg√©taire (N+1)</label>
          <input id="annee_upload" type="number" name="annee" min="2020" max="2050" required 
                 value="{{ annee if annee != 'toutes' else '' }}" 
                 placeholder="Ex: 2025">
          <span class="form-help">üìÖ Ann√©e du budget √† pr√©parer (N+1). Ex: Pour pr√©parer le budget 2025, saisissez 2025</span>
        </div>

        <div class="form-group">
          <label for="fichier_upload">Fichier de la fiche technique (.xlsx, .xls, .pdf)</label>
          <input id="fichier_upload" type="file" name="fichier" accept=".xlsx,.xls,.pdf" required>
          <span class="form-help">
            Formats support√©s : Excel (.xlsx, .xls) ou PDF (.pdf)<br>
            <strong>üí° Utilisez le mod√®le Excel ci-dessus pour garantir la conformit√©</strong>
          </span>
        </div>

        <div class="form-group">
          <label for="nom_fiche">Nom de la fiche (optionnel)</label>
          <input id="nom_fiche" type="text" name="nom_fiche" placeholder="Ex: Fiche DOUANE 2025">
          <span class="form-help">Si non renseign√©, le nom sera g√©n√©r√© automatiquement</span>
        </div>

        <div class="modal-actions bordered">
          <button type="button" class="btn btn-secondary" onclick="closeChargerModal()">Annuler</button>
          <button type="submit" class="btn btn-primary btn-block">üìÇ Charger et Analyser</button>
        </div>
      </form>

      <div id="chargerResult" class="upload-result"></div>
    </div>
  </div>
</div>

<!-- Modal G√©rer Documents Fiche -->
<div id="modalDocumentsFiche" class="modal-xl">
  <div class="modal-content modal-large">
    <div class="modal-header">
      <h2>üìé Documents de la Fiche Technique</h2>
      <button class="modal-close" onclick="closeModal('modalDocumentsFiche')">&times;</button>
    </div>
    <div class="modal-body">
      <div class="info-banner soft">
        <strong>‚ÑπÔ∏è Information :</strong> G√©rez les documents attach√©s √† cette fiche technique (justificatifs, annexes, etc.)
      </div>

      <!-- Formulaire Upload -->
      <form id="formUploadDocumentFiche" onsubmit="handleUploadDocumentFiche(event)" enctype="multipart/form-data" class="modal-form">
        <input type="hidden" id="doc_fiche_id" name="fiche_id">

        <div class="form-group">
          <label class="required" for="document_upload">Fichier</label>
          <input id="document_upload" type="file" name="fichier" required accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
          <span class="form-help">Formats accept√©s : PDF, Word, Excel, Images (max 10 MB)</span>
        </div>

        <div class="form-group">
          <label for="document_description">Description</label>
          <input id="document_description" type="text" name="description" placeholder="Description du document (optionnel)">
        </div>

        <button type="submit" class="btn btn-primary btn-block">
          üì§ Uploader le Document
        </button>
      </form>

      <!-- Liste des documents -->
      <div class="documents-list">
        <h3>üìã Documents existants</h3>
        <div id="listeDocumentsFiche" class="documents-scroll"></div>
      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block scripts %}
<script>
// Fermer l'overlay au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
  hideGlobalLoading();
});

function focusOverlay() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function filtrerFiches() {
  const annee = document.getElementById('filter-annee').value;
  const programmeId = document.getElementById('filter-programme').value;
  
  // Construire l'URL avec les param√®tres
  let url = "{{ url_for('budget_fiches_hierarchique') }}" + `?annee=${annee}`;
  if (programmeId !== 'tous') {
    url += `&programme_id=${programmeId}`;
  }
  
  focusOverlay();
  showGlobalLoading('Filtrage...', 'Chargement des fiches');
  setTimeout(() => {
    window.location.href = url;
  }, 300);
}

function reinitialiserFiltres() {
  focusOverlay();
  showGlobalLoading('R√©initialisation...', 'Chargement de toutes les fiches');
  setTimeout(() => {
    window.location.href = "{{ url_for('budget_fiches_hierarchique') }}" + '?annee=toutes';
  }, 300);
}

function voirFiche(ficheId) {
  focusOverlay();
  showGlobalLoading('Chargement...', 'Ouverture de la fiche');
  setTimeout(() => {
    window.location.href = "{{ url_for('budget_fiche_structure', fiche_id=0) }}".replace('/0', `/${ficheId}`);
  }, 300);
}

function exporterExcel(ficheId) {
  focusOverlay();
  showGlobalLoading('G√©n√©ration Excel...', 'Cr√©ation du fichier Excel');
  
  // Cr√©er un lien temporaire pour le t√©l√©chargement
  const link = document.createElement('a');
  link.href = "{{ url_for('api_export_fiche_excel', fiche_id=0) }}".replace('/0', `/${ficheId}`);
  link.download = '';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  // Fermer l'overlay apr√®s 5 secondes
  setTimeout(() => {
    hideGlobalLoading();
  }, 5000);
}

function exporterPDF(ficheId) {
  focusOverlay();
  showGlobalLoading('G√©n√©ration PDF...', 'Veuillez patienter');
  
  // Cr√©er un lien temporaire pour le t√©l√©chargement
  const link = document.createElement('a');
  link.href = "{{ url_for('api_export_fiche_pdf', fiche_id=0) }}".replace('/0', `/${ficheId}`);
  link.download = '';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  // Fermer l'overlay apr√®s 5 secondes
  setTimeout(() => {
    hideGlobalLoading();
  }, 5000);
}

async function gererDocumentsFiche(ficheId) {
  document.getElementById('doc_fiche_id').value = ficheId;
  document.getElementById('modalDocumentsFiche').classList.add('show');
  document.getElementById('formUploadDocumentFiche').reset();
  document.getElementById('doc_fiche_id').value = ficheId;
  
  // Charger les documents existants
  await chargerDocumentsFiche(ficheId);
}

async function chargerDocumentsFiche(ficheId) {
  try {
    const response = await fetch("{{ url_for('api_get_documents_fiche', fiche_id=0) }}".replace('/0', `/${ficheId}`));
    const result = await response.json();
    
    const listeDiv = document.getElementById('listeDocumentsFiche');
    
    if (response.ok && result.documents && result.documents.length > 0) {
      listeDiv.innerHTML = result.documents.map(doc => `
        <div class="document-item">
          <div class="document-item-body">
            <strong>üìÑ ${doc.filename || doc.nom_fichier || 'Document'}</strong>
            ${doc.description ? `<br><span class="text-muted">${doc.description}</span>` : ''}
            <br><span class="text-muted">Upload√© le ${new Date(doc.date_upload || doc.created_at).toLocaleDateString('fr-FR')}</span>
          </div>
          <div class="document-item-actions">
            <button type="button" class="btn btn-secondary btn-sm" data-document-action="download" data-fiche-id="${ficheId}" data-document-id="${doc.id}">
              üì• T√©l√©charger
            </button>
            <button type="button" class="btn btn-danger btn-sm" data-document-action="delete" data-fiche-id="${ficheId}" data-document-id="${doc.id}">
              üóëÔ∏è Supprimer
            </button>
          </div>
        </div>
      `).join('');
    } else {
      listeDiv.innerHTML = '<p class="documents-empty">Aucun document attach√© √† cette fiche.</p>';
    }
  } catch (error) {
    console.error('Erreur chargement documents:', error);
    document.getElementById('listeDocumentsFiche').innerHTML = '<p class="documents-error">Erreur lors du chargement des documents.</p>';
  }
}

async function handleUploadDocumentFiche(event) {
  event.preventDefault();
  const formData = new FormData(event.target);
  const ficheId = formData.get('fiche_id');
  
  focusOverlay();
  showGlobalLoading('Upload...', 'Upload du document en cours');
  
  try {
    const response = await submitFormAsJson("{{ url_for('api_upload_document', fiche_id=0) }}".replace('/0', `/${ficheId}`), formData, 'POST');
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      hideGlobalLoading();
      showSuccess('‚úÖ Document upload√© avec succ√®s');
      document.getElementById('formUploadDocumentFiche').reset();
      document.getElementById('doc_fiche_id').value = ficheId;
      await chargerDocumentsFiche(ficheId);
    } else {
      hideGlobalLoading();
      await handleFetchError(response, 'Erreur lors de l\'upload');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur r√©seau. V√©rifiez votre connexion.');
  }
}

function telechargerDocument(ficheId, documentId) {
  window.open("{{ url_for('api_download_document_fiche', fiche_id=0, document_id=0) }}".replace('/0/documents/0', `/${ficheId}/documents/${documentId}`), '_blank');
}

async function supprimerDocumentFiche(ficheId, documentId) {
  if (!confirm('‚ö†Ô∏è Supprimer ce document ?')) return;
  
  focusOverlay();
  showGlobalLoading('Suppression...', 'Suppression du document');
  
  try {
    const response = await fetch("{{ url_for('api_delete_document_fiche', fiche_id=0, document_id=0) }}".replace('/0/documents/0', `/${ficheId}/documents/${documentId}`), {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      hideGlobalLoading();
      showSuccess('‚úÖ Document supprim√©');
      await chargerDocumentsFiche(ficheId);
    } else {
      hideGlobalLoading();
      await handleFetchError(response, 'Erreur lors de la suppression');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur r√©seau. V√©rifiez votre connexion.');
  }
}

async function supprimerFiche(ficheId) {
  if (!confirm('‚ö†Ô∏è Supprimer cette fiche technique ?\n\nCette action est irr√©versible.')) return;
  
  focusOverlay();
  showGlobalLoading('Suppression...', 'Veuillez patienter');
  
  try {
    const response = await fetch("{{ url_for('api_delete_fiche', fiche_id=0) }}".replace('/0', `/${ficheId}`), {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      showGlobalLoading('‚úÖ Fiche supprim√©e', 'Actualisation de la page...');
      setTimeout(() => location.reload(), 500);
    } else {
      hideGlobalLoading();
      await handleFetchError(response, 'Erreur lors de la suppression');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur r√©seau. V√©rifiez votre connexion.');
  }
}

// D√©l√©gation de clic sur les boutons d'actions des fiches/documents
document.addEventListener('click', (event) => {
  let target = event.target;
  while (target && !(target instanceof Element)) {
    target = target.parentElement;
  }

  if (!(target instanceof Element)) {
    return;
  }

  const ficheButton = target.closest('[data-fiche-action]');
  if (ficheButton) {
    const ficheId = Number(ficheButton.dataset.ficheId);
    switch (ficheButton.dataset.ficheAction) {
      case 'voir':
        voirFiche(ficheId);
        break;
      case 'excel':
        exporterExcel(ficheId);
        break;
      case 'pdf':
        exporterPDF(ficheId);
        break;
      case 'documents':
        gererDocumentsFiche(ficheId);
        break;
      case 'supprimer':
        supprimerFiche(ficheId);
        break;
      default:
        break;
    }
    return;
  }

  const documentButton = target.closest('[data-document-action]');
  if (documentButton) {
    const ficheId = Number(documentButton.dataset.ficheId);
    const documentId = Number(documentButton.dataset.documentId);
    switch (documentButton.dataset.documentAction) {
      case 'download':
        telechargerDocument(ficheId, documentId);
        break;
      case 'delete':
        supprimerDocumentFiche(ficheId, documentId);
        break;
      default:
        break;
    }
  }
});

function telechargerTemplate() {
  // R√©cup√©rer l'ann√©e depuis le filtre (ou utiliser 2025 par d√©faut)
  const anneeFilter = document.getElementById('filter-annee');
  let annee = anneeFilter ? anneeFilter.value : '2025';
  
  // Si "toutes" est s√©lectionn√©, utiliser 2025
  if (annee === 'toutes') {
    annee = '2025';
  }
  
  focusOverlay();
  // Afficher l'overlay pendant le t√©l√©chargement
  showGlobalLoading('G√©n√©ration du mod√®le...', 'T√©l√©chargement en cours');
  
  // Cr√©er un lien temporaire pour le t√©l√©chargement
  const link = document.createElement('a');
  link.href = "{{ url_for('api_telecharger_template_fiche') }}" + `?annee=${annee}`;
  link.download = `Modele_Fiche_Technique_${annee}.xlsx`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  // Recharger la page imm√©diatement pour fermer automatiquement les modals et l'overlay
  location.reload();
}

async function handleChargerFiche(event) {
  event.preventDefault();
  
  focusOverlay();
  showGlobalLoading('Analyse en cours...', 'Chargement et analyse du fichier');
  
  const formData = new FormData(event.target);
  
  try {
    const response = await submitFormAsJson("{{ url_for('api_charger_fiche') }}", formData, 'POST');
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      const resultDiv = document.getElementById('chargerResult');
      resultDiv.className = 'upload-result success show';
      resultDiv.innerHTML = `
        <strong>‚úÖ Fiche charg√©e avec succ√®s !</strong><br>
        <strong>Fiche cr√©√©e :</strong> ${result.fiche_numero}<br>
        <strong>Actions :</strong> ${result.actions_count}<br>
        <strong>Services :</strong> ${result.services_count}<br>
        <strong>Activit√©s :</strong> ${result.activites_count}<br>
        <strong>Lignes :</strong> ${result.lignes_count}<br>
        <strong>Budget total :</strong> ${result.budget_total.toLocaleString()} FCFA<br>
        ${result.errors.length > 0 ? '<br><strong>‚ö†Ô∏è Avertissements:</strong><br>' + result.errors.join('<br>') : ''}
      `;
      
      closeChargerModal();
      showGlobalLoading('‚úÖ Fiche cr√©√©e', 'Actualisation de la page...');
      setTimeout(() => location.reload(), 1000);
    } else {
      hideGlobalLoading();
      await handleFetchError(response, 'Erreur lors du chargement');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur r√©seau. V√©rifiez votre connexion.');
  }
}

function closeChargerModal() {
  document.getElementById('chargerModal').classList.remove('show');
  document.getElementById('chargerForm').reset();
  const resultDiv = document.getElementById('chargerResult');
  resultDiv.className = 'upload-result';
  resultDiv.textContent = '';
}

function openModal(modalId) {
  document.getElementById(modalId).classList.add('show');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('show');
}

console.log('‚úÖ Page fiches techniques hi√©rarchiques charg√©e');
</script>

{% endblock %}
