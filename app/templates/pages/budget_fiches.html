{% extends "layouts/base.html" %}

{% block title %}Fiches Techniques Budg√©taires - {{ app_name }}{% endblock %}

{% block content %}
<div class="page-grid">
  
  <!-- En-t√™te -->
  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
      <h1 style="margin: 0;">üìã Fiches Techniques Budg√©taires</h1>
      <a href="/api/v1/budget/" class="btn-back" title="Retour au Budget">
        <span style="font-size: 1.2rem;">‚Üê</span> Retour
      </a>
    </div>
    <p style="color: #6c757d; margin: 0;">
      G√©rez les fiches techniques pour les conf√©rences budg√©taires internes et minist√©rielles
    </p>
  </div>

  <!-- Actions -->
  <div class="card">
    <div class="actions-bar">
      <div style="display: flex; gap: 1rem; align-items: center;">
        <label style="font-weight: 600;">Ann√©e Budget:</label>
        <select id="filter-annee" onchange="filtrerFiches()" style="padding: 0.75rem 1rem; border: 2px solid #e0e0e0; border-radius: 10px;">
          <option value="{{ annee }}" selected>{{ annee }}</option>
          <option value="{{ annee - 1 }}">{{ annee - 1 }}</option>
          <option value="{{ annee + 1 }}">{{ annee + 1 }}</option>
        </select>
      </div>
      
      <div style="display: flex; gap: 1rem;">
        <a href="/api/v1/budget/fiches/hierarchique" class="btn-primary" style="background: linear-gradient(135deg, #10b981, #059669);">
          üìã Fiches Hi√©rarchiques
        </a>
        <a href="/api/v1/budget/fiches/nouveau" class="btn-primary">
          ‚ûï Nouvelle Fiche Technique
        </a>
        <button onclick="document.getElementById('importModal').classList.add('show')" class="btn-primary" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
          üì• Importer Activit√©s Excel
        </button>
      </div>
    </div>
  </div>

  <!-- Liste des fiches -->
  <div class="card">
    <h3 style="margin-bottom: 1.5rem;">üìä Fiches Techniques {{ annee }}</h3>
    
    {% if fiches %}
    <div class="data-table">
      <table>
        <thead>
          <tr>
            <th>Num√©ro</th>
            <th>Programme</th>
            <th>Direction</th>
            <th>Budget Demand√©</th>
            <th>Phase</th>
            <th>Statut</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for f in fiches %}
          <tr>
            <td><strong>{{ f.numero_fiche }}</strong></td>
            <td>{{ programmes[f.programme_id].code if f.programme_id in programmes else '-' }}</td>
            <td>{{ directions[f.direction_id].code if f.direction_id and f.direction_id in directions else '-' }}</td>
            <td><strong style="color: #27ae60;">{{ "{:,.0f}".format(f.budget_total_demande) }} FCFA</strong></td>
            <td><span class="badge badge-info">{{ f.phase }}</span></td>
            <td>
              {% if f.statut == 'Brouillon' %}
                <span class="badge badge-secondary">{{ f.statut }}</span>
              {% elif f.statut == 'Soumis' %}
                <span class="badge badge-warning">{{ f.statut }}</span>
              {% elif f.statut == 'Valid√©' or f.statut == 'Approuv√©' %}
                <span class="badge badge-success">{{ f.statut }}</span>
              {% else %}
                <span class="badge badge-danger">{{ f.statut }}</span>
              {% endif %}
            </td>
            <td>{{ f.date_creation.strftime('%d/%m/%Y') }}</td>
            <td>
              <div class="action-icons">
                <span class="action-icon" onclick="window.location.href='/api/v1/budget/fiches/{{ f.id }}'" title="Voir d√©tail">üëÅÔ∏è</span>
                <span class="action-icon" onclick="exporterPDF({{ f.id }})" title="Exporter PDF">üìÑ</span>
                <span class="action-icon" onclick="supprimerFiche({{ f.id }})" title="Supprimer">üóëÔ∏è</span>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="empty-state">
      <div class="empty-state-icon">üìã</div>
      <p><strong>Aucune fiche technique pour {{ annee }}</strong></p>
      <p>Cr√©ez votre premi√®re fiche technique pour la conf√©rence budg√©taire</p>
    </div>
    {% endif %}
  </div>

</div>

<!-- Modal Import Excel -->
<div id="importModal" class="modal-overlay">
  <div class="modal-content" style="max-width: 600px;">
    <div class="modal-header">
      <h2>üì• Importer Activit√©s Excel</h2>
      <button class="modal-close" onclick="closeImportModal()">&times;</button>
    </div>
    
    <div style="padding: 1rem; background: #e3f2fd; border-radius: 10px; margin-bottom: 1rem;">
      <strong>Format attendu :</strong>
      <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
        <li>Code (obligatoire)</li>
        <li>Libelle (obligatoire)</li>
        <li>Programme (optionnel)</li>
        <li>Direction (optionnel)</li>
        <li>Nature (optionnel)</li>
        <li>Description (optionnel)</li>
      </ul>
    </div>
    
    <form id="importForm" onsubmit="handleImport(event)" enctype="multipart/form-data">
      <div class="form-group">
        <label>Fichier Excel (.xlsx, .xls)</label>
        <input type="file" name="fichier" accept=".xlsx,.xls" required>
      </div>
      
      <div class="modal-actions" style="margin-top: 1.5rem; padding-top: 1rem; border-top: 2px solid #e0e0e0;">
        <button type="button" class="btn-modal secondary" onclick="closeImportModal()">Annuler</button>
        <button type="submit" class="btn-modal primary">üì• Importer</button>
      </div>
    </form>
    
    <div id="importResult" style="display: none; margin-top: 1rem; padding: 1rem; border-radius: 10px;"></div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function filtrerFiches() {
  const annee = document.getElementById('filter-annee').value;
  showGlobalLoading('Filtrage...', 'Chargement des fiches');
  setTimeout(() => {
    window.location.href = `/api/v1/budget/fiches?annee=${annee}`;
  }, 300);
}

function exporterPDF(ficheId) {
  showGlobalLoading('G√©n√©ration PDF...', 'Veuillez patienter');
  setTimeout(() => {
    window.open(`/api/v1/budget/api/fiches/${ficheId}/export/pdf`, '_blank');
    hideGlobalLoading();
  }, 500);
}

async function supprimerFiche(ficheId) {
  if (!confirm('‚ö†Ô∏è Supprimer cette fiche technique ?\n\nCette action est irr√©versible.')) return;
  
  showGlobalLoading('Suppression...', 'Veuillez patienter');
  
  try {
    const response = await fetch(`/api/v1/budget/api/fiches/${ficheId}`, {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      showGlobalLoading('‚úÖ Fiche supprim√©e', 'Actualisation de la page...');
      setTimeout(() => location.reload(), 500);
    } else {
      hideGlobalLoading();
      await handleFetchError(response, 'Erreur lors de la suppression');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur r√©seau. V√©rifiez votre connexion.');
  }
}

async function handleImport(event) {
  event.preventDefault();
  
  showGlobalLoading('Import en cours...', 'Traitement du fichier Excel');
  
  const formData = new FormData(event.target);
  
  try {
    const response = await fetch('/api/v1/budget/api/import/activites', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      const resultDiv = document.getElementById('importResult');
      resultDiv.style.display = 'block';
      resultDiv.style.background = '#d4edda';
      resultDiv.style.color = '#155724';
      resultDiv.innerHTML = `
        <strong>‚úÖ Import r√©ussi !</strong><br>
        ${result.created} activit√©(s) cr√©√©e(s)<br>
        ${result.updated} activit√©(s) mise(s) √† jour<br>
        ${result.errors.length > 0 ? '<br><strong>Erreurs:</strong><br>' + result.errors.join('<br>') : ''}
      `;
      hideGlobalLoading();
      
      setTimeout(() => {
        showSuccess(`Import termin√©: ${result.created + result.updated} activit√©s trait√©es`);
        closeImportModal();
      }, 2000);
    } else {
      await handleFetchError(response, 'Erreur lors de l\'import');
    }
  } catch (error) {
    console.error('Erreur:', error);
    showError('Erreur r√©seau. V√©rifiez votre connexion.');
  }
}

function closeImportModal() {
  document.getElementById('importModal').classList.remove('show');
  document.getElementById('importForm').reset();
  document.getElementById('importResult').style.display = 'none';
}

// Styles modal
const style = document.createElement('style');
style.textContent = `
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
  }
  
  .modal-overlay.show {
    display: flex;
  }
  
  .modal-content {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e0e0e0;
  }
  
  .modal-header h2 {
    margin: 0;
    color: #333;
  }
  
  .modal-close {
    font-size: 2rem;
    color: #6c757d;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
    line-height: 1;
  }
  
  .modal-close:hover {
    color: #dc3545;
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
  }
  
  .form-group label {
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  
  .form-group input[type="file"] {
    padding: 0.75rem;
    border: 2px dashed #667eea;
    border-radius: 10px;
    background: #f8f9fa;
  }
  
  .modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
  }
  
  .btn-modal {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .btn-modal.primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  
  .btn-modal.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
  }
  
  .btn-modal.secondary {
    background: #e9ecef;
    color: #495057;
  }
  
  .btn-modal.secondary:hover {
    background: #dee2e6;
  }
`;
document.head.appendChild(style);

console.log('‚úÖ Page fiches techniques charg√©e');
</script>
{% endblock %}

