{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}{{ 'Modifier' if article else 'Nouvel' }} Article - Stocks - {{ app_name }}</body>
{% endblock %}

{% block styles %}
<!-- Styles centralis√©s dans cards.css, forms.css -->
</body>
{% endblock %}

{% block content %}
<body class="form-page-premium">
{{ page_header(
    title='üìù Modifier l\'Article' if article else '‚ûï Nouvel Article',
    breadcrumbs=[
        {'name': 'Stocks', 'url': url_for('stock_home')},
        {'name': 'Articles', 'url': url_for('stock_articles')},
        {'name': article.code if article else 'Nouveau'}
    ],
    actions=[
        {'label': '‚Üê Retour Articles', 'url': url_for('stock_articles'), 'primary': False}
    ]
) }}

<div class="page-grid">
  
  <!-- Formulaire -->
  <div class="card">
    <form id="articleForm" onsubmit="submitForm(event)">
      {% if article %}
      <input type="hidden" name="article_id" value="{{ article.id }}">
      {% endif %}
      
      <!-- Identification -->
      <h3 style="margin-bottom: 1.5rem; color: var(--secondary-color);">üè∑Ô∏è Identification</h3>
      <div class="form-grid" style="margin-bottom: 2rem;">
        <div class="form-group">
          <label class="form-label">Cat√©gorie *</label>
          <select name="categorie_id" id="categorie_id" class="form-select" required onchange="genererCode()">
            <option value="">-- S√©lectionner une cat√©gorie --</option>
            {% for cat in categories %}
            <option value="{{ cat.id }}" data-code="{{ cat.code }}" {{ 'selected' if article and article.categorie_id == cat.id else '' }}>
              {{ cat.libelle }}
            </option>
            {% endfor %}
          </select>
          <small style="color: var(--gray-600);">
            {% if categories %}
              {{ categories|length }} cat√©gorie(s) disponible(s) ‚Ä¢ 
              {% if article %}
                ‚ö†Ô∏è Changer la cat√©gorie r√©g√©n√©rera automatiquement le code
              {% else %}
                Le code sera g√©n√©r√© automatiquement
              {% endif %}
            {% else %}
              ‚ö†Ô∏è Aucune cat√©gorie configur√©e - <a href="{{ url_for('referentiels_home') }}" target="_blank" style="color: #0066cc;">Cr√©er des cat√©gories</a>
            {% endif %}
          </small>
        </div>
        
        <div class="form-group">
          <label class="form-label">Code Article *</label>
          <input type="text" name="code" id="code" class="form-input" required readonly
                 value="{{ article.code if article else '' }}"
                 placeholder="S√©lectionnez une cat√©gorie..."
                 style="background: var(--gray-100); cursor: not-allowed;">
          <small style="color: var(--gray-600);">G√©n√©r√© automatiquement</small>
        </div>
        
        <div class="form-group">
          <label class="form-label">D√©signation *</label>
          <input type="text" name="designation" class="form-input" required
                 value="{{ article.designation if article else '' }}"
                 placeholder="Ex: Ramette papier A4">
        </div>
        
        <div class="form-group">
          <label class="form-label">Unit√© *</label>
          <select name="unite" class="form-select" required>
            <option value="Unit√©" {{ 'selected' if not article or article.unite == 'Unit√©' else '' }}>Unit√©</option>
            <option value="Pi√®ce" {{ 'selected' if article and article.unite == 'Pi√®ce' else '' }}>Pi√®ce</option>
            <option value="Carton" {{ 'selected' if article and article.unite == 'Carton' else '' }}>Carton</option>
            <option value="Lot" {{ 'selected' if article and article.unite == 'Lot' else '' }}>Lot</option>
            <option value="Kg" {{ 'selected' if article and article.unite == 'Kg' else '' }}>Kg</option>
            <option value="Litre" {{ 'selected' if article and article.unite == 'Litre' else '' }}>Litre</option>
          </select>
        </div>
      </div>
      
      <!-- Stock & Prix -->
      <h3 style="margin-bottom: 1.5rem; color: var(--secondary-color);">üìä Stock & Prix</h3>
      
      <div style="background: #dbeafe; padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 1.5rem;">
        <p style="color: #1e40af; margin: 0; line-height: 1.6; font-size: 0.9rem;">
          <strong>üí° Prix Automatique :</strong> Le prix unitaire moyen est calcul√© automatiquement √† partir des prix r√©els des mouvements d'entr√©e en stock. Ce prix sert pour la valorisation du stock et l'amortissement.
        </p>
      </div>
      
      <div class="form-grid" style="margin-bottom: 2rem;">
        <div class="form-group">
          <label class="form-label">Stock Minimum *</label>
          <input type="number" name="quantite_min" class="form-input" required min="0" step="0.01"
                 value="{{ article.quantite_min if article else '0' }}">
          <small style="color: var(--gray-600);">Seuil d'alerte de r√©approvisionnement</small>
        </div>
        
        <div class="form-group">
          <label class="form-label">Stock Maximum</label>
          <input type="number" name="quantite_max" class="form-input" min="0" step="0.01"
                 value="{{ article.quantite_max if article else '' }}">
          <small style="color: var(--gray-600);">Stock maximum recommand√©</small>
        </div>
        
        <div class="form-group">
          <label class="form-label">Prix Unitaire Moyen (FCFA) <span style="color: #10b981;">‚úì Auto</span></label>
          <input type="number" name="prix_unitaire" class="form-input" min="0" step="1"
                 value="{{ article.prix_unitaire if article else '' }}"
                 placeholder="Calcul√© automatiquement"
                 readonly
                 style="background: var(--gray-100); cursor: not-allowed;">
          <small style="color: #10b981; font-weight: 500;">
            Calcul√© automatiquement √† partir des mouvements d'entr√©e
          </small>
        </div>
        
        <div class="form-group">
          <label class="form-label">Emplacement</label>
          <input type="text" name="emplacement" class="form-input"
                 value="{{ article.emplacement if article else '' }}"
                 placeholder="Ex: Magasin A - Rayon 3">
        </div>
      </div>
      
      <!-- Description -->
      <h3 style="margin-bottom: 1.5rem; color: var(--secondary-color);">üìù Description</h3>
      <div class="form-group" style="margin-bottom: 2rem;">
        <label class="form-label">Description d√©taill√©e</label>
        <textarea name="description" class="form-textarea" rows="4" 
                  placeholder="D√©tails suppl√©mentaires sur l'article...">{{ article.description if article else '' }}</textarea>
      </div>
      
      <!-- Info : Gestion P√©rissable et Amortissement -->
      <div style="background: #dbeafe; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #3b82f6; margin-bottom: 2rem;">
        <h3 style="margin: 0 0 1rem 0; color: #1e40af; font-size: 1rem;">üí° Informations P√©rissables et Amortissement</h3>
        <p style="color: #1e40af; margin: 0; line-height: 1.6; font-size: 0.95rem;">
          Les informations de <strong>p√©remption</strong> (pour denr√©es, m√©dicaments) et d'<strong>amortissement</strong> 
          (pour √©quipements, v√©hicules) sont d√©sormais saisies <strong>lors des mouvements d'entr√©e en stock</strong>.<br><br>
          Cela permet de g√©rer plusieurs lots avec des dates diff√©rentes et plusieurs achats de mat√©riel 
          avec des plans d'amortissement distincts.<br><br>
          üì¶ <strong>Rendez-vous dans "Mouvements ‚Üí Nouvelle Entr√©e"</strong> pour saisir ces informations.
        </p>
      </div>
      
      <!-- Actions -->
      <div class="form-actions">
        <a href="{{ url_for('stock_articles') }}" class="btn btn-secondary">Annuler</a>
        <button type="submit" class="btn btn-primary">
          {{ 'üíæ Enregistrer' if article else '‚ûï Cr√©er l\'Article' }}
        </button>
      </div>
      
    </form>
  </div>
  
</div>
</body>
{% endblock %}

{% block scripts %}
<script>
// ========================================
// FERMER L'OVERLAY AU CHARGEMENT
// ========================================
document.addEventListener('DOMContentLoaded', function() {
  // S'assurer que l'overlay est ferm√© au chargement de la page
  const overlay = document.getElementById('globalLoadingOverlay');
  if (overlay) {
    overlay.classList.remove('show');
  }
});

// G√©n√©rer automatiquement le code article
async function genererCode() {
  const select = document.getElementById('categorie_id');
  const codeInput = document.getElementById('code');
  
  if (!select.value) {
    codeInput.value = '';
    codeInput.placeholder = 'S√©lectionnez une cat√©gorie...';
    return;
  }
  
  try {
    const response = await fetch(`/api/v1/stock/api/generer-code/${select.value}`);
    const result = await response.json();
    
    if (result.success) {
      codeInput.value = result.data.code;
      showInfo(`Code g√©n√©r√© : ${result.data.code}`, 'Code Auto-g√©n√©r√©', 2000);
    } else {
      showError('Erreur lors de la g√©n√©ration du code');
    }
  } catch (error) {
    console.error('Erreur:', error);
    showError('Erreur lors de la g√©n√©ration du code');
  }
}

async function submitForm(event) {
  event.preventDefault();
  
  // Afficher l'overlay avec message personnalis√©
  showGlobalLoading('Enregistrement en cours...', 'Veuillez patienter');
  
  const formData = new FormData(event.target);
  const articleId = formData.get('article_id');
  
  // D√©terminer l'URL et la m√©thode selon cr√©ation ou modification
  const url = articleId 
    ? "{{ url_for('api_update_article', article_id=0) }}".replace('/0', `/${articleId}`)
    : "{{ url_for('api_create_article') }}";
  const method = articleId ? 'PUT' : 'POST';
  
  try {
    const response = await submitFormAsJson(url, formData, method, true);
    
    const result = await response.json();
    
    if (result.success) {
      // Changer le message de l'overlay pour la redirection
      showGlobalLoading('Redirection...', 'Article enregistr√© avec succ√®s');
      showSuccess(result.message);
      // L'overlay reste affich√© pendant la redirection
      setTimeout(() => {
        window.location.href = '{{ url_for("stock_articles") }}';
      }, 800);
    } else {
      // Masquer l'overlay SEULEMENT en cas d'erreur
      hideGlobalLoading();
      showError(result.error);
    }
  } catch (error) {
    // Masquer l'overlay SEULEMENT en cas d'erreur
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur lors de l\'enregistrement');
  }
}
</script>
</body>
{% endblock %}

