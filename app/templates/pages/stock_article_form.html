{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}{{ 'Modifier' if article else 'Nouvel' }} Article - Stocks - {{ app_name }}</body>
{% endblock %}

{% block styles %}
<!-- Styles centralis√©s dans cards.css, forms.css -->
</body>
{% endblock %}

{% block content %}
<body class="form-page-premium">
{{ page_header(
    title='üìù Modifier l\'Article' if article else '‚ûï Nouvel Article',
    breadcrumbs=[
        {'name': 'Stocks', 'url': url_for('stock_home')},
        {'name': 'Articles', 'url': url_for('stock_articles')},
        {'name': article.code if article else 'Nouveau'}
    ],
    actions=[
        {'label': '‚Üê Retour Articles', 'url': url_for('stock_articles'), 'primary': False}
    ]
) }}

<div class="page-grid">
  
  <!-- Formulaire -->
  <div class="card">
    <form id="articleForm" onsubmit="submitForm(event)">
      {% if article %}
      <input type="hidden" name="article_id" value="{{ article.id }}">
      {% endif %}
      
      <!-- Identification -->
      <h3 style="margin-bottom: 1.5rem; color: var(--secondary-color);">üè∑Ô∏è Identification</h3>
      <div class="form-grid" style="margin-bottom: 2rem;">
        <div class="form-group">
          <label class="form-label">Cat√©gorie *</label>
          <select name="categorie_id" id="categorie_id" class="form-select" required onchange="genererCode()">
            <option value="">-- S√©lectionner une cat√©gorie --</option>
            {% for cat in categories %}
            <option value="{{ cat.id }}" data-code="{{ cat.code }}" {{ 'selected' if article and article.categorie_id == cat.id else '' }}>
              {{ cat.libelle }}
            </option>
            {% endfor %}
          </select>
          <small style="color: var(--gray-600);">
            {% if article %}
              ‚ö†Ô∏è Changer la cat√©gorie r√©g√©n√©rera automatiquement le code
            {% else %}
              Le code sera g√©n√©r√© automatiquement
            {% endif %}
          </small>
        </div>
        
        <div class="form-group">
          <label class="form-label">Code Article *</label>
          <input type="text" name="code" id="code" class="form-input" required readonly
                 value="{{ article.code if article else '' }}"
                 placeholder="S√©lectionnez une cat√©gorie..."
                 style="background: var(--gray-100); cursor: not-allowed;">
          <small style="color: var(--gray-600);">G√©n√©r√© automatiquement</small>
        </div>
        
        <div class="form-group">
          <label class="form-label">D√©signation *</label>
          <input type="text" name="designation" class="form-input" required
                 value="{{ article.designation if article else '' }}"
                 placeholder="Ex: Ramette papier A4">
        </div>
        
        <div class="form-group">
          <label class="form-label">Unit√© *</label>
          <select name="unite" class="form-select" required>
            <option value="Unit√©" {{ 'selected' if not article or article.unite == 'Unit√©' else '' }}>Unit√©</option>
            <option value="Pi√®ce" {{ 'selected' if article and article.unite == 'Pi√®ce' else '' }}>Pi√®ce</option>
            <option value="Carton" {{ 'selected' if article and article.unite == 'Carton' else '' }}>Carton</option>
            <option value="Lot" {{ 'selected' if article and article.unite == 'Lot' else '' }}>Lot</option>
            <option value="Kg" {{ 'selected' if article and article.unite == 'Kg' else '' }}>Kg</option>
            <option value="Litre" {{ 'selected' if article and article.unite == 'Litre' else '' }}>Litre</option>
          </select>
        </div>
      </div>
      
      <!-- Stock & Prix -->
      <h3 style="margin-bottom: 1.5rem; color: var(--secondary-color);">üìä Stock & Prix</h3>
      <div class="form-grid" style="margin-bottom: 2rem;">
        <div class="form-group">
          <label class="form-label">Stock Minimum *</label>
          <input type="number" name="quantite_min" class="form-input" required min="0" step="0.01"
                 value="{{ article.quantite_min if article else '0' }}">
          <small style="color: var(--gray-600);">Seuil d'alerte de r√©approvisionnement</small>
        </div>
        
        <div class="form-group">
          <label class="form-label">Stock Maximum</label>
          <input type="number" name="quantite_max" class="form-input" min="0" step="0.01"
                 value="{{ article.quantite_max if article else '' }}">
          <small style="color: var(--gray-600);">Stock maximum recommand√©</small>
        </div>
        
        <div class="form-group">
          <label class="form-label">Prix Unitaire (FCFA)</label>
          <input type="number" name="prix_unitaire" class="form-input" min="0" step="1"
                 value="{{ article.prix_unitaire if article else '' }}"
                 placeholder="0">
        </div>
        
        <div class="form-group">
          <label class="form-label">Emplacement</label>
          <input type="text" name="emplacement" class="form-input"
                 value="{{ article.emplacement if article else '' }}"
                 placeholder="Ex: Magasin A - Rayon 3">
        </div>
      </div>
      
      <!-- Description -->
      <h3 style="margin-bottom: 1.5rem; color: var(--secondary-color);">üìù Description</h3>
      <div class="form-group" style="margin-bottom: 2rem;">
        <label class="form-label">Description d√©taill√©e</label>
        <textarea name="description" class="form-textarea" rows="4" 
                  placeholder="D√©tails suppl√©mentaires sur l'article...">{{ article.description if article else '' }}</textarea>
      </div>
      
      <!-- NOUVEAUT√â : Articles P√©rissables -->
      <h3 style="margin-bottom: 1.5rem; color: var(--secondary-color);">üçÉ Article P√©rissable</h3>
      <div style="margin-bottom: 2rem;">
        <div class="form-group" style="margin-bottom: 1rem;">
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="est_perissable" id="est_perissable" value="true" 
                   {{ 'checked' if article and article.est_perissable else '' }}
                   onchange="togglePerissableFields()"
                   style="width: 20px; height: 20px; cursor: pointer;">
            <span style="font-weight: 600; color: var(--text-color);">Cet article est p√©rissable (denr√©es, m√©dicaments, etc.)</span>
          </label>
          <small style="color: var(--gray-600); margin-left: 28px; display: block; margin-top: 0.25rem;">
            Les articles p√©rissables n√©cessitent un suivi par lot avec date de p√©remption
          </small>
        </div>
        
        <div id="perissable-fields" style="display: none; padding: 1.5rem; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">
          <div class="form-group">
            <label class="form-label">Seuil d'alerte p√©remption (jours)</label>
            <input type="number" name="seuil_alerte_peremption_jours" class="form-input" min="1" step="1"
                   value="{{ article.seuil_alerte_peremption_jours if article else '30' }}">
            <small style="color: var(--gray-600);">Alerte X jours avant p√©remption (d√©faut: 30 jours)</small>
          </div>
          
          <div style="background: #dbeafe; padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6; margin-top: 1rem;">
            <p style="color: #1e40af; margin: 0; line-height: 1.6;">
              <strong>üí° Note :</strong> La date de p√©remption sera saisie lors de la cr√©ation de chaque lot dans 
              <strong>"Stock ‚Üí Lots P√©rissables"</strong>
            </p>
          </div>
        </div>
      </div>
      
      <!-- NOUVEAUT√â : Amortissement -->
      <h3 style="margin-bottom: 1.5rem; color: var(--secondary-color);">üí∞ Amortissement du Mat√©riel</h3>
      <div style="margin-bottom: 2rem;">
        <div class="form-group" style="margin-bottom: 1rem;">
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="est_amortissable" id="est_amortissable" value="true"
                   {{ 'checked' if article and article.est_amortissable else '' }}
                   onchange="toggleAmortissableFields()"
                   style="width: 20px; height: 20px; cursor: pointer;">
            <span style="font-weight: 600; color: var(--text-color);">Cet article est amortissable (√©quipements, v√©hicules, etc.)</span>
          </label>
          <small style="color: var(--gray-600); margin-left: 28px; display: block; margin-top: 0.25rem;">
            Les articles amortissables n√©cessitent un suivi comptable de leur d√©pr√©ciation
          </small>
        </div>
        
        <div id="amortissable-fields" style="display: none; padding: 1.5rem; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;">
          <div class="form-grid" style="margin-bottom: 1rem;">
            <div class="form-group">
              <label class="form-label">Date d'acquisition</label>
              <input type="date" name="date_acquisition" class="form-input"
                     value="{{ article.date_acquisition if article else '' }}">
              <small style="color: var(--gray-600);">Date d'achat du mat√©riel</small>
            </div>
            
            <div class="form-group">
              <label class="form-label">Valeur d'acquisition (FCFA)</label>
              <input type="number" name="valeur_acquisition" class="form-input" min="0" step="1"
                     value="{{ article.valeur_acquisition if article else '' }}"
                     placeholder="0">
              <small style="color: var(--gray-600);">Prix d'achat initial</small>
            </div>
            
            <div class="form-group">
              <label class="form-label">Dur√©e d'amortissement (ann√©es)</label>
              <input type="number" name="duree_amortissement_annees" class="form-input" min="1" step="1"
                     value="{{ article.duree_amortissement_annees if article else '' }}"
                     placeholder="Ex: 3">
              <small style="color: var(--gray-600);">Dur√©e d'amortissement</small>
            </div>
            
            <div class="form-group">
              <label class="form-label">M√©thode d'amortissement</label>
              <select name="methode_amortissement" class="form-select">
                <option value="LINEAIRE" {{ 'selected' if not article or article.methode_amortissement == 'LINEAIRE' else '' }}>Lin√©aire</option>
                <option value="DEGRESSIF" {{ 'selected' if article and article.methode_amortissement == 'DEGRESSIF' else '' }}>D√©gressif</option>
              </select>
              <small style="color: var(--gray-600);">Mode de calcul</small>
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Taux d'amortissement (%)</label>
              <input type="number" name="taux_amortissement" class="form-input" min="0" max="100" step="0.01"
                     value="{{ article.taux_amortissement if article else '' }}"
                     placeholder="Ex: 33.33">
              <small style="color: var(--gray-600);">Pour m√©thode d√©gressive</small>
            </div>
            
            <div class="form-group">
              <label class="form-label">Valeur r√©siduelle (FCFA)</label>
              <input type="number" name="valeur_residuelle" class="form-input" min="0" step="1"
                     value="{{ article.valeur_residuelle if article else '' }}"
                     placeholder="0">
              <small style="color: var(--gray-600);">Valeur finale apr√®s amortissement</small>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Actions -->
      <div class="form-actions">
        <a href="{{ url_for('stock_articles') }}" class="btn btn-secondary">Annuler</a>
        <button type="submit" class="btn btn-primary">
          {{ 'üíæ Enregistrer' if article else '‚ûï Cr√©er l\'Article' }}
        </button>
      </div>
      
    </form>
  </div>
  
</div>
</body>
{% endblock %}

{% block scripts %}
<script>
// ========================================
// FERMER L'OVERLAY AU CHARGEMENT
// ========================================
document.addEventListener('DOMContentLoaded', function() {
  // S'assurer que l'overlay est ferm√© au chargement de la page
  const overlay = document.getElementById('globalLoadingOverlay');
  if (overlay) {
    overlay.classList.remove('show');
  }
  
  // Afficher les champs conditionnels si les checkboxes sont coch√©es
  togglePerissableFields();
  toggleAmortissableFields();
});

// ========================================
// GESTION DES CHAMPS CONDITIONNELS
// ========================================
function togglePerissableFields() {
  const checkbox = document.getElementById('est_perissable');
  const fields = document.getElementById('perissable-fields');
  
  if (checkbox.checked) {
    fields.style.display = 'block';
  } else {
    fields.style.display = 'none';
  }
}

function toggleAmortissableFields() {
  const checkbox = document.getElementById('est_amortissable');
  const fields = document.getElementById('amortissable-fields');
  
  if (checkbox.checked) {
    fields.style.display = 'block';
  } else {
    fields.style.display = 'none';
  }
}

// G√©n√©rer automatiquement le code article
async function genererCode() {
  const select = document.getElementById('categorie_id');
  const codeInput = document.getElementById('code');
  
  if (!select.value) {
    codeInput.value = '';
    codeInput.placeholder = 'S√©lectionnez une cat√©gorie...';
    return;
  }
  
  try {
    const response = await fetch(`/api/v1/stock/api/generer-code/${select.value}`);
    const result = await response.json();
    
    if (result.success) {
      codeInput.value = result.data.code;
      showInfo(`Code g√©n√©r√© : ${result.data.code}`, 'Code Auto-g√©n√©r√©', 2000);
    } else {
      showError('Erreur lors de la g√©n√©ration du code');
    }
  } catch (error) {
    console.error('Erreur:', error);
    showError('Erreur lors de la g√©n√©ration du code');
  }
}

async function submitForm(event) {
  event.preventDefault();
  
  // Afficher l'overlay avec message personnalis√©
  showGlobalLoading('Enregistrement en cours...', 'Veuillez patienter');
  
  const formData = new FormData(event.target);
  const articleId = formData.get('article_id');
  
  // D√©terminer l'URL et la m√©thode selon cr√©ation ou modification
  const url = articleId 
    ? "{{ url_for('api_update_article', article_id=0) }}".replace('/0', `/${articleId}`)
    : "{{ url_for('api_create_article') }}";
  const method = articleId ? 'PUT' : 'POST';
  
  try {
    const response = await fetch(url, {
      method: method,
      body: formData
    });
    
    const result = await response.json();
    
    if (result.success) {
      // Changer le message de l'overlay pour la redirection
      showGlobalLoading('Redirection...', 'Article enregistr√© avec succ√®s');
      showSuccess(result.message);
      // L'overlay reste affich√© pendant la redirection
      setTimeout(() => {
        window.location.href = '{{ url_for("stock_articles") }}';
      }, 800);
    } else {
      // Masquer l'overlay SEULEMENT en cas d'erreur
      hideGlobalLoading();
      showError(result.error);
    }
  } catch (error) {
    // Masquer l'overlay SEULEMENT en cas d'erreur
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur lors de l\'enregistrement');
  }
}
</script>
</body>
{% endblock %}

