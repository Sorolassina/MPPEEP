{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}Articles - Gestion des Stocks - {{ app_name }}</body>
{% endblock %}

{% block styles %}
<style>
/* R√©duction de la police du tableau */
.data-table {
    font-size: 0.85rem;
}

.data-table th,
.data-table td {
    padding: 0.6rem 0.75rem;
}

.data-table th {
    font-size: 0.8rem;
}
</style>
{% endblock %}

{% block content %}
<body class="form-page-premium">
{{ page_header(
    title='üì¶ Gestion des Articles',
    breadcrumbs=[
        {'name': 'Stocks', 'url': url_for('stock_home')},
        {'name': 'Articles'}
    ],
    actions=[
        {'label': '‚Üê Retour Stock', 'url': url_for('stock_home'), 'primary': False},
        {'label': '‚ûï Nouvel Article', 'url': url_for('stock_article_new'), 'primary': True}
    ]
) }}

<div class="page-grid">
  
  <!-- Tableau des articles -->
  <div class="card">
    <div style="margin-bottom: 1rem;">
      <h2 style="margin: 0;">Articles ({{ articles|length }})</h2>
    </div>
    
    <table class="data-table">
      <thead>
        <tr>
          <th>Code</th>
          <th>D√©signation</th>
          <th>Cat√©gorie</th>
          <th>Stock</th>
          <th>Stock Min</th>
          <th>Prix Unit.</th>
          <th>Valeur</th>
          <th>√âtat</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if articles %}
          {% for article in articles %}
          <tr>
            <td><strong>{{ article.code }}</strong></td>
            <td>{{ article.designation }}</td>
            <td>
              {% if article.categorie_id %}
                {% for cat in categories %}
                  {% if cat.id == article.categorie_id %}
                    {{ cat.libelle }}
                  {% endif %}
                {% endfor %}
              {% else %}
                -
              {% endif %}
            </td>
            <td>{{ article.quantite_stock }} {{ article.unite }}</td>
            <td>{{ article.quantite_min }} {{ article.unite }}</td>
            <td>{{ "{:,.0f}".format(article.prix_unitaire) if article.prix_unitaire else '-' }} F</td>
            <td>{{ "{:,.0f}".format(article.quantite_stock * article.prix_unitaire) if article.prix_unitaire else '-' }} F</td>
            <td>
              {% if article.quantite_stock <= article.quantite_min %}
                {% if article.quantite_stock == 0 %}
                  <span class="badge badge-danger">Rupture</span>
                {% else %}
                  <span class="badge badge-warning">Faible</span>
                {% endif %}
              {% else %}
                <span class="badge badge-success">OK</span>
              {% endif %}
            </td>
            <td>
              <div style="display: flex; gap: 0.5rem;">
                <button onclick="voirArticle({{ article.id }})" class="btn-action" title="Voir">
                  üëÅÔ∏è
                </button>
                <button onclick="modifierArticle({{ article.id }})" class="btn-action" title="Modifier">
                  ‚úèÔ∏è
                </button>
                <button onclick="supprimerArticle({{ article.id }}, '{{ article.designation }}')" class="btn-action btn-premium btn-danger" title="Supprimer">
                  üóëÔ∏è
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="9" style="text-align: center; padding: 2rem; color: var(--gray-500);">
              Aucun article enregistr√©
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  
</div>
</body>
{% endblock %}

{% block scripts %}
<script>
// ========================================
// FERMER L'OVERLAY AU CHARGEMENT
// ========================================
document.addEventListener('DOMContentLoaded', function() {
  // S'assurer que l'overlay est ferm√© au chargement de la page
  const overlay = document.getElementById('globalLoadingOverlay');
  if (overlay) {
    overlay.classList.remove('show');
  }
});

// Voir d√©tail d'un article
function voirArticle(articleId) {
  // Afficher l'overlay avant la navigation
  showGlobalLoading('Chargement des d√©tails...', 'Veuillez patienter');
  window.location.href = "{{ url_for('stock_article_detail', article_id=0) }}".replace('/0', `/${articleId}`);
}

// Modifier un article
function modifierArticle(articleId) {
  // Afficher l'overlay avant la navigation
  showGlobalLoading('Chargement du formulaire...', 'Veuillez patienter');
  window.location.href = "{{ url_for('stock_article_edit', article_id=0) }}".replace('/0', `/${articleId}`);
}

// Supprimer un article
async function supprimerArticle(articleId, designation) {
  if (!confirm(`√ätes-vous s√ªr de vouloir supprimer l'article "${designation}" ?\n\nCette action est irr√©versible.`)) {
    return;
  }
  
  // Afficher l'overlay avec message personnalis√©
  showGlobalLoading('Suppression en cours...', 'Veuillez patienter');
  
  try {
    const response = await fetch(`/api/v1/stock/api/articles/${articleId}`, {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (result.success) {
      showSuccess(result.message);
      // L'overlay reste affich√© pendant le rechargement
      setTimeout(() => {
        window.location.reload();
      }, 800);
    } else {
      // Masquer l'overlay SEULEMENT en cas d'erreur
      hideGlobalLoading();
      showError(result.error);
    }
  } catch (error) {
    // Masquer l'overlay SEULEMENT en cas d'erreur
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur lors de la suppression');
  }
}
</script>
</body>
{% endblock %}

