{% extends "layouts/base.html" %}

{% block title %}Dashboard</body>
{% endblock %}

{% block styles %}
<style>
background: #fff;
.pbi-frame-wrap::before {
background: linear-gradient(120deg, rgba(0,0,0,.02), rgba(0,0,0,0) 40%), var(--primary-light, #f7f9fc);
border-top-color: var(--primary-color, #4f46e5);
animation: pbi-spin 1s linear infinite;
.pbi-hint { margin-top: .75rem; font-size: .9rem; color: #555; text-align:center; }
@keyframes pbi-spin { to { transform: rotate(360deg); } }
</style>
</body>
{% endblock %}

{% block content %}
<body class="form-page-premium">
<div class="pbi-container">

  <div class="pbi-card">
    <div class="pbi-frame-wrap">
      <div id="pbiLoader" class="pbi-loader" aria-hidden="false">
        <div>
          <div class="pbi-spinner" aria-label="Chargement du rapport..."></div>
          <div class="pbi-hint">Chargement du rapport Power BI…</div>
        </div>
      </div>

      <!-- Iframe Publish to web (public) -->
      <iframe
        id="pbiFrame"
        class="pbi-frame"
        title="Rapport_budgetaire_Portefeuille"
        src="https://app.powerbi.com/view?r=eyJrIjoiMWY4MDBiYTMtZTRhZS00NGM5LTk4YTItNjMxMzAxMjM3MTljIiwidCI6IjgxMzg2OTIwLTdiMTItNDVkNi1hMTA4LTZlYWZkMzRkYjY3NSJ9"
        allowfullscreen
        loading="lazy"
        referrerpolicy="strict-origin-when-cross-origin">
      </iframe>
    </div>
  </div>
</div>
</body>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    const frame = document.getElementById('pbiFrame');
    const loader = document.getElementById('pbiLoader');
    const btnFs  = document.getElementById('btnFullscreen');

    frame.addEventListener('load', () => { if (loader) loader.style.display = 'none'; });

    btnFs?.addEventListener('click', () => {
      const wrap = frame.closest('.pbi-frame-wrap');
      if (!wrap) return;
      const req = wrap.requestFullscreen || wrap.webkitRequestFullscreen || wrap.msRequestFullscreen;
      req?.call(wrap);
    });

    // Sécurité : si l’iframe ne finit jamais de charger, on cache le loader au bout de 15s
    setTimeout(() => { if (loader && loader.style.display !== 'none') loader.style.display = 'none'; }, 15000);
  })();
</script>
</body>
{% endblock %}
