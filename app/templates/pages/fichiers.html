{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}Gestion des Fichiers - {{ app_name }}</body>
{% endblock %}

{% block styles %}
<style>
transition: all 0.3s;
.accordion-header:hover {
transition: transform 0.3s;
transition: max-height 0.3s ease-out;
transition: max-height 0.5s ease-in;
.accordion-body {
color: #333;
border: 1px solid #ddd;
border: 2px dashed #ddd;
transition: all 0.3s;
background: #f9f9f9;
.file-input-label:hover {
background: #f0f0f0;
background: #e8f5e9;
transition: all 0.3s;
.btn-upload:hover:not(:disabled) {
background: #ccc;
color: #666;
border: 1px solid #ddd;
background: #f5f5f5;
border-bottom: 1px solid #eee;
color: #333;
.files-table tbody tr:hover {
background: #f9f9f9;
background: #e3f2fd;
color: #1976d2;
background: #fff3e0;
color: #f57c00;
background: #e8f5e9;
color: #388e3c;
background: #ffebee;
color: #d32f2f;
background: #f5f5f5;
color: #757575;
transition: all 0.3s;
background: #2196f3;
.btn-view:hover {
background: #1976d2;
background: #ff9800;
.btn-reprocess:hover {
background: #f57c00;
background: #f44336;
.btn-delete:hover {
background: #d32f2f;
color: #666;
color: #999;
background: #e0e0e0;
transition: width 0.3s;
color: #666;
</style>
</body>
{% endblock %}

{% block content %}
<body class="form-page-premium">
{{ page_header(
    title='ğŸ“ Gestion des Fichiers',
    breadcrumbs=[
        {'name': 'Accueil', 'url': url_for('accueil')},
        {'name': 'Fichiers'}
    ]
) }}

<div class="files-container">

    <!-- Statistics -->
    <div class="stats-grid" id="statsGrid" style="display: none;">
        <!-- Stats will be loaded here -->
    </div>

    <!-- Upload Section -->
    <div class="upload-section" id="uploadSection">
        <div class="accordion-header" onclick="toggleAccordion()">
            <h2>
                <span>ğŸ“¤</span>
                <span>TÃ©lÃ©charger un nouveau fichier</span>
            </h2>
            <span class="accordion-icon" id="accordionIcon">â–¼</span>
        </div>
        <div class="accordion-content" id="accordionContent">
            <div class="accordion-body">
                <form id="uploadForm" class="upload-form" enctype="multipart/form-data">
            <!-- File Input -->
            <div class="form-group-premium">
                <label>Fichier Excel *</label>
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" name="file" accept=".xlsx,.xls" required>
                    <label for="fileInput" class="file-input-label" id="fileInputLabel">
                        <span>ğŸ“„ Cliquez pour sÃ©lectionner un fichier</span>
                    </label>
                </div>
            </div>

            <!-- Type de fichier -->
            <div class="form-group-premium">
                <label for="fileType">Type de fichier *</label>
                <select id="fileType" name="file_type" required>
                    <option value="">-- SÃ©lectionner --</option>
                    <option value="budget">ğŸ’° Budget</option>
                    <option value="depenses">ğŸ’¸ DÃ©penses</option>
                    <option value="revenus">ğŸ’µ Revenus</option>
                    <option value="personnel">ğŸ‘¥ Personnel</option>
                    <option value="rapport_activite">ğŸ“‹ Rapport d'activitÃ©</option>
                    <option value="beneficiaires">ğŸ‘¤ BÃ©nÃ©ficiaires</option>
                    <option value="indicateurs">ğŸ“Š Indicateurs</option>
                    <option value="autre">ğŸ“„ Autre</option>
                </select>
            </div>

            <!-- Programme -->
            <div class="form-group-premium">
                <label for="program">Programme *</label>
                <select id="program" name="program" required>
                    <option value="">-- SÃ©lectionner --</option>
                    <option value="education">ğŸ“ Ã‰ducation</option>
                    <option value="sante">ğŸ¥ SantÃ©</option>
                    <option value="agriculture">ğŸŒ¾ Agriculture</option>
                    <option value="infrastructure">ğŸ—ï¸ Infrastructure</option>
                    <option value="protection_sociale">ğŸ›¡ï¸ Protection sociale</option>
                    <option value="environnement">ğŸŒ± Environnement</option>
                    <option value="gouvernance">âš–ï¸ Gouvernance</option>
                    <option value="autre">ğŸ“‹ Autre</option>
                </select>
            </div>

            <!-- PÃ©riode -->
            <div class="form-group-premium">
                <label for="period">PÃ©riode *</label>
                <input type="text" id="period" name="period" placeholder="Ex: 2024-01, Q1-2024, 2024" required>
            </div>

            <!-- Titre -->
            <div class="form-group-premium">
                <label for="title">Titre *</label>
                <input type="text" id="title" name="title" placeholder="Ex: Budget annuel 2024" required>
            </div>

            <!-- Description -->
            <div class="form-group-premium">
                <label for="description">Description (optionnel)</label>
                <textarea id="description" name="description" placeholder="Description ou notes additionnelles..."></textarea>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn-upload" id="submitBtn">
                ğŸ“¤ TÃ©lÃ©charger et traiter
            </button>

            <!-- Progress Bar -->
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-bar-fill" id="progressBarFill" style="width: 0%;"></div>
            </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
        <div class="filter-group">
            <label for="filterType">Type</label>
            <select id="filterType" onchange="loadFiles()">
                <option value="">Tous</option>
                <option value="budget">Budget</option>
                <option value="depenses">DÃ©penses</option>
                <option value="revenus">Revenus</option>
                <option value="personnel">Personnel</option>
                <option value="rapport_activite">Rapport d'activitÃ©</option>
                <option value="beneficiaires">BÃ©nÃ©ficiaires</option>
                <option value="indicateurs">Indicateurs</option>
                <option value="autre">Autre</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="filterStatus">Statut</label>
            <select id="filterStatus" onchange="loadFiles()">
                <option value="">Tous</option>
                <option value="uploaded">TÃ©lÃ©chargÃ©</option>
                <option value="processing">En traitement</option>
                <option value="processed">TraitÃ©</option>
                <option value="error">Erreur</option>
                <option value="archived">ArchivÃ©</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="filterProgram">Programme</label>
            <select id="filterProgram" onchange="loadFiles()">
                <option value="">Tous</option>
                <option value="education">Ã‰ducation</option>
                <option value="sante">SantÃ©</option>
                <option value="agriculture">Agriculture</option>
                <option value="infrastructure">Infrastructure</option>
                <option value="protection_sociale">Protection sociale</option>
                <option value="environnement">Environnement</option>
                <option value="gouvernance">Gouvernance</option>
                <option value="autre">Autre</option>
            </select>
        </div>

        <button onclick="resetFilters()" class="btn-action btn-view">ğŸ”„ RÃ©initialiser</button>
    </div>

    <!-- Files List -->
    <div class="files-list">
        <h2>ğŸ“‹ Liste des fichiers</h2>
        <div id="filesTableContainer">
            <div class="loading">Chargement des fichiers...</div>
        </div>
    </div>
</div>
</body>
{% endblock %}

{% block scripts %}
<script>
// Toggle accordion
function toggleAccordion() {
    const content = document.getElementById('accordionContent');
    const icon = document.getElementById('accordionIcon');
    
    content.classList.toggle('open');
    icon.classList.toggle('open');
}

// File input handling
document.getElementById('fileInput').addEventListener('change', function(e) {
    const label = document.getElementById('fileInputLabel');
    if (e.target.files.length > 0) {
        const fileName = e.target.files[0].name;
        const fileSize = (e.target.files[0].size / (1024 * 1024)).toFixed(2);
        label.innerHTML = `<span>âœ… ${fileName} (${fileSize} MB)</span>`;
        label.classList.add('has-file');
    } else {
        label.innerHTML = '<span>ğŸ“„ Cliquez pour sÃ©lectionner un fichier</span>';
        label.classList.remove('has-file');
    }
});

// Upload form submission
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Masquer l'overlay global s'il est affichÃ©
    if (typeof hideGlobalLoading === 'function') {
        hideGlobalLoading();
    }
    
    const submitBtn = document.getElementById('submitBtn');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressBarFill');
    
    // Disable button
    submitBtn.disabled = true;
    submitBtn.textContent = 'â³ TÃ©lÃ©chargement en cours...';
    progressBar.style.display = 'block';
    progressFill.style.width = '30%';
    
    // Prepare form data
    const formData = new FormData(this);
    
    try {
        const response = await fetch('/api/v1/files/upload', {
            method: 'POST',
            body: formData
        });
        
        progressFill.style.width = '70%';
        
        if (response.ok) {
            const data = await response.json();
            progressFill.style.width = '100%';
            
            alert('âœ… Fichier tÃ©lÃ©chargÃ© avec succÃ¨s! Le traitement a dÃ©marrÃ©.');
            
            // Reset form
            this.reset();
            document.getElementById('fileInputLabel').innerHTML = '<span>ğŸ“„ Cliquez pour sÃ©lectionner un fichier</span>';
            document.getElementById('fileInputLabel').classList.remove('has-file');
            
            // Fermer l'accordÃ©on
            toggleAccordion();
            
            // Attendre un peu avant de rafraÃ®chir (laisser le temps au backend)
            setTimeout(() => {
                loadFiles();
                loadStatistics();
            }, 2000);
            
        } else {
            const error = await response.json();
            alert(`âŒ Erreur: ${error.detail || 'Erreur inconnue'}`);
        }
        
    } catch (error) {
        console.error('Upload error:', error);
        alert('âŒ Erreur lors du tÃ©lÃ©chargement: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ“¤ TÃ©lÃ©charger et traiter';
        progressBar.style.display = 'none';
        progressFill.style.width = '0%';
        
        // S'assurer que l'overlay est bien cachÃ©
        if (typeof hideGlobalLoading === 'function') {
            hideGlobalLoading();
        }
    }
});

// Load files list
async function loadFiles() {
    const container = document.getElementById('filesTableContainer');
    if (!container) return; // Protection si l'Ã©lÃ©ment n'existe pas
    
    container.innerHTML = '<div class="loading">Chargement des fichiers...</div>';
    
    // Get filters
    const filterType = document.getElementById('filterType')?.value || '';
    const filterStatus = document.getElementById('filterStatus')?.value || '';
    const filterProgram = document.getElementById('filterProgram')?.value || '';
    
    // Build query string
    let query = '/api/v1/files/list_files?limit=100';
    if (filterType) query += `&file_type=${filterType}`;
    if (filterStatus) query += `&status=${filterStatus}`;
    if (filterProgram) query += `&program=${filterProgram}`;
    
    try {
        const response = await fetch(query);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.files && data.files.length > 0) {
            renderFilesTable(data.files);
            
            // VÃ©rifier s'il y a des fichiers en traitement
            hasProcessingFiles = checkProcessingFiles(data.files);
            
            if (hasProcessingFiles) {
                startAutoRefresh(); // Activer l'auto-refresh
            } else {
                stopAutoRefresh(); // DÃ©sactiver l'auto-refresh
            }
        } else {
            container.innerHTML = '<div class="empty-state">Aucun fichier trouvÃ©</div>';
            hasProcessingFiles = false;
            stopAutoRefresh();
        }
    } catch (error) {
        console.error('Error loading files:', error);
        container.innerHTML = `<div class="empty-state">âŒ Erreur lors du chargement: ${error.message}</div>`;
    }
}

// Render files table
function renderFilesTable(files) {
    const container = document.getElementById('filesTableContainer');
    
    let html = `
        <table class="files-table">
            <thead>
                <tr>
                    <th>Fichier</th>
                    <th>Type</th>
                    <th>Programme</th>
                    <th>PÃ©riode</th>
                    <th>Statut</th>
                    <th>Taille</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    files.forEach(file => {
        const statusClass = `status-${file.status}`;
        const date = new Date(file.created_at).toLocaleDateString('fr-FR');
        
        html += `
            <tr>
                <td title="${file.original_filename}">
                    <strong>${file.title}</strong><br>
                    <small>${file.original_filename}</small>
                </td>
                <td>${formatFileType(file.file_type)}</td>
                <td>${formatProgram(file.program)}</td>
                <td>${file.period}</td>
                <td><span class="status-badge ${statusClass}">${formatStatus(file.status)}</span></td>
                <td>${file.file_size_mb} MB</td>
                <td>${date}</td>
                <td>
                    <div class="file-actions">
                        <button class="btn-action btn-view" onclick="viewFile(${file.id})" title="Voir dÃ©tails">ğŸ‘ï¸</button>
                        ${file.status === 'error' ? `<button class="btn-action btn-reprocess" onclick="reprocessFile(${file.id})" title="Retraiter">ğŸ”„</button>` : ''}
                        <button class="btn-action btn-delete" onclick="deleteFile(${file.id})" title="Supprimer">ğŸ—‘ï¸</button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += `
            </tbody>
        </table>
    `;
    
    container.innerHTML = html;
}

// Format helpers
function formatFileType(type) {
    const types = {
        'budget': 'ğŸ’° Budget',
        'depenses': 'ğŸ’¸ DÃ©penses',
        'revenus': 'ğŸ’µ Revenus',
        'personnel': 'ğŸ‘¥ Personnel',
        'rapport_activite': 'ğŸ“‹ Rapport',
        'beneficiaires': 'ğŸ‘¤ BÃ©nÃ©ficiaires',
        'indicateurs': 'ğŸ“Š Indicateurs',
        'autre': 'ğŸ“„ Autre'
    };
    return types[type] || type;
}

function formatProgram(program) {
    const programs = {
        'education': 'ğŸ“ Ã‰ducation',
        'sante': 'ğŸ¥ SantÃ©',
        'agriculture': 'ğŸŒ¾ Agriculture',
        'infrastructure': 'ğŸ—ï¸ Infrastructure',
        'protection_sociale': 'ğŸ›¡ï¸ Protection sociale',
        'environnement': 'ğŸŒ± Environnement',
        'gouvernance': 'âš–ï¸ Gouvernance',
        'autre': 'ğŸ“‹ Autre'
    };
    return programs[program] || program;
}

function formatStatus(status) {
    const statuses = {
        'uploaded': 'TÃ©lÃ©chargÃ©',
        'processing': 'En traitement',
        'processed': 'TraitÃ©',
        'error': 'Erreur',
        'archived': 'ArchivÃ©'
    };
    return statuses[status] || status;
}

// File actions
async function viewFile(fileId) {
    window.location.href = `/api/v1/files/get_file/${fileId}`;
}

async function reprocessFile(fileId) {
    if (!confirm('Voulez-vous vraiment retraiter ce fichier?')) return;
    
    try {
        const response = await fetch(`/api/v1/files/reprocess_file/${fileId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            alert('âœ… Retraitement lancÃ©!');
            loadFiles();
        } else {
            alert('âŒ Erreur lors du retraitement');
        }
    } catch (error) {
        console.error('Reprocess error:', error);
        alert('âŒ Erreur');
    }
}

async function deleteFile(fileId) {
    if (!confirm('Voulez-vous vraiment supprimer ce fichier? Cette action est irrÃ©versible.')) return;
    
    try {
        const response = await fetch(`/api/v1/files/delete_file/${fileId}`, {
            method: 'DELETE'
        });
        
        if (response.ok || response.status === 204) {
            alert('âœ… Fichier supprimÃ©!');
            loadFiles();
            loadStatistics();
        } else {
            alert('âŒ Erreur lors de la suppression');
        }
    } catch (error) {
        console.error('Delete error:', error);
        alert('âŒ Erreur');
    }
}

// Load statistics
async function loadStatistics() {
    try {
        const response = await fetch('/api/v1/files/get_statistics');
        const stats = await response.json();
        
        const statsGrid = document.getElementById('statsGrid');
        statsGrid.style.display = 'grid';
        
        statsGrid.innerHTML = `
            <div class="stat-card">
                <h3>${stats.total_files}</h3>
                <p>Fichiers total</p>
            </div>
            <div class="stat-card">
                <h3>${stats.files_by_status.processed || 0}</h3>
                <p>TraitÃ©s</p>
            </div>
            <div class="stat-card">
                <h3>${stats.files_by_status.processing || 0}</h3>
                <p>En traitement</p>
            </div>
            <div class="stat-card">
                <h3>${stats.total_size_mb} MB</h3>
                <p>Espace utilisÃ©</p>
            </div>
        `;
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

// Reset filters
function resetFilters() {
    document.getElementById('filterType').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterProgram').value = '';
    loadFiles();
}

// Variable pour suivre les fichiers en traitement
let hasProcessingFiles = false;
let autoRefreshInterval = null;

// Fonction pour vÃ©rifier s'il y a des fichiers en traitement
function checkProcessingFiles(files) {
    return files.some(file => file.status === 'processing' || file.status === 'uploaded');
}

// DÃ©marrer l'auto-refresh si nÃ©cessaire
function startAutoRefresh() {
    if (autoRefreshInterval) return; // DÃ©jÃ  actif
    
    console.log('ğŸ”„ Auto-refresh activÃ© (fichiers en traitement)');
    autoRefreshInterval = setInterval(() => {
        if (!document.hidden && hasProcessingFiles) {
            console.log('ğŸ”„ RafraÃ®chissement automatique...');
            loadFiles();
        } else if (!hasProcessingFiles && autoRefreshInterval) {
            // Plus de fichiers en traitement, arrÃªter l'auto-refresh
            stopAutoRefresh();
        }
    }, 10000); // Toutes les 10 secondes
}

// ArrÃªter l'auto-refresh
function stopAutoRefresh() {
    if (autoRefreshInterval) {
        console.log('â¸ï¸ Auto-refresh dÃ©sactivÃ© (plus de fichiers en traitement)');
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// Initial load
document.addEventListener('DOMContentLoaded', function() {
    loadFiles();
    loadStatistics();
});
</script>
</body>
{% endblock %}

