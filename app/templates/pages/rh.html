{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}RH – Administration Publique · {{ app_name }}
{% endblock %}

{% block styles %}
<style>
/* ========== RH PAGE STYLES ========== */
.rh-container {
    padding: 2rem 0;
    background: #f8f9fa;
    min-height: 100vh;
}

/* Bannière de démonstration */
.demo-notice {
    margin-bottom: 2rem;
    padding: 1rem;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.demo-banner {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.demo-icon {
    font-size: 1.2rem;
}

.demo-text {
    font-weight: 600;
    color: white;
    font-size: 1.1rem;
}

.demo-description {
    color: rgba(255, 255, 255, 0.9);
    margin: 0;
    font-size: 0.95rem;
}

/* KPIs */
.kpis {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.kpi {
    background: white;
    padding: 1.5rem;
    border-radius: 15px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    text-align: center;
    transition: all 0.3s;
    border: 2px solid transparent;
}

.kpi:hover {
    background: #fff;
    transform: translateY(-2px);
    box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.1);
    border-color: var(--primary-color);
}

.kpi .label {
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.kpi .val {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-color);
}

/* Les actions sont maintenant dans l'en-tête */

/* Badges d'état */
.badge-state {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge-state.draft { background: #adb5bd; color: white; }
.badge-state.submitted { background: #0dcaf0; color: white; }
.badge-state.validation { background: #ffc107; color: white; }
.badge-state.signature { background: #fd7e14; color: white; }
.badge-state.archived { background: #198754; color: white; }
.badge-state.rejected { background: #dc3545; color: white; }
</style>
{% endblock %}

{% block content %}
{{ page_header(
    title='📋 Gestion des Ressources Humaines',
    breadcrumbs=[
        {'name': 'Accueil', 'url': url_for('accueil')},
        {'name': 'Ressources Humaines'}
    ],
    actions=[
        {'label': '← Retour Accueil', 'url': url_for('accueil'), 'primary': False},
        {'label': '📝 Nouvelle demande', 'url': url_for('rh_new_demande'), 'primary': False, 'disabled': current_user.is_guest},
        {'label': '👥 Personnel', 'url': url_for('personnel_home'), 'primary': False, 'disabled': current_user.is_guest},
        {'label': '📊 Besoins agents', 'url': url_for('besoins_home'), 'primary': True, 'disabled': current_user.is_guest}
    ]
) }}

<div class="rh-container container">
  {% if current_user.is_guest %}
  <div class="demo-notice">
    <div class="demo-banner">
      <span class="demo-icon">🎯</span>
      <span class="demo-text">Mode Démonstration - Données fictives</span>
    </div>
    <p class="demo-description">
      Vous êtes en mode invité. Les données affichées sont des exemples pour vous permettre de découvrir l'interface.
    </p>
  </div>
  {% endif %}

  <!-- KPIs et Actions -->
  <div class="card">
    <h2 style="margin: 0 0 1.5rem 0; color: #000000; font-size: 1.3rem;">📊 Statistiques et Indicateurs</h2>
    
    <!-- KPIs Agents -->
    <h3 style="font-size: 1rem; margin: 1rem 0 0.5rem 0; color: #000000;">👥 Effectifs</h3>
    <div class="kpis">
      <div class="kpi">
        <div class="label">Total Agents</div>
        <div class="val" id="kpi-total-agents">—</div>
      </div>
      <div class="kpi">
        <div class="label">Agents Actifs</div>
        <div class="val" id="kpi-actifs">—</div>
      </div>
    </div>
    
    <!-- KPIs Demandes -->
    <h3 style="font-size: 1rem; margin: 1rem 0 0.5rem 0; color: #000000;">📋 Demandes</h3>
    <div class="kpis">
      <div class="kpi">
        <div class="label">Total Demandes</div>
        <div class="val" id="kpi-total-demandes">—</div>
      </div>
      <div class="kpi">
        <div class="label">En Cours</div>
        <div class="val" id="kpi-demandes-cours">—</div>
      </div>
      <div class="kpi">
        <div class="label">Archivées</div>
        <div class="val" id="kpi-demandes-archivees">—</div>
      </div>
      <div class="kpi">
        <div class="label">Taux Traitement</div>
        <div class="val" id="kpi-taux-traitement">—</div>
      </div>
    </div>
    
    <!-- Circuit - En attente par état (dynamique) -->
    <h3 style="font-size: 1rem; margin: 1rem 0 0.5rem 0; color: #000000;">🔄 Circuit de Validation</h3>
    <div class="kpis" id="kpis-etats">
      <!-- Sera peuplé dynamiquement -->
    </div>

    </div>

  <!-- Évolution des effectifs -->
  <div class="card chart-card">
    <h3>📈 Évolution des effectifs par année</h3>
      <canvas id="chart-evolution" height="120"></canvas>
  </div>

  <!-- Répartition par grade -->
  <div class="card chart-card">
    <h3>🎯 Répartition par grade</h3>
      <canvas id="chart-grade" height="180"></canvas>
    </div>

  <!-- Répartition par service -->
  <div class="card chart-card">
    <h3>🏢 Répartition par service</h3>
      <canvas id="chart-service" height="180"></canvas>
    </div>

  <!-- Satisfaction besoins -->
  <div class="card chart-card">
    <h3>⭐ Satisfaction besoins d'actes</h3>
      <canvas id="chart-satisfaction" height="160"></canvas>
  </div>

  <!-- Liste des demandes récentes -->
  <div class="card">
    <h3>📋 Demandes Récentes ({{ demandes|length }})</h3>
    
    {% if demandes and demandes|length > 0 %}
    <div class="data-table">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Type</th>
          <th>Objet</th>
          <th>Agent</th>
          <th>État</th>
          <th>Créée le</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for d in demandes %}
        <tr>
          <td><strong>#{{ d.id }}</strong></td>
          <td><span class="badge-type">{{ d.type }}</span></td>
          <td>
            {{ d.objet }}
            {% if d.document_joint %}<span title="Document joint">📎</span>{% endif %}
            {% if d.acte_type %}<br><small style="color: #000000;">{{ d.acte_type.value }}</small>{% endif %}
          </td>
          <td>#{{ d.agent_id }}</td>
          <td>
            {% set state_class = 'draft' %}
            {% if 'Soumis' in d.current_state %}{% set state_class = 'submitted' %}
            {% elif 'Validation' in d.current_state %}{% set state_class = 'validation' %}
            {% elif 'Signature' in d.current_state %}{% set state_class = 'signature' %}
            {% elif 'Archivé' in d.current_state %}{% set state_class = 'archived' %}
            {% elif 'Rejeté' in d.current_state %}{% set state_class = 'rejected' %}
            {% endif %}
            <span class="badge-state {{ state_class }}">{{ d.current_state.value }}</span>
            {% if d.current_assignee_role %}
            <br><small style="color: #000000;">→ {{ d.current_assignee_role }}</small>
            {% endif %}
          </td>
          <td style="font-size: 0.85rem;">
            {{ d.created_at.strftime('%d/%m/%Y') if d.created_at else '—' }}<br>
            <small style="color: #000000;">{{ d.created_at.strftime('%H:%M') if d.created_at else '' }}</small>
          </td>
          <td>
            <div class="action-icons">
              <a href="{{ url_for('rh_demande_detail', request_id=d.id) }}" class="action-icon" title="Voir les détails">
                👁️
              </a>
              <span class="action-icon" onclick="supprimerDemande({{ d.id }})" title="Supprimer" style="cursor: pointer;">
                🗑️
              </span>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
    {% else %}
    <div class="empty-state">
      <div class="empty-state-icon">📭</div>
      <p><strong>Aucune demande pour le moment</strong></p>
      <p>Les demandes apparaîtront ici</p>
    </div>
    {% endif %}
  </div>
  
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Activer l'overlay pour le bouton retour
document.addEventListener('DOMContentLoaded', function() {
  const btnBack = document.querySelector('.btn-back');
  if (btnBack) {
    btnBack.addEventListener('click', function(e) {
      e.preventDefault();
      const overlay = document.getElementById('globalLoadingOverlay');
      if (overlay) {
        overlay.querySelector('.loading-text').textContent = 'Retour à l\'accueil...';
        overlay.querySelector('.loading-subtext').textContent = 'Veuillez patienter';
        overlay.classList.add('show');
      }
      setTimeout(() => {
        window.location.href = this.href;
      }, 300);
    });
  }
});

async function getJSON(url){ 
  const r = await fetch(url, {headers:{'Accept':'application/json'}}); 
  return r.json(); 
}

(async ()=>{
  try {
  // KPIs
    const k = await getJSON("{{ url_for('rh_home') }}api/kpis".replace(/\/$/, ""));
    console.log('📊 KPIs reçus:', k);
    
    // KPIs Agents
    document.getElementById('kpi-total-agents').textContent = k.total_agents ?? 0;
  document.getElementById('kpi-actifs').textContent = k.actifs ?? 0;
    
    // KPIs Demandes
    document.getElementById('kpi-total-demandes').textContent = k.total_demandes ?? 0;
    document.getElementById('kpi-demandes-cours').textContent = k.demandes_en_cours ?? 0;
    document.getElementById('kpi-demandes-archivees').textContent = k.demandes_archivees ?? 0;
    document.getElementById('kpi-taux-traitement').textContent = `${k.taux_traitement ?? 0}%`;
    
    // Circuit - En attente par état (dynamique)
    const kpisEtatsContainer = document.getElementById('kpis-etats');
    kpisEtatsContainer.innerHTML = ''; // Vider
    
    if (k.demandes_par_etat && Object.keys(k.demandes_par_etat).length > 0) {
      // Filtrer pour ne garder que les états de validation en attente
      const etatsValidation = ['Validation N+1', 'Validation N+2', 'Validation N+3', 'Validation N+4', 'Validation N+5', 'Validation N+6', 'Soumis'];
      
      Object.entries(k.demandes_par_etat).forEach(([etat, count]) => {
        if (etatsValidation.includes(etat)) {
          const kpiDiv = document.createElement('div');
          kpiDiv.className = 'kpi';
          kpiDiv.innerHTML = `
            <div class="label">⏳ ${etat}</div>
            <div class="val">${count}</div>
          `;
          kpisEtatsContainer.appendChild(kpiDiv);
        }
      });
    } else {
      kpisEtatsContainer.innerHTML = '<div style="color: #666; padding: 1rem;">Aucune demande en attente</div>';
    }

  // Évolution
  const evo = await getJSON("{{ url_for('rh_home') }}api/evolution".replace(/\/$/, ""));
  new Chart(document.getElementById('chart-evolution').getContext('2d'), {
    type:'line',
    data:{
      labels: evo.map(x=>x.annee),
      datasets:[{label:'Effectif', data:evo.map(x=>x.effectif)}]
    }
  });

  // Grade
  const grd = await getJSON("{{ url_for('rh_home') }}api/grade".replace(/\/$/, ""));
  new Chart(document.getElementById('chart-grade').getContext('2d'), {
    type:'bar',
    data:{ labels: grd.map(x=>x.grade), datasets:[{label:'Agents', data: grd.map(x=>x.nb)}] }
  });

  // Service
  const svc = await getJSON("{{ url_for('rh_home') }}api/service".replace(/\/$/, ""));
  new Chart(document.getElementById('chart-service').getContext('2d'), {
    type:'bar',
    data:{ labels: svc.map(x=>x.service), datasets:[{label:'Agents', data: svc.map(x=>x.nb)}] }
  });

    // Satisfaction exprimés vs satisfaits
    const sat = await getJSON("{{ url_for('rh_home') }}api/satisfaction-besoins".replace(/\/$/, ""));
    new Chart(document.getElementById('chart-satisfaction').getContext('2d'), {
      type:'bar',
      data:{
        labels:['Exprimés','Satisfaits'],
        datasets:[{label:'Besoins', data:[sat.exprimes, sat.satisfaits]}]
      }
    });
    
  } catch(error) {
    console.error('❌ Erreur chargement données RH:', error);
  }
})();

// Fonction pour supprimer une demande
async function supprimerDemande(demandeId) {
  if (!confirm('⚠️ Êtes-vous sûr de vouloir supprimer cette demande ?\n\nCette action est irréversible.')) {
    return;
  }
  
  showGlobalLoading('Suppression en cours...', 'Veuillez patienter');
  
  try {
    const res = await fetch(`/api/v1/rh/api/demandes/${demandeId}`, {
      method: 'DELETE',
      headers: {'Accept': 'application/json'}
    });
    
    const data = await res.json();
    
    if (res.ok && data.ok) {
      showGlobalLoading('✅ Demande supprimée', 'Actualisation de la page...');
      setTimeout(() => location.reload(), 500);
    } else {
      hideGlobalLoading();
      await handleFetchError(res, 'Impossible de supprimer cette demande');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur réseau. Vérifiez votre connexion.');
  }
}
</script>
</body>
{% endblock %}
