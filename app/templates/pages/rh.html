{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}RH â€“ Administration Publique Â· {{ app_name }}
{% endblock %}

{% block styles %}{% endblock %}

{% block content %}
{{ page_header(
    title='ğŸ“‹ Gestion des Ressources Humaines',
    breadcrumbs=[
        {'name': 'Accueil', 'url': url_for('accueil')},
        {'name': 'Ressources Humaines'}
    ],
    actions=[
        {'label': 'â† Retour Accueil', 'url': url_for('accueil'), 'primary': False},
        {'label': 'ğŸ“ Nouvelle demande', 'url': url_for('rh_new_demande'), 'primary': False, 'disabled': current_user.is_guest},
        {'label': 'ğŸ‘¥ Personnel', 'url': url_for('personnel_home'), 'primary': False, 'disabled': current_user.is_guest},
        {'label': 'ğŸ“Š Besoins agents', 'url': url_for('besoins_home'), 'primary': True, 'disabled': current_user.is_guest}
    ]
) }}

<div class="rh-page">
  {% if current_user.is_guest %}
  <div class="notice-banner">
    <span class="banner-icon">ğŸ¯</span>
    <div class="banner-content">
      <strong>Mode DÃ©monstration</strong>
      <p>Vous consultez des donnÃ©es fictives afin d'explorer les fonctionnalitÃ©s RH.</p>
    </div>
  </div>
  {% endif %}

  <!-- KPIs et Circuit -->
  <section class="rh-overview">
    <header class="section-header">
      <div class="section-header-icon">ğŸ“Š</div>
      <div class="section-header-text">
        <h2>Statistiques et indicateurs</h2>
        <p>Suivi de lâ€™effectif et de lâ€™activitÃ© des demandes RH.</p>
      </div>
    </header>

    <div class="rh-kpi-grid">
      <article class="rh-kpi-card">
        <span class="rh-kpi-label">Total agents</span>
        <span class="rh-kpi-value" id="kpi-total-agents">â€”</span>
        <span class="rh-kpi-sub">Effectifs dÃ©clarÃ©s</span>
      </article>
      <article class="rh-kpi-card">
        <span class="rh-kpi-label">Agents actifs</span>
        <span class="rh-kpi-value" id="kpi-actifs">â€”</span>
        <span class="rh-kpi-sub">PrÃ©sents ce mois</span>
      </article>
      <article class="rh-kpi-card">
        <span class="rh-kpi-label">Demandes en cours</span>
        <span class="rh-kpi-value" id="kpi-demandes-cours">â€”</span>
        <span class="rh-kpi-sub">Actions nÃ©cessaires</span>
      </article>
      <article class="rh-kpi-card">
        <span class="rh-kpi-label">Taux de traitement</span>
        <span class="rh-kpi-value" id="kpi-taux-traitement">â€”</span>
        <span class="rh-kpi-sub">Demandes clÃ´turÃ©es</span>
      </article>
    </div>

    <div class="rh-circuit">
      <header class="circuit-header">
        <div class="section-header-icon">ğŸ”„</div>
        <div class="section-header-text">
          <h3>Circuit de validation</h3>
          <p>Demande en attente par Ã©tape</p>
        </div>
      </header>
      <div class="rh-circuit-grid" id="kpis-etats">
        <!-- alimentÃ© via JS -->
      </div>
    </div>
  </section>

  <!-- Ã‰volution des effectifs -->
  <section class="rh-chart-card">
    <header class="section-header">
      <div class="section-header-icon">ğŸ“ˆ</div>
      <div class="section-header-text">
        <h3>Ã‰volution des effectifs</h3>
        <p>Suivi annuel du nombre dâ€™agents</p>
      </div>
    </header>
    <canvas id="chart-evolution" height="120"></canvas>
  </section>

  <!-- RÃ©partition par grade -->
  <section class="rh-chart-card">
    <header class="section-header">
      <div class="section-header-icon">ğŸ¯</div>
      <div class="section-header-text">
        <h3>RÃ©partition par grade</h3>
        <p>Visualisation des positions internes</p>
      </div>
    </header>
    <canvas id="chart-grade" height="180"></canvas>
  </section>

  <!-- RÃ©partition par service -->
  <section class="rh-chart-card">
    <header class="section-header">
      <div class="section-header-icon">ğŸ¢</div>
      <div class="section-header-text">
        <h3>RÃ©partition par service</h3>
        <p>FiliÃ¨res administratives principales</p>
      </div>
    </header>
    <canvas id="chart-service" height="180"></canvas>
  </section>

  <!-- Satisfaction besoins -->
  <section class="rh-chart-card">
    <header class="section-header">
      <div class="section-header-icon">â­</div>
      <div class="section-header-text">
        <h3>Satisfaction des besoins</h3>
        <p>Comparaison des besoins exprimÃ©s vs satisfaits</p>
      </div>
    </header>
    <canvas id="chart-satisfaction" height="160"></canvas>
  </section>

  <!-- Liste des demandes rÃ©centes -->
  <section class="rh-table-card">
    <header class="section-header">
      <div class="section-header-icon">ğŸ“‹</div>
      <div class="section-header-text">
        <h3>Demandes rÃ©centes ({{ demandes|length }})</h3>
        <p>DerniÃ¨res actions soumises par les agents</p>
      </div>
    </header>
    {% if demandes and demandes|length > 0 %}
    <div class="data-table">
    <table class="rh-data-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Type</th>
          <th>Objet</th>
          <th>Agent</th>
          <th>Ã‰tat</th>
          <th>CrÃ©Ã©e le</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for d in demandes %}
        <tr>
          <td><strong>#{{ d.id }}</strong></td>
          <td><span class="badge-type">{{ d.type }}</span></td>
          <td>
            {{ d.objet }}
            {% if d.document_joint %}<span title="Document joint">ğŸ“</span>{% endif %}
            {% if d.acte_type %}<br><small class="text-muted">{{ d.acte_type.value }}</small>{% endif %}
          </td>
          <td>#{{ d.agent_id }}</td>
          <td>
            {% set state_class = 'draft' %}
            {% if 'Soumis' in d.current_state %}{% set state_class = 'submitted' %}
            {% elif 'Validation' in d.current_state %}{% set state_class = 'validation' %}
            {% elif 'Signature' in d.current_state %}{% set state_class = 'signature' %}
            {% elif 'ArchivÃ©' in d.current_state %}{% set state_class = 'archived' %}
            {% elif 'RejetÃ©' in d.current_state %}{% set state_class = 'rejected' %}
            {% endif %}
            <span class="badge-state {{ state_class }}">{{ d.current_state.value }}</span>
            {% if d.current_assignee_role %}
            <br><small class="text-muted">â†’ {{ d.current_assignee_role }}</small>
            {% endif %}
          </td>
          <td class="text-small">
            {{ d.created_at.strftime('%d/%m/%Y') if d.created_at else 'â€”' }}<br>
            <small class="text-muted">{{ d.created_at.strftime('%H:%M') if d.created_at else '' }}</small>
          </td>
          <td>
            <div class="action-icons">
              <a href="{{ url_for('rh_demande_detail', request_id=d.id) }}" class="btn-action btn-premium btn-primary btn-compact" title="Voir les dÃ©tails">
                ğŸ‘ï¸
              </a>
              <button
                type="button"
                class="btn-action btn-premium btn-danger btn-compact"
                data-delete-url="{{ url_for('api_delete_rh_demande', demande_id=d.id) }}"
                onclick="supprimerDemande(this)"
                title="Supprimer"
              >
                ğŸ—‘ï¸
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
    {% else %}
    <div class="empty-state">
      <div class="empty-state-icon">ğŸ“­</div>
      <p><strong>Aucune demande pour le moment</strong></p>
      <p>Les demandes apparaÃ®tront ici dÃ¨s leur soumission.</p>
    </div>
    {% endif %}
  </section>
  
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Activer l'overlay pour le bouton retour
document.addEventListener('DOMContentLoaded', function() {
  const btnBack = document.querySelector('.btn-back');
  if (btnBack) {
    btnBack.addEventListener('click', function(e) {
      e.preventDefault();
      const overlay = document.getElementById('globalLoadingOverlay');
      if (overlay) {
        overlay.querySelector('.loading-text').textContent = 'Retour Ã  l\'accueil...';
        overlay.querySelector('.loading-subtext').textContent = 'Veuillez patienter';
        overlay.classList.add('show');
      }
      setTimeout(() => {
        window.location.href = this.href;
      }, 300);
    });
  }
});

async function getJSON(url){ 
  const r = await fetch(url, {headers:{'Accept':'application/json'}}); 
  return r.json(); 
}

(async ()=>{
  try {
  // KPIs
    const k = await getJSON("{{ url_for('rh_home') }}api/kpis".replace(/\/$/, ""));
    console.log('ğŸ“Š KPIs reÃ§us:', k);
    
    // KPIs Agents
    document.getElementById('kpi-total-agents').textContent = k.total_agents ?? 0;
  document.getElementById('kpi-actifs').textContent = k.actifs ?? 0;
    
    // KPIs Demandes
    document.getElementById('kpi-total-demandes').textContent = k.total_demandes ?? 0;
    document.getElementById('kpi-demandes-cours').textContent = k.demandes_en_cours ?? 0;
    document.getElementById('kpi-demandes-archivees').textContent = k.demandes_archivees ?? 0;
    document.getElementById('kpi-taux-traitement').textContent = `${k.taux_traitement ?? 0}%`;
    
    // Circuit - En attente par Ã©tat (dynamique)
    const kpisEtatsContainer = document.getElementById('kpis-etats');
    kpisEtatsContainer.innerHTML = ''; // Vider
    
    if (k.demandes_par_etat && Object.keys(k.demandes_par_etat).length > 0) {
      // Filtrer pour ne garder que les Ã©tats de validation en attente
      const etatsValidation = ['Validation N+1', 'Validation N+2', 'Validation N+3', 'Validation N+4', 'Validation N+5', 'Validation N+6', 'Soumis'];
      
      Object.entries(k.demandes_par_etat).forEach(([etat, count]) => {
        if (etatsValidation.includes(etat)) {
          const kpiDiv = document.createElement('div');
          kpiDiv.className = 'kpi';
          kpiDiv.innerHTML = `
            <div class="label">â³ ${etat}</div>
            <div class="val">${count}</div>
          `;
          kpisEtatsContainer.appendChild(kpiDiv);
        }
      });
    } else {
      kpisEtatsContainer.innerHTML = '<div style="color: #666; padding: 1rem;">Aucune demande en attente</div>';
    }

  // Ã‰volution
  const evo = await getJSON("{{ url_for('rh_home') }}api/evolution".replace(/\/$/, ""));
  new Chart(document.getElementById('chart-evolution').getContext('2d'), {
    type:'line',
    data:{
      labels: evo.map(x=>x.annee),
      datasets:[{label:'Effectif', data:evo.map(x=>x.effectif)}]
    }
  });

  // Grade
  const grd = await getJSON("{{ url_for('rh_home') }}api/grade".replace(/\/$/, ""));
  new Chart(document.getElementById('chart-grade').getContext('2d'), {
    type:'bar',
    data:{ labels: grd.map(x=>x.grade), datasets:[{label:'Agents', data: grd.map(x=>x.nb)}] }
  });

  // Service
  const svc = await getJSON("{{ url_for('rh_home') }}api/service".replace(/\/$/, ""));
  new Chart(document.getElementById('chart-service').getContext('2d'), {
    type:'bar',
    data:{ labels: svc.map(x=>x.service), datasets:[{label:'Agents', data: svc.map(x=>x.nb)}] }
  });

    // Satisfaction exprimÃ©s vs satisfaits
    const sat = await getJSON("{{ url_for('rh_home') }}api/satisfaction-besoins".replace(/\/$/, ""));
    new Chart(document.getElementById('chart-satisfaction').getContext('2d'), {
      type:'bar',
      data:{
        labels:['ExprimÃ©s','Satisfaits'],
        datasets:[{label:'Besoins', data:[sat.exprimes, sat.satisfaits]}]
      }
    });
    
  } catch(error) {
    console.error('âŒ Erreur chargement donnÃ©es RH:', error);
  }
})();

// Fonction pour supprimer une demande
async function supprimerDemande(button) {
  const demandeId = button.dataset.deleteUrl.split('/').pop(); // RÃ©cupÃ©rer l'ID de la demande
  if (!confirm('âš ï¸ ÃŠtes-vous sÃ»r de vouloir supprimer cette demande ?\n\nCette action est irrÃ©versible.')) {
    return;
  }
  
  showGlobalLoading('Suppression en cours...', 'Veuillez patienter');
  
  try {
    const res = await fetch(button.dataset.deleteUrl, {
      method: 'DELETE',
      headers: {'Accept': 'application/json'}
    });
    
    const data = await res.json();
    
    if (res.ok && data.ok) {
      showGlobalLoading('âœ… Demande supprimÃ©e', 'Actualisation de la page...');
      setTimeout(() => location.reload(), 500);
    } else {
      hideGlobalLoading();
      await handleFetchError(res, 'Impossible de supprimer cette demande');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur rÃ©seau. VÃ©rifiez votre connexion.');
  }
}
</script>
</body>
{% endblock %}
