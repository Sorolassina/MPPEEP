{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}Gestion des Utilisateurs{% endblock %}

{% block content %}
{{ page_header(
    title='👥 Gestion des Utilisateurs',
    breadcrumbs=[
        {'name': 'Accueil', 'url': url_for('accueil')},
        {'name': 'Administration'},
        {'name': 'Utilisateurs'}
    ],
    actions=[
        {'label': '❓ Aide', 'url': url_for('aide_utilisateurs'), 'primary': False},
        {'label': '➕ Nouvel Utilisateur', 'onclick': 'openCreateModal()', 'primary': True}
    ]
) }}

<div class="users-management">
    <!-- Messages -->
    <div id="message-container"></div>

    <!-- Statistiques rapides -->
    <div class="stats-grid">
        <div class="stat-card white">
            <div class="stat-icon">👥</div>
            <div class="stat-content">
                <div class="stat-label">Total Utilisateurs</div>
                <div class="stat-value">{{ users|length }}</div>
            </div>
        </div>
        <div class="stat-card white">
            <div class="stat-icon">✅</div>
            <div class="stat-content">
                <div class="stat-label">Comptes Actifs</div>
                <div class="stat-value">{{ users|selectattr('is_active')|list|length }}</div>
            </div>
        </div>
        <div class="stat-card white">
            <div class="stat-icon">👑</div>
            <div class="stat-content">
                <div class="stat-label">Administrateurs</div>
                <div class="stat-value">{{ users|selectattr('type_user', 'equalto', 'admin')|list|length }}</div>
            </div>
        </div>
        <div class="stat-card white">
            <div class="stat-icon">🔧</div>
            <div class="stat-content">
                <div class="stat-label">Modérateurs</div>
                <div class="stat-value">{{ users|selectattr('type_user', 'equalto', 'moderator')|list|length }}</div>
            </div>
        </div>
    </div>

    <!-- Tableau des utilisateurs -->
    <div class="card">
        {% if users %}
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Photo</th>
                        <th>ID</th>
                        <th>Nom</th>
                        <th>Email</th>
                        <th>Type</th>
                        <th>Statut</th>
                        <th>Créé le</th>
                        <th class="actions-col">Actions</th>
                    </tr>
                </thead>
                <tbody id="users-tbody">
                    {% for user in users %}
                    <tr class="{% if not user.is_active %}disabled{% endif %}" data-user-id="{{ user.id }}">
                        <td class="text-center">
                            <img src="{{ profile_picture_url(user) }}" alt="Photo {{ user.full_name or user.email }}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                        </td>
                        <td>#{{ user.id }}</td>
                        <td><strong>{{ user.full_name or '-' }}</strong></td>
                        <td>{{ user.email }}</td>
                        <td>
                            <span class="badge badge-{{ user.type_user }}">
                                {{ user.type_user }}
                            </span>
                        </td>
                        <td>
                            {% if user.is_active %}
                                <span class="status-badge status-active">✓ Actif</span>
                            {% else %}
                                <span class="status-badge status-inactive">✗ Inactif</span>
                            {% endif %}
                        </td>
                        <td>{{ user.created_at|format_date }}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn-icon" title="Modifier photo" onclick="openPhotoModal({{ user.id }}, '{{ user.full_name or user.email }}')">
                                    📸
                                </button>
                                <button class="btn-icon" title="Modifier" onclick="openEditModal({{ user.id }})">
                                    ✏️
                                </button>
                                <button class="btn-icon btn-danger" title="Supprimer" onclick="deleteUser({{ user.id }}, '{{ user.email }}')">
                                    🗑️
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <p>Aucun utilisateur trouvé</p>
        </div>
        {% endif %}
    </div>

    <!-- Bouton retour -->
    <div class="actions-footer">
        <a href="{{ url_for('accueil') }}" class="btn btn-secondary">
            ← Retour à l'accueil
        </a>
    </div>
</div>

<!-- Modal Créer Utilisateur -->
<div id="createModal" class="modal" >
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="color: var(--white-color);">➕ Créer un Utilisateur</h3>
            <span class="modal-close" onclick="closeModals()">&times;</span>
        </div>
        <form id="createUserForm" onsubmit="createUser(event)">
            <div class="form-group">
                <label>Email *</label>
                <input type="email" name="email" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Nom complet *</label>
                <input type="text" name="full_name" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Mot de passe *</label>
                <input type="password" name="password" class="form-control" required minlength="6">
            </div>
            <div class="form-group">
                <label>Type d'utilisateur</label>
                <select name="type_user" class="form-control">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                    <option value="moderator">Moderator</option>
                    <option value="guest">Guest</option>
                </select>
            </div>
            <div class="form-group checkbox-group">
                <label>
                    <input type="checkbox" name="is_active" checked>
                    Compte actif
                </label>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModals()">Annuler</button>
                <button type="submit" class="btn btn-primary">Créer</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Upload Photo de Profil -->
<div id="photoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="color: var(--white-color);>📸 Photo de Profil</h3>
            <span class="modal-close" onclick="closeModals()">&times;</span>
        </div>
        <div class="photo-upload-container">
            <input type="hidden" id="photo-user-id">
            <div class="current-photo">
                <h4>Photo actuelle</h4>
                <img id="current-photo-preview" src="" alt="Photo actuelle" class="photo-preview">
                <p id="photo-user-name" class="text-muted"></p>
            </div>
            <div class="new-photo">
                <h4>Nouvelle photo</h4>
                <label for="photo-upload" class="btn btn-secondary">
                    📁 Choisir une photo
                </label>
                <input type="file" id="photo-upload" accept="image/*" style="display: none;" onchange="uploadUserPhoto(this)">
                <p class="help-text">JPG, PNG, GIF, WEBP - Max 2MB</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Modifier Utilisateur -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="color: var(--white-color);">✏️ Modifier l'Utilisateur</h3>
            <span class="modal-close" onclick="closeModals()">&times;</span>
        </div>
        <form id="editUserForm" onsubmit="updateUser(event)">
            <input type="hidden" name="user_id" id="edit-user-id">
            <div class="form-group">
                <label>Email *</label>
                <input type="email" name="email" id="edit-email" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Nom complet *</label>
                <input type="text" name="full_name" id="edit-full-name" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Nouveau mot de passe (laisser vide pour ne pas changer)</label>
                <input type="password" name="password" id="edit-password" class="form-control" minlength="6">
            </div>
            <div class="form-group">
                <label>Type d'utilisateur</label>
                <select name="type_user" id="edit-type-user" class="form-control">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                    <option value="moderator">Moderator</option>
                    <option value="guest">Guest</option>
                </select>
            </div>
            <div class="form-group checkbox-group">
                <label>
                    <input type="checkbox" name="is_active" id="edit-is-active">
                    Compte actif
                </label>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModals()">Annuler</button>
                <button type="submit" class="btn btn-primary">Modifier</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block styles %}
<style>
/* Styles spécifiques pour la gestion des utilisateurs */
.users-management {
    max-width: 1400px;
    margin: 0 auto;
    padding: 1rem;
}

#message-container {
    margin-bottom: 1rem;
}

.photo-upload-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    padding: 1rem;
}

.current-photo, .new-photo {
    text-align: center;
}

.photo-preview {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    object-fit: cover;
    margin: 1rem auto;
    display: block;
    border: 3px solid var(--gray-300);
}

.actions-footer {
    margin-top: 2rem;
    text-align: center;
}

@media (max-width: 768px) {
    .photo-upload-container {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Fonctions pour l'overlay de chargement (utilise l'overlay global de base.html)
function showLoading(message = 'Traitement en cours...', subtext = 'Veuillez patienter') {
    const overlay = document.getElementById('globalLoadingOverlay');
    if (overlay) {
        const loadingText = overlay.querySelector('.loading-text');
        const loadingSubtext = overlay.querySelector('.loading-subtext');
        if (loadingText) loadingText.textContent = message;
        if (loadingSubtext) loadingSubtext.textContent = subtext;
        overlay.classList.add('show');
    }
}

function hideLoading() {
    const overlay = document.getElementById('globalLoadingOverlay');
    if (overlay) {
        overlay.classList.remove('show');
    }
}

// Fonction pour recharger la page automatiquement après succès
// L'overlay reste visible pendant la redirection et ne se ferme qu'au rechargement
function reloadAfterSuccess(message, delay = 1500) {
    showMessage(message, 'success');
    showMessage('🔄 Actualisation automatique...', 'info');
    showLoading('Actualisation...', 'Mise à jour de la page en cours');
    // NE PAS appeler hideLoading() - l'overlay reste visible jusqu'au rechargement
    setTimeout(() => {
        location.reload(true);  // true = force reload sans cache
    }, delay);
}

// Fonctions pour les modaux
function openCreateModal() {
    document.getElementById('createModal').classList.add('show');
    document.getElementById('createUserForm').reset();
}

async function openEditModal(userId) {
    showLoading('Chargement...', 'Récupération des données utilisateur');
    
    try {
        const response = await fetch("{{ url_for('get_user_api', user_id=0) }}".replace('/0', `/${userId}`));
        const data = await response.json();
        
        hideLoading();
        
        if (data.success) {
            document.getElementById('edit-user-id').value = data.user.id;
            document.getElementById('edit-email').value = data.user.email;
            document.getElementById('edit-full-name').value = data.user.full_name;
            document.getElementById('edit-type-user').value = data.user.type_user;
            document.getElementById('edit-is-active').checked = data.user.is_active;
            document.getElementById('edit-password').value = '';
            
            document.getElementById('editModal').classList.add('show');
        } else {
            showMessage(data.message, 'error');
        }
    } catch (error) {
        hideLoading();
        showMessage('Erreur lors du chargement des données', 'error');
    }
}

function closeModals() {
    document.getElementById('createModal').classList.remove('show');
    document.getElementById('editModal').classList.remove('show');
    document.getElementById('photoModal').classList.remove('show');
}

// Ouvrir le modal de photo
async function openPhotoModal(userId, userName) {
    showLoading('Chargement...', 'Récupération des données utilisateur');
    
    try {
        const response = await fetch("{{ url_for('get_user_api', user_id=0) }}".replace('/0', `/${userId}`));
        const data = await response.json();
        
        hideLoading();
        
        if (data.success) {
            document.getElementById('photo-user-id').value = userId;
            document.getElementById('photo-user-name').textContent = userName;
            
            // Afficher la photo actuelle ou placeholder
            const photoPreview = document.getElementById('current-photo-preview');
            if (data.user.profile_picture) {
                photoPreview.src = `/uploads/${data.user.profile_picture}`;
                photoPreview.style.display = 'block';
            } else {
                photoPreview.src = '/static/images/default-avatar.svg';
                photoPreview.style.display = 'block';
            }
            
            document.getElementById('photoModal').classList.add('show');
        } else {
            showMessage(data.message, 'error');
        }
    } catch (error) {
        hideLoading();
        showMessage('Erreur lors du chargement des données', 'error');
    }
}

// Upload de la photo de profil
async function uploadUserPhoto(input) {
    if (!input.files || !input.files[0]) {
        return;
    }
    
    const file = input.files[0];
    const userId = document.getElementById('photo-user-id').value;
    
    // Vérifier la taille (2MB max)
    if (file.size > 2 * 1024 * 1024) {
        showMessage('Le fichier est trop volumineux (max 2MB)', 'error');
        input.value = '';
        return;
    }
    
    const formData = new FormData();
    formData.append('photo', file);
    
    closeModals();
    showLoading('Upload...', `Téléchargement de ${file.name} en cours`);
    
    try {
        const response = await fetch("{{ url_for('upload_user_photo_api', user_id=0) }}".replace('/0', `/${userId}`), {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // NE PAS fermer l'overlay - il reste visible pendant le rechargement
            reloadAfterSuccess(data.message);
        } else {
            hideLoading();
            showMessage(data.message, 'error');
        }
    } catch (error) {
        hideLoading();
        showMessage('Erreur lors de l\'upload', 'error');
    }
    
    input.value = '';
}

// Fermer le modal en cliquant en dehors
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        closeModals();
    }
}

// Créer un utilisateur
async function createUser(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    closeModals();
    showLoading('Création...', 'Création de l\'utilisateur en cours');
    
    try {
        const response = await fetch("{{ url_for('create_user_api') }}", {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // NE PAS fermer l'overlay - il reste visible pendant le rechargement
            reloadAfterSuccess(data.message);
        } else {
            hideLoading();
            showMessage(data.message, 'error');
        }
    } catch (error) {
        hideLoading();
        showMessage('Erreur lors de la création', 'error');
    }
}

// Modifier un utilisateur
async function updateUser(event) {
    event.preventDefault();
    const form = event.target;
    const userId = form.querySelector('[name="user_id"]').value;
    const formData = new FormData(form);
    
    closeModals();
    showLoading('Modification...', 'Mise à jour de l\'utilisateur en cours');
    
    try {
        const response = await fetch(`/api/v1/admin/users/${userId}/update`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // NE PAS fermer l'overlay - il reste visible pendant le rechargement
            reloadAfterSuccess(data.message);
        } else {
            hideLoading();
            showMessage(data.message, 'error');
        }
    } catch (error) {
        hideLoading();
        showMessage('Erreur lors de la modification', 'error');
    }
}

// Supprimer un utilisateur
async function deleteUser(userId, email) {
    if (!confirm(`Êtes-vous sûr de vouloir supprimer l'utilisateur ${email} ?`)) {
        return;
    }
    
    showLoading('Suppression...', `Suppression de ${email} en cours`);
    
    try {
        const response = await fetch(`/api/v1/admin/users/${userId}/delete`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            // NE PAS fermer l'overlay - il reste visible pendant le rechargement
            reloadAfterSuccess(data.message);
        } else {
            hideLoading();
            showMessage(data.message, 'error');
        }
    } catch (error) {
        hideLoading();
        showMessage('Erreur lors de la suppression', 'error');
    }
}

// Afficher un message
function showMessage(message, type) {
    const container = document.getElementById('message-container');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.textContent = message;
    
    container.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}
