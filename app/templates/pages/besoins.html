{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}Suivi des Besoins en Agents - {{ app_name }}
{% endblock %}

{% block styles %}{% endblock %}

{% block content %}
{{ page_header(
    title='üìä Suivi des Besoins en Agents',
    breadcrumbs=[
        {'name': 'Accueil', 'url': url_for('accueil')},
        {'name': 'RH', 'url': url_for('rh_home')},
        {'name': 'Besoins en Agents'}
    ],
    actions=[
        {'label': '‚Üê Retour RH', 'url': url_for('rh_home'), 'primary': False},
        {'label': '‚ûï Nouveau Besoin', 'url': url_for('besoin_nouveau'), 'primary': True}
    ]
) }}

<div class="besoins-page">

  <section class="needs-overview">
    <div class="needs-overview-header">
      <div class="needs-overview-icon">üßë‚Äçü§ù‚Äçüßë</div>
      <div class="needs-overview-text">
        <h2>Anticipez vos besoins en effectifs</h2>
        <p>Suivez les demandes exprim√©es, mesurez leur satisfaction et priorisez les recrutements critiques.</p>
      </div>
    </div>
    <div class="needs-kpi-grid">
      <article class="needs-kpi-card">
        <span class="needs-kpi-label">Total besoins</span>
        <span class="needs-kpi-value">{{ total_besoins }}</span>
        <span class="needs-kpi-meta">Demandes enregistr√©es</span>
      </article>
      <article class="needs-kpi-card warning">
        <span class="needs-kpi-label">Agents demand√©s</span>
        <span class="needs-kpi-value">{{ total_demande }}</span>
        <span class="needs-kpi-meta">Volumes exprim√©s</span>
      </article>
      <article class="needs-kpi-card success">
        <span class="needs-kpi-label">Agents obtenus</span>
        <span class="needs-kpi-value">{{ total_obtenu }}</span>
        <span class="needs-kpi-meta">Affectations valid√©es</span>
      </article>
      <article class="needs-kpi-card neutral">
        <span class="needs-kpi-label">Taux de satisfaction</span>
        <span class="needs-kpi-value">{{ taux_satisfaction }}%</span>
        <span class="needs-kpi-meta">Couverture globale</span>
      </article>
    </div>
  </section>

  <section class="needs-filters filters-panel">
    <div class="filters-header">
      <div class="filters-heading">
        <span class="filters-icon">üß≠</span>
        <div class="filters-text">
          <h3>Param√®tres d'analyse</h3>
          <p>Affinez la liste selon l'ann√©e budg√©taire et le statut de traitement.</p>
        </div>
      </div>
      <div class="filters-actions">
        <a href="{{ url_for('besoins_consolidation') }}" class="btn btn-premium btn-secondary">
          üìã Vue consolid√©e
        </a>
      </div>
    </div>
    <div class="filters-row">
      <div class="filter-group">
        <label class="filter-label" for="filter-annee">Ann√©e</label>
        <select id="filter-annee" class="filter-select" onchange="filtrerBesoins()">
          <option value="{{ annee_actuelle }}" selected>{{ annee_actuelle }}</option>
          <option value="{{ annee_actuelle - 1 }}">{{ annee_actuelle - 1 }}</option>
          <option value="{{ annee_actuelle - 2 }}">{{ annee_actuelle - 2 }}</option>
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label" for="filter-statut">Statut</label>
        <select id="filter-statut" class="filter-select" onchange="filtrerBesoins()">
          <option value="">Tous</option>
          <option value="Exprim√©">Exprim√©</option>
          <option value="Transmis">Transmis</option>
          <option value="En attente">En attente</option>
          <option value="Partiellement satisfait">Partiellement satisfait</option>
          <option value="Satisfait">Satisfait</option>
          <option value="Rejet√©">Rejet√©</option>
        </select>
      </div>
    </div>
  </section>

  <section class="needs-table-card">
    <header class="needs-section-header">
      <div class="needs-section-icon">üìã</div>
      <div>
        <h3>Liste des besoins</h3>
        <p>Visualisez les demandes par service et suivez leur avancement.</p>
      </div>
    </header>

    <div class="table-container">
      <table class="data-table table-compact needs-table">
        <thead>
          <tr>
            <th>Service</th>
            <th>Poste</th>
            <th>Grade</th>
            <th>Demand√©</th>
            <th>Obtenu</th>
            <th>Satisfaction</th>
            <th>Urgence</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="besoins-tbody">
          {% if besoins %}
            {% for b in besoins %}
            {% set progress = (b.nombre_obtenu / b.nombre_demande * 100) if b.nombre_demande > 0 else 0 %}
            {% set statut_class = b.statut|lower|replace(' ', '-')|replace('√©', 'e')|replace('√®', 'e') %}
            {% set urgence_value = b.urgence or 'Non d√©fini' %}
            {% set urgence_class = urgence_value|lower|replace(' ', '-')|replace('√©', 'e')|replace('√®', 'e') %}
            <tr>
              <td>
                {% if b.service_id and b.service_id in services %}
                <div class="needs-cell">
                  <strong class="needs-strong">{{ services[b.service_id].code }}</strong>
                  <span class="needs-meta">{{ services[b.service_id].libelle }}</span>
                </div>
                {% else %}
                <span class="needs-empty">‚Äî</span>
                {% endif %}
              </td>
              <td>
                <div class="needs-cell">
                  <strong class="needs-strong">{{ b.poste_libelle }}</strong>
                  {% if b.periode %}
                  <span class="needs-meta">{{ b.periode }}</span>
                  {% endif %}
                </div>
              </td>
              <td>
                {% if b.grade_id and b.grade_id in grades %}
                <span class="needs-badge badge-info">{{ grades[b.grade_id].code }}</span>
                {% elif b.categorie_souhaitee %}
                <span class="needs-badge badge-warning">Cat. {{ b.categorie_souhaitee }}</span>
                {% else %}
                <span class="needs-empty">‚Äî</span>
                {% endif %}
              </td>
              <td><span class="needs-amount">{{ b.nombre_demande }}</span></td>
              <td><span class="needs-amount needs-amount-success">{{ b.nombre_obtenu }}</span></td>
              <td>
                <div class="needs-progress">
                  <div class="needs-progress-bar">
                    <div class="needs-progress-fill {% if progress < 50 %}low{% elif progress < 100 %}medium{% else %}high{% endif %}" style="--progress-value: {{ progress|round(2) }};">
                      {{ progress|round(0)|int }}%
                    </div>
                  </div>
                </div>
              </td>
              <td>
                <span class="badge-urgence {{ urgence_class }}">{{ urgence_value }}</span>
              </td>
              <td>
                <span class="badge-statut {{ statut_class }}">{{ b.statut }}</span>
              </td>
              <td>
                <div class="table-actions table-actions-compact">
                  <button type="button" class="btn-action btn-premium btn-primary btn-compact needs-action" data-need-action="detail" data-need-id="{{ b.id }}" title="Voir d√©tail">üëÅÔ∏è</button>
                  <button type="button" class="btn-action btn-premium btn-secondary btn-compact needs-action" data-need-action="update" data-need-id="{{ b.id }}" title="Mettre √† jour">üìù</button>
                  <button type="button" class="btn-action btn-premium btn-danger btn-compact needs-action" data-need-action="delete" data-need-id="{{ b.id }}" title="Supprimer">üóëÔ∏è</button>
                </div>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="9">
                <div class="empty-state">
                  <div class="empty-state-icon">üì≠</div>
                  <p class="empty-state-title"><strong>Aucun besoin exprim√© pour {{ annee_actuelle }}</strong></p>
                  <p class="empty-state-message">Commencez par exprimer un besoin</p>
                </div>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </section>

</div>

<!-- Modal Mise √† jour -->
<div id="updateModal" class="modal modal-xl">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üìù Mettre √† jour le besoin</h2>
      <button class="modal-close" onclick="closeUpdateModal()">&times;</button>
    </div>

    <form id="updateForm" class="needs-update-form" onsubmit="handleUpdate(event)">
      <div class="modal-body">
        <div class="modal-form-grid">
          <div class="form-group">
            <label for="update-nombre-obtenu">Nombre obtenu</label>
            <input type="number" name="nombre_obtenu" id="update-nombre-obtenu" min="0" required>
            <span class="form-help">Agents effectivement obtenus</span>
          </div>

          <div class="form-group">
            <label for="update-statut">Statut</label>
            <select name="statut" id="update-statut">
              <option value="Exprim√©">Exprim√©</option>
              <option value="Transmis">Transmis au Minist√®re</option>
              <option value="En attente">En attente de r√©ponse</option>
              <option value="Partiellement satisfait">Partiellement satisfait</option>
              <option value="Satisfait">Satisfait</option>
              <option value="Rejet√©">Rejet√©</option>
            </select>
          </div>

          <div class="form-group">
            <label for="update-date-transmission">Date de transmission</label>
            <input type="date" name="date_transmission" id="update-date-transmission">
            <span class="form-help">Date d'envoi au Minist√®re de la Fonction Publique</span>
          </div>

          <div class="form-group full">
            <label for="update-observations">Observations</label>
            <textarea name="observations" id="update-observations" rows="3" placeholder="Commentaires sur l'√©volution du besoin..."></textarea>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeUpdateModal()">Annuler</button>
        <button type="submit" class="btn btn-primary">üíæ Enregistrer</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal D√©tail -->
<div id="detailModal" class="modal modal-xl">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üìä D√©tail du besoin</h2>
      <button class="modal-close" onclick="closeDetailModal()">&times;</button>
    </div>

    <div class="modal-body needs-detail-container" id="detail-content">
      <!-- Rempli dynamiquement -->
    </div>
  </div>
</div>

</body>
{% endblock %}

{% block scripts %}
<script>
let currentBesoinId = null;

// Bouton retour avec overlay
document.addEventListener('DOMContentLoaded', function() {
  const btnBack = document.querySelector('.btn-back');
  if (btnBack) {
    btnBack.addEventListener('click', function(e) {
      e.preventDefault();
      showGlobalLoading('Retour √† RH...', 'Veuillez patienter');
      setTimeout(() => {
        window.location.href = this.href;
      }, 300);
    });
  }
});

document.addEventListener('click', function(event) {
  const trigger = event.target.closest('.needs-action');
  if (!trigger) {
    return;
  }

  const action = trigger.dataset.needAction;
  const id = Number(trigger.dataset.needId);

  if (Number.isNaN(id)) {
    return;
  }

  if (action === 'detail') {
    voirDetail(id);
  } else if (action === 'update') {
    mettreAJour(id);
  } else if (action === 'delete') {
    supprimerBesoin(id);
  }
});

// Filtrer les besoins
async function filtrerBesoins() {
  const annee = document.getElementById('filter-annee').value;
  const statut = document.getElementById('filter-statut').value;
  
  showGlobalLoading('Filtrage...', 'Recherche des besoins');
  
  try {
    let url = "{{ url_for('list_besoins_api') }}" + `?annee=${annee}`;
    if (statut) url += `&statut=${encodeURIComponent(statut)}`;
    
    const response = await fetch(url);
    const besoins = await response.json();
    
    const tbody = document.getElementById('besoins-tbody');
    
    if (besoins.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="9">
            <div class="empty-state">
              <div class="empty-state-icon">üì≠</div>
              <p><strong>Aucun besoin trouv√©</strong></p>
              <p>Modifiez les filtres ou cr√©ez un nouveau besoin</p>
            </div>
          </td>
        </tr>
      `;
    } else {
      tbody.innerHTML = besoins.map(b => {
        const progress = b.nombre_demande > 0 ? Math.round((b.nombre_obtenu / b.nombre_demande) * 100) : 0;
        const progressValue = Math.max(0, Math.min(progress, 100));
        const progressClass = progressValue < 50 ? 'low' : progressValue < 100 ? 'medium' : 'high';
        const statutClass = (b.statut || '').toLowerCase().replace(/ /g, '-').replace(/√©/g, 'e').replace(/√®/g, 'e');
        const urgenceLabel = b.urgence || 'Non d√©fini';
        const urgenceClass = urgenceLabel.toLowerCase().replace(/ /g, '-').replace(/√©/g, 'e').replace(/√®/g, 'e');
        const gradeBadge = b.grade_code
          ? `<span class="needs-badge badge-info">${b.grade_code}</span>`
          : (b.categorie_souhaitee ? `<span class="needs-badge badge-warning">Cat. ${b.categorie_souhaitee}</span>` : `<span class="needs-empty">‚Äî</span>`);
        const serviceSection = b.service_libelle
          ? `
              <div class="needs-cell">
                <strong class="needs-strong">${b.service_code || '‚Äî'}</strong>
                <span class="needs-meta">${b.service_libelle}</span>
              </div>
            `
          : '<span class="needs-empty">‚Äî</span>';
        const periodeLabel = b.periode ? `<span class="needs-meta">${b.periode}</span>` : '';

        return `
          <tr>
            <td>${serviceSection}</td>
            <td>
              <div class="needs-cell">
                <strong class="needs-strong">${b.poste_libelle}</strong>
                ${periodeLabel}
              </div>
            </td>
            <td>${gradeBadge}</td>
            <td><span class="needs-amount">${b.nombre_demande}</span></td>
            <td><span class="needs-amount needs-amount-success">${b.nombre_obtenu}</span></td>
            <td>
              <div class="needs-progress">
                <div class="needs-progress-bar">
                  <div class="needs-progress-fill ${progressClass}" style="--progress-value: ${progressValue};">
                    ${progressValue}%
                  </div>
                </div>
              </div>
            </td>
            <td><span class="badge-urgence ${urgenceClass}">${urgenceLabel}</span></td>
            <td><span class="badge-statut ${statutClass}">${b.statut}</span></td>
            <td>
              <div class="table-actions table-actions-compact">
                <button type="button" class="btn-action btn-premium btn-primary btn-compact needs-action" data-need-action="detail" data-need-id="${b.id}" title="Voir d√©tail">üëÅÔ∏è</button>
                <button type="button" class="btn-action btn-premium btn-secondary btn-compact needs-action" data-need-action="update" data-need-id="${b.id}" title="Mettre √† jour">üìù</button>
                <button type="button" class="btn-action btn-premium btn-danger btn-compact needs-action" data-need-action="delete" data-need-id="${b.id}" title="Supprimer">üóëÔ∏è</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }
    
    hideGlobalLoading();
  } catch (error) {
    console.error('Erreur:', error);
    showError('Erreur lors du filtrage');
  }
}

// Voir d√©tail d'un besoin
async function voirDetail(besoinId) {
  showGlobalLoading('Chargement...', 'R√©cup√©ration des d√©tails');
  
  try {
    const response = await fetch("{{ url_for('list_besoins_api') }}");
    const besoins = await response.json();
    const besoin = besoins.find(b => b.id === besoinId);
    
    if (!besoin) {
      showError('Besoin non trouv√©');
      return;
    }
    
    const progress = besoin.nombre_demande > 0 ? Math.round((besoin.nombre_obtenu / besoin.nombre_demande) * 100) : 0;
    const progressValue = Math.max(0, Math.min(progress, 100));
    const progressClass = progressValue < 50 ? 'low' : progressValue < 100 ? 'medium' : 'high';
    const statutClass = (besoin.statut || '').toLowerCase().replace(/ /g, '-').replace(/√©/g, 'e').replace(/√®/g, 'e');
    const urgenceLabel = besoin.urgence || 'Non d√©fini';
    const urgenceClass = urgenceLabel.toLowerCase().replace(/ /g, '-').replace(/√©/g, 'e').replace(/√®/g, 'e');
    const periodeLabel = besoin.periode ? ` ¬∑ ${besoin.periode}` : '';
    const gradeBadge = besoin.grade_code ? `<span class="needs-badge badge-info">${besoin.grade_code}</span>` : '‚Äî';
    const urgenceBadge = besoin.urgence ? `<span class="badge-urgence ${urgenceClass}">${urgenceLabel}</span>` : '‚Äî';
    
    document.getElementById('detail-content').innerHTML = `
      <div class="needs-detail-content">
        <div class="needs-detail-grid meta">
          <div class="needs-detail-card">
            <span class="needs-detail-label">Ann√©e</span>
            <span class="needs-detail-value">${besoin.annee}${periodeLabel}</span>
          </div>
          <div class="needs-detail-card">
            <span class="needs-detail-label">Statut</span>
            <span class="needs-detail-value"><span class="badge-statut ${statutClass}">${besoin.statut}</span></span>
          </div>
        </div>

        <h3 class="needs-detail-title">${besoin.poste_libelle}</h3>

        <div class="needs-detail-grid">
          <div class="needs-detail-card">
            <span class="needs-detail-label">Service</span>
            <span class="needs-detail-value">${besoin.service_libelle || '‚Äî'}</span>
          </div>
          <div class="needs-detail-card">
            <span class="needs-detail-label">Direction</span>
            <span class="needs-detail-value">${besoin.direction_libelle || '‚Äî'}</span>
          </div>
          <div class="needs-detail-card">
            <span class="needs-detail-label">Grade souhait√©</span>
            <span class="needs-detail-value">${gradeBadge}</span>
          </div>
        </div>

        <div class="needs-detail-divider"></div>

        <div class="needs-detail-kpis">
          <div class="needs-detail-kpi demande">
            <span class="needs-detail-kpi-value">${besoin.nombre_demande}</span>
            <span class="needs-detail-kpi-label">Agents demand√©s</span>
          </div>
          <div class="needs-detail-kpi obtenu">
            <span class="needs-detail-kpi-value">${besoin.nombre_obtenu}</span>
            <span class="needs-detail-kpi-label">Agents obtenus</span>
          </div>
        </div>

        <div class="needs-detail-progress">
          <span class="needs-detail-label">Taux de satisfaction</span>
          <div class="needs-progress-bar">
            <div class="needs-progress-fill ${progressClass}" style="--progress-value: ${progressValue};">${progressValue}%</div>
          </div>
        </div>

        <div class="needs-detail-grid meta">
          <div class="needs-detail-card">
            <span class="needs-detail-label">Urgence</span>
            <span class="needs-detail-value">${urgenceBadge}</span>
          </div>
          <div class="needs-detail-card">
            <span class="needs-detail-label">Date d'expression</span>
            <span class="needs-detail-value">${besoin.date_expression || '‚Äî'}</span>
          </div>
        </div>
      </div>
    `;
    
    document.getElementById('detailModal').classList.add('show');
    hideGlobalLoading();
  } catch (error) {
    console.error('Erreur:', error);
    showError('Erreur lors du chargement des d√©tails');
  }
}

// Mettre √† jour un besoin
function mettreAJour(besoinId) {
  currentBesoinId = besoinId;
  
  // R√©cup√©rer les donn√©es actuelles du besoin
  fetch(`/api/v1/besoins/api/besoins`)
    .then(res => res.json())
    .then(besoins => {
      const besoin = besoins.find(b => b.id === besoinId);
      if (besoin) {
        document.getElementById('update-nombre-obtenu').value = besoin.nombre_obtenu || 0;
        document.getElementById('update-statut').value = besoin.statut || 'Exprim√©';
      }
      document.getElementById('updateModal').classList.add('show');
    });
}

// Soumettre la mise √† jour
async function handleUpdate(event) {
  event.preventDefault();
  
  if (!currentBesoinId) return;
  
  showGlobalLoading('Mise √† jour...', 'Enregistrement des modifications');
  
  const formData = new FormData(event.target);
  
  try {
    const response = await submitFormAsJson(`/api/v1/besoins/api/besoins/${currentBesoinId}`, formData, 'PUT', true);
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      closeUpdateModal();
      showGlobalLoading('‚úÖ Besoin mis √† jour', 'Actualisation de la page...');
      setTimeout(() => location.reload(), 500);
    } else {
      hideGlobalLoading();
      await handleFetchError(response, 'Erreur lors de la mise √† jour');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur r√©seau. V√©rifiez votre connexion.');
  }
}

// Supprimer un besoin
async function supprimerBesoin(besoinId) {
  if (!confirm('‚ö†Ô∏è Supprimer ce besoin ?\n\nCette action est irr√©versible.')) return;
  
  showGlobalLoading('Suppression...', 'Veuillez patienter');
  
  try {
    const response = await fetch(`/api/v1/besoins/api/besoins/${besoinId}`, {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      showGlobalLoading('‚úÖ Besoin supprim√©', 'Actualisation de la page...');
      setTimeout(() => location.reload(), 500);
    } else {
      hideGlobalLoading();
      await handleFetchError(response, 'Erreur lors de la suppression');
    }
  } catch (error) {
    hideGlobalLoading();
    console.error('Erreur:', error);
    showError('Erreur r√©seau. V√©rifiez votre connexion.');
  }
}

// Fermer les modaux
function closeUpdateModal() {
  document.getElementById('updateModal').classList.remove('show');
  document.getElementById('updateForm').reset();
  currentBesoinId = null;
}

function closeDetailModal() {
  document.getElementById('detailModal').classList.remove('show');
}

// Les styles sont maintenant centralis√©s dans modals.css

console.log('‚úÖ Page suivi des besoins charg√©e');
</script>
{% endblock %}

