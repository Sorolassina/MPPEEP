{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}Suivi Budg√©taire - {{ app_name }}{% endblock %}

{% block content %}
{{ page_header(
    title='üí∞ Suivi Budg√©taire ' + annee|string + (' - Trimestre ' + trimestre|string if trimestre else ''),
    breadcrumbs=[
        {'name': 'Accueil', 'url': url_for('accueil')},
        {'name': 'Budget'}
    ],
    actions=[
        {'label': '‚ùì Aide', 'url': url_for('aide_budget'), 'primary': False, 'disabled': current_user.is_guest},
        {'label': 'üìã Fiches Techniques', 'url': url_for('budget_fiches_hierarchique'), 'primary': False, 'disabled': current_user.is_guest},
        {'label': 'üìä SIGOBE', 'url': url_for('budget_sigobe'), 'primary': False, 'disabled': current_user.is_guest},
        {'label': '‚Üê Retour Accueil', 'url': url_for('accueil'), 'primary': False}
    ]
) }}

<div class="budget-container">
  {% if current_user.is_guest %}
  <div class="demo-notice">
    <div class="demo-banner">
      <span class="demo-icon">üéØ</span>
      <span class="demo-text">Mode D√©monstration - Donn√©es fictives</span>
    </div>
    <p class="demo-description">
      Vous √™tes en mode invit√©. Les donn√©es affich√©es sont des exemples pour vous permettre de d√©couvrir l'interface.
    </p>
  </div>
  {% endif %}
  
  <div class="budget-layout">

    <!-- ========== ROW 2 : FILTRES (P√©riode, Programme, Nature) ========== -->
    <div class="filters-row">
      <!-- Filtre P√©riode -->
      <div class="filter-group">
        <label class="filter-label">üìÖ Ann√©e</label>
        <select id="filter-annee" class="filter-select" onchange="filtrerDashboard()">
          {% if annees_disponibles %}
            {% for an in annees_disponibles %}
              <option value="{{ an }}" {% if an == annee %}selected{% endif %}>{{ an }}</option>
            {% endfor %}
          {% else %}
            <option value="{{ annee }}" selected>{{ annee }}</option>
          {% endif %}
        </select>
      </div>
      
      <!-- Filtre Trimestre -->
      <div class="filter-group">
        <label class="filter-label">üìä Trimestre</label>
        <select id="filter-trimestre" class="filter-select" onchange="filtrerDashboard()">
          <option value="">Annuel</option>
          <option value="1" {% if trimestre == 1 %}selected{% endif %}>T1</option>
          <option value="2" {% if trimestre == 2 %}selected{% endif %}>T2</option>
          <option value="3" {% if trimestre == 3 %}selected{% endif %}>T3</option>
          <option value="4" {% if trimestre == 4 %}selected{% endif %}>T4</option>
        </select>
      </div>
      
      <!-- Filtre Programme -->
      <div class="filter-group">
        <label class="filter-label">üè¢ Programme</label>
        <select id="filter-programme" class="filter-select" onchange="filtrerDashboard()">
          <option value="">Tous les programmes</option>
          {% for prog in programmes %}
          <option value="{{ prog.id }}">{{ prog.code }} - {{ prog.libelle }}</option>
          {% endfor %}
        </select>
      </div>
      
      <!-- Filtre Nature de d√©pense -->
      <div class="filter-group">
        <label class="filter-label">üí≥ Nature de D√©pense</label>
        <select id="filter-nature" class="filter-select" onchange="filtrerDashboard()">
          <option value="">Toutes les natures</option>
          <option value="BS">BS - Biens & Services</option>
          <option value="P">P - Personnel</option>
          <option value="I">I - Investissement</option>
          <option value="T">T - Transferts</option>
        </select>
      </div>
    </div>

    <!-- ========== ROW 3 : KPIs EXECUTION BUDGETAIRE ========== -->
    <div class="kpis-container">
      <div class="kpis-header">
        <div class="header-icon"></div>
        <div class="header-title">Ex√©cution Budg√©taire (FCFA)</div>
      </div>
      <div class="kpis-list">
        <!-- Budget Actuel -->
        <div class="kpi-item">
          <div class="kpi-item-top">
            <div class="kpi-item-icon">BV</div>
            <div class="kpi-item-details">
              <div class="kpi-item-name">Budg. Actuel</div>
              <div class="kpi-item-percent">100%</div>
            </div>
          </div>
          <div class="kpi-item-amount">{{ "{:,.0f}".format(budget_actuel_total) }}</div>
          <div class="kpi-item-date">{{ annee }}</div>
        </div>
        
        <!-- Engagements -->
        <div class="kpi-item">
          <div class="kpi-item-top">
            <div class="kpi-item-icon">Eng</div>
            <div class="kpi-item-details">
              <div class="kpi-item-name">Engagements</div>
              <div class="kpi-item-percent">{{ "{:.2f}".format(taux_engagement) }}%</div>
            </div>
          </div>
          <div class="kpi-item-amount">{{ "{:,.0f}".format(engagements_total) }}</div>
          <div class="kpi-item-date">{{ annee }}</div>
        </div>
        
        <!-- Mandats Vis√©s -->
        <div class="kpi-item">
          <div class="kpi-item-top">
            <div class="kpi-item-icon">MV</div>
            <div class="kpi-item-details">
              <div class="kpi-item-name">Mand. Vis√©s</div>
              <div class="kpi-item-percent">{{ "{:.2f}".format((mandats_vises_total / engagements_total * 100) if engagements_total > 0 else 0) }}%</div>
            </div>
          </div>
          <div class="kpi-item-amount">{{ "{:,.0f}".format(mandats_vises_total) }}</div>
          <div class="kpi-item-date">{{ annee }}</div>
        </div>
        
        <!-- Mandats PEC -->
        <div class="kpi-item">
          <div class="kpi-item-top">
            <div class="kpi-item-icon">MP</div>
            <div class="kpi-item-details">
              <div class="kpi-item-name">Mand. PEC</div>
              <div class="kpi-item-percent">{{ "{:.2f}".format(taux_mandatement_pec) }}%</div>
            </div>
          </div>
          <div class="kpi-item-amount">{{ "{:,.0f}".format(mandats_pec_total) }}</div>
          <div class="kpi-item-date">{{ annee }}</div>
        </div>
        
        <!-- Disponible -->
        <div class="kpi-item">
          <div class="kpi-item-top">
            <div class="kpi-item-icon">Dis</div>
            <div class="kpi-item-details">
              <div class="kpi-item-name">Disponible</div>
              <div class="kpi-item-percent">{{ "{:.2f}".format(taux_execution_global) }}%</div>
            </div>
          </div>
          <div class="kpi-item-amount">{{ "{:,.0f}".format(disponible_eng_total) }}</div>
          <div class="kpi-item-date">{{ annee }}</div>
        </div>
      </div>
    </div>

    <!-- ========== ROW 4 : STATS (2 colonnes) ========== -->
    <div class="stats-grid">
      
      <!-- Ex√©cution par Programme -->
      <div class="stats-card">
        <div class="card-header">
          <div class="card-icon">üìä</div>
          <div class="card-title">Ex√©cution par Programme (FCFA)</div>
        </div>
        
        <div class="prog-list">
          {% if exec_par_programme %}
            {% for code, data in exec_par_programme.items() %}
            <div class="prog-card">
              <div class="prog-card-left">
                <div class="prog-card-icon">{{ data.libelle|extract_initials(3) }}</div>
                <div class="prog-card-details">
                  <div class="prog-card-name">{{ data.libelle }}</div>
                  <div class="prog-card-budget">Budget : {{ "{:,.0f}".format(data.budget) }} FCFA</div>
                  <div class="prog-card-bar-container">
                    <div class="prog-card-bar-fill" style="width: {{ data.taux }}%;">
                      <span class="prog-card-bar-shimmer"></span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="prog-card-right">
                <div class="prog-card-percent {% if data.taux >= 50 %}high{% else %}low{% endif %}">{{ "{:.1f}".format(data.taux) }}%</div>
                <div class="prog-card-label">Ex√©cution</div>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="empty-state">
              <div class="empty-state-icon">üìä</div>
              <p>Aucune donn√©e d'ex√©cution</p>
            </div>
          {% endif %}
        </div>
      </div>
      
      <!-- Nature de D√©penses -->
      <div class="stats-card">
        <div class="card-header">
          <div class="card-icon">üí≥</div>
          <div class="card-title">Nature de D√©penses (FCFA)</div>
        </div>
        
        <div class="nature-list">
          {% if exec_par_nature %}
            {% for code, data in exec_par_nature.items() %}
            <div class="nature-item {{ (data.libelle|extract_initials).lower() }}">
              <div class="nature-item-left">
                <div class="nature-item-icon">{{ data.libelle|extract_initials }}</div>
                <div class="nature-item-details">
                  <div class="nature-item-name">{{ data.libelle }}</div>
                  <div class="nature-item-budget">Budget : {{ "{:,.0f}".format(data.budget) }} FCFA</div>
                </div>
              </div>
              <div class="nature-item-right">
                <div class="nature-item-percent {% if data.taux >= 50 %}positive{% else %}negative{% endif %}">{{ "{:.1f}".format(data.taux) }}%</div>
                <div class="nature-item-date">{{ annee }}</div>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="empty-state">
              <div class="empty-state-icon">üí≥</div>
              <p>Aucune donn√©e disponible</p>
            </div>
          {% endif %}
        </div>
      </div>
      
    </div>

    <!-- ========== ROW 5 : VARIATION (pleine largeur) ========== -->
    <div class="variation-container">
      <div class="card-header">
        <div class="card-icon">üìà</div>
        <div class="card-title">
          Variation relative {{ annee }}{% if trimestre %} T{{ trimestre }}{% endif %} vs {{ annee - 1 }}{% if trimestre %} T{{ trimestre }}{% endif %}
        </div>
      </div>
      
      {% if variation_engagement is not none %}
      <div class="variation-grid">
        <div class="bars-and-legend">
          <div class="bars-wrapper">
            <!-- Taux Engagement -->
            <div class="bar-column">
              <div class="bar-container">
                {% set bar_height = [variation_engagement|abs, 100]|min %}
                <div class="bar-fill {% if variation_engagement >= 0 %}positive{% else %}negative{% endif %}" style="--bar-height: {{ bar_height }}%;"></div>
              </div>
              <div class="bar-value {% if variation_engagement >= 0 %}positive{% else %}negative{% endif %}">
                {% if variation_engagement >= 0 %}+{% endif %}{{ "{:.1f}".format(variation_engagement) }}%
              </div>
              <div class="bar-label">Tx Eng.</div>
              <div class="bar-previous">N-1: {{ "{:.1f}".format(taux_engagement_n1) if taux_engagement_n1 is not none else 'N/A' }}%</div>
            </div>
            
            <!-- Taux Mandatement Vis√© -->
            <div class="bar-column">
              <div class="bar-container">
                {% set bar_height = [variation_mandatement_vise|abs, 100]|min if variation_mandatement_vise is not none else 0 %}
                <div class="bar-fill {% if variation_mandatement_vise is not none and variation_mandatement_vise >= 0 %}positive{% else %}negative{% endif %}" style="--bar-height: {{ bar_height }}%;"></div>
              </div>
              <div class="bar-value {% if variation_mandatement_vise is not none and variation_mandatement_vise >= 0 %}positive{% else %}negative{% endif %}">
                {% if variation_mandatement_vise is not none %}
                  {% if variation_mandatement_vise >= 0 %}+{% endif %}{{ "{:.1f}".format(variation_mandatement_vise) }}%
                {% else %}
                  N/A
                {% endif %}
              </div>
              <div class="bar-label">Tx. MV</div>
              <div class="bar-previous">N-1: {{ "{:.1f}".format(taux_mandatement_vise_n1) if taux_mandatement_vise_n1 is not none else 'N/A' }}%</div>
            </div>
            
            <!-- Taux PEC -->
            <div class="bar-column">
              <div class="bar-container">
                {% set bar_height = [variation_mandatement_pec|abs, 100]|min if variation_mandatement_pec is not none else 0 %}
                <div class="bar-fill {% if variation_mandatement_pec is not none and variation_mandatement_pec >= 0 %}positive{% else %}negative{% endif %}" style="--bar-height: {{ bar_height }}%;"></div>
              </div>
              <div class="bar-value {% if variation_mandatement_pec is not none and variation_mandatement_pec >= 0 %}positive{% else %}negative{% endif %}">
                {% if variation_mandatement_pec is not none %}
                  {% if variation_mandatement_pec >= 0 %}+{% endif %}{{ "{:.1f}".format(variation_mandatement_pec) }}%
                {% else %}
                  N/A
                {% endif %}
              </div>
              <div class="bar-label">Tx M.PEC</div>
              <div class="bar-previous">N-1: {{ "{:.1f}".format(taux_mandatement_pec_n1) if taux_mandatement_pec_n1 is not none else 'N/A' }}%</div>
            </div>
            
            <!-- Taux Ex√©cution Global -->
            <div class="bar-column">
              <div class="bar-container">
                {% set bar_height = [variation_execution_global|abs, 100]|min if variation_execution_global is not none else 0 %}
                <div class="bar-fill {% if variation_execution_global is not none and variation_execution_global >= 0 %}positive{% else %}negative{% endif %}" style="--bar-height: {{ bar_height }}%;"></div>
              </div>
              <div class="bar-value {% if variation_execution_global is not none and variation_execution_global >= 0 %}positive{% else %}negative{% endif %}">
                {% if variation_execution_global is not none %}
                  {% if variation_execution_global >= 0 %}+{% endif %}{{ "{:.1f}".format(variation_execution_global) }}%
                {% else %}
                  N/A
                {% endif %}
              </div>
              <div class="bar-label">Tx E.G</div>
              <div class="bar-previous">N-1: {{ "{:.1f}".format(taux_execution_global_n1) if taux_execution_global_n1 is not none else 'N/A' }}%</div>
            </div>
          </div>
          
          <div class="legend-box">
            <div class="legend-item">
              <div class="legend-color positive"></div>
              <div class="legend-text">Variation (+)</div>
            </div>
            <div class="legend-item">
              <div class="legend-color negative"></div>
              <div class="legend-text">Variation (-)</div>
            </div>
            <div class="legend-item">
              <div class="legend-text">Eng. : Engagement</div>
            </div>
            <div class="legend-item">
              <div class="legend-text">MV : Mandats Vis√©s</div>
            </div>
            <div class="legend-item">
              <div class="legend-text">MPEC : Mandat PEC</div>
            </div>
            <div class="legend-item">
              <div class="legend-text">E.G : Ex√©cution Globale</div>
            </div>
          </div>
        </div>
      </div>
      {% else %}
      <!-- Message si pas de donn√©es N-1 -->
      <div style="padding: 3rem; text-align: center; color: #6b7280;">
        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;">üìä</div>
        <p style="font-size: 1.1rem; margin-bottom: 0.5rem; font-weight: 500;">
          Pas de donn√©es pour {{ annee - 1 }}{% if trimestre %} T{{ trimestre }}{% endif %}
        </p>
        <p style="font-size: 0.9rem;">
          Importez les donn√©es SIGOBE de l'ann√©e {{ annee - 1 }}{% if trimestre %} (trimestre {{ trimestre }}){% endif %} pour afficher les variations.
        </p>
      </div>
      {% endif %}
    </div>

    <!-- ========== ROW 6 : EVOLUTION TAUX D'EXECUTION N vs N-1 ========== -->
    <div class="execution-evolution-container">
      <div class="card-header">
        <div class="card-icon">üìä</div>
        <div class="card-title">√âvolution du Taux d'Ex√©cution Globale</div>
      </div>
      
      <!-- D√©finition des gradients SVG -->
      <svg style="width: 0; height: 0; position: absolute;">
        <defs>
          <linearGradient id="gradient-n1" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#fa709a;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#fee140;stop-opacity:1" />
          </linearGradient>
          <linearGradient id="gradient-current" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#43e97b;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#38f9d7;stop-opacity:1" />
          </linearGradient>
        </defs>
      </svg>
      
      <div class="execution-comparison">
        <!-- Ann√©e N-1 -->
        <div class="execution-year">
          <div class="execution-year-label">Ann√©e {{ annee - 1 }}</div>
          <div class="execution-circle-container">
            <svg class="execution-circle" viewBox="0 0 200 200">
              <circle cx="100" cy="100" r="80" class="circle-bg"></circle>
              <circle cx="100" cy="100" r="80" class="circle-progress n-1" 
                      style="--progress: {{ (taux_execution_global_n1 if taux_execution_global_n1 is not none else 0) }}"></circle>
            </svg>
            <div class="execution-value">
              <div class="execution-percent">{{ "{:.1f}".format(taux_execution_global_n1) if taux_execution_global_n1 is not none else 'N/A' }}%</div>
              <div class="execution-label">Ex√©cution N-1</div>
            </div>
          </div>
          <div class="execution-details">
            <div class="execution-detail-item">
              <span class="detail-label">Budget :</span>
              <span class="detail-value">{{ "{:,.0f}".format(budget_actuel_n1 if budget_actuel_n1 else 0) }} FCFA</span>
            </div>
            <div class="execution-detail-item">
              <span class="detail-label">Engag√© :</span>
              <span class="detail-value">{{ "{:,.0f}".format(engagements_n1 if engagements_n1 else 0) }} FCFA</span>
            </div>
          </div>
        </div>
        
        <!-- Fl√®che de comparaison -->
        <div class="execution-arrow">
          {% if variation_execution_global is not none %}
            <div class="arrow-value {% if variation_execution_global >= 0 %}positive{% else %}negative{% endif %}">
              {% if variation_execution_global >= 0 %}
                ‚ñ≤<br>+{{ "{:.1f}".format(variation_execution_global) }}%
              {% else %}
                ‚ñº<br>{{ "{:.1f}".format(variation_execution_global) }}%
              {% endif %}
            </div>
            <div class="arrow-label">Variation</div>
          {% else %}
            <div class="arrow-value neutral">‚Äî</div>
            <div class="arrow-label">N/A</div>
          {% endif %}
        </div>
        
        <!-- Ann√©e N -->
        <div class="execution-year">
          <div class="execution-year-label">Ann√©e {{ annee }}</div>
          <div class="execution-circle-container">
            <svg class="execution-circle" viewBox="0 0 200 200">
              <circle cx="100" cy="100" r="80" class="circle-bg"></circle>
              <circle cx="100" cy="100" r="80" class="circle-progress current" 
                      style="--progress: {{ taux_execution_global }}"></circle>
            </svg>
            <div class="execution-value">
              <div class="execution-percent">{{ "{:.1f}".format(taux_execution_global) }}%</div>
              <div class="execution-label">Ex√©cution N</div>
            </div>
          </div>
          <div class="execution-details">
            <div class="execution-detail-item">
              <span class="detail-label">Budget :</span>
              <span class="detail-value">{{ "{:,.0f}".format(budget_actuel_total) }} FCFA</span>
            </div>
            <div class="execution-detail-item">
              <span class="detail-label">Engag√© :</span>
              <span class="detail-value">{{ "{:,.0f}".format(engagements_total) }} FCFA</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Message informatif -->
      <div class="execution-info">
        üí° <strong>Taux d'Ex√©cution Globale</strong> : Ratio entre les engagements et le budget actuel. 
        Un taux √©lev√© indique une bonne utilisation du budget allou√©.
      </div>
    </div>

  </div>
</div>

{% endblock %}

{% block styles %}
<style>
/* Styles sp√©cifiques pour le Budget Dashboard */
.budget-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 1rem;
}

/* Banni√®re de d√©monstration */
.demo-notice {
    margin-bottom: 2rem;
    padding: 1rem;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
}

.demo-banner {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.demo-icon {
    font-size: 1.2rem;
}

.demo-text {
    font-weight: 600;
    color: white;
    font-size: 1.1rem;
}

.demo-description {
    color: rgba(255, 255, 255, 0.9);
    margin: 0;
    font-size: 0.95rem;
}

/* Filtres - R√©partition √©quitable */
.filters-row {
    display: flex;
    gap: 12px;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, var(--primary-color) 0%, color-mix(in srgb, var(--primary-color) 85%, #000) 100%);
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    flex: 1;
}

.filter-label {
    font-weight: 600;
    color: #FFFFFF !important;
    font-size: 0.9rem;
}

.filter-select {
    width: 100%;
    padding: 0.875rem 1.25rem;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.95);
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 500;
    font-size: 1rem;
}

.filter-select:hover {
    border-color: var(--white-color);
    background: var(--white-color);
    transform: translateY(-2px);
}

.filter-select:focus {
    outline: none;
    border-color: var(--white-color);
    background: var(--white-color);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* KPIs - Style Power BI horizontal agrandi */
.kpis-container {
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 2rem;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border-top: 3px solid #43e97b;
}

.kpis-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    padding: 12px 16px;
    background: linear-gradient(135deg, rgba(67, 233, 123, 0.1) 0%, rgba(56, 249, 215, 0.1) 100%);
    border-radius: 10px;
    border-left: 4px solid #43e97b;
}

.header-icon {
    width: 28px;
    height: 28px;
    background: linear-gradient(135deg, #43e97b, #38f9d7);
    border-radius: 8px;
}

.header-title {
    font-weight: 600;
    font-size: 20px;
    color: #333;
}

.kpis-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
}

.kpi-item {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: flex-start;
    padding: 16px;
    border-radius: 12px;
    background: #f9f9f9;
    box-shadow: inset 3px 3px 6px #ffffff, inset -3px -3px 6px #d1d9e6;
    transition: all 0.2s ease;
    border-left: 4px solid transparent;
}

.kpi-item:hover {
    box-shadow: 3px 3px 8px #d1d9e6, -3px -3px 8px #ffffff;
    transform: translateY(-2px);
}

/* Bordures color√©es pour chaque KPI */
.kpi-item:nth-child(1) {
    border-left-color: #667eea;
}

.kpi-item:nth-child(2) {
    border-left-color: #f093fb;
}

.kpi-item:nth-child(3) {
    border-left-color: #4facfe;
}

.kpi-item:nth-child(4) {
    border-left-color: #43e97b;
}

.kpi-item:nth-child(5) {
    border-left-color: #fa709a;
}

.kpi-item-top {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
}

.kpi-item-icon {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #eeeeee;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 700;
    color: var(--white-color);
    box-shadow: 4px 4px 8px #d1d9e6, -2px -2px 6px #ffffff;
}

/* Couleurs sp√©cifiques pour chaque KPI */
.kpi-item:nth-child(1) .kpi-item-icon {
    background: linear-gradient(135deg, #667eea, #764ba2);
}

.kpi-item:nth-child(2) .kpi-item-icon {
    background: linear-gradient(135deg, #f093fb, #f5576c);
}

.kpi-item:nth-child(3) .kpi-item-icon {
    background: linear-gradient(135deg, #4facfe, #00f2fe);
}

.kpi-item:nth-child(4) .kpi-item-icon {
    background: linear-gradient(135deg, #43e97b, #38f9d7);
}

.kpi-item:nth-child(5) .kpi-item-icon {
    background: linear-gradient(135deg, #fa709a, #fee140);
}

.kpi-item-details {
    display: flex;
    flex-direction: column;
}

.kpi-item-name {
    font-weight: 600;
    font-size: 15px;
    color: #333;
}

.kpi-item-percent {
    font-size: 13px;
    color: #777;
}

.kpi-item-amount {
    font-weight: 700;
    font-size: 18px;
    color: #27ae60;
    margin-top: 8px;
    line-height: 1.2;
    word-break: break-all;
}

.kpi-item-date {
    font-size: 12px;
    color: #999;
    margin-top: 4px;
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stats-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    padding: 20px;
    border-radius: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    border-top: 3px solid transparent;
}

.stats-card:nth-child(1) {
    border-top-color: #667eea;
}

.stats-card:nth-child(2) {
    border-top-color: #f093fb;
}

.card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    padding: 12px 16px;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    border-radius: 10px;
    border-left: 4px solid transparent;
}

.stats-card:nth-child(1) .card-header {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    border-left-color: #667eea;
}

.stats-card:nth-child(2) .card-header {
    background: linear-gradient(135deg, rgba(240, 147, 251, 0.1) 0%, rgba(245, 87, 108, 0.1) 100%);
    border-left-color: #f093fb;
}

.variation-container .card-header {
    background: linear-gradient(135deg, rgba(79, 172, 254, 0.1) 0%, rgba(0, 242, 254, 0.1) 100%);
    border-left-color: #4facfe;
}

.card-icon {
    width: 28px;
    height: 28px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
}

.stats-card:nth-child(1) .card-icon {
    background: linear-gradient(135deg, #667eea, #764ba2);
}

.stats-card:nth-child(2) .card-icon {
    background: linear-gradient(135deg, #f093fb, #f5576c);
}

.card-title {
    font-weight: 600;
    font-size: 18px;
    color: #333;
}

/* Programme Cards - Style Power BI */
.prog-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.prog-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-radius: 12px;
    background: #f9f9f9;
    box-shadow: inset 2px 2px 5px #ffffff, inset -2px -2px 5px #d1d9e6;
    transition: all 0.3s ease;
}

.prog-card:hover {
    box-shadow: 2px 2px 8px #d1d9e6, -2px -2px 8px #ffffff;
}

.prog-card-left {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
}

.prog-card-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #eeeeee;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
    color: #555;
    box-shadow: 3px 3px 6px #d1d9e6, -3px -3px 6px #ffffff;
}

.prog-card-details {
    display: flex;
    flex-direction: column;
    flex: 1;
}

.prog-card-name {
    font-weight: 500;
    font-size: 14px;
    color: #333;
    margin-bottom: 2px;
}

.prog-card-budget {
    font-size: 12px;
    color: #777;
    margin-bottom: 5px;
}

.prog-card-bar-container {
    width: 100%;
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    overflow: hidden;
}

.prog-card-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #10b981, #34d399);
    border-radius: 3px;
    transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.prog-card-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
}

.prog-card-percent {
    font-weight: 600;
    font-size: 14px;
    color: #10b981;
}

.prog-card-percent.low {
    color: #f59e0b;
}

.prog-card-label {
    font-size: 10px;
    color: #999;
    margin-top: 2px;
}

/* Nature Items - Style Power BI */
.nature-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.nature-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-radius: 12px;
    background: #f9f9f9;
    box-shadow: inset 2px 2px 5px #ffffff, inset -2px -2px 5px #d1d9e6;
    transition: all 0.3s ease;
}

.nature-item:hover {
    box-shadow: 2px 2px 8px #d1d9e6, -2px -2px 8px #ffffff;
}

.nature-item-left {
    display: flex;
    align-items: center;
    gap: 10px;
}

.nature-item-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #eeeeee;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 600;
    color: #555;
    box-shadow: 3px 3px 6px #d1d9e6, -3px -3px 6px #ffffff;
}

.nature-item-details {
    display: flex;
    flex-direction: column;
}

.nature-item-name {
    font-weight: 500;
    font-size: 14px;
    color: #333;
}

.nature-item-budget {
    font-size: 12px;
    color: #777;
}

.nature-item-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
}

.nature-item-percent {
    font-weight: 600;
    font-size: 14px;
}

.nature-item-percent.positive {
    color: #27ae60;
}

.nature-item-percent.negative {
    color: #c0392b;
}

.nature-item-date {
    font-size: 10px;
    color: #aaa;
    margin-top: 2px;
}

/* Variation Container - Agrandi avec l√©gende √† droite */
.variation-container {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    margin-bottom: 2rem;
    border-top: 3px solid #4facfe;
}

.variation-container .card-icon {
    background: linear-gradient(135deg, #4facfe, #00f2fe);
    width: 28px;
    height: 28px;
}

.variation-grid {
    margin-top: 2rem;
}

.bars-and-legend {
    display: flex;
    gap: 60px;
    align-items: center;
    justify-content: center;
}

.bars-wrapper {
    display: flex;
    gap: 60px;
    align-items: flex-end;
    padding: 2rem 0;
}

.bar-column {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.bar-container {
    position: relative;
    width: 25px;
    height: 150px;
    border-radius: 12px;
    background: #f0f0f0;
    overflow: hidden;
    box-shadow: inset 6px 6px 12px #a3b1c6, inset -6px -6px 12px #ffffff;
    margin-bottom: 0.75rem;
}

.bar-fill {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 0%;
    animation: fillUp 1.5s forwards;
}

.bar-fill.positive {
    background: linear-gradient(to top, #27ae60, #6fcf97);
}

.bar-fill.negative {
    background: linear-gradient(to top, #c0392b, #e74c3c);
}

@keyframes fillUp {
    to {
        height: var(--bar-height);
    }
}

.bar-value {
    font-size: 16px;
    font-weight: 700;
    margin-top: 4px;
}

.bar-value.positive {
    color: #27ae60;
}

.bar-value.negative {
    color: #c0392b;
}

.bar-label {
    margin-top: 8px;
    font-size: 14px;
    font-weight: 600;
    color: #333;
}

.bar-previous {
    font-size: 12px;
    color: #777;
    margin-top: 4px;
}

/* Legend - √Ä droite des barres */
.legend-box {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 1.5rem;
    background: var(--gray-50);
    border-radius: 10px;
    min-width: 200px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 10px;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
    flex-shrink: 0;
}

.legend-color.positive {
    background: #27ae60;
}

.legend-color.negative {
    background: #c0392b;
}

.legend-text {
    font-size: 14px;
    color: #333;
    font-weight: 500;
}

/* √âvolution Taux d'Ex√©cution N vs N-1 */
.execution-evolution-container {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    margin-bottom: 2rem;
    border-top: 3px solid #667eea;
}

.execution-evolution-container .card-icon {
    background: linear-gradient(135deg, #667eea, #764ba2);
}

.execution-comparison {
    display: flex;
    justify-content: space-around;
    align-items: center;
    gap: 3rem;
    margin-top: 2rem;
}

.execution-year {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.execution-year-label {
    font-size: 18px;
    font-weight: 700;
    color: var(--secondary-color);
    margin-bottom: 1.5rem;
}

.execution-circle-container {
    position: relative;
    width: 200px;
    height: 200px;
    margin-bottom: 1.5rem;
}

.execution-circle {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}

.circle-bg {
    fill: none;
    stroke: #e5e7eb;
    stroke-width: 12;
}

.circle-progress {
    fill: none;
    stroke-width: 12;
    stroke-linecap: round;
    stroke-dasharray: 502.4;
    stroke-dashoffset: calc(502.4 - (502.4 * var(--progress) / 100));
    transition: stroke-dashoffset 2s ease-out;
}

.circle-progress.n-1 {
    stroke: url(#gradient-n1);
}

.circle-progress.current {
    stroke: url(#gradient-current);
}

.execution-value {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}

.execution-percent {
    font-size: 36px;
    font-weight: 700;
    color: var(--secondary-color);
    margin-bottom: 0.25rem;
}

.execution-label {
    font-size: 14px;
    color: var(--gray-600);
    font-weight: 500;
}

.execution-details {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    width: 100%;
    max-width: 300px;
}

.execution-detail-item {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    background: #f9f9f9;
    border-radius: 8px;
    box-shadow: inset 2px 2px 4px #ffffff, inset -2px -2px 4px #d1d9e6;
}

.detail-label {
    font-weight: 600;
    color: var(--gray-600);
    font-size: 14px;
}

.detail-value {
    font-weight: 700;
    color: var(--secondary-color);
    font-size: 14px;
}

.execution-arrow {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
}

.arrow-value {
    font-size: 32px;
    font-weight: 700;
    text-align: center;
    line-height: 1.2;
}

.arrow-value.positive {
    color: #27ae60;
}

.arrow-value.negative {
    color: #c0392b;
}

.arrow-value.neutral {
    color: var(--gray-400);
}

.arrow-label {
    font-size: 14px;
    font-weight: 600;
    color: var(--gray-600);
}

.execution-info {
    margin-top: 2rem;
    padding: 1rem 1.5rem;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
    border-left: 4px solid #667eea;
    border-radius: 8px;
    font-size: 14px;
    color: var(--gray-700);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--gray-500);
}

.empty-state-icon {
    font-size: 4rem;
    opacity: 0.3;
    margin-bottom: 1rem;
}

/* Animations */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.filters-row { animation: fadeInUp 0.3s ease-out; }
.kpis-container { animation: fadeInUp 0.4s ease-out; }
.kpi-item { animation: fadeInUp 0.4s ease-out backwards; }
.kpi-item:nth-child(1) { animation-delay: 0.05s; }
.kpi-item:nth-child(2) { animation-delay: 0.1s; }
.kpi-item:nth-child(3) { animation-delay: 0.15s; }
.kpi-item:nth-child(4) { animation-delay: 0.2s; }
.kpi-item:nth-child(5) { animation-delay: 0.25s; }
.stats-card { animation: fadeInUp 0.5s ease-out backwards; }
.variation-container { animation: fadeInUp 0.6s ease-out backwards; }
.execution-evolution-container { animation: fadeInUp 0.7s ease-out backwards; }

/* Responsive */
@media (max-width: 1200px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .kpis-list {
        flex-direction: column;
    }
    
    .kpi-item {
        width: 100%;
    }
    
    .filters-row {
        flex-direction: column;
    }
    
    .bars-and-legend {
        flex-direction: column;
        gap: 30px;
    }
    
    .bars-wrapper {
        gap: 30px;
    }
    
    .legend-box {
        width: 100%;
    }
    
    .execution-comparison {
        flex-direction: column;
        gap: 2rem;
    }
    
    .execution-circle-container {
        width: 180px;
        height: 180px;
    }
    
    .execution-percent {
        font-size: 28px;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
function filtrerDashboard() {
  const annee = document.getElementById('filter-annee').value;
  const trimestre = document.getElementById('filter-trimestre').value;
  const programme = document.getElementById('filter-programme').value;
  const nature = document.getElementById('filter-nature').value;
  
  showGlobalLoading('Filtrage...', 'Actualisation du dashboard');
  
  let url = "{{ url_for('budget_home') }}" + `?annee=${annee}`;
  if (trimestre) url += `&trimestre=${trimestre}`;
  if (programme) url += `&programme_id=${programme}`;
  if (nature) url += `&nature=${nature}`;
  
  setTimeout(() => {
    window.location.href = url;
  }, 300);
}

// Animation des montants avec compteur
document.addEventListener('DOMContentLoaded', function() {
  // Fermer l'overlay au chargement de la page
  hideGlobalLoading();
  
  document.querySelectorAll('.kpi-item-amount').forEach((el, index) => {
    const text = el.textContent.trim();
    const match = text.match(/[\d,]+/);
    if (match) {
      const targetValue = parseFloat(match[0].replace(/,/g, ''));
      
      let currentValue = 0;
      const increment = targetValue / 30;
      const timer = setInterval(() => {
        currentValue += increment;
        if (currentValue >= targetValue) {
          currentValue = targetValue;
          clearInterval(timer);
        }
        el.textContent = currentValue.toLocaleString('fr-FR', {maximumFractionDigits: 0});
      }, 30);
    }
  });
  
  console.log('‚úÖ Dashboard budg√©taire professionnel charg√©');
});
</script>
{% endblock %}
