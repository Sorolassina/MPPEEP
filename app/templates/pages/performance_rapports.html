{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}Rapports de Performance - {{ app_name }}{% endblock %}

{% block styles %}{% endblock %}

{% block content %}
{{ page_header(
    title='üìã Rapports de Performance',
    breadcrumbs=[
        {'name': 'Performance', 'url': url_for('performance_home')},
        {'name': 'Rapports'}
    ],
    actions=[
        {'label': '‚Üê Retour Performance', 'url': url_for('performance_home'), 'primary': False}
    ]
) }}

<div class="performance-reports-page">
    <!-- G√©n√©rateur de rapports -->
    <section class="report-generator">
        <h2 class="generator-title">üìä G√©n√©rateur de Rapports</h2>
        <p class="generator-subtitle">Cr√©ez un rapport personnalis√© en s√©lectionnant vos crit√®res</p>
        
        <div class="generator-form">
            <div class="form-field">
                <label for="report-type">Type de rapport</label>
                <select id="report-type">
                    <option value="GLOBAL">üìä Global</option>
                    <option value="OBJECTIFS">üéØ Objectifs</option>
                    <option value="INDICATEURS">üìà Indicateurs</option>
                    <option value="SYNTHESE">üìã Synth√®se</option>
                </select>
            </div>
            
            <div class="form-field">
                <label for="report-period">P√©riode</label>
                <select id="report-period">
                    <option value="CURRENT_MONTH">Mois en cours</option>
                    <option value="LAST_MONTH">Mois dernier</option>
                    <option value="CURRENT_QUARTER">Trimestre en cours</option>
                    <option value="LAST_QUARTER">Trimestre dernier</option>
                    <option value="CURRENT_YEAR">Ann√©e en cours</option>
                    <option value="LAST_YEAR">Ann√©e derni√®re</option>
                    <option value="CUSTOM">P√©riode personnalis√©e</option>
                </select>
            </div>
            
            <div class="form-field">
                <label for="report-format">Format</label>
                <select id="report-format">
                    <option value="PDF">üìÑ PDF</option>
                    <option value="EXCEL">üìä Excel</option>
                    <option value="POWERPOINT">üìä PowerPoint</option>
                    <option value="HTML">üåê HTML</option>
                </select>
            </div>
            
            <div class="form-field" id="custom-dates" style="display: none; grid-column: 1 / -1;">
                <label>Dates personnalis√©es</label>
                <div style="display: flex; gap: 1rem;">
                    <input type="date" id="date-debut" class="form-control" style="flex: 1;">
                    <input type="date" id="date-fin" class="form-control" style="flex: 1;">
                </div>
            </div>
            
            <button type="button" class="btn btn-premium btn-accent generator-submit-btn" onclick="generateReport()">
                üìÑ G√©n√©rer le rapport
            </button>
        </div>
    </section>

    <!-- Templates de rapports -->
    <section class="report-templates">
        <h3 class="templates-title">üìÅ Mod√®les Pr√©d√©finis</h3>
        <div class="templates-grid">
            <div class="template-card" onclick="useTemplate('MENSUEL')">
                <div class="template-icon">üóìÔ∏è</div>
                <div class="template-name">Rapport Mensuel</div>
                <div class="template-description">
                    Vue d'ensemble des performances du mois : objectifs, indicateurs, KPIs, et analyse d√©taill√©e des tendances
                </div>
                <div style="text-align: center;">
                    <span class="template-badge badge-periodique">P√©riodique</span>
                </div>
                <div style="margin-top: 1rem; font-size: 0.8rem; color: #9ca3af;">
                    ‚úì Objectifs mensuels<br>
                    ‚úì Indicateurs cl√©s<br>
                    ‚úì Comparaison mois pr√©c√©dent
                </div>
            </div>
            
            <div class="template-card" onclick="useTemplate('TRIMESTRIEL')">
                <div class="template-icon">üìä</div>
                <div class="template-name">Rapport Trimestriel</div>
                <div class="template-description">
                    Analyse d√©taill√©e des tendances et √©volutions sur 3 mois avec graphiques et recommandations strat√©giques
                </div>
                <div style="text-align: center;">
                    <span class="template-badge badge-periodique">P√©riodique</span>
                    <span class="template-badge badge-analytique">Analytique</span>
                </div>
                <div style="margin-top: 1rem; font-size: 0.8rem; color: #9ca3af;">
                    ‚úì Vue trimestrielle<br>
                    ‚úì √âvolution des KPIs<br>
                    ‚úì Analyse comparative
                </div>
            </div>
            
            <div class="template-card" onclick="useTemplate('ANNUEL')">
                <div class="template-icon">üìà</div>
                <div class="template-name">Rapport Annuel</div>
                <div class="template-description">
                    Bilan complet de l'ann√©e avec comparaisons historiques, r√©alisations majeures et perspectives strat√©giques
                </div>
                <div style="text-align: center;">
                    <span class="template-badge badge-periodique">P√©riodique</span>
                    <span class="template-badge badge-executif">Ex√©cutif</span>
                </div>
                <div style="margin-top: 1rem; font-size: 0.8rem; color: #9ca3af;">
                    ‚úì Bilan annuel complet<br>
                    ‚úì Statistiques d√©taill√©es<br>
                    ‚úì Recommandations strat√©giques
                </div>
            </div>
            
            <div class="template-card" onclick="useTemplate('EXECUTIF')">
                <div class="template-icon">üìã</div>
                <div class="template-name">Tableau de Bord Ex√©cutif</div>
                <p class="template-description">
                    Vue synth√©tique √† destination du cabinet du ministre et de la direction g√©n√©rale.
                </p>
                <span class="template-badge badge-executif">Ex√©cutif</span>
            </div>
            <div class="template-card" onclick="useTemplate('RAP')">
                <div class="template-icon">üìò</div>
                <div class="template-name">Rapport Annuel de Performance (RAP)</div>
                <p class="template-description">
                    Consolidation annuelle des r√©sultats, √©carts et plans d'am√©lioration par programme.
                </p>
                <span class="template-badge badge-analytique">Annuel</span>
            </div>
            <div class="template-card" onclick="useTemplate('RPROG')">
                <div class="template-icon">üßë‚Äçüíº</div>
                <div class="template-name">Rapport Semestriel RPROG</div>
                <p class="template-description">
                    Bilan semestriel des responsables de programme, indicateurs cl√©s et besoins d'arbitrage.
                </p>
                <span class="template-badge badge-analytique">Semestriel</span>
            </div>
            <div class="template-card" onclick="useTemplate('DAF')">
                <div class="template-icon">üíº</div>
                <div class="template-name">Rapport Trimestriel DAF</div>
                <p class="template-description">
                    Suivi financier trimestriel, ex√©cution budg√©taire et alertes du Directeur Administratif et Financier.
                </p>
                <span class="template-badge badge-periodique">Trimestriel</span>
            </div>
        </div>
    </section>

    <!-- Historique des rapports -->
    <section class="reports-history">
        <div class="history-header">
            <div class="history-header-text">
                <h3 class="history-title">üìö Historique des Rapports</h3>
                <p class="history-subtitle">Consultez les rapports g√©n√©r√©s ou planifi√©s r√©cemment</p>
            </div>
            <div class="history-actions">
                <button type="button" class="btn btn-secondary" onclick="loadReports()">üîÑ Actualiser</button>
                <button type="button" class="btn btn-primary" onclick="planifierRapport()">‚è±Ô∏è Planifier un rapport</button>
            </div>
        </div>

        <div id="reports-list" class="reports-grid">
            <!-- Les rapports seront charg√©s dynamiquement -->
        </div>
    </section>
</div>

<script>
// Afficher/masquer les dates personnalis√©es
document.getElementById('report-period').addEventListener('change', function() {
    const customDates = document.getElementById('custom-dates');
    if (this.value === 'CUSTOM') {
        customDates.style.display = 'block';
    } else {
        customDates.style.display = 'none';
    }
});

// Utiliser un template
function useTemplate(template) {
    const reportType = document.getElementById('report-type');
    const reportPeriod = document.getElementById('report-period');
    
    switch(template) {
        case 'MENSUEL':
            reportType.value = 'GLOBAL';
            reportPeriod.value = 'CURRENT_MONTH';
            break;
        case 'TRIMESTRIEL':
            reportType.value = 'GLOBAL';
            reportPeriod.value = 'CURRENT_QUARTER';
            break;
        case 'ANNUEL':
            reportType.value = 'GLOBAL';
            reportPeriod.value = 'CURRENT_YEAR';
            break;
        case 'EXECUTIF':
            reportType.value = 'SYNTHESE';
            reportPeriod.value = 'CURRENT_MONTH';
            break;
        case 'RAP':
            reportType.value = 'GLOBAL';
            reportPeriod.value = 'CURRENT_YEAR';
            break;
        case 'RPROG': {
            reportType.value = 'OBJECTIFS';
            reportPeriod.value = 'CUSTOM';
            reportPeriod.dispatchEvent(new Event('change'));

            const now = new Date();
            const year = now.getFullYear();
            const firstHalf = now.getMonth() < 6;
            const startDate = firstHalf ? new Date(year, 0, 1) : new Date(year, 6, 1);
            const endDate = firstHalf ? new Date(year, 5, 30) : new Date(year, 11, 31);

            setCustomDates(startDate, endDate);
            break;
        }
        case 'DAF':
            reportType.value = 'INDICATEURS';
            reportPeriod.value = 'CURRENT_QUARTER';
            break;
    }
    
    // Scroller vers le g√©n√©rateur
    document.querySelector('.report-generator').scrollIntoView({ behavior: 'smooth' });
    showSuccess(`Template "${getTemplateName(template)}" charg√© !`);
}

function setCustomDates(startDate, endDate) {
    const startInput = document.getElementById('date-debut');
    const endInput = document.getElementById('date-fin');
    if (!startInput || !endInput) {
        return;
    }

    const toIso = (date) => date.toISOString().split('T')[0];
    startInput.value = toIso(startDate);
    endInput.value = toIso(endDate);
}

// G√©n√©rer un rapport
async function generateReport() {
    const type = document.getElementById('report-type').value;
    const period = document.getElementById('report-period').value;
    const format = document.getElementById('report-format').value;
    
    let dateDebut = null;
    let dateFin = null;
    
    if (period === 'CUSTOM') {
        dateDebut = document.getElementById('date-debut').value;
        dateFin = document.getElementById('date-fin').value;
        
        if (!dateDebut || !dateFin) {
            showError('Veuillez s√©lectionner les dates de d√©but et fin');
            return;
        }
    }
    
    try {
        showGlobalLoading('G√©n√©ration du rapport...', 'Veuillez patienter');
        
        // Cr√©er le FormData
        const formData = new FormData();
        formData.append('report_type', type);
        formData.append('period', period);
        formData.append('format', format);
        if (dateDebut) formData.append('date_debut', dateDebut);
        if (dateFin) formData.append('date_fin', dateFin);
        
        // Appeler l'API pour g√©n√©rer le rapport
        const response = await submitFormAsJson('{{ url_for("generate_report_api") }}', formData, 'POST', true);
        
        if (response.ok) {
            // T√©l√©charger le fichier
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rapport_performance_${type.toLowerCase()}_${new Date().getTime()}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            hideGlobalLoading();
            showSuccess(`Rapport ${getReportTypeName(type)} g√©n√©r√© et t√©l√©charg√© avec succ√®s !`);
            
            // Recharger la liste des rapports
            loadReports();
        } else {
            const result = await response.json();
            hideGlobalLoading();
            showError(result.error || 'Erreur lors de la g√©n√©ration du rapport');
        }
    } catch (error) {
        console.error('Erreur:', error);
        hideGlobalLoading();
        showError('Erreur lors de la g√©n√©ration du rapport');
    }
}

// Charger l'historique des rapports
async function loadReports() {
    const container = document.getElementById('reports-list');
    
    try {
        const response = await fetch('{{ url_for("get_rapports_historique") }}');
        const data = await response.json();
        
        if (!data.success || !data.rapports || data.rapports.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <h3 class="empty-state-title">Aucun rapport g√©n√©r√©</h3>
                    <p class="empty-state-message">
                        Vous n'avez pas encore g√©n√©r√© de rapports.<br>
                        Utilisez le g√©n√©rateur ci-dessus ou choisissez un template pour commencer.
                    </p>
                    <button type="button" class="btn btn-premium btn-primary" onclick="focusGenerator()">
                        ‚ûï Cr√©er un rapport
                    </button>
                </div>
            `;
            return;
        }
        
        // Afficher les rapports
        container.innerHTML = data.rapports.map(rapport => `
            <div class="report-card">
                <div class="report-header">
                    <h4 class="report-title">${rapport.titre}</h4>
                    <span class="report-type badge-${getReportTypeBadgeClass(rapport.type_rapport)}">
                        ${getReportTypeIcon(rapport.type_rapport)} ${rapport.type_rapport}
                    </span>
                </div>
                
                <p class="report-description">${rapport.description || 'Aucune description'}</p>
                
                <div class="report-meta">
                    <div class="meta-item">
                        <p class="meta-label">P√©riode</p>
                        <p class="meta-value">${formatPeriode(rapport.periode)}</p>
                    </div>
                    <div class="meta-item">
                        <p class="meta-label">Format</p>
                        <p class="meta-value">${rapport.format_fichier}</p>
                    </div>
                    <div class="meta-item">
                        <p class="meta-label">Taux r√©alisation</p>
                        <p class="meta-value">${rapport.taux_realisation}%</p>
                    </div>
                </div>
                
                <div class="report-meta">
                    <div class="meta-item">
                        <p class="meta-label">Objectifs</p>
                        <p class="meta-value">${rapport.nb_objectifs}</p>
                    </div>
                    <div class="meta-item">
                        <p class="meta-label">Indicateurs</p>
                        <p class="meta-value">${rapport.nb_indicateurs}</p>
                    </div>
                    <div class="meta-item">
                        <p class="meta-label">Taille</p>
                        <p class="meta-value">${formatFileSize(rapport.fichier_taille)}</p>
                    </div>
                </div>
                
                <div class="report-footer">
                    <span class="report-footer-meta">üìÖ ${formatDate(rapport.created_at)} par ${rapport.created_by_nom}</span>
                    <div class="report-actions">
                        <button type="button" class="btn-action btn-premium btn-danger btn-compact" onclick="deleteReport(${rapport.id})" title="Supprimer ce rapport">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Erreur lors du chargement des rapports:', error);
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">‚ö†Ô∏è</div>
                <h3 class="empty-state-title">Erreur de chargement</h3>
                <p class="empty-state-message">
                    Impossible de charger l'historique des rapports.<br>
                    Veuillez r√©essayer plus tard.
                </p>
            </div>
        `;
    }
}

// Fonctions utilitaires
function getReportTypeName(type) {
    const names = {
        'GLOBAL': 'Global',
        'OBJECTIFS': 'Objectifs',
        'INDICATEURS': 'Indicateurs',
        'SYNTHESE': 'Synth√®se'
    };
    return names[type] || type;
}

function getTemplateName(template) {
    const names = {
        'MENSUEL': 'Rapport Mensuel',
        'TRIMESTRIEL': 'Rapport Trimestriel',
        'ANNUEL': 'Rapport Annuel',
        'EXECUTIF': 'Tableau de Bord Ex√©cutif',
        'RAP': 'Rapport Annuel de Performance (RAP)',
        'RPROG': 'Rapport Semestriel RPROG',
        'DAF': 'Rapport Trimestriel DAF'
    };
    return names[template] || template;
}

function getReportTypeBadgeClass(type) {
    const classes = {
        'GLOBAL': 'periodique',
        'OBJECTIFS': 'analytique',
        'INDICATEURS': 'analytique',
        'SYNTHESE': 'executif'
    };
    return classes[type] || 'periodique';
}

function getReportTypeIcon(type) {
    const icons = {
        'GLOBAL': 'üìä',
        'OBJECTIFS': 'üéØ',
        'INDICATEURS': 'üìà',
        'SYNTHESE': 'üìã'
    };
    return icons[type] || 'üìÑ';
}

function formatPeriode(periode) {
    const periodes = {
        'CURRENT_MONTH': 'Mois en cours',
        'LAST_MONTH': 'Mois dernier',
        'CURRENT_QUARTER': 'Trimestre en cours',
        'LAST_QUARTER': 'Trimestre dernier',
        'CURRENT_YEAR': 'Ann√©e en cours',
        'LAST_YEAR': 'Ann√©e derni√®re',
        'CUSTOM': 'P√©riode personnalis√©e'
    };
    return periodes[periode] || periode;
}

function formatFileSize(bytes) {
    if (!bytes) return '0 KB';
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    let index = 0;
    let size = bytes;
    while (size >= 1024 && index < units.length - 1) {
        size /= 1024;
        index++;
    }
    return `${size.toFixed(1)} ${units[index]}`;
}

function focusGenerator() {
    const generatorSection = document.querySelector('.report-generator');
    if (generatorSection) {
        generatorSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    const options = { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    };
    return date.toLocaleDateString('fr-FR', options);
}

// Supprimer un rapport
async function deleteReport(reportId) {
    if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce rapport de l\'historique ?')) {
        return;
    }
    
    try {
        showGlobalLoading('Suppression du rapport...', 'Veuillez patienter');
        
        const response = await fetch(`{{ url_for("delete_rapport_api", rapport_id=0) }}`.replace('/0', `/${reportId}`), {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        hideGlobalLoading();
        
        if (result.success) {
            showSuccess('Rapport supprim√© avec succ√®s !');
            loadReports();  // Recharger la liste
        } else {
            showError(result.error || 'Erreur lors de la suppression du rapport');
        }
    } catch (error) {
        console.error('Erreur:', error);
        hideGlobalLoading();
        showError('Erreur lors de la suppression du rapport');
    }
}

// Charger les rapports au d√©marrage
document.addEventListener('DOMContentLoaded', function() {
    const overlay = document.getElementById('globalLoadingOverlay');
    if (overlay) {
        overlay.classList.remove('show');
    }
    loadReports();
});
</script>
{% endblock %}
