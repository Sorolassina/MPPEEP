{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}Nouveau Mouvement - Stocks - {{ app_name }}</body>
{% endblock %}

{% block styles %}
<style>
/* ========== STOCK MOUVEMENT FORM PAGE STYLES ========== */

/* Type Tabs */
.type-tabs {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
}

.type-tab {
    padding: 1.5rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 2px solid var(--gray-300);
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.type-tab:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    border-color: var(--primary-color);
}

.type-tab.active {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border-color: transparent;
    color: white;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

.type-tab .icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.type-tab .label {
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 0.25rem;
}

.type-tab small {
    font-size: 0.85rem;
    opacity: 0.9;
}

.type-tab.active small {
    color: rgba(255, 255, 255, 0.9);
}
</style>
{% endblock %}

{% block content %}
<body class="form-page-premium">
{{ page_header(
    title='üîÑ Nouveau Mouvement de Stock',
    breadcrumbs=[
        {'name': 'Stocks', 'url': url_for('stock_home')},
        {'name': 'Mouvements', 'url': url_for('stock_mouvements')},
        {'name': 'Nouveau'}
    ],
    actions=[
        {'label': '‚Üê Retour Mouvements', 'url': url_for('stock_mouvements'), 'primary': False}
    ]
) }}

<div class="page-grid">
  
  <!-- Formulaire -->
  <div class="card">
    <form id="mouvementForm" onsubmit="submitForm(event)" enctype="multipart/form-data">
      
      <!-- Type de mouvement -->
      <h3 style="margin-bottom: 1rem; color: var(--secondary-color);">üìã Type de Mouvement</h3>
      <div class="type-tabs">
        <div class="type-tab active" onclick="selectType('ENTREE', this)">
          <div class="icon">‚¨ÜÔ∏è</div>
          <div class="label">Entr√©e</div>
          <small>Achat / R√©ception</small>
        </div>
        <div class="type-tab" onclick="selectType('SORTIE', this)">
          <div class="icon">‚¨áÔ∏è</div>
          <div class="label">Sortie</div>
          <small>Distribution / Utilisation</small>
        </div>
        <div class="type-tab" onclick="selectType('AJUSTEMENT', this)">
          <div class="icon">‚öôÔ∏è</div>
          <div class="label">Ajustement</div>
          <small>Correction inventaire</small>
        </div>
      </div>
      <input type="hidden" name="type_mouvement" id="type_mouvement" value="ENTREE">
      
      <!-- Article & Quantit√© -->
      <h3 style="margin-bottom: 1.5rem; color: var(--secondary-color);">üì¶ Article & Quantit√©</h3>
      <div class="form-grid" style="margin-bottom: 2rem;">
        <div class="form-group" style="grid-column: 1 / -1;">
          <label class="form-label">Article *</label>
          <select name="article_id" id="article_id" class="form-select" required onchange="updateArticleInfo()">
            <option value="">-- S√©lectionner un article --</option>
            {% for article in articles %}
            <option value="{{ article.id }}" 
                    data-stock="{{ article.quantite_stock }}"
                    data-min="{{ article.quantite_min }}"
                    data-unite="{{ article.unite }}">
              {{ article.code }} - {{ article.designation }} (Stock: {{ article.quantite_stock }} {{ article.unite }})
            </option>
            {% endfor %}
          </select>
          <small style="color: var(--gray-600); font-size: 0.85rem;">
            {% if articles %}
              {{ articles|length }} article(s) disponible(s)
            {% else %}
              ‚ö†Ô∏è Aucun article configur√© - <a href="{{ url_for('stock_articles') }}" target="_blank" style="color: #0066cc;">Cr√©er des articles</a>
            {% endif %}
          </small>
        </div>
        
        <div class="form-group">
          <label class="form-label">Quantit√© *</label>
          <input type="number" name="quantite" id="quantite" class="form-input" required min="0.01" step="0.01" onchange="calculerMontant()">
        </div>
        
        <div class="form-group">
          <label class="form-label">Prix Unitaire (Optionnel)</label>
          <input type="number" name="prix_unitaire_reel" id="prix_unitaire_reel" class="form-input" min="0" step="0.01" placeholder="Prix r√©el si diff√©rent" onchange="calculerMontant()">
          <small style="color: var(--gray-600); font-size: 0.85rem;">Pour g√©rer les r√©ductions ou prix sp√©cifiques</small>
        </div>
        
        <div class="form-group">
          <label class="form-label">Montant Total</label>
          <input type="text" id="montant_total_display" class="form-input" readonly style="background: #f5f5f5;" placeholder="Calcul√© automatiquement">
        </div>
        
        <div class="form-group">
          <label class="form-label">Motif *</label>
          <input type="text" name="motif" class="form-input" required placeholder="Ex: Achat fournisseur">
        </div>
      </div>
      
      <!-- Options pour ENTREE seulement -->
      <div id="entree-options" style="margin-bottom: 1.5rem;">
        <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="enable_perissable" onchange="togglePerissableSection()" 
                   style="width: 18px; height: 18px; cursor: pointer;">
            <span style="font-weight: 500;">üçÉ Article p√©rissable (lot avec p√©remption)</span>
          </label>
          
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="enable_amortissable" onchange="toggleAmortissableSection()" 
                   style="width: 18px; height: 18px; cursor: pointer;">
            <span style="font-weight: 500;">üí∞ Mat√©riel amortissable (avec num√©ro de s√©rie)</span>
          </label>
        </div>
      </div>
      
      <!-- Info stock actuel -->
      <div id="stock-info" style="display: none; padding: 1rem; background: var(--info-light); border-left: 4px solid var(--info-color); border-radius: 8px; margin-bottom: 2rem;">
        <div style="color: var(--info-dark);">
          <strong>Stock actuel :</strong> <span id="info-stock">-</span> <span id="info-unite">-</span>
          <span style="margin-left: 1rem;">‚Ä¢</span>
          <strong>Stock minimum :</strong> <span id="info-min">-</span> <span id="info-unite2">-</span>
        </div>
      </div>
      
      <!-- D√©tails sp√©cifiques -->
      <h3 style="margin-bottom: 1.5rem; color: var(--secondary-color);">üìù D√©tails</h3>
      <div class="form-grid" style="margin-bottom: 2rem;">
        <div class="form-group" id="fournisseur-group" style="display: none;">
          <label class="form-label">Fournisseur</label>
          <select name="fournisseur_id" class="form-select">
            <option value="">-- Aucun --</option>
            {% for f in fournisseurs %}
            <option value="{{ f.id }}">{{ f.nom }}</option>
            {% endfor %}
          </select>
          <small style="color: var(--gray-600); font-size: 0.85rem;">
            {% if fournisseurs %}
              {{ fournisseurs|length }} fournisseur(s) disponible(s)
            {% else %}
              ‚ö†Ô∏è Aucun fournisseur configur√© - <a href="{{ url_for('stock_fournisseurs') }}" target="_blank" style="color: #0066cc;">Cr√©er des fournisseurs</a>
            {% endif %}
          </small>
        </div>
        
        <div class="form-group" id="beneficiaire-group" style="display: none;">
          <label class="form-label">B√©n√©ficiaire</label>
          <input type="text" name="beneficiaire" class="form-input" placeholder="Service ou Agent">
        </div>
        
        <div class="form-group" style="grid-column: 1 / -1;">
          <label class="form-label">Observations</label>
          <textarea name="observations" class="form-textarea" rows="3" 
                    placeholder="Informations compl√©mentaires..."></textarea>
        </div>
      </div>
      
      <!-- NOUVEAUT√â : Articles P√©rissables (ENTREE seulement) -->
      <div id="perissable-section" style="display: none; margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1.5rem; color: var(--secondary-color);">üçÉ Informations P√©rissables</h3>
        <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #10b981;">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Num√©ro de Lot *</label>
              <input type="text" name="numero_lot" id="numero_lot" class="form-input"
                     placeholder="Ex: LOT-2025-0312">
              <small style="color: var(--gray-600);">Num√©ro de lot du fournisseur</small>
            </div>
            
            <div class="form-group">
              <label class="form-label">Date de Fabrication</label>
              <input type="date" name="date_fabrication" id="date_fabrication" class="form-input">
            </div>
            
            <div class="form-group">
              <label class="form-label">Date de P√©remption *</label>
              <input type="date" name="date_peremption" id="date_peremption" class="form-input">
              <small style="color: #dc2626; font-weight: 500;">Obligatoire pour les articles p√©rissables</small>
            </div>
          </div>
          
          <div style="background: #dbeafe; padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6; margin-top: 1rem;">
            <p style="color: #1e40af; margin: 0; line-height: 1.6; font-size: 0.9rem;">
              <strong>üí° Info :</strong> Ces informations seront utilis√©es pour le suivi FIFO (First In, First Out) et les alertes de p√©remption.
            </p>
          </div>
        </div>
      </div>
      
      <!-- NOUVEAUT√â : Amortissement du Mat√©riel (ENTREE seulement) -->
      <div id="amortissable-section" style="display: none; margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1.5rem; color: var(--secondary-color);">üí∞ Informations d'Amortissement</h3>
        <div style="background: #fef3c7; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #f59e0b;">
          <div class="form-grid" style="margin-bottom: 1rem;">
            <div class="form-group" style="grid-column: 1 / -1;">
              <label class="form-label">Num√©ro(s) de S√©rie *</label>
              <input type="text" name="numero_serie" id="numero_serie" class="form-input"
                     placeholder="Ex: SN001, SN002, SN003">
              <small style="color: var(--gray-600);">S√©parer par des virgules si plusieurs unit√©s</small>
            </div>
            
            <div class="form-group">
              <label class="form-label">Date d'Acquisition *</label>
              <input type="date" name="date_acquisition" id="date_acquisition" class="form-input">
              <small style="color: var(--gray-600);">Date d'achat du mat√©riel</small>
            </div>
            
            <div class="form-group">
              <label class="form-label">Dur√©e d'Amortissement (ann√©es) *</label>
              <input type="number" name="duree_amortissement_annees" id="duree_amortissement_annees" 
                     class="form-input" min="1" step="1" placeholder="Ex: 3"
                     onchange="calculerAmortissement()">
            </div>
            
            <div class="form-group">
              <label class="form-label">M√©thode d'Amortissement</label>
              <select name="methode_amortissement" id="methode_amortissement" class="form-select" 
                      onchange="calculerAmortissement()">
                <option value="LINEAIRE">Lin√©aire</option>
                <option value="DEGRESSIF">D√©gressif</option>
              </select>
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Taux d'Amortissement (%) <span style="color: #10b981;">‚úì Auto</span></label>
              <input type="number" name="taux_amortissement" id="taux_amortissement" 
                     class="form-input" min="0" max="100" step="0.01"
                     placeholder="Calcul√© automatiquement" readonly
                     style="background: var(--gray-100); cursor: not-allowed;">
              <small style="color: #10b981; font-weight: 500;">Calcul√© automatiquement</small>
            </div>
            
            <div class="form-group">
              <label class="form-label">Valeur R√©siduelle (FCFA) <span style="color: #10b981;">‚úì Auto</span></label>
              <input type="number" name="valeur_residuelle" id="valeur_residuelle" 
                     class="form-input" min="0" step="1"
                     placeholder="Calcul√©e automatiquement" readonly
                     style="background: var(--gray-100); cursor: not-allowed;">
              <small style="color: #10b981; font-weight: 500;">10% de la valeur d'acquisition</small>
            </div>
          </div>
          
          <div style="background: #dbeafe; padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6; margin-top: 1rem;">
            <p style="color: #1e40af; margin: 0; line-height: 1.6; font-size: 0.9rem;">
              <strong>üí° Calcul automatique :</strong><br>
              ‚Ä¢ <strong>Lin√©aire :</strong> Taux = 100 √∑ Dur√©e (ex: 3 ans ‚Üí 33.33%)<br>
              ‚Ä¢ <strong>D√©gressif :</strong> Taux = (100 √∑ Dur√©e) √ó Coefficient (1.25/1.75/2.25)<br>
              ‚Ä¢ <strong>Valeur r√©siduelle :</strong> 10% de la valeur d'acquisition
            </p>
          </div>
        </div>
      </div>
      
      <!-- Document justificatif -->
      <h3 style="margin-bottom: 1.5rem; color: var(--secondary-color);">üìé Document Justificatif</h3>
      <div class="form-group" style="margin-bottom: 2rem;">
        <input type="file" name="document" id="document" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" 
               style="border: 2px dashed var(--secondary-color); padding: 1rem; border-radius: 8px;">
        <small style="color: var(--gray-600);">
          Formats accept√©s : PDF, Images, Word (max 10 MB) - Bon de commande, bon de livraison, etc.
        </small>
      </div>
      
      <!-- Actions -->
      <div class="form-actions">
        <a href="{{ url_for('stock_mouvements') }}" class="btn btn-secondary">Annuler</a>
        <button type="submit" class="btn btn-primary">‚úÖ Enregistrer le Mouvement</button>
      </div>
      
    </form>
  </div>
  
</div>
</body>
{% endblock %}

{% block scripts %}
<script>
function selectType(type, element) {
  // Mettre √† jour l'input hidden
  document.getElementById('type_mouvement').value = type;
  
  // Mettre √† jour les tabs
  document.querySelectorAll('.type-tab').forEach(tab => tab.classList.remove('active'));
  element.classList.add('active');
  
  // Afficher/masquer les champs sp√©cifiques
  const fournisseurGroup = document.getElementById('fournisseur-group');
  const beneficiaireGroup = document.getElementById('beneficiaire-group');
  const perissableSection = document.getElementById('perissable-section');
  const amortissableSection = document.getElementById('amortissable-section');
  
  if (type === 'ENTREE') {
    fournisseurGroup.style.display = 'block';
    beneficiaireGroup.style.display = 'none';
    // Les sections p√©rissable et amortissable seront affich√©es selon l'article s√©lectionn√©
    updateArticleSpecificSections();
  } else if (type === 'SORTIE') {
    fournisseurGroup.style.display = 'none';
    beneficiaireGroup.style.display = 'block';
    // Masquer les sections pour les sorties
    perissableSection.style.display = 'none';
    amortissableSection.style.display = 'none';
  } else {
    fournisseurGroup.style.display = 'none';
    beneficiaireGroup.style.display = 'none';
    // Masquer les sections pour les ajustements
    perissableSection.style.display = 'none';
    amortissableSection.style.display = 'none';
  }
}

function updateArticleInfo() {
  const select = document.getElementById('article_id');
  const option = select.options[select.selectedIndex];
  
  if (option.value) {
    const stock = option.dataset.stock;
    const min = option.dataset.min;
    const unite = option.dataset.unite;
    
    document.getElementById('info-stock').textContent = stock;
    document.getElementById('info-min').textContent = min;
    document.getElementById('info-unite').textContent = unite;
    document.getElementById('info-unite2').textContent = unite;
    document.getElementById('stock-info').style.display = 'block';
    
    // Mettre √† jour les sections sp√©cifiques selon le type d'article
    updateArticleSpecificSections();
  } else {
    document.getElementById('stock-info').style.display = 'none';
  }
}

function updateArticleSpecificSections() {
  const typeMouvement = document.getElementById('type_mouvement').value;
  const entreeOptions = document.getElementById('entree-options');
  
  // Afficher les options uniquement pour les ENTREES
  if (typeMouvement === 'ENTREE') {
    entreeOptions.style.display = 'block';
  } else {
    entreeOptions.style.display = 'none';
    // Masquer les sections si on change de type
    document.getElementById('perissable-section').style.display = 'none';
    document.getElementById('amortissable-section').style.display = 'none';
    document.getElementById('enable_perissable').checked = false;
    document.getElementById('enable_amortissable').checked = false;
  }
}

function togglePerissableSection() {
  const checkbox = document.getElementById('enable_perissable');
  const section = document.getElementById('perissable-section');
  
  if (checkbox.checked) {
    section.style.display = 'block';
  } else {
    section.style.display = 'none';
  }
}

function toggleAmortissableSection() {
  const checkbox = document.getElementById('enable_amortissable');
  const section = document.getElementById('amortissable-section');
  
  if (checkbox.checked) {
    section.style.display = 'block';
    // Calculer automatiquement l'amortissement
    calculerAmortissement();
  } else {
    section.style.display = 'none';
  }
}

// ========================================
// CALCUL AUTOMATIQUE DE L'AMORTISSEMENT
// ========================================
function calculerAmortissement() {
  const prixUnitaire = parseFloat(document.getElementById('prix_unitaire_reel')?.value) || 0;
  const dureeAnnees = parseInt(document.getElementById('duree_amortissement_annees')?.value) || 0;
  const methode = document.getElementById('methode_amortissement')?.value || 'LINEAIRE';
  
  const tauxInput = document.getElementById('taux_amortissement');
  const valeurResiduielleInput = document.getElementById('valeur_residuelle');
  
  if (!tauxInput || !valeurResiduielleInput) return;
  
  // Si on n'a pas les donn√©es n√©cessaires, on ne calcule pas
  if (dureeAnnees === 0) {
    tauxInput.value = '';
    valeurResiduielleInput.value = '';
    return;
  }
  
  // Calcul du taux d'amortissement
  let taux = 0;
  if (methode === 'LINEAIRE') {
    // M√©thode lin√©aire : 100 / nombre d'ann√©es
    taux = 100 / dureeAnnees;
  } else if (methode === 'DEGRESSIF') {
    // M√©thode d√©gressive : (100 / nombre d'ann√©es) √ó coefficient
    let coefficient = 1.25;
    if (dureeAnnees >= 5 && dureeAnnees <= 6) {
      coefficient = 1.75;
    } else if (dureeAnnees > 6) {
      coefficient = 2.25;
    }
    taux = (100 / dureeAnnees) * coefficient;
  }
  
  // Arrondir √† 2 d√©cimales
  taux = Math.round(taux * 100) / 100;
  tauxInput.value = taux;
  
  // Calcul de la valeur r√©siduelle (10% de la valeur d'acquisition)
  const valeurResiduelle = Math.round(prixUnitaire * 0.10);
  valeurResiduielleInput.value = valeurResiduelle;
}

function calculerMontant() {
  const quantite = parseFloat(document.getElementById('quantite').value) || 0;
  const prixUnitaire = parseFloat(document.getElementById('prix_unitaire_reel').value) || 0;
  
  if (quantite > 0 && prixUnitaire > 0) {
    const montant = quantite * prixUnitaire;
    document.getElementById('montant_total_display').value = montant.toLocaleString('fr-FR', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }) + ' FCFA';
  } else {
    document.getElementById('montant_total_display').value = '';
  }
  
  // Recalculer l'amortissement si la section est visible
  calculerAmortissement();
}

async function submitForm(event) {
  event.preventDefault();
  
  // Afficher l'overlay
  const overlay = document.getElementById('globalLoadingOverlay');
  if (overlay) overlay.classList.add('show');
  
  const formData = new FormData(event.target);
  
  try {
    const response = await submitFormAsJson("{{ url_for('api_create_mouvement') }}", formData, 'POST', true);
    
    const result = await response.json();
    
    if (result.success) {
      showSuccess(result.message);
      
      // Afficher l'alerte si pr√©sente
      if (result.alerte) {
        setTimeout(() => {
          showWarning(result.alerte, 'Alerte Stock', 8000);
        }, 500);
      }
      
      // L'overlay reste affich√© pendant la redirection
      setTimeout(() => {
        window.location.href = '{{ url_for("stock_mouvements") }}';
      }, result.alerte ? 1800 : 800);
    } else {
      // Masquer l'overlay SEULEMENT en cas d'erreur
      if (overlay) overlay.classList.remove('show');
      showError(result.error);
    }
  } catch (error) {
    // Masquer l'overlay SEULEMENT en cas d'erreur
    if (overlay) overlay.classList.remove('show');
    console.error('Erreur:', error);
    showError('Erreur lors de l\'enregistrement');
  }
}
</script>
</body>
{% endblock %}

