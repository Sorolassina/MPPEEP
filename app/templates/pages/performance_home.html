{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}Performance - {{ app_name }}{% endblock %}

{% block styles %}{% endblock %}

{% block content %}
{{ page_header(
    title='üìä Performance Organisationnelle',
    breadcrumbs=[
        {'name': 'Accueil', 'url': url_for('accueil')},
        {'name': 'Performance'}
    ],
    actions=[
        {'label': '‚ùì Aide', 'url': url_for('aide_performance'), 'primary': False, 'disabled': current_user.is_guest},
        {'label': '‚Üê Retour Accueil', 'url': url_for('accueil'), 'primary': False}
    ]
) }}

<div class="performance-page">
    {% if current_user.is_guest %}
    <div class="performance-demo-notice">
        <div class="performance-demo-icon">üéØ</div>
        <div class="performance-demo-content">
            <h3>Mode d√©monstration</h3>
            <p>Vous √™tes en mode invit√©. Les donn√©es affich√©es sont fictives et illustrent les indicateurs du module performance.</p>
        </div>
    </div>
    {% endif %}
    
    <section class="performance-hero">
        <div class="performance-hero-content">
            <h2 class="performance-hero-title">Pilotez l'ex√©cution des objectifs strat√©giques</h2>
            <p class="performance-hero-description">
                Visualisez la progression des programmes, identifiez les alertes et priorisez les actions pour soutenir la performance du MPPEEP.
            </p>
            <div class="performance-hero-insights">
                <div class="hero-insight">
                    <span class="hero-insight-label">Taux de r√©alisation</span>
                    <span class="hero-insight-value">{{ kpis.taux_realisation }}%</span>
                </div>
                <div class="hero-insight">
                    <span class="hero-insight-label">Objectifs atteints</span>
                    <span class="hero-insight-value">
                        {% if kpis.total_objectifs > 0 %}
                        {{ kpis.objectifs_atteints }} / {{ kpis.total_objectifs }}
                        {% else %}
                        Aucune cible
                        {% endif %}
                    </span>
                </div>
                <div class="hero-insight">
                    <span class="hero-insight-label">Indicateurs en alerte</span>
                    <span class="hero-insight-value">{{ kpis.indicateurs_alerte }}</span>
                </div>
            </div>
            <div class="performance-hero-actions">
                <a href="{{ url_for('performance_objectifs') }}" class="btn btn-premium btn-primary">G√©rer les objectifs</a>
                <button type="button" class="btn btn-premium btn-secondary" onclick="openEngagementModal()">Lettre d'engagement</button>
            </div>
        </div>
        <div class="performance-hero-metrics">
            <div class="performance-hero-metric">
                <span class="metric-icon">‚≠ê</span>
                <span class="metric-label">Score global</span>
                <span class="metric-value">{{ kpis.score_global }}/10</span>
            </div>
            <div class="performance-hero-metric">
                <span class="metric-icon">üèÉ</span>
                <span class="metric-label">Objectifs en cours</span>
                <span class="metric-value">{{ kpis.objectifs_en_cours }}</span>
            </div>
            <div class="performance-hero-metric">
                <span class="metric-icon">üìä</span>
                <span class="metric-label">Rapports disponibles</span>
                <span class="metric-value">{{ kpis.total_rapports }}</span>
            </div>
        </div>
    </section>

    <section class="performance-kpis">
        <div class="performance-section-header">
            <div class="section-icon">üìå</div>
            <div class="section-text">
                <h3>Indicateurs cl√©s</h3>
                <p>Synth√®se de la performance courante et des actions √† prioriser.</p>
            </div>
        </div>
        <div class="performance-kpi-grid">
            <article class="performance-kpi-card">
                <div class="performance-kpi-icon">üéØ</div>
                <span class="performance-kpi-title">Taux de r√©alisation</span>
                <span class="performance-kpi-value">{{ kpis.taux_realisation }}%</span>
                <span class="performance-kpi-change {% if kpis.taux_realisation >= 80 %}positive{% elif kpis.taux_realisation >= 50 %}neutral{% else %}negative{% endif %}">
                {% if kpis.total_objectifs > 0 %}
                    {{ kpis.objectifs_atteints }} / {{ kpis.total_objectifs }} objectifs
                {% else %}
                    Aucun objectif d√©fini
                {% endif %}
                </span>
            </article>

            <article class="performance-kpi-card">
                <div class="performance-kpi-icon">‚úÖ</div>
                <span class="performance-kpi-title">Objectifs atteints</span>
                <span class="performance-kpi-value">{{ kpis.objectifs_atteints }}</span>
                <span class="performance-kpi-change neutral">Sur {{ kpis.total_objectifs }} au total</span>
            </article>

            <article class="performance-kpi-card">
                <div class="performance-kpi-icon">‚ö†Ô∏è</div>
                <span class="performance-kpi-title">Indicateurs en alerte</span>
                <span class="performance-kpi-value">{{ kpis.indicateurs_alerte }}</span>
                <span class="performance-kpi-change {% if kpis.indicateurs_alerte > 0 %}negative{% else %}positive{% endif %}">
                {% if kpis.indicateurs_alerte > 0 %}
                    ‚ö†Ô∏è N√©cessitent attention
                {% else %}
                    ‚úÖ Tous les indicateurs sont au vert
                {% endif %}
                </span>
            </article>

            <article class="performance-kpi-card">
                <div class="performance-kpi-icon">‚≠ê</div>
                <span class="performance-kpi-title">Score global</span>
                <span class="performance-kpi-value">{{ kpis.score_global }}/10</span>
                <span class="performance-kpi-change {% if kpis.score_global >= 7 %}positive{% elif kpis.score_global >= 5 %}neutral{% else %}negative{% endif %}">
                {% if kpis.score_global >= 7 %}
                    ‚úÖ Performance √©lev√©e
                {% elif kpis.score_global >= 5 %}
                    ‚ö†Ô∏è Performance moyenne
                {% else %}
                    ‚ùå √Ä renforcer
                {% endif %}
                </span>
            </article>

            <article class="performance-kpi-card">
                <div class="performance-kpi-icon">üèÉ</div>
                <span class="performance-kpi-title">Objectifs en cours</span>
                <span class="performance-kpi-value">{{ kpis.objectifs_en_cours }}</span>
                <span class="performance-kpi-change neutral">En progression</span>
            </article>

            <article class="performance-kpi-card">
                <div class="performance-kpi-icon">üìä</div>
                <span class="performance-kpi-title">Rapports g√©n√©r√©s</span>
                <span class="performance-kpi-value">{{ kpis.total_rapports }}</span>
                <span class="performance-kpi-change neutral">Disponibles pour analyse</span>
            </article>
        </div>
    </section>

    <section class="performance-charts">
        <div class="performance-section-header">
            <div class="section-icon">üìà</div>
            <div class="section-text">
                <h3>Analyses et tendances</h3>
                <p>Visualisations cl√©s pour anticiper les √©volutions et prioriser les actions.</p>
            </div>
        </div>
        <div class="performance-chart-grid">
            <article class="performance-chart-card">
                <h3 class="performance-chart-title">√âvolution des objectifs (6 derniers mois)</h3>
                <div class="performance-chart-placeholder">
                    üìà Graphique d'√©volution des objectifs
                    <small>Les graphiques interactifs seront int√©gr√©s prochainement</small>
                </div>
            </article>
            <article class="performance-chart-card">
                <h3 class="performance-chart-title">Performance par programme</h3>
                <div class="performance-chart-placeholder">
                    üìä Graphique en barres par programme
                    <small>Comparaison des performances par secteur</small>
                </div>
            </article>
            <article class="performance-chart-card">
                <h3 class="performance-chart-title">Indicateurs cl√©s de performance</h3>
                <div class="performance-chart-placeholder">
                    üéØ Graphique radar des KPIs
                    <small>Vue d'ensemble des indicateurs principaux</small>
                </div>
            </article>
            <article class="performance-chart-card">
                <h3 class="performance-chart-title">Tendances et pr√©visions</h3>
                <div class="performance-chart-placeholder">
                    üìà Graphique de tendances
                    <small>Projections et analyses pr√©dictives</small>
                </div>
            </article>
        </div>
    </section>

    <section class="performance-actions">
        <div class="performance-section-header">
            <div class="section-icon">‚ö°</div>
            <div class="section-text">
                <h3>Actions rapides</h3>
                <p>Acc√©dez aux modules cl√©s pour suivre et documenter la performance.</p>
            </div>
        </div>
        <div class="performance-actions-grid">
            <a href="{{ url_for('performance_objectifs') }}" class="action-button">
                <span class="action-icon">üéØ</span>
                <span class="action-text">G√©rer les objectifs</span>
            </a>
            <a href="{{ url_for('performance_indicateurs') }}" class="action-button">
                <span class="action-icon">üìä</span>
                <span class="action-text">Configurer les indicateurs</span>
            </a>
            <a href="{{ url_for('performance_rapports') }}" class="action-button">
                <span class="action-icon">üìã</span>
                <span class="action-text">G√©n√©rer un rapport</span>
            </a>
            <button type="button" class="action-button" onclick="openEngagementModal()">
                <span class="action-icon">‚úâÔ∏è</span>
                <span class="action-text">Lettre d'engagement op√©rationnel</span>
            </button>
            <button type="button" class="action-button" onclick="openPerformanceEngagementModal()">
                <span class="action-icon">üìà</span>
                <span class="action-text">Lettre d'engagement de performance</span>
            </button>
        </div>
    </section>
</div>

<div id="engagementModal" class="modal-xl performance-modal">
    <div class="modal-content performance-engagement-modal">
        <div class="modal-header">
            <h2 class="modal-title">Pr√©parer la lettre d'engagement</h2>
            <button type="button" class="modal-close" onclick="closeEngagementModal()">&times;</button>
        </div>
        <form id="engagementForm" class="modal-body performance-engagement-body" data-endpoint="{{ url_for('performance_lettres_engagement_pdf') }}">
            <p class="performance-engagement-intro">
                Renseignez les informations ci-dessous. Les champs laiss√©s vides utiliseront les valeurs de r√©f√©rence d√©j√† enregistr√©es.
            </p>
            <button type="button" class="link-button performance-engagement-reset" onclick="applyEngagementDefaults()">
                ‚Ü∫ Remettre les valeurs de r√©f√©rence
            </button>

            <section>
                <h3 class="performance-engagement-title">
                    <span>üìÑ</span> Informations g√©n√©rales
                </h3>
                <div class="performance-engagement-grid">
                    <div class="form-group">
                        <label for="annee" class="form-label">Ann√©e</label>
                        <input type="number" id="annee" name="annee" class="form-control" min="2000" max="2100" step="1" placeholder="2025">
                    </div>
                    <div class="form-group">
                        <label for="pays" class="form-label">Pays</label>
                        <input type="text" id="pays" name="pays" class="form-control" placeholder="R√©publique de C√¥te d'Ivoire">
                    </div>
                    <div class="form-group">
                        <label for="devise" class="form-label">Devise / devise nationale</label>
                        <input type="text" id="devise" name="devise" class="form-control" placeholder="Union ‚Äì Discipline ‚Äì Travail">
                    </div>
                    <div class="form-group">
                        <label for="ministere" class="form-label">Minist√®re</label>
                        <input type="text" id="ministere" name="ministere" class="form-control" placeholder="Minist√®re du Patrimoine...">
                    </div>
                    <div class="form-group">
                        <label for="programme" class="form-label">Intitul√© du programme</label>
                        <input type="text" id="programme" name="programme" class="form-control" placeholder="Administration G√©n√©rale">
                    </div>
                    <div class="form-group">
                        <label for="bop" class="form-label">Intitul√© du BOP</label>
                        <input type="text" id="bop" name="bop" class="form-control" placeholder="Affaires Administratives et Financi√®res">
                    </div>
                    <div class="form-group">
                        <label for="ville" class="form-label">Ville de signature</label>
                        <input type="text" id="ville" name="ville" class="form-control" placeholder="Abidjan">
                    </div>
                    <div class="form-group">
                        <label for="date" class="form-label">Date de signature</label>
                        <input type="date" id="date" name="date" class="form-control">
                        <span class="performance-engagement-hint">Format : JJ/MM/AAAA</span>
                    </div>
                </div>
            </section>

            <section>
                <h3 class="performance-engagement-title">
                    <span>üë§</span> Responsable de programme
                </h3>
                <div class="performance-engagement-grid">
                    <div class="form-group">
                        <label for="rprog_nom" class="form-label">Nom complet</label>
                        <input type="text" id="rprog_nom" name="rprog_nom" class="form-control" placeholder="Monsieur ADAMA SALL">
                    </div>
                    <div class="form-group">
                        <label for="rprog_fonction" class="form-label">Fonction</label>
                        <input type="text" id="rprog_fonction" name="rprog_fonction" class="form-control" placeholder="Responsable du Programme">
                    </div>
                    <div class="performance-upload-group">
                        <label for="rprog_photo" class="form-label">Photo officielle</label>
                        <div class="performance-upload-row">
                            <input type="text" id="rprog_photo" name="rprog_photo" class="form-control" placeholder="uploads/performance/engagement/rprog_photo.png">
                            <label class="performance-upload-button">
                                <input type="file" id="rprog_photo_file" accept="image/*" onchange="uploadEngagementPhoto('rprog_photo')">
                                üìÅ Joindre
                            </label>
                        </div>
                        <span class="performance-engagement-hint">Formats accept√©s&nbsp;: JPG, PNG, WEBP (max 5&nbsp;MB)</span>
                        <div class="performance-upload-preview" id="rprog_photo_preview_wrapper">
                            <img id="rprog_photo_preview" alt="Pr√©visualisation du responsable de programme">
                        </div>
                    </div>
                </div>
            </section>

            <section>
                <h3 class="performance-engagement-title">
                    <span>ü§ù</span> Responsable BOP
                </h3>
                <div class="performance-engagement-grid">
                    <div class="form-group">
                        <label for="rbop_nom" class="form-label">Nom complet</label>
                        <input type="text" id="rbop_nom" name="rbop_nom" class="form-control" placeholder="Monsieur DIARRA Hamidou">
                    </div>
                    <div class="form-group">
                        <label for="rbop_fonction" class="form-label">Fonction</label>
                        <input type="text" id="rbop_fonction" name="rbop_fonction" class="form-control" placeholder="Responsable du BOP">
                    </div>
                    <div class="performance-upload-group">
                        <label for="rbop_photo" class="form-label">Photo officielle</label>
                        <div class="performance-upload-row">
                            <input type="text" id="rbop_photo" name="rbop_photo" class="form-control" placeholder="uploads/performance/engagement/rbop_photo.png">
                            <label class="performance-upload-button">
                                <input type="file" id="rbop_photo_file" accept="image/*" onchange="uploadEngagementPhoto('rbop_photo')">
                                üìÅ Joindre
                            </label>
                        </div>
                        <span class="performance-engagement-hint">Formats accept√©s&nbsp;: JPG, PNG, WEBP (max 5&nbsp;MB)</span>
                        <div class="performance-upload-preview" id="rbop_photo_preview_wrapper">
                            <img id="rbop_photo_preview" alt="Pr√©visualisation du responsable BOP">
                        </div>
                    </div>
                </div>
            </section>

            <section>
                <h3 class="performance-engagement-title">
                    <span>üìë</span> R√©f√©rences et visuels
                </h3>
                <div class="performance-engagement-grid">
                    <div class="form-group">
                        <label for="decret_org_num" class="form-label">D√©cret organisation (num√©ro)</label>
                        <input type="text" id="decret_org_num" name="decret_org_num" class="form-control" placeholder="Ex: N¬∞ 2023-123">
                    </div>
                    <div class="form-group">
                        <label for="decret_org_date" class="form-label">D√©cret organisation (date)</label>
                        <input type="text" id="decret_org_date" name="decret_org_date" class="form-control" placeholder="Ex: 15/03/2023">
                    </div>
                    <div class="form-group">
                        <label for="decret_resp_num" class="form-label">D√©cret nomination (num√©ro)</label>
                        <input type="text" id="decret_resp_num" name="decret_resp_num" class="form-control" placeholder="Ex: N¬∞ 2024-045">
                    </div>
                    <div class="form-group">
                        <label for="decret_resp_date" class="form-label">D√©cret nomination (date)</label>
                        <input type="text" id="decret_resp_date" name="decret_resp_date" class="form-control" placeholder="Ex: 01/02/2024">
                    </div>
                    <div class="performance-upload-group">
                        <label for="logo_path" class="form-label">Logo √† afficher</label>
                        <div class="performance-upload-row">
                            <input type="text" id="logo_path" name="logo_path" class="form-control" placeholder="uploads/performance/engagement/logo.png">
                            <label class="performance-upload-button">
                                <input type="file" id="logo_path_file" accept="image/*" onchange="uploadEngagementPhoto('logo_path')">
                                üìÅ Joindre
                            </label>
                        </div>
                        <span class="performance-engagement-hint">Chemin relatif ou t√©l√©versement (JPG, PNG, WEBP ‚Äì max 5&nbsp;MB)</span>
                        <div class="performance-upload-preview" id="logo_path_preview_wrapper">
                            <img id="logo_path_preview" alt="Pr√©visualisation du logo">
                        </div>
                    </div>
                </div>
            </section>
        </form>
        <div class="modal-footer performance-engagement-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEngagementModal()">Annuler</button>
            <button type="submit" form="engagementForm" class="btn btn-primary">G√©n√©rer le PDF</button>
        </div>
    </div>
</div>

<!-- Modal pour la lettre d'engagement de performance -->
<div id="performanceEngagementModal" class="modal-xl performance-modal">
    <div class="modal-content performance-engagement-modal">
        <div class="modal-header">
            <h2 class="modal-title">Pr√©parer la lettre d'engagement de performance</h2>
            <button type="button" class="modal-close" onclick="closePerformanceEngagementModal()">&times;</button>
        </div>
        <form id="performanceEngagementForm" class="modal-body performance-engagement-body" data-endpoint="{{ url_for('performance_lettres_engagement_performance_pdf') }}">
            <p class="performance-engagement-intro">
                Renseignez les informations ci-dessous. Les champs laiss√©s vides utiliseront les valeurs de r√©f√©rence d√©j√† enregistr√©es.
            </p>
            <button type="button" class="link-button performance-engagement-reset" onclick="applyPerformanceEngagementDefaults()">
                ‚Ü∫ Remettre les valeurs de r√©f√©rence
            </button>

            <section>
                <h3 class="performance-engagement-title">
                    <span>üìÑ</span> Informations g√©n√©rales
                </h3>
                <div class="performance-engagement-grid">
                    <div class="form-group">
                        <label for="perf_annee" class="form-label">Ann√©e</label>
                        <input type="number" id="perf_annee" name="annee" class="form-control" min="2000" max="2100" step="1" placeholder="2025">
                    </div>
                    <div class="form-group">
                        <label for="perf_pays" class="form-label">Pays</label>
                        <input type="text" id="perf_pays" name="pays" class="form-control" placeholder="R√©publique de C√¥te d'Ivoire">
                    </div>
                    <div class="form-group">
                        <label for="perf_devise" class="form-label">Devise / devise nationale</label>
                        <input type="text" id="perf_devise" name="devise" class="form-control" placeholder="Union ‚Äì Discipline ‚Äì Travail">
                    </div>
                    <div class="form-group">
                        <label for="perf_programme" class="form-label">Intitul√© du programme</label>
                        <input type="text" id="perf_programme" name="programme" class="form-control" placeholder="PORTEFEUILLE DE L'ETAT">
                    </div>
                    <div class="form-group">
                        <label for="perf_ville" class="form-label">Ville de signature</label>
                        <input type="text" id="perf_ville" name="ville" class="form-control" placeholder="Abidjan">
                    </div>
                    <div class="form-group">
                        <label for="perf_date" class="form-label">Date de signature</label>
                        <input type="date" id="perf_date" name="date" class="form-control">
                        <span class="performance-engagement-hint">Format : JJ/MM/AAAA</span>
                    </div>
                </div>
            </section>

            <section>
                <h3 class="performance-engagement-title">
                    <span>üëî</span> Ministre
                </h3>
                <div class="performance-engagement-grid">
                    <div class="form-group">
                        <label for="perf_minister_civility" class="form-label">Civilit√©</label>
                        <select id="perf_minister_civility" name="minister_civility" class="form-control">
                            <option value="">-- S√©lectionner --</option>
                            <option value="Monsieur">Monsieur</option>
                            <option value="Madame">Madame</option>
                            <option value="Mademoiselle">Mademoiselle</option>
                            <option value="Docteur">Docteur</option>
                            <option value="Professeur">Professeur</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="perf_minister_nom" class="form-label">Nom complet</label>
                        <input type="text" id="perf_minister_nom" name="minister_nom" class="form-control" placeholder="MOUSSA SANOGO">
                    </div>
                    <div class="form-group">
                        <label for="perf_minister_fonction" class="form-label">Fonction</label>
                        <input type="text" id="perf_minister_fonction" name="minister_fonction" class="form-control" placeholder="MINISTRE DU PATRIMOINE, DU PORTEFEUILLE DE L'ETAT ET DES ENTREPRISES PUBLIQUES">
                    </div>
                    <div class="performance-upload-group">
                        <label for="perf_minister_photo" class="form-label">Photo officielle</label>
                        <div class="performance-upload-row">
                            <input type="text" id="perf_minister_photo" name="minister_photo" class="form-control" placeholder="uploads/performance/engagement/minister_photo.png">
                            <label class="performance-upload-button">
                                <input type="file" id="perf_minister_photo_file" accept="image/*" onchange="uploadEngagementPhoto('perf_minister_photo')">
                                üìÅ Joindre
                            </label>
                        </div>
                        <span class="performance-engagement-hint">Formats accept√©s&nbsp;: JPG, PNG, WEBP (max 5&nbsp;MB)</span>
                        <div class="performance-upload-preview" id="perf_minister_photo_preview_wrapper">
                            <img id="perf_minister_photo_preview" alt="Pr√©visualisation du ministre">
                        </div>
                    </div>
                </div>
            </section>

            <section>
                <h3 class="performance-engagement-title">
                    <span>üë§</span> Responsable de programme
                </h3>
                <div class="performance-engagement-grid">
                    <div class="form-group">
                        <label for="perf_rprog_nom" class="form-label">Nom complet</label>
                        <input type="text" id="perf_rprog_nom" name="rprog_nom" class="form-control" placeholder="Monsieur ADAMA SALL">
                    </div>
                    <div class="form-group">
                        <label for="perf_rprog_fonction" class="form-label">Fonction</label>
                        <input type="text" id="perf_rprog_fonction" name="rprog_fonction" class="form-control" placeholder="Responsable du Programme">
                    </div>
                    <div class="performance-upload-group">
                        <label for="perf_rprog_photo" class="form-label">Photo officielle</label>
                        <div class="performance-upload-row">
                            <input type="text" id="perf_rprog_photo" name="rprog_photo" class="form-control" placeholder="uploads/performance/engagement/rprog_photo.png">
                            <label class="performance-upload-button">
                                <input type="file" id="perf_rprog_photo_file" accept="image/*" onchange="uploadEngagementPhoto('perf_rprog_photo')">
                                üìÅ Joindre
                            </label>
                        </div>
                        <span class="performance-engagement-hint">Formats accept√©s&nbsp;: JPG, PNG, WEBP (max 5&nbsp;MB)</span>
                        <div class="performance-upload-preview" id="perf_rprog_photo_preview_wrapper">
                            <img id="perf_rprog_photo_preview" alt="Pr√©visualisation du responsable de programme">
                        </div>
                    </div>
                </div>
            </section>

            <section>
                <h3 class="performance-engagement-title">
                    <span>üìë</span> R√©f√©rences et visuels
                </h3>
                <div class="performance-engagement-grid">
                    <div class="performance-upload-group">
                        <label for="perf_logo_path" class="form-label">Logo √† afficher</label>
                        <div class="performance-upload-row">
                            <input type="text" id="perf_logo_path" name="logo_path" class="form-control" placeholder="uploads/performance/engagement/logo.png">
                            <label class="performance-upload-button">
                                <input type="file" id="perf_logo_path_file" accept="image/*" onchange="uploadEngagementPhoto('perf_logo_path')">
                                üìÅ Joindre
                            </label>
                        </div>
                        <span class="performance-engagement-hint">Chemin relatif ou t√©l√©versement (JPG, PNG, WEBP ‚Äì max 5&nbsp;MB)</span>
                        <div class="performance-upload-preview" id="perf_logo_path_preview_wrapper">
                            <img id="perf_logo_path_preview" alt="Pr√©visualisation du logo">
                        </div>
                    </div>
                </div>
            </section>
        </form>
        <div class="modal-footer performance-engagement-footer">
            <button type="button" class="btn btn-secondary" onclick="closePerformanceEngagementModal()">Annuler</button>
            <button type="submit" form="performanceEngagementForm" class="btn btn-primary">G√©n√©rer le PDF</button>
        </div>
    </div>
</div>

<script>
function showComingSoon(feature) {
    showInfo(`La fonctionnalit√© "${feature}" sera bient√¥t disponible !`);
}

// S'assurer que l'overlay est ferm√© au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    const overlay = document.getElementById('globalLoadingOverlay');
    if (overlay) {
        overlay.classList.remove('show');
    }
});

const engagementDefaults = JSON.parse('{{ engagement_defaults | tojson | safe }}');
const performanceEngagementDefaults = JSON.parse('{{ performance_engagement_defaults | tojson | safe }}');
const ENGAGEMENT_PHOTO_MAX_SIZE = 5 * 1024 * 1024; // 5 MB
const engagementPhotoUploadUrl = "{{ url_for('upload_engagement_photo') }}";
const engagementPhotoFields = ["rprog_photo", "rbop_photo", "logo_path"];
const performanceEngagementPhotoFields = ["perf_minister_photo", "perf_rprog_photo", "perf_logo_path"];

function normalizeEngagementAssetUrl(rawValue) {
    if (!rawValue) {
        return "";
    }

    if (/^(https?:\/\/|data:)/i.test(rawValue)) {
        return rawValue;
    }

    let url = rawValue.trim();
    if (url.startsWith("/")) {
        return url;
    }

    if (url.startsWith("uploads/")) {
        return `/${url}`;
    }

    if (url.startsWith("static/")) {
        return `/${url}`;
    }

    if (url.startsWith("images/")) {
        return `/static/${url}`;
    }

    return `/static/${url}`;
}

function updateEngagementPhotoPreview(field, explicitUrl) {
    const wrapper = document.getElementById(`${field}_preview_wrapper`);
    const img = document.getElementById(`${field}_preview`);
    if (!wrapper || !img) {
        return;
    }

    const input = document.getElementById(field);
    const value = explicitUrl || input?.value || "";

    if (!value) {
        wrapper.classList.remove("show");
        img.src = "";
        return;
    }

    const url = normalizeEngagementAssetUrl(value);
    img.src = url;
    wrapper.classList.add("show");
}

async function uploadEngagementPhoto(field) {
    const fileInput = document.getElementById(`${field}_file`);
    if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
        return;
    }

    const file = fileInput.files[0];
    if (file.size > ENGAGEMENT_PHOTO_MAX_SIZE) {
        if (typeof showError === "function") {
            showError("La photo d√©passe la taille maximale de 5 MB.");
        }
        fileInput.value = "";
        return;
    }

    const formData = new FormData();
    formData.append("photo", file);

    if (typeof showGlobalLoading === "function") {
        showGlobalLoading("T√©l√©versement en cours...", "Import de la photo");
    }

    try {
        const response = await fetch(engagementPhotoUploadUrl, {
            method: "POST",
            body: formData,
        });

        const result = await response.json().catch(() => ({}));

        if (!response.ok || !result?.success) {
            const message = result?.detail || result?.error || "Erreur lors du t√©l√©versement de la photo.";
            if (typeof showError === "function") {
                showError(message);
            }
            return;
        }

        const input = document.getElementById(field);
        if (input) {
            input.value = result.path || result.relative_path || result.url || "";
        }

        updateEngagementPhotoPreview(field, result.url || input?.value);

        if (typeof showSuccess === "function") {
            showSuccess(result.message || "Photo import√©e avec succ√®s.");
        }
    } catch (error) {
        console.error("Erreur upload photo lettre engagement:", error);
        if (typeof showError === "function") {
            showError("Erreur r√©seau lors du t√©l√©versement de la photo.");
        }
    } finally {
        if (typeof hideGlobalLoading === "function") {
            hideGlobalLoading();
        }
        fileInput.value = "";
    }
}

function openEngagementModal() {
    const modal = document.getElementById('engagementModal');
    if (!modal) {
        return;
    }
    modal.classList.add('show');
    document.body.classList.add('modal-open');
}

function closeEngagementModal() {
    const modal = document.getElementById('engagementModal');
    if (!modal) {
        return;
    }
    modal.classList.remove('show');
    document.body.classList.remove('modal-open');
}

function formatDateForInput(value) {
    if (!value) {
        return "";
    }
    if (value.includes("-")) {
        return value;
    }
    const parts = value.split("/");
    if (parts.length === 3) {
        const [day, month, year] = parts;
        return `${year.padStart(4, "0")}-${month.padStart(2, "0")}-${day.padStart(2, "0")}`;
    }
    return value;
}

function formatDateForApi(value) {
    if (!value) {
        return "";
    }
    if (value.includes("/")) {
        return value;
    }
    const parts = value.split("-");
    if (parts.length === 3) {
        const [year, month, day] = parts;
        return `${day.padStart(2, "0")}/${month.padStart(2, "0")}/${year.padStart(4, "0")}`;
    }
    return value;
}

function applyEngagementDefaults() {
    const form = document.getElementById('engagementForm');
    if (!form || !engagementDefaults) {
        return;
    }
    form.reset();
    Object.entries(engagementDefaults).forEach(([key, value]) => {
        const field = form.querySelector(`[name="${key}"]`);
        if (!field) {
            return;
        }
        if (key === "date") {
            field.value = formatDateForInput(value);
            return;
        }
        field.value = value ?? "";
    });

    engagementPhotoFields.forEach((field) => updateEngagementPhotoPreview(field));
}

function handleEngagementSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const endpoint = form.dataset.endpoint;
    if (!endpoint) {
        if (typeof showWarning === "function") {
            showWarning("Impossible de d√©terminer l'URL de g√©n√©ration du PDF.");
        }
        return;
    }

    const params = new URLSearchParams();
    const formData = new FormData(form);

    for (const [key, rawValue] of formData.entries()) {
        let value = (rawValue || "").toString().trim();
        if (!value) {
            continue;
        }

        if (key === "date") {
            value = formatDateForApi(value);
        }

        if (key === "annee") {
            value = value.replace(/[^\d]/g, "");
        }

        if (!value) {
            continue;
        }

        params.append(key, value);
    }

    const query = params.toString();
    const targetUrl = query ? `${endpoint}?${query}` : endpoint;

    if (typeof showGlobalLoading === "function") {
        showGlobalLoading("G√©n√©ration du PDF...", "Veuillez patienter");
    }

    closeEngagementModal();
    window.location.assign(targetUrl);
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('engagementForm');
    if (form) {
        applyEngagementDefaults();
        form.addEventListener('submit', handleEngagementSubmit);
    }

    engagementPhotoFields.forEach((field) => {
        const input = document.getElementById(field);
        if (input) {
            input.addEventListener('change', () => updateEngagementPhotoPreview(field));
            input.addEventListener('blur', () => updateEngagementPhotoPreview(field));
        }
    });

    const modal = document.getElementById('engagementModal');
    if (modal) {
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeEngagementModal();
            }
        });
    }

    // Modal de performance
    const perfForm = document.getElementById('performanceEngagementForm');
    if (perfForm) {
        applyPerformanceEngagementDefaults();
        perfForm.addEventListener('submit', handlePerformanceEngagementSubmit);
    }

    performanceEngagementPhotoFields.forEach((field) => {
        const input = document.getElementById(field);
        if (input) {
            input.addEventListener('change', () => updateEngagementPhotoPreview(field));
            input.addEventListener('blur', () => updateEngagementPhotoPreview(field));
        }
    });

    const perfModal = document.getElementById('performanceEngagementModal');
    if (perfModal) {
        perfModal.addEventListener('click', function(event) {
            if (event.target === perfModal) {
                closePerformanceEngagementModal();
            }
        });
    }
});

// Fonctions pour le modal de performance
function openPerformanceEngagementModal() {
    const modal = document.getElementById('performanceEngagementModal');
    if (!modal) {
        return;
    }
    modal.classList.add('show');
    document.body.classList.add('modal-open');
}

function closePerformanceEngagementModal() {
    const modal = document.getElementById('performanceEngagementModal');
    if (!modal) {
        return;
    }
    modal.classList.remove('show');
    document.body.classList.remove('modal-open');
}

function applyPerformanceEngagementDefaults() {
    const form = document.getElementById('performanceEngagementForm');
    if (!form || !performanceEngagementDefaults) {
        return;
    }
    form.reset();
    Object.entries(performanceEngagementDefaults).forEach(([key, value]) => {
        const field = form.querySelector(`[name="${key}"]`);
        if (!field) {
            return;
        }
        if (key === "date") {
            field.value = formatDateForInput(value);
            return;
        }
        field.value = value ?? "";
    });

    // Mettre √† jour les pr√©visualisations des photos
    performanceEngagementPhotoFields.forEach((field) => {
        updateEngagementPhotoPreview(field);
    });
}

function handlePerformanceEngagementSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const endpoint = form.dataset.endpoint;
    if (!endpoint) {
        if (typeof showWarning === "function") {
            showWarning("Impossible de d√©terminer l'URL de g√©n√©ration du PDF.");
        }
        return;
    }

    const params = new URLSearchParams();
    const formData = new FormData(form);

    for (const [key, rawValue] of formData.entries()) {
        let value = (rawValue || "").toString().trim();
        if (!value) {
            continue;
        }

        if (key === "date") {
            value = formatDateForApi(value);
        }

        if (key === "annee") {
            value = value.replace(/[^\d]/g, "");
        }

        if (!value) {
            continue;
        }

        params.append(key, value);
    }

    const query = params.toString();
    const targetUrl = query ? `${endpoint}?${query}` : endpoint;

    if (typeof showGlobalLoading === "function") {
        showGlobalLoading("G√©n√©ration du PDF...", "Veuillez patienter");
    }

    closePerformanceEngagementModal();
    window.location.assign(targetUrl);
}
</script>
{% endblock %}
