{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}Objectifs de Performance - {{ app_name }}{% endblock %}

{% block styles %}{% endblock %}

{% block content %}
{{ page_header(
    title='üéØ Objectifs de Performance',
    breadcrumbs=[
        {'name': 'Performance', 'url': url_for('performance_home')},
        {'name': 'Objectifs'}
    ],
    actions=[
        {'label': '‚Üê Retour Performance', 'url': url_for('performance_home'), 'primary': False},
        {'label': '‚ûï Nouvel Objectif', 'onclick': 'openCreateModal()', 'primary': True}
    ]
) }}

<div class="performance-objectives-page">
    <section class="objectives-actions">
        <div class="objectives-cta">
            <div class="objectives-cta-text">
                <h2>Cartographier vos objectifs</h2>
                <p>Centralisez vos objectifs strat√©giques et op√©rationnels, suivez leur progression et priorisez les actions.</p>
            </div>
            <div class="objectives-cta-actions">
                <button type="button" class="btn btn-premium btn-primary" onclick="openCreateModal()">‚ûï Nouvel objectif</button>
                <button type="button" class="btn btn-premium btn-secondary" onclick="loadObjectives()">üîÑ Actualiser</button>
            </div>
        </div>
    </section>

    <section class="objectives-filters card filters-panel compact">
        <div class="filters-header">
            <div class="filters-heading">
                <span class="filters-icon">üß≠</span>
                <div class="filters-text">
                    <h3>Affiner l'affichage</h3>
                    <p>Combinez les filtres pour vous concentrer sur les objectifs critiques.</p>
                </div>
            </div>
        </div>
        <div class="filters-row">
            <div class="filter-group">
                <label class="filter-label" for="search-input">üîç Recherche</label>
                <input 
                    type="text" 
                    id="search-input" 
                    class="form-control" 
                    placeholder="Rechercher un objectif..." 
                    oninput="filterObjectives()"
                >
            </div>
            <div class="filter-group">
                <label class="filter-label" for="filter-statut">üìå Statut</label>
                <select id="filter-statut" class="form-control" onchange="filterObjectives()">
                    <option value="">Tous</option>
                    <option value="PLANIFIE">Planifi√©</option>
                    <option value="EN_COURS">En cours</option>
                    <option value="ATTEINT">Atteint</option>
                    <option value="EN_RETARD">En retard</option>
                    <option value="ANNULE">Annul√©</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label" for="filter-type">üéØ Type</label>
                <select id="filter-type" class="form-control" onchange="filterObjectives()">
                    <option value="">Tous</option>
                    <option value="STRATEGIQUE">Strat√©gique</option>
                    <option value="OPERATIONNEL">Op√©rationnel</option>
                    <option value="FINANCIER">Financier</option>
                    <option value="RH">RH</option>
                    <option value="QUALITE">Qualit√©</option>
                    <option value="CLIENT">Client</option>
                </select>
            </div>
        </div>
    </section>

    <section class="objectives-list-section">
        <div id="objectives-list" class="objectives-grid">
            <!-- objectifs dynamiques -->
        </div>
    </section>
</div>

<!-- Modal de cr√©ation/modification -->
<div id="objectiveModal" class="modal-md">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle" class="modal-title">Nouvel Objectif</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <form id="objectiveForm" class="modal-body">
            <input type="hidden" id="objectiveId" name="objective_id">
            
            <div class="form-group">
                <label for="titre" class="form-label">Titre *</label>
                <input type="text" id="titre" name="titre" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="description" class="form-label">Description</label>
                <textarea id="description" name="description" class="form-control" rows="3"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="type_objectif" class="form-label">Type</label>
                    <select id="type_objectif" name="type_objectif" class="form-control">
                        <option value="OPERATIONNEL">Op√©rationnel</option>
                        <option value="STRATEGIQUE">Strat√©gique</option>
                        <option value="FINANCIER">Financier</option>
                        <option value="RH">RH</option>
                        <option value="QUALITE">Qualit√©</option>
                        <option value="CLIENT">Client</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="priorite" class="form-label">Priorit√©</label>
                    <select id="priorite" name="priorite" class="form-control">
                        <option value="NORMALE">Normale</option>
                        <option value="BASSE">Basse</option>
                        <option value="HAUTE">Haute</option>
                        <option value="CRITIQUE">Critique</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="date_debut" class="form-label" title="Date √† laquelle commence la p√©riode de l'objectif">
                        Date de d√©but * ‚ÑπÔ∏è
                    </label>
                    <input type="date" id="date_debut" name="date_debut" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="date_fin" class="form-label" title="Date limite pour atteindre l'objectif (√©ch√©ance)">
                        Date de fin (√©ch√©ance) * ‚ÑπÔ∏è
                    </label>
                    <input type="date" id="date_fin" name="date_fin" class="form-control" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="periode" class="form-label">P√©riode *</label>
                <input type="text" id="periode" name="periode" class="form-control" placeholder="ex: 2025, Q1 2025" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="valeur_cible" class="form-label">Valeur cible *</label>
                    <input type="number" id="valeur_cible" name="valeur_cible" class="form-control" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="valeur_actuelle" class="form-label">Valeur actuelle</label>
                    <input type="number" id="valeur_actuelle" name="valeur_actuelle" class="form-control" step="0.01" value="0">
                </div>
                
                <div class="form-group">
                    <label for="unite" class="form-label">Unit√© *</label>
                    <input type="text" id="unite" name="unite" class="form-control" placeholder="%, ‚Ç¨, nombre..." required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="service_responsable" class="form-label">Service responsable</label>
                <select id="service_responsable" name="service_responsable" class="form-control" onchange="filterUsersByService()">
                    <option value="">S√©lectionner un service...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="responsable_id" class="form-label">Responsable *</label>
                <select id="responsable_id" name="responsable_id" class="form-control" required>
                    <option value="">S√©lectionner d'abord un service...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="commentaires" class="form-label">Commentaires</label>
                <textarea id="commentaires" name="commentaires" class="form-control" rows="2"></textarea>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                <button type="submit" class="btn btn-primary">Enregistrer</button>
            </div>
        </form>
    </div>
</div>

<script>
// URLs g√©n√©r√©es par le serveur
const API_URLS = {
    list: "{{ url_for('get_objectifs_api') }}",
    create: "{{ url_for('create_objectif_api') }}",
    detail: (id) => "{{ url_for('get_objectif_api', objectif_id=0) }}".replace('/0', `/${id}`),
    update: (id) => "{{ url_for('update_objectif_api', objectif_id=0) }}".replace('/0', `/${id}`),
    delete: (id) => "{{ url_for('delete_objectif_api', objectif_id=0) }}".replace('/0', `/${id}`),
    kpis: "{{ url_for('get_objectifs_kpis_api') }}"
};

let currentObjectives = [];
let editingObjectiveId = null;
let allUsers = []; // Stocker tous les utilisateurs

// Charger les objectifs au d√©marrage
document.addEventListener('DOMContentLoaded', function() {
    const overlay = document.getElementById('globalLoadingOverlay');
    if (overlay) {
        overlay.classList.remove('show');
    }
    loadObjectives();
    loadUsers();
    loadServices();
});

// Charger la liste des objectifs
async function loadObjectives() {
    try {
        showGlobalLoading('Chargement des objectifs...', 'Veuillez patienter');
        
        const response = await fetch(API_URLS.list);
        const result = await response.json();
        
        if (result.success) {
            currentObjectives = result.data;
            displayObjectives(result.data);
        } else {
            showError('Erreur lors du chargement des objectifs');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors du chargement des objectifs');
    } finally {
        hideGlobalLoading();
    }
}

// Charger la liste des utilisateurs
async function loadUsers() {
    try {
        const response = await fetch("{{ url_for('list_users') }}");
        allUsers = await response.json();
        
        // Ne pas peupler le select ici, attendre la s√©lection du service
        const select = document.getElementById('responsable_id');
        select.innerHTML = '<option value="">S√©lectionner d\'abord un service...</option>';
    } catch (error) {
        console.error('Erreur lors du chargement des utilisateurs:', error);
    }
}

// Filtrer les utilisateurs par service
async function filterUsersByService() {
    const serviceSelect = document.getElementById('service_responsable');
    const userSelect = document.getElementById('responsable_id');
    const selectedServiceId = serviceSelect.value;
    
    userSelect.innerHTML = '<option value="">Chargement...</option>';
    
    if (!selectedServiceId) {
        userSelect.innerHTML = '<option value="">S√©lectionner d\'abord un service...</option>';
        return;
    }
    
    try {
        // Charger les utilisateurs du service s√©lectionn√©
        const response = await fetch("{{ url_for('get_users_by_service', service_id=0) }}".replace('/0', `/${selectedServiceId}`));
        const users = await response.json();
        
        userSelect.innerHTML = '<option value="">S√©lectionner un responsable...</option>';
        
        if (users && users.length > 0) {
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.full_name || user.email;
                userSelect.appendChild(option);
            });
        } else {
            userSelect.innerHTML += '<option value="" disabled>Aucun utilisateur dans ce service</option>';
        }
    } catch (error) {
        console.error('Erreur lors du filtrage des utilisateurs:', error);
        userSelect.innerHTML = '<option value="">Erreur de chargement</option>';
    }
}

// Charger la liste des services
let allServices = []; // Stocker tous les services avec leurs IDs
async function loadServices() {
    try {
        const response = await fetch("{{ url_for('get_services_api') }}");
        const services = await response.json();
        allServices = services; // Stocker pour le filtrage
        
        const select = document.getElementById('service_responsable');
        select.innerHTML = '<option value="">S√©lectionner un service...</option>';
        
        if (services && Array.isArray(services)) {
            services.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id; // Utiliser l'ID au lieu du libell√©
                option.textContent = `${service.code} - ${service.libelle}`;
                option.setAttribute('data-libelle', service.libelle); // Stocker le libell√© comme data attribute
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erreur lors du chargement des services:', error);
        // Si l'API n'existe pas encore, on laisse le champ vide
    }
}

// Afficher les objectifs
function displayObjectives(objectives) {
    const container = document.getElementById('objectives-list');
    
    if (objectives.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üéØ</div>
                <h3 class="empty-state-title">Aucun objectif de performance</h3>
                <p class="empty-state-message">
                    Vous n'avez pas encore d√©fini d'objectifs de performance.<br>
                    Commencez par cr√©er votre premier objectif pour suivre et am√©liorer vos r√©sultats.
                </p>
                <button class="btn btn-premium btn-primary" onclick="openCreateModal()">
                    ‚ûï Cr√©er mon premier objectif
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = objectives.map(obj => `
        <article class="objective-card" data-id="${obj.id}">
            <div class="objective-top">
                <div class="objective-icon">${getTypeIcon(obj.type_objectif)}</div>
                <span class="objective-status status-badge status-${obj.statut.toLowerCase().replace('_', '-')}">${getStatusLabel(obj.statut)}</span>
            </div>

            <div class="objective-header">
                <h3 class="objective-title">${obj.titre}</h3>
                <div class="objective-actions">
                    <button type="button" class="btn-action btn-premium btn-secondary btn-compact" onclick="editObjective(${obj.id})" title="Modifier">‚úèÔ∏è</button>
                    <button type="button" class="btn-action btn-premium btn-danger btn-compact" onclick="deleteObjective(${obj.id}, '${obj.titre.replace(/'/g, '&#39;')}')" title="Supprimer">üóëÔ∏è</button>
                </div>
            </div>

            <p class="objective-description">${obj.description || 'Aucune description'}</p>

            <div class="objective-progress">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${obj.progression_pourcentage}%"></div>
                </div>
                <div class="progress-text">
                    <span>${obj.progression_pourcentage}%</span>
                    <span>${obj.valeur_actuelle} / ${obj.valeur_cible} ${obj.unite}</span>
                </div>
            </div>

            <div class="objective-meta">
                <div class="meta-item">
                    <div class="meta-label">Type</div>
                    <div class="meta-value">${getTypeLabel(obj.type_objectif)}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">√âch√©ance</div>
                    <div class="meta-value">${formatDate(obj.date_fin)}</div>
                </div>
            </div>
        </article>
    `).join('');
}

// Fonctions pour g√©rer les modales
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('show');
        document.body.classList.add('modal-open');
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('show');
        document.body.classList.remove('modal-open');
    }
}

// Ouvrir le modal de cr√©ation
function openCreateModal() {
    editingObjectiveId = null;
    document.getElementById('modalTitle').textContent = 'Nouvel Objectif';
    document.getElementById('objectiveForm').reset();
    showModal('objectiveModal');
}

// Modifier un objectif
function editObjective(id) {
    const objective = currentObjectives.find(obj => obj.id === id);
    if (!objective) return;
    
    editingObjectiveId = id;
    document.getElementById('modalTitle').textContent = 'Modifier l\'Objectif';
    
    // Remplir le formulaire
    document.getElementById('objectiveId').value = objective.id;
    document.getElementById('titre').value = objective.titre;
    document.getElementById('description').value = objective.description || '';
    document.getElementById('type_objectif').value = objective.type_objectif;
    document.getElementById('priorite').value = objective.priorite;
    document.getElementById('date_debut').value = objective.date_debut;
    document.getElementById('date_fin').value = objective.date_fin;
    document.getElementById('periode').value = objective.periode || '';
    document.getElementById('valeur_cible').value = objective.valeur_cible;
    document.getElementById('valeur_actuelle').value = objective.valeur_actuelle;
    document.getElementById('unite').value = objective.unite;
    document.getElementById('commentaires').value = objective.commentaires || '';
    
    // Trouver l'ID du service √† partir du libell√©
    const serviceLibelle = objective.service_responsable || '';
    const serviceSelect = document.getElementById('service_responsable');
    for (let option of serviceSelect.options) {
        if (option.getAttribute('data-libelle') === serviceLibelle) {
            serviceSelect.value = option.value;
            break;
        }
    }
    
    // D√©clencher le filtrage des utilisateurs par service
    filterUsersByService();
    
    // Puis s√©lectionner le responsable
    setTimeout(() => {
        document.getElementById('responsable_id').value = objective.responsable_id;
    }, 200);
    
    showModal('objectiveModal');
}

// Supprimer un objectif
async function deleteObjective(id, titre) {
    if (!confirm(`√ätes-vous s√ªr de vouloir supprimer l'objectif "${titre}" ?\n\nCette action est irr√©versible.`)) {
        return;
    }
    
    try {
        showGlobalLoading('Suppression en cours...', 'Veuillez patienter');
        
        const response = await fetch(API_URLS.delete(id), {
            method: 'DELETE'
        });
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            loadObjectives();
        } else {
            showError(result.error);
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de la suppression');
    } finally {
        hideGlobalLoading();
    }
}

// Fermer le modal
function closeModal() {
    hideModal('objectiveModal');
    document.getElementById('objectiveForm').reset();
    editingObjectiveId = null;
}

// Soumettre le formulaire
document.getElementById('objectiveForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
        showGlobalLoading('Enregistrement en cours...', 'Veuillez patienter');
        
        const formData = new FormData(this);
        
        // Convertir l'ID du service en libell√© pour la sauvegarde
        const serviceSelect = document.getElementById('service_responsable');
        const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
        if (selectedOption && selectedOption.getAttribute('data-libelle')) {
            formData.set('service_responsable', selectedOption.getAttribute('data-libelle'));
        }
        
        const url = editingObjectiveId 
            ? API_URLS.update(editingObjectiveId)
            : API_URLS.create;
        const method = editingObjectiveId ? 'PUT' : 'POST';
        
        const response = await submitFormAsJson(url, formData, method, true);
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            closeModal();
            loadObjectives();
        } else {
            showError(result.error);
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de l\'enregistrement');
    } finally {
        hideGlobalLoading();
    }
});

// Filtrer les objectifs
function filterObjectives() {
    const searchInput = document.getElementById('search-input').value.toLowerCase();
    const statutFilter = document.getElementById('filter-statut').value;
    const typeFilter = document.getElementById('filter-type').value;
    
    let filteredObjectives = currentObjectives;
    
    // Filtre de recherche par titre ou description
    if (searchInput) {
        filteredObjectives = filteredObjectives.filter(obj => 
            obj.titre.toLowerCase().includes(searchInput) || 
            (obj.description && obj.description.toLowerCase().includes(searchInput))
        );
    }
    
    // Filtre par statut
    if (statutFilter) {
        filteredObjectives = filteredObjectives.filter(obj => obj.statut === statutFilter);
    }
    
    // Filtre par type
    if (typeFilter) {
        filteredObjectives = filteredObjectives.filter(obj => obj.type_objectif === typeFilter);
    }
    
    displayObjectives(filteredObjectives);
}

// Fonctions utilitaires
function getStatusLabel(statut) {
    const labels = {
        'PLANIFIE': 'Planifi√©',
        'EN_COURS': 'En Cours',
        'ATTEINT': 'Atteint',
        'EN_RETARD': 'En Retard',
        'ANNULE': 'Annul√©'
    };
    return labels[statut] || statut;
}

function getTypeLabel(type) {
    const labels = {
        'STRATEGIQUE': 'Strat√©gique',
        'OPERATIONNEL': 'Op√©rationnel',
        'FINANCIER': 'Financier',
        'RH': 'RH',
        'QUALITE': 'Qualit√©',
        'CLIENT': 'Client'
    };
    return labels[type] || type;
}

function getTypeIcon(type) {
    const icons = {
        'STRATEGIQUE': 'üéØ',
        'OPERATIONNEL': '‚öôÔ∏è',
        'FINANCIER': 'üí∞',
        'RH': 'üë•',
        'QUALITE': '‚≠ê',
        'CLIENT': 'ü§ù'
    };
    return icons[type] || 'üìä';
}

function formatDate(dateString) {
    return new Date(dateString).toLocaleDateString('fr-FR');
}
</script>
{% endblock %}
