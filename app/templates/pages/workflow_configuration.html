{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}Configuration des Workflows - {{ app_name }}{% endblock %}

{% block styles %}
<style>
/* Configuration Workflows Styles */
.workflow-config-container {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
}

/* Tabs */
.tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    border-bottom: 2px solid #e0e0e0;
}

.tab-button {
    padding: 1rem 1.5rem;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    color: #666;
    transition: all 0.3s;
}

.tab-button:hover {
    color: var(--primary-color);
}

.tab-button.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* Templates Grid */
.templates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.template-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s;
    border-left: 4px solid var(--primary-color);
}

.template-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.template-card.system {
    border-left-color: #28a745;
    background: #f8fff9;
}

.template-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.template-icon {
    font-size: 2rem;
}

.template-info h4 {
    margin: 0;
    color: #333;
    font-size: 1.1rem;
}

.template-info .badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-top: 0.25rem;
}

.badge-system {
    background: #d4edda;
    color: #155724;
}

.badge-custom {
    background: #d1ecf1;
    color: #0c5460;
}

.template-description {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.template-stats {
    display: flex;
    gap: 1rem;
    font-size: 0.85rem;
    color: #999;
    margin-bottom: 1rem;
}

.template-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    justify-content: flex-start;
    align-items: center;
}

.btn-sm {
    padding: 0.4rem 0.75rem;
    font-size: 0.75rem;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 500;
    height: 30px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    white-space: nowrap;
}

.btn-preview {
    background: #17a2b8;
    color: white;
}

.btn-preview:hover {
    background: #138496;
}

.btn-edit {
    background: #ffc107;
    color: #333;
}

.btn-edit:hover {
    background: #e0a800;
}

.btn-delete {
    background: #dc3545;
    color: white;
}

.btn-delete:hover {
    background: #c82333;
}

/* Request Types */
.request-types-container {
    display: grid;
    gap: 1rem;
}

.category-section {
    margin-bottom: 2rem;
}

.category-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    border-radius: 8px;
    margin-bottom: 1rem;
}

.request-types-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
}

.request-type-card {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    transition: all 0.3s;
    min-height: 100px;
}

.request-type-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}

.request-type-icon {
    font-size: 2rem;
    flex-shrink: 0;
}

.request-type-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.request-type-info h5 {
    margin: 0;
    color: #333;
}

.request-type-info p {
    margin: 0;
    font-size: 0.85rem;
    color: #666;
}

.request-type-info .btn-sm {
    padding: 0.3rem 0.6rem;
    font-size: 0.7rem;
    height: auto;
    white-space: nowrap;
}

/* Custom Roles */
.roles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.role-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.role-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 1rem;
}

.role-header h4 {
    margin: 0;
    color: #333;
}

.role-agents {
    font-size: 0.9rem;
    color: #666;
    margin-top: 0.5rem;
}

/* Preview Modal */
.workflow-preview {
    padding: 2rem;
}

.workflow-step {
    display: flex;
    align-items: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 1rem;
    position: relative;
}

.workflow-step::after {
    content: 'â†“';
    position: absolute;
    bottom: -1.5rem;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1.5rem;
    color: var(--primary-color);
}

.workflow-step:last-child::after {
    display: none;
}

.step-number {
    background: var(--primary-color);
    color: white;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 1rem;
}

.step-info {
    flex: 1;
}

.step-role {
    font-weight: 600;
    color: #333;
}

.step-details {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.25rem;
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem;
    color: #999;
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

/* Action Button */
.action-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.3s;
}

.action-btn:hover {
    background: var(--secondary-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* Form Groups */
.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #333;
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 1rem;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
}

select.form-control {
    cursor: pointer;
}

/* Steps Editor */
.steps-editor {
    margin-top: 1.5rem;
}

.step-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 0.5rem;
}

.step-order {
    background: var(--primary-color);
    color: white;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.step-item-content {
    flex: 1;
}

.step-item-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-icon {
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

.btn-icon:hover {
    transform: scale(1.1);
}

/* Direction Selection */
.direction-option {
    cursor: pointer;
}

.direction-label {
    display: block;
    padding: 1.5rem;
    background: white;
    border: 2px solid #ddd;
    border-radius: 12px;
    text-align: center;
    transition: all 0.3s;
    cursor: pointer;
}

.direction-label:hover {
    border-color: var(--primary-color);
    background: #f0f8ff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.direction-option input[type="radio"]:checked + .direction-label {
    border-color: var(--primary-color);
    background: linear-gradient(135deg, rgba(74, 144, 226, 0.1), rgba(52, 152, 219, 0.05));
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
}

.direction-icon {
    font-size: 3rem;
    margin-bottom: 0.5rem;
}

.direction-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 0.25rem;
}

.direction-desc {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 0.5rem;
}

.direction-example {
    font-size: 0.8rem;
    color: #999;
    font-style: italic;
}

/* Icon Picker */
.icon-btn {
    width: 50px;
    height: 50px;
    border: 2px solid #ddd;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    font-size: 1.5rem;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.icon-btn:hover {
    border-color: var(--primary-color);
    background: #f0f8ff;
    transform: scale(1.1);
}

.icon-btn.selected {
    border-color: var(--primary-color);
    background: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
}

/* Delete Menu Dropdown */
.delete-menu {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 0.5rem;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    min-width: 200px;
    z-index: 1000;
}

.delete-menu-item {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    width: 100%;
    padding: 0.75rem 1rem;
    border: none;
    background: white;
    cursor: pointer;
    text-align: left;
    transition: background 0.2s;
    font-size: 0.9rem;
    border-bottom: 1px solid #f0f0f0;
}

.delete-menu-item:last-child {
    border-bottom: none;
}

.delete-menu-item:hover {
    background: #f8f9fa;
}

.delete-menu-item.danger:hover {
    background: #fff5f5;
    color: #dc3545;
}

.delete-menu-item small {
    font-size: 0.75rem;
    color: #999;
    margin-top: 0.25rem;
}

.delete-menu-item.danger small {
    color: #dc3545;
}

/* Workflow Steps Selector */
.workflow-steps-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.step-checkbox {
    position: relative;
}

.step-checkbox input[type="checkbox"] {
    position: absolute;
    opacity: 0;
    cursor: pointer;
}

.step-checkbox-label {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: white;
    border: 2px solid #ddd;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s;
}

.step-checkbox-label:hover {
    border-color: var(--primary-color);
    background: #f8f9fa;
}

.step-checkbox input[type="checkbox"]:checked + .step-checkbox-label {
    border-color: var(--primary-color);
    background: linear-gradient(135deg, rgba(74, 144, 226, 0.05), rgba(52, 152, 219, 0.02));
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
}

.step-checkbox-icon {
    font-size: 2rem;
    flex-shrink: 0;
}

.step-checkbox-content {
    flex: 1;
}

.step-checkbox-title {
    font-weight: 600;
    color: #333;
    margin-bottom: 0.25rem;
    font-size: 0.95rem;
}

.step-checkbox-desc {
    font-size: 0.8rem;
    color: #666;
}
</style>
{% endblock %}

{% block content %}
{{ page_header(
    title='ğŸ”„ Configuration des Workflows',
    breadcrumbs=[
        {'name': 'Accueil', 'url': url_for('accueil')},
        {'name': 'Configuration Workflows'}
    ],
    actions=[
        {'label': 'â† Retour Accueil', 'url': url_for('accueil'), 'primary': False}
    ]
) }}

<div class="workflow-config-container">
    
    <!-- Tabs Navigation -->
    <div class="tabs">
        <button class="tab-button active" onclick="switchTab('templates')">
            ğŸ“‹ Templates de Workflows
        </button>
        <button class="tab-button" onclick="switchTab('request-types')">
            ğŸ“ Types de Demandes
        </button>
        <button class="tab-button" onclick="switchTab('custom-roles')">
            ğŸ‘¥ RÃ´les PersonnalisÃ©s
        </button>
    </div>

    <!-- Tab 1: Templates -->
    <div id="tab-templates" class="tab-content active">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3>ğŸ“‹ Templates de Workflows</h3>
            <div style="display: flex; gap: 0.5rem;">
                <button class="action-btn" style="background: #28a745;" onclick="initializeSystemWorkflows()">
                    ğŸ”„ Initialiser les Workflows SystÃ¨me
                </button>
                <button class="action-btn" onclick="openCreateTemplateModal()">
                    â• CrÃ©er un Template
                </button>
            </div>
        </div>

        <div class="templates-grid" id="templates-container">
            <!-- Templates will be loaded here -->
        </div>
    </div>

    <!-- Tab 2: Request Types -->
    <div id="tab-request-types" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3>ğŸ“ Types de Demandes</h3>
            <button class="action-btn" onclick="openCreateRequestTypeModal()">
                â• CrÃ©er un Type de Demande
            </button>
        </div>

        <div class="request-types-container" id="request-types-container">
            <!-- Request types will be loaded here -->
        </div>
    </div>

    <!-- Tab 3: Custom Roles -->
    <div id="tab-custom-roles" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3>ğŸ‘¥ RÃ´les PersonnalisÃ©s</h3>
            <button class="action-btn" onclick="openCreateRoleModal()">
                â• CrÃ©er un RÃ´le
            </button>
        </div>

        <div class="roles-grid" id="roles-container">
            <!-- Roles will be loaded here -->
        </div>
    </div>

</div>

<!-- Modal: Create/Edit Template -->
<div id="modal-template" class="modal-lg">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-template-title" style="color:var(--white-color)">CrÃ©er un Template</h3>
            <button class="modal-close" onclick="closeModal('modal-template')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="form-template" onsubmit="saveTemplate(event)">
                <input type="hidden" id="template-id" name="id">
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                    <!-- Colonne gauche: Formulaire -->
                    <div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Code du Template *</label>
                                <input type="text" class="form-control" id="template-code" name="code" required>
                            </div>
                            <div class="form-group">
                                <label>Nom du Template *</label>
                                <input type="text" class="form-control" id="template-nom" name="nom" required>
                            </div>
                        </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control" id="template-description" name="description" rows="3" readonly style="background: #f8f9fa; cursor: not-allowed;"></textarea>
                    <small style="color: #999; font-size: 0.8rem;">
                        ğŸ’¡ La description est gÃ©nÃ©rÃ©e automatiquement selon les niveaux sÃ©lectionnÃ©s
                    </small>
                </div>

                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>Direction du Workflow *</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.5rem;">
                        <div class="direction-option" onclick="selectDirection('ASCENDANT')">
                            <input type="radio" name="direction" id="direction-ascendant" value="ASCENDANT" checked style="display: none;">
                            <label for="direction-ascendant" class="direction-label">
                                <div class="direction-icon">â¬†ï¸</div>
                                <div class="direction-title">Ascendant</div>
                                <div class="direction-desc">Agent â†’ HiÃ©rarchie</div>
                                <div class="direction-example">Ex: Demande de congÃ©</div>
                            </label>
                        </div>
                        <div class="direction-option" onclick="selectDirection('DESCENDANT')">
                            <input type="radio" name="direction" id="direction-descendant" value="DESCENDANT" style="display: none;">
                            <label for="direction-descendant" class="direction-label">
                                <div class="direction-icon">â¬‡ï¸</div>
                                <div class="direction-title">Descendant</div>
                                <div class="direction-desc">Chef â†’ Agent</div>
                                <div class="direction-example">Ex: Instruction, TÃ¢che</div>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>IcÃ´ne</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                            <input type="text" class="form-control" id="template-icone" name="icone" value="ğŸ“„" maxlength="10" placeholder="ğŸ“„" readonly style="width: 100px; text-align: center; font-size: 1.5rem; cursor: pointer;" onclick="toggleIconPicker()">
                            <span style="color: #666; font-size: 0.9rem;">Cliquez pour choisir une icÃ´ne</span>
                        </div>
                        <div id="icon-picker" style="display: none; padding: 1rem; background: #f8f9fa; border-radius: 8px; max-height: 200px; overflow-y: auto;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 0.5rem;">
                                <!-- IcÃ´nes gÃ©nÃ©rales -->
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ“„')">ğŸ“„</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ“‹')">ğŸ“‹</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ“')">ğŸ“</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ“‘')">ğŸ“‘</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ“Š')">ğŸ“Š</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ“ˆ')">ğŸ“ˆ</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ“‰')">ğŸ“‰</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ“†')">ğŸ“†</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ“…')">ğŸ“…</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ—“ï¸')">ğŸ—“ï¸</button>
                                <!-- RH & Personnel -->
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ‘¤')">ğŸ‘¤</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ‘¥')">ğŸ‘¥</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ‘¨â€ğŸ’¼')">ğŸ‘¨â€ğŸ’¼</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ‘©â€ğŸ’¼')">ğŸ‘©â€ğŸ’¼</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ§‘â€ğŸ’¼')">ğŸ§‘â€ğŸ’¼</button>
                                <!-- Actions -->
                                <button type="button" class="icon-btn" onclick="selectIcon('âœ…')">âœ…</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('âœ”ï¸')">âœ”ï¸</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('âŒ')">âŒ</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('âš ï¸')">âš ï¸</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ””')">ğŸ””</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ”•')">ğŸ”•</button>
                                <!-- Workflow -->
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ”„')">ğŸ”„</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ”')">ğŸ”</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('â¬†ï¸')">â¬†ï¸</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('â¬‡ï¸')">â¬‡ï¸</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('â¡ï¸')">â¡ï¸</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('â¬…ï¸')">â¬…ï¸</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ”€')">ğŸ”€</button>
                                <!-- Objets -->
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ’¼')">ğŸ’¼</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ“')">ğŸ“</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ–ï¸')">ğŸ–ï¸</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('âœˆï¸')">âœˆï¸</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ¥')">ğŸ¥</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ’°')">ğŸ’°</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ’µ')">ğŸ’µ</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ¦')">ğŸ¦</button>
                                <!-- MatÃ©riel -->
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ–¥ï¸')">ğŸ–¥ï¸</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('âŒ¨ï¸')">âŒ¨ï¸</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ–¨ï¸')">ğŸ–¨ï¸</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ“±')">ğŸ“±</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ’»')">ğŸ’»</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ–±ï¸')">ğŸ–±ï¸</button>
                                <!-- Autres -->
                                <button type="button" class="icon-btn" onclick="selectIcon('âš™ï¸')">âš™ï¸</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ”§')">ğŸ”§</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ”¨')">ğŸ”¨</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ› ï¸')">ğŸ› ï¸</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ“¦')">ğŸ“¦</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ“®')">ğŸ“®</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ“¬')">ğŸ“¬</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸ¯')">ğŸ¯</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('ğŸš€')">ğŸš€</button>
                                <button type="button" class="icon-btn" onclick="selectIcon('â­')">â­</button>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Couleur</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="color" id="template-couleur" name="couleur" value="#3498db" style="width: 60px; height: 40px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;">
                            <input type="text" class="form-control" id="template-couleur-text" value="#3498db" readonly style="flex: 1; background: #f8f9fa;">
                        </div>
                    </div>
                </div>

                <!-- Ã‰tapes du Workflow -->
                <div class="form-group" style="grid-column: 1 / -1; margin-top: 1rem;">
                    <label style="font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; display: block;">
                        ğŸ“‹ Niveaux de Validation
                    </label>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
                        SÃ©lectionnez les niveaux qui doivent intervenir dans ce workflow (dans l'ordre)
                    </p>
                    
                    <div class="workflow-steps-selector">
                        <div class="step-checkbox">
                            <input type="checkbox" id="step-n1" name="steps[]" value="N+1" checked onchange="updateWorkflowPreview()">
                            <label for="step-n1" class="step-checkbox-label">
                                <div class="step-checkbox-icon">1ï¸âƒ£</div>
                                <div class="step-checkbox-content">
                                    <div class="step-checkbox-title">N+1 - Chef de Service</div>
                                    <div class="step-checkbox-desc">Superviseur direct de l'agent</div>
                                </div>
                            </label>
                        </div>
                        
                        <div class="step-checkbox">
                            <input type="checkbox" id="step-n2" name="steps[]" value="N+2" checked onchange="updateWorkflowPreview()">
                            <label for="step-n2" class="step-checkbox-label">
                                <div class="step-checkbox-icon">2ï¸âƒ£</div>
                                <div class="step-checkbox-content">
                                    <div class="step-checkbox-title">N+2 - Sous-directeur</div>
                                    <div class="step-checkbox-desc">Chef de dÃ©partement</div>
                                </div>
                            </label>
                        </div>
                        
                        <div class="step-checkbox">
                            <input type="checkbox" id="step-rh" name="steps[]" value="RH" onchange="updateWorkflowPreview()">
                            <label for="step-rh" class="step-checkbox-label">
                                <div class="step-checkbox-icon">3ï¸âƒ£</div>
                                <div class="step-checkbox-content">
                                    <div class="step-checkbox-title">RH - Ressources Humaines</div>
                                    <div class="step-checkbox-desc">Validation RH (pour types RH uniquement)</div>
                                </div>
                            </label>
                        </div>
                        
                        <div class="step-checkbox">
                            <input type="checkbox" id="step-daf" name="steps[]" value="DAF" onchange="updateWorkflowPreview()">
                            <label for="step-daf" class="step-checkbox-label">
                                <div class="step-checkbox-icon">4ï¸âƒ£</div>
                                <div class="step-checkbox-content">
                                    <div class="step-checkbox-title">DAF - Direction Administrative</div>
                                    <div class="step-checkbox-desc">Signature finale</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                        <p style="color: #999; font-size: 0.85rem; margin-top: 0.5rem; font-style: italic;">
                            ğŸ’¡ Les Ã©tapes non cochÃ©es seront sautÃ©es dans le circuit de validation
                        </p>
                    </div>
                    </div>
                    
                    <!-- Colonne droite: PrÃ©visualisation du SchÃ©ma -->
                    <div>
                        <div style="position: sticky; top: 1rem;">
                            <h4 style="margin: 0 0 1rem 0; color: #333; font-size: 1rem;">
                                ğŸ“Š AperÃ§u du Circuit
                            </h4>
                            <div id="workflow-preview-live" style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; min-height: 300px;">
                                <!-- La prÃ©visualisation sera gÃ©nÃ©rÃ©e ici -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modal-template')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Preview Workflow -->
<div id="modal-preview" class="modal-lg">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="color:var(--white-color)">ğŸ‘ï¸ PrÃ©visualisation du Workflow</h3>
            <button class="modal-close" onclick="closeModal('modal-preview')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="preview-container" class="workflow-preview">
                <!-- Preview will be rendered here -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('modal-preview')">Fermer</button>
        </div>
    </div>
</div>

<!-- Modal: Create Request Type -->
<div id="modal-request-type" class="modal-lg">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-request-type-title" style="color:var(--white-color)">CrÃ©er un Type de Demande</h3>
            <button class="modal-close" onclick="closeModal('modal-request-type')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="form-request-type" onsubmit="saveRequestType(event)">
                <div class="form-row">
                    <div class="form-group">
                        <label>Code *</label>
                        <input type="text" class="form-control" id="rt-code" name="code" required>
                    </div>
                    <div class="form-group">
                        <label>LibellÃ© *</label>
                        <input type="text" class="form-control" id="rt-libelle" name="libelle" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control" id="rt-description" name="description" rows="2"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Template de Workflow *</label>
                        <select class="form-control" id="rt-template" name="workflow_template_id" required>
                            <option value="">-- SÃ©lectionner un template --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>CatÃ©gorie</label>
                        <select class="form-control" id="rt-categorie" name="categorie">
                            <option value="RH">RH</option>
                            <option value="Logistique">Logistique</option>
                            <option value="Administratif">Administratif</option>
                            <option value="Budget">Budget</option>
                            <option value="Autre">Autre</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="rt-doc-obligatoire" name="document_obligatoire">
                            Document obligatoire
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="rt-validation-rh" name="necessite_validation_rh">
                            Validation RH obligatoire
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="rt-validation-daf" name="necessite_validation_daf">
                            Validation DAF obligatoire
                        </label>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modal-request-type')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Create Custom Role -->
<div id="modal-role" class="modal-md">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-role-title" style="color:var(--white-color)">â• Nouveau RÃ´le PersonnalisÃ©</h3>
            <button class="modal-close" onclick="closeModal('modal-role')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="form-role" onsubmit="saveRole(event)">
                <div class="form-group">
                    <label>Code du RÃ´le *</label>
                    <input type="text" class="form-control" id="role-code" name="code" required placeholder="Ex: SUPERVISEUR">
                </div>

                <div class="form-group">
                    <label>LibellÃ© *</label>
                    <input type="text" class="form-control" id="role-libelle" name="libelle" required placeholder="Ex: Superviseur de projet">
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control" id="role-description" name="description" rows="3" placeholder="Description du rÃ´le et de ses responsabilitÃ©s..."></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('modal-role')">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
console.log('ğŸ”„ Chargement du script workflow_configuration.html...');

// Global state
let templates = [];
let requestTypes = [];
let customRoles = [];

// Tab switching
function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(`tab-${tabName}`).classList.add('active');
    event.target.classList.add('active');
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadTemplates();
    loadRequestTypes();
    loadCustomRoles();
    
    // Synchroniser le color picker avec le champ texte
    const colorPicker = document.getElementById('template-couleur');
    const colorText = document.getElementById('template-couleur-text');
    
    if (colorPicker && colorText) {
        colorPicker.addEventListener('input', function(e) {
            colorText.value = e.target.value;
        });
    }
    
    // Mettre Ã  jour la prÃ©visualisation quand on coche/dÃ©coche
    document.querySelectorAll('input[name="steps[]"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateWorkflowPreview);
    });
    
    // PrÃ©visualisation initiale
    updateWorkflowPreview();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEMPLATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadTemplates() {
    showGlobalLoading('Chargement des templates...', '');
    
    try {
        const response = await fetch('{{ url_for("api_list_workflow_templates") }}');
        templates = await response.json();
        
        renderTemplates();
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors du chargement des templates');
    } finally {
        hideGlobalLoading();
    }
}

function renderTemplates() {
    const container = document.getElementById('templates-container');
    
    if (templates.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“‹</div>
                <p><strong>Aucun template pour le moment</strong></p>
                <p>CrÃ©ez votre premier template de workflow</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = templates.map(t => `
        <div class="template-card ${t.est_systeme ? 'system' : ''}">
            <div class="template-header">
                <div class="template-icon">${t.icone}</div>
                <div class="template-info">
                    <h4>${t.nom}</h4>
                    <span class="badge ${t.est_systeme ? 'badge-system' : 'badge-custom'}">
                        ${t.est_systeme ? 'SystÃ¨me' : 'PersonnalisÃ©'}
                    </span>
                </div>
            </div>
            <p class="template-description">${t.description || 'Aucune description'}</p>
            <div class="template-stats">
                <span>ğŸ“Š Direction: ${t.direction === 'ASCENDANT' ? 'â¬†ï¸ Ascendant' : 'â¬‡ï¸ Descendant'}</span>
                <span>ğŸ¨ ${t.couleur}</span>
            </div>
            <div class="template-actions">
                <button class="btn-sm btn-preview" onclick="previewWorkflow(${t.id})">
                    ğŸ‘ï¸ PrÃ©visualiser
                </button>
                ${!t.est_systeme ? `
                    <button class="btn-sm btn-edit" onclick="editTemplate(${t.id})">
                        âœï¸ Ã‰diter
                    </button>
                    <div style="position: relative; display: inline-block;">
                        <button class="btn-sm btn-delete" onclick="toggleDeleteMenu(${t.id}, event)">
                            ğŸ—‘ï¸ Supprimer â–¼
                        </button>
                        <div id="delete-menu-${t.id}" class="delete-menu" style="display: none;">
                            <button onclick="deleteTemplate(${t.id})" class="delete-menu-item">
                                ğŸ”´ DÃ©sactiver
                                <small>Peut Ãªtre rÃ©activÃ©</small>
                            </button>
                            <button onclick="deleteTemplatePermanent(${t.id})" class="delete-menu-item danger">
                                ğŸ—‘ï¸ Supprimer dÃ©finitivement
                                <small>Action irrÃ©versible</small>
                            </button>
                        </div>
                    </div>
                ` : ''}
            </div>
        </div>
    `).join('');
}

function openCreateTemplateModal() {
    console.log('ğŸ“ Ouverture du modal de crÃ©ation de template...');
    
    const modal = document.getElementById('modal-template');
    if (!modal) {
        console.error('âŒ Modal modal-template introuvable !');
        alert('Erreur: Modal introuvable');
        return;
    }
    
    document.getElementById('modal-template-title').textContent = 'CrÃ©er un Template';
    document.getElementById('form-template').reset();
    document.getElementById('template-id').value = '';
    
    // RÃ©initialiser la sÃ©lection de direction
    document.getElementById('direction-ascendant').checked = true;
    
    showModal('modal-template');
    
    console.log('âœ… Modal ouvert');
}

async function editTemplate(templateId) {
    console.log('âœï¸ Ã‰dition du template:', templateId);
    
    showGlobalLoading('Chargement du template...', '');
    
    try {
        // Trouver le template dans la liste
        const template = templates.find(t => t.id === templateId);
        
        if (!template) {
            showError('Template introuvable');
            hideGlobalLoading();
            return;
        }
        
        // Charger les Ã©tapes du template
        const stepsResponse = await fetch(`{{ url_for("api_get_template_steps", template_id=0) }}`.replace('/0', `/${templateId}`));
        const steps = await stepsResponse.json();
        
        // Remplir le formulaire
        document.getElementById('modal-template-title').textContent = 'Ã‰diter le Template';
        document.getElementById('template-id').value = template.id;
        document.getElementById('template-code').value = template.code;
        document.getElementById('template-nom').value = template.nom;
        document.getElementById('template-description').value = template.description || '';
        document.getElementById('template-icone').value = template.icone;
        document.getElementById('template-couleur').value = template.couleur;
        document.getElementById('template-couleur-text').value = template.couleur;
        
        // SÃ©lectionner la direction
        if (template.direction === 'ASCENDANT') {
            document.getElementById('direction-ascendant').checked = true;
        } else {
            document.getElementById('direction-descendant').checked = true;
        }
        
        // DÃ©cocher toutes les Ã©tapes d'abord
        document.querySelectorAll('input[name="steps[]"]').forEach(cb => cb.checked = false);
        
        // Cocher les Ã©tapes du template
        steps.forEach(step => {
            const checkbox = document.querySelector(`input[name="steps[]"][value="${step.role_type}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
        
        // Mettre Ã  jour la prÃ©visualisation
        updateWorkflowPreview();
        
        // Ouvrir le modal
        showModal('modal-template');
        
        console.log('âœ… Modal d\'Ã©dition ouvert');
        
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors du chargement du template');
    } finally {
        hideGlobalLoading();
    }
}

console.log('âœ… Fonction editTemplate dÃ©finie');

async function saveTemplate(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData.entries());
    
    // RÃ©cupÃ©rer les Ã©tapes sÃ©lectionnÃ©es
    const selectedSteps = [];
    document.querySelectorAll('input[name="steps[]"]:checked').forEach((checkbox, index) => {
        selectedSteps.push({
            role_type: checkbox.value,
            order_index: index + 1
        });
    });
    
    // Ajouter les Ã©tapes aux donnÃ©es
    data.steps = selectedSteps;
    
    // VÃ©rifier si c'est une crÃ©ation ou une modification
    const templateId = document.getElementById('template-id').value;
    const isEdit = templateId && templateId !== '';
    
    showGlobalLoading(isEdit ? 'Modification...' : 'CrÃ©ation...', '');
    
    try {
        let url, method;
        
        if (isEdit) {
            // Modification
            url = `{{ url_for("api_update_workflow_template", template_id=0) }}`.replace('/0', `/${templateId}`);
            method = 'PUT';
        } else {
            // CrÃ©ation
            url = '{{ url_for("api_create_workflow_template") }}';
            method = 'POST';
        }
        
        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showSuccess(isEdit ? 'Template modifiÃ© avec succÃ¨s !' : 'Template crÃ©Ã© avec succÃ¨s !');
            closeModal('modal-template');
            loadTemplates();
        } else {
            showError(result.detail || (isEdit ? 'Erreur lors de la modification' : 'Erreur lors de la crÃ©ation'));
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de l\'enregistrement');
    } finally {
        hideGlobalLoading();
    }
}

async function previewWorkflow(templateId) {
    showGlobalLoading('GÃ©nÃ©ration de l\'aperÃ§u...', '');
    
    try {
        const response = await fetch(`{{ url_for("api_preview_workflow_template", template_id=0) }}`.replace('/0', `/${templateId}`));
        const preview = await response.json();
        
        renderPreview(preview);
        showModal('modal-preview');
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de la gÃ©nÃ©ration de l\'aperÃ§u');
    } finally {
        hideGlobalLoading();
    }
}

function renderPreview(preview) {
    const container = document.getElementById('preview-container');
    
    if (!preview.circuit) {
        container.innerHTML = '<p>Aucune donnÃ©e d\'aperÃ§u disponible</p>';
        return;
    }
    
    container.innerHTML = `
        <div style="text-align: center; margin-bottom: 2rem;">
            <h4>${preview.template.icone} ${preview.template.nom}</h4>
            <p>${preview.template.description}</p>
        </div>
        ${preview.circuit.map((step, index) => `
            <div class="workflow-step">
                <div class="step-number">${index + 1}</div>
                <div class="step-info">
                    <div class="step-role">${step.libelle}</div>
                    <div class="step-details">
                        ${step.obligatoire !== undefined ? (step.obligatoire ? 'âš ï¸ Obligatoire' : 'âœ“ Optionnel') : ''}
                        ${step.peut_rejeter !== undefined ? (step.peut_rejeter ? ' â€¢ Peut rejeter' : ' â€¢ Validation uniquement') : ''}
                        ${step.delai_jours ? ` â€¢ DÃ©lai: ${step.delai_jours} jours` : ''}
                    </div>
                </div>
            </div>
        `).join('')}
    `;
}

function toggleDeleteMenu(templateId, event) {
    event.stopPropagation();
    
    // Fermer tous les autres menus
    document.querySelectorAll('.delete-menu').forEach(menu => {
        if (menu.id !== `delete-menu-${templateId}`) {
            menu.style.display = 'none';
        }
    });
    
    // Toggle le menu actuel
    const menu = document.getElementById(`delete-menu-${templateId}`);
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}

// Fermer le menu si on clique ailleurs
document.addEventListener('click', function() {
    document.querySelectorAll('.delete-menu').forEach(menu => {
        menu.style.display = 'none';
    });
});

async function deleteTemplate(templateId) {
    if (!confirm('âš ï¸ DÃ©sactiver ce template ?\n\nLe template sera dÃ©sactivÃ© (soft delete).\nIl ne sera plus utilisable pour de nouveaux types de demandes.\n\nLes types existants continueront de fonctionner.')) {
        return;
    }
    
    showGlobalLoading('DÃ©sactivation du template...', 'Veuillez patienter');
    
    try {
        const response = await fetch(`{{ url_for("api_delete_workflow_template", template_id=0) }}`.replace('/0', `/${templateId}`), {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showSuccess('Template dÃ©sactivÃ© avec succÃ¨s');
            loadTemplates();
        } else {
            const result = await response.json();
            showError(result.detail || 'Erreur lors de la dÃ©sactivation');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de la dÃ©sactivation');
    } finally {
        hideGlobalLoading();
    }
}

async function deleteTemplatePermanent(templateId) {
    if (!confirm('ğŸš¨ ATTENTION - SUPPRESSION DÃ‰FINITIVE\n\nCette action est IRRÃ‰VERSIBLE !\n\nLe template et toutes ses Ã©tapes seront supprimÃ©s dÃ©finitivement de la base de donnÃ©es.\n\nÃŠtes-vous ABSOLUMENT sÃ»r ?')) {
        return;
    }
    
    showGlobalLoading('Suppression dÃ©finitive...', 'Cette action est irrÃ©versible');
    
    try {
        const response = await fetch(`{{ url_for("api_delete_workflow_template_permanent", template_id=0) }}`.replace('/0', `/${templateId}`), {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showSuccess('Template supprimÃ© dÃ©finitivement', 'Suppression rÃ©ussie');
            loadTemplates();
        } else {
            const result = await response.json();
            showError(result.detail || 'Erreur lors de la suppression');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de la suppression');
    } finally {
        hideGlobalLoading();
    }
}

async function initializeSystemWorkflows() {
    if (!confirm('Initialiser les 3 workflows systÃ¨me de base ?\n\n- Circuit Long (avec RH)\n- Circuit Moyen (sans RH)\n- TÃ¢che Descendante\n\nCette opÃ©ration est idempotente (peut Ãªtre exÃ©cutÃ©e plusieurs fois sans doublon).')) {
        return;
    }
    
    showGlobalLoading('Initialisation des workflows systÃ¨me...', 'Veuillez patienter');
    
    try {
        const response = await fetch('{{ url_for("api_initialize_system_workflows") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showSuccess('Workflows systÃ¨me initialisÃ©s avec succÃ¨s !');
            loadTemplates();
        } else {
            showError(result.detail || 'Erreur lors de l\'initialisation');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de l\'initialisation');
    } finally {
        hideGlobalLoading();
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REQUEST TYPES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadRequestTypes() {
    try {
        const response = await fetch('{{ url_for("api_list_request_types") }}');
        requestTypes = await response.json();
        
        renderRequestTypes();
    } catch (error) {
        console.error('Erreur:', error);
    }
}

function renderRequestTypes() {
    const container = document.getElementById('request-types-container');
    
    if (requestTypes.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“</div>
                <p><strong>Aucun type de demande personnalisÃ©</strong></p>
                <p>CrÃ©ez votre premier type de demande</p>
            </div>
        `;
        return;
    }
    
    // Grouper par catÃ©gorie
    const byCategory = requestTypes.reduce((acc, rt) => {
        const cat = rt.categorie || 'Autre';
        if (!acc[cat]) acc[cat] = [];
        acc[cat].push(rt);
        return acc;
    }, {});
    
    container.innerHTML = Object.keys(byCategory).map(category => `
        <div class="category-section">
            <div class="category-header">
                <h4>${category}</h4>
                <span>(${byCategory[category].length})</span>
            </div>
            <div class="request-types-list">
                ${byCategory[category].map(rt => `
                    <div class="request-type-card">
                        <div class="request-type-icon">${rt.icone || 'ğŸ“„'}</div>
                        <div class="request-type-info">
                            <h5>${rt.libelle}</h5>
                            <p style="font-size: 0.8rem; color: #666; margin: 0.25rem 0;">${rt.description || 'Aucune description'}</p>
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                <button class="btn-sm btn-preview" onclick="viewRequestType(${rt.id})">
                                    ğŸ‘ï¸ Voir
                                </button>
                                ${!rt.est_systeme ? `
                                    <button class="btn-sm btn-edit" onclick="editRequestType(${rt.id})">
                                        âœï¸ Ã‰diter
                                    </button>
                                    <button class="btn-sm btn-delete" onclick="deleteRequestType(${rt.id})">
                                        ğŸ”´ DÃ©sactiver
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');
}

async function openCreateRequestTypeModal() {
    // Charger les templates pour le select
    if (templates.length === 0) {
        await loadTemplates();
    }
    
    const selectTemplate = document.getElementById('rt-template');
    selectTemplate.innerHTML = '<option value="">-- SÃ©lectionner un template --</option>' +
        templates.filter(t => t.actif).map(t => `
            <option value="${t.id}">${t.icone} ${t.nom}</option>
        `).join('');
    
    // RÃ©initialiser le formulaire et le titre
    const form = document.getElementById('form-request-type');
    form.reset();
    delete form.dataset.requestTypeId;
    document.getElementById('modal-request-type-title').textContent = 'â• Nouveau Type de Demande';
    
    showModal('modal-request-type');
}

async function saveRequestType(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const requestTypeId = event.target.dataset.requestTypeId;
    const isEdit = !!requestTypeId;
    
    const data = {
        code: formData.get('code'),
        libelle: formData.get('libelle'),
        description: formData.get('description'),
        workflow_template_id: parseInt(formData.get('workflow_template_id')),
        categorie: formData.get('categorie'),
        document_obligatoire: formData.get('document_obligatoire') === 'on',
        necessite_validation_rh: formData.get('necessite_validation_rh') === 'on',
        necessite_validation_daf: formData.get('necessite_validation_daf') === 'on'
    };
    
    showGlobalLoading(isEdit ? 'Modification...' : 'CrÃ©ation...', '');
    
    try {
        let url, method;
        
        if (isEdit) {
            // Mode Ã©dition - PUT
            url = '{{ url_for("api_update_request_type", request_type_id=0) }}'.replace('/0', `/${requestTypeId}`);
            method = 'PUT';
        } else {
            // Mode crÃ©ation - POST
            url = '{{ url_for("api_create_request_type") }}';
            method = 'POST';
        }
        
        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showSuccess(isEdit ? 'Type de demande modifiÃ© avec succÃ¨s !' : 'Type de demande crÃ©Ã© avec succÃ¨s !');
            closeModal('modal-request-type');
            
            // RÃ©initialiser le formulaire
            delete event.target.dataset.requestTypeId;
            
            loadRequestTypes();
        } else {
            showError(result.detail || `Erreur lors de ${isEdit ? 'la modification' : 'la crÃ©ation'}`);
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de l\'enregistrement');
    } finally {
        hideGlobalLoading();
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CUSTOM ROLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadCustomRoles() {
    showGlobalLoading('Chargement des rÃ´les...', '');
    
    try {
        const response = await fetch('{{ url_for("api_list_custom_roles") }}');
        const data = await response.json();
        
        customRoles = data;
        renderCustomRoles();
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors du chargement des rÃ´les');
    } finally {
        hideGlobalLoading();
    }
}

function renderCustomRoles() {
    const container = document.getElementById('roles-container');
    
    if (customRoles.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ‘¥</div>
                <p><strong>Aucun rÃ´le personnalisÃ©</strong></p>
                <p>CrÃ©ez votre premier rÃ´le personnalisÃ©</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = customRoles.map(role => `
        <div class="template-card" style="min-height: 150px;">
            <div class="template-header">
                <h4>${role.libelle}</h4>
                <span class="badge badge-success">${role.code}</span>
            </div>
            <p style="font-size: 0.85rem; color: #666; margin: 0.5rem 0;">${role.description || 'Aucune description'}</p>
            <div class="template-footer" style="display: flex; gap: 0.5rem; margin-top: auto;">
                <button class="btn-sm btn-edit" onclick="editCustomRole(${role.id})">
                    âœï¸ Ã‰diter
                </button>
                <button class="btn-sm btn-delete" onclick="deleteCustomRole(${role.id})">
                    ğŸ”´ DÃ©sactiver
                </button>
            </div>
        </div>
    `).join('');
}

function openCreateRoleModal() {
    const form = document.getElementById('form-role');
    form.reset();
    delete form.dataset.roleId;
    document.getElementById('modal-role-title').textContent = 'â• Nouveau RÃ´le PersonnalisÃ©';
    showModal('modal-role');
}

async function saveRole(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const roleId = event.target.dataset.roleId;
    const isEdit = !!roleId;
    
    const data = {
        code: formData.get('code'),
        libelle: formData.get('libelle'),
        description: formData.get('description')
    };
    
    showGlobalLoading(isEdit ? 'Modification...' : 'CrÃ©ation...', '');
    
    try {
        let url, method;
        
        if (isEdit) {
            // Mode Ã©dition - PUT
            url = '{{ url_for("api_update_custom_role", role_id=0) }}'.replace('/0', `/${roleId}`);
            method = 'PUT';
        } else {
            // Mode crÃ©ation - POST
            url = '{{ url_for("api_create_custom_role") }}';
            method = 'POST';
        }
        
        const response = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showSuccess(isEdit ? 'RÃ´le modifiÃ© avec succÃ¨s !' : 'RÃ´le crÃ©Ã© avec succÃ¨s !');
            closeModal('modal-role');
            
            // RÃ©initialiser le formulaire
            delete event.target.dataset.roleId;
            
            loadCustomRoles();
        } else {
            showError(result.detail || `Erreur lors de ${isEdit ? 'la modification' : 'la crÃ©ation'}`);
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de l\'enregistrement');
    } finally {
        hideGlobalLoading();
    }
}

function editCustomRole(roleId) {
    const role = customRoles.find(r => r.id === roleId);
    if (!role) {
        showError('RÃ´le introuvable');
        return;
    }
    
    // Remplir le modal
    document.getElementById('modal-role-title').textContent = 'âœï¸ Ã‰diter le RÃ´le';
    document.getElementById('role-code').value = role.code;
    document.getElementById('role-libelle').value = role.libelle;
    document.getElementById('role-description').value = role.description || '';
    
    // Stocker l'ID pour la modification
    document.getElementById('form-role').dataset.roleId = role.id;
    
    // Ouvrir le modal
    showModal('modal-role');
}

async function deleteCustomRole(roleId) {
    if (!confirm('âš ï¸ DÃ©sactiver ce rÃ´le ?\n\nLe rÃ´le sera dÃ©sactivÃ© et ne sera plus disponible.\n\nLes attributions existantes continueront de fonctionner.')) {
        return;
    }
    
    showGlobalLoading('DÃ©sactivation...', '');
    
    try {
        const url = '{{ url_for("api_delete_custom_role", role_id=0) }}'.replace('/0', `/${roleId}`);
        
        const response = await fetch(url, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showSuccess('RÃ´le dÃ©sactivÃ© avec succÃ¨s !');
            loadCustomRoles();
        } else {
            showError(result.detail || 'Erreur lors de la dÃ©sactivation');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de la dÃ©sactivation');
    } finally {
        hideGlobalLoading();
    }
}

function viewRequestType(requestTypeId) {
    const rt = requestTypes.find(r => r.id === requestTypeId);
    if (!rt) {
        showError('Type de demande introuvable');
        return;
    }
    
    // Afficher les dÃ©tails dans un toast ou modal
    const details = `
Type: ${rt.libelle}
Code: ${rt.code}
CatÃ©gorie: ${rt.categorie}
Template: ID ${rt.workflow_template_id}
Document obligatoire: ${rt.document_obligatoire ? 'Oui' : 'Non'}
Validation RH: ${rt.necessite_validation_rh ? 'Oui' : 'Non'}
Validation DAF: ${rt.necessite_validation_daf ? 'Oui' : 'Non'}
    `;
    
    alert(details.trim());
}

async function editRequestType(requestTypeId) {
    const rt = requestTypes.find(r => r.id === requestTypeId);
    if (!rt) {
        showError('Type de demande introuvable');
        return;
    }
    
    // Charger les templates si besoin
    if (templates.length === 0) {
        await loadTemplates();
    }
    
    // Peupler le select des templates
    const selectTemplate = document.getElementById('rt-template');
    selectTemplate.innerHTML = '<option value="">-- SÃ©lectionner un template --</option>' +
        templates.filter(t => t.actif).map(t => 
            `<option value="${t.id}">${t.nom} (${t.direction === 'ASCENDANT' ? 'â¬†ï¸' : 'â¬‡ï¸'})</option>`
        ).join('');
    
    // Remplir le modal
    document.getElementById('modal-request-type-title').textContent = 'âœï¸ Ã‰diter le Type de Demande';
    document.getElementById('rt-code').value = rt.code;
    document.getElementById('rt-libelle').value = rt.libelle;
    document.getElementById('rt-description').value = rt.description || '';
    document.getElementById('rt-template').value = rt.workflow_template_id;
    document.getElementById('rt-categorie').value = rt.categorie;
    document.getElementById('rt-doc-obligatoire').checked = rt.document_obligatoire;
    document.getElementById('rt-validation-rh').checked = rt.necessite_validation_rh;
    document.getElementById('rt-validation-daf').checked = rt.necessite_validation_daf;
    
    // Stocker l'ID pour la modification
    document.getElementById('form-request-type').dataset.requestTypeId = rt.id;
    
    // Ouvrir le modal
    showModal('modal-request-type');
}

async function deleteRequestType(requestTypeId) {
    if (!confirm('âš ï¸ DÃ©sactiver ce type de demande ?\n\nLe type sera dÃ©sactivÃ© et ne sera plus disponible pour de nouvelles demandes.\n\nLes demandes existantes de ce type continueront de fonctionner.')) {
        return;
    }
    
    showGlobalLoading('DÃ©sactivation...', '');
    
    try {
        const url = '{{ url_for("api_delete_request_type", request_type_id=0) }}'.replace('/0', `/${requestTypeId}`);
        
        const response = await fetch(url, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showSuccess('Type de demande dÃ©sactivÃ© avec succÃ¨s !');
            loadRequestTypes();
        } else {
            showError(result.detail || 'Erreur lors de la dÃ©sactivation');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de la dÃ©sactivation');
    } finally {
        hideGlobalLoading();
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showModal(modalId) {
    document.getElementById(modalId).classList.add('show');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

// Note: showSuccess() et showError() sont dÃ©jÃ  dÃ©finis dans toast_notifications.html (inclus dans base.html)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ICON PICKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function toggleIconPicker() {
    const picker = document.getElementById('icon-picker');
    if (picker.style.display === 'none') {
        picker.style.display = 'block';
    } else {
        picker.style.display = 'none';
    }
}

function selectIcon(icon) {
    const iconInput = document.getElementById('template-icone');
    iconInput.value = icon;
    
    // Fermer le picker
    document.getElementById('icon-picker').style.display = 'none';
    
    // Mettre en surbrillance l'icÃ´ne sÃ©lectionnÃ©e
    document.querySelectorAll('.icon-btn').forEach(btn => {
        btn.classList.remove('selected');
        if (btn.textContent === icon) {
            btn.classList.add('selected');
        }
    });
}

function selectDirection(direction) {
    // Cocher le radio button correspondant
    if (direction === 'ASCENDANT') {
        document.getElementById('direction-ascendant').checked = true;
        document.getElementById('direction-descendant').checked = false;
    } else {
        document.getElementById('direction-ascendant').checked = false;
        document.getElementById('direction-descendant').checked = true;
    }
    updateWorkflowPreview();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PREVIEW EN TEMPS RÃ‰EL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function updateWorkflowPreview() {
    const previewContainer = document.getElementById('workflow-preview-live');
    if (!previewContainer) return;
    
    // RÃ©cupÃ©rer les Ã©tapes cochÃ©es
    const selectedSteps = [];
    const stepLabels = {
        'N+1': 'N+1',
        'N+2': 'N+2',
        'RH': 'RH',
        'DAF': 'DAF'
    };
    
    const stepLabelsLong = {
        'N+1': 'N+1 - Chef Service',
        'N+2': 'N+2 - Sous-directeur',
        'RH': 'RH - Ressources Humaines',
        'DAF': 'DAF - Direction Admin'
    };
    
    document.querySelectorAll('input[name="steps[]"]:checked').forEach(checkbox => {
        selectedSteps.push({
            value: checkbox.value,
            label: stepLabelsLong[checkbox.value] || checkbox.value
        });
    });
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GÃ‰NÃ‰RER LA DESCRIPTION AUTOMATIQUEMENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    let description = 'Circuit : Agent â†’ ';
    
    if (selectedSteps.length > 0) {
        description += selectedSteps.map(s => stepLabels[s.value]).join(' â†’ ');
    } else {
        description += 'Archivage direct';
    }
    
    description += ' â†’ ArchivÃ©';
    
    // Mettre Ã  jour le champ description
    const descriptionField = document.getElementById('template-description');
    if (descriptionField) {
        descriptionField.value = description;
    }
    
    // GÃ©nÃ©rer le schÃ©ma
    let html = '<div style="text-align: center;">';
    
    // Ã‰tape initiale
    html += `
        <div style="padding: 0.75rem; background: white; border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid #6c757d;">
            <div style="font-weight: 600; font-size: 0.85rem; color: #333;">ğŸ“ DEMANDEUR</div>
            <div style="font-size: 0.75rem; color: #666;">CrÃ©ation de la demande</div>
        </div>
    `;
    
    // FlÃ¨che
    if (selectedSteps.length > 0) {
        html += '<div style="text-align: center; margin: 0.25rem 0; color: var(--primary-color); font-size: 1.5rem;">â†“</div>';
    }
    
    // Ã‰tapes sÃ©lectionnÃ©es
    selectedSteps.forEach((step, index) => {
        const colors = {
            'N+1': '#3498db',
            'N+2': '#2ecc71',
            'RH': '#f39c12',
            'DAF': '#e74c3c'
        };
        
        html += `
            <div style="padding: 0.75rem; background: white; border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid ${colors[step.value] || '#6c757d'};">
                <div style="font-weight: 600; font-size: 0.85rem; color: #333;">${index + 1}. ${step.label}</div>
                <div style="font-size: 0.75rem; color: #666;">Validation niveau ${index + 1}</div>
            </div>
        `;
        
        // FlÃ¨che sauf pour le dernier
        if (index < selectedSteps.length - 1) {
            html += '<div style="text-align: center; margin: 0.25rem 0; color: var(--primary-color); font-size: 1.5rem;">â†“</div>';
        }
    });
    
    // Ã‰tape finale
    if (selectedSteps.length > 0) {
        html += '<div style="text-align: center; margin: 0.25rem 0; color: var(--primary-color); font-size: 1.5rem;">â†“</div>';
    }
    
    html += `
        <div style="padding: 0.75rem; background: white; border-radius: 8px; border-left: 4px solid #28a745;">
            <div style="font-weight: 600; font-size: 0.85rem; color: #333;">âœ… ARCHIVÃ‰</div>
            <div style="font-size: 0.75rem; color: #666;">Demande terminÃ©e</div>
        </div>
    `;
    
    // Message si aucune Ã©tape
    if (selectedSteps.length === 0) {
        html += `
            <div style="padding: 1rem; background: #fff3cd; border-radius: 8px; color: #856404; margin-top: 1rem;">
                <strong>âš ï¸ Aucune Ã©tape sÃ©lectionnÃ©e</strong>
                <div style="font-size: 0.8rem; margin-top: 0.25rem;">
                    La demande passera directement Ã  l'archivage
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    
    previewContainer.innerHTML = html;
}
</script>
{% endblock %}

