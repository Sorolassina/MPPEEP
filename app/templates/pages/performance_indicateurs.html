{% extends "layouts/base.html" %}
{% from 'components/page_header.html' import page_header %}

{% block title %}Indicateurs de Performance - {{ app_name }}{% endblock %}

{% block styles %}{% endblock %}

{% block content %}
{{ page_header(
    title='üìä Indicateurs de Performance',
    breadcrumbs=[
        {'name': 'Performance', 'url': url_for('performance_home')},
        {'name': 'Indicateurs'}
    ],
    actions=[
        {'label': '‚Üê Retour Performance', 'url': url_for('performance_home'), 'primary': False},
        {'label': '‚ûï Nouvel Indicateur', 'onclick': 'openCreateModal()', 'primary': True}
    ]
) }}

<div class="performance-indicators-page">
    <section class="indicators-hero">
        <div class="indicators-hero-text">
            <h2>Mesurez ce qui compte</h2>
            <p>Consolidez les indicateurs cl√©s pour suivre la performance et d√©clencher les actions correctives au bon moment.</p>
        </div>
        <div class="indicators-hero-actions">
            <button type="button" class="btn btn-premium btn-primary" onclick="openCreateModal()">‚ûï Nouvel indicateur</button>
            <button type="button" class="btn btn-premium btn-secondary" onclick="loadIndicateurs()">üîÑ Actualiser</button>
        </div>
    </section>

    <section class="indicators-filters card filters-panel compact">
        <div class="filters-header">
            <div class="filters-heading">
                <span class="filters-icon">üéõÔ∏è</span>
                <div class="filters-text">
                    <h3>Affiner les indicateurs</h3>
                    <p>Combinez recherche, cat√©gorie et fr√©quence pour isoler les KPIs pertinents.</p>
                </div>
            </div>
        </div>
        <div class="filters-row">
            <div class="filter-group">
                <label class="filter-label" for="search-input">üîç Recherche</label>
                <input 
                    type="text" 
                    id="search-input" 
                    class="form-control" 
                    placeholder="Rechercher un indicateur..." 
                    oninput="filterIndicateurs()"
                >
            </div>
            <div class="filter-group">
                <label class="filter-label" for="filter-categorie">üéØ Cat√©gorie</label>
                <select id="filter-categorie" class="form-control" onchange="filterIndicateurs()">
                    <option value="">Toutes</option>
                    <option value="QUALITE">Qualit√©</option>
                    <option value="EFFICACITE">Efficacit√©</option>
                    <option value="FINANCIER">Financier</option>
                    <option value="RH">RH</option>
                    <option value="OPERATIONNEL">Op√©rationnel</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label" for="filter-frequence">‚è±Ô∏è Fr√©quence</label>
                <select id="filter-frequence" class="form-control" onchange="filterIndicateurs()">
                    <option value="">Toutes</option>
                    <option value="JOURNALIER">Journalier</option>
                    <option value="HEBDOMADAIRE">Hebdomadaire</option>
                    <option value="MENSUEL">Mensuel</option>
                    <option value="TRIMESTRIEL">Trimestriel</option>
                    <option value="ANNUEL">Annuel</option>
                </select>
            </div>
        </div>
    </section>

    <section class="indicators-list-section">
        <div id="indicators-list" class="indicators-grid">
            <!-- indicateurs dynamiques -->
        </div>
    </section>
</div>

<!-- Modal de cr√©ation/modification -->
<div id="indicatorModal" class="modal-md">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle" class="modal-title">Nouvel Indicateur</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <form id="indicatorForm" class="modal-body">
            <input type="hidden" id="indicatorId" name="indicator_id">
            
            <div class="form-group">
                <label for="nom" class="form-label">Nom de l'indicateur *</label>
                <input type="text" id="nom" name="nom" class="form-control" required>
            </div>
            
            <div class="form-group">
                <label for="description" class="form-label">Description</label>
                <textarea id="description" name="description" class="form-control" rows="3"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="categorie" class="form-label">Cat√©gorie</label>
                    <select id="categorie" name="categorie" class="form-control">
                        <option value="QUALITE">Qualit√©</option>
                        <option value="EFFICACITE">Efficacit√©</option>
                        <option value="FINANCIER">Financier</option>
                        <option value="RH">RH</option>
                        <option value="OPERATIONNEL">Op√©rationnel</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="frequence_mesure" class="form-label">Fr√©quence de mesure</label>
                    <select id="frequence_mesure" name="frequence_mesure" class="form-control">
                        <option value="JOURNALIER">Journalier</option>
                        <option value="HEBDOMADAIRE">Hebdomadaire</option>
                        <option value="MENSUEL">Mensuel</option>
                        <option value="TRIMESTRIEL">Trimestriel</option>
                        <option value="ANNUEL">Annuel</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="valeur_cible" class="form-label">Valeur cible *</label>
                    <input type="number" id="valeur_cible" name="valeur_cible" class="form-control" step="0.01" required>
                </div>
                
                <div class="form-group">
                    <label for="valeur_actuelle" class="form-label">Valeur actuelle</label>
                    <input type="number" id="valeur_actuelle" name="valeur_actuelle" class="form-control" step="0.01" value="0">
                </div>
                
                <div class="form-group">
                    <label for="unite_mesure" class="form-label">Unit√© *</label>
                    <input type="text" id="unite_mesure" name="unite_mesure" class="form-control" placeholder="%, ‚Ç¨, h, unit√©s..." required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="seuil_alerte_min" class="form-label">Seuil alerte min</label>
                    <input type="number" id="seuil_alerte_min" name="seuil_alerte_min" class="form-control" step="0.01">
                </div>
                
                <div class="form-group">
                    <label for="seuil_alerte_max" class="form-label">Seuil alerte max</label>
                    <input type="number" id="seuil_alerte_max" name="seuil_alerte_max" class="form-control" step="0.01">
                </div>
            </div>
            
            <div class="form-group">
                <label for="service_responsable" class="form-label">Service responsable</label>
                <select id="service_responsable" name="service_responsable" class="form-control" onchange="filterUsersByService()">
                    <option value="">S√©lectionner un service...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="responsable_id" class="form-label">Responsable *</label>
                <select id="responsable_id" name="responsable_id" class="form-control" required>
                    <option value="">S√©lectionner d'abord un service...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="source_donnees" class="form-label">Source des donn√©es</label>
                <input type="text" id="source_donnees" name="source_donnees" class="form-control" placeholder="ex: Syst√®me, Enqu√™tes, Comptabilit√©...">
            </div>
            
            <div class="form-group">
                <label for="commentaires" class="form-label">Commentaires</label>
                <textarea id="commentaires" name="commentaires" class="form-control" rows="2"></textarea>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                <button type="submit" class="btn btn-primary">Enregistrer</button>
            </div>
        </form>
    </div>
</div>

<script>
// URLs g√©n√©r√©es par le serveur
const API_URLS = {
    list: "{{ url_for('get_indicateurs_api') }}",
    create: "{{ url_for('create_indicateur_api') }}",
    detail: (id) => "{{ url_for('get_indicateur_api', indicateur_id=0) }}".replace('/0', `/${id}`),
    update: (id) => "{{ url_for('update_indicateur_api', indicateur_id=0) }}".replace('/0', `/${id}`),
    delete: (id) => "{{ url_for('delete_indicateur_api', indicateur_id=0) }}".replace('/0', `/${id}`)
};

let currentIndicateurs = [];
let editingIndicateurId = null;
let allUsers = []; // Stocker tous les utilisateurs
let allServices = []; // Stocker tous les services avec leurs IDs

// Charger les indicateurs au d√©marrage
document.addEventListener('DOMContentLoaded', function() {
    const overlay = document.getElementById('globalLoadingOverlay');
    if (overlay) {
        overlay.classList.remove('show');
    }
    loadIndicateurs();
    loadUsers();
    loadServices();
});

// Charger la liste des indicateurs
async function loadIndicateurs() {
    try {
        showGlobalLoading('Chargement des indicateurs...', 'Veuillez patienter');
        
        const response = await fetch(API_URLS.list);
        const result = await response.json();
        
        if (result.success) {
            currentIndicateurs = result.data;
            displayIndicateurs(result.data);
        } else {
            showError('Erreur lors du chargement des indicateurs');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors du chargement des indicateurs');
    } finally {
        hideGlobalLoading();
    }
}

// Charger la liste des utilisateurs
async function loadUsers() {
    try {
        const response = await fetch("{{ url_for('list_users') }}");
        allUsers = await response.json();
        
        // Ne pas peupler le select ici, attendre la s√©lection du service
        const select = document.getElementById('responsable_id');
        select.innerHTML = '<option value="">S√©lectionner d\'abord un service...</option>';
    } catch (error) {
        console.error('Erreur lors du chargement des utilisateurs:', error);
    }
}

// Filtrer les utilisateurs par service
async function filterUsersByService() {
    const serviceSelect = document.getElementById('service_responsable');
    const userSelect = document.getElementById('responsable_id');
    const selectedServiceId = serviceSelect.value;
    
    userSelect.innerHTML = '<option value="">Chargement...</option>';
    
    if (!selectedServiceId) {
        userSelect.innerHTML = '<option value="">S√©lectionner d\'abord un service...</option>';
        return;
    }
    
    try {
        // Charger les utilisateurs du service s√©lectionn√©
        const response = await fetch(`/api/v1/users/by-service/${selectedServiceId}`);
        const users = await response.json();
        
        userSelect.innerHTML = '<option value="">S√©lectionner un responsable...</option>';
        
        if (users && users.length > 0) {
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.full_name || user.email;
                userSelect.appendChild(option);
            });
        } else {
            userSelect.innerHTML += '<option value="" disabled>Aucun utilisateur dans ce service</option>';
        }
    } catch (error) {
        console.error('Erreur lors du filtrage des utilisateurs:', error);
        userSelect.innerHTML = '<option value="">Erreur de chargement</option>';
    }
}

// Charger la liste des services
async function loadServices() {
    try {
        const response = await fetch("{{ url_for('get_services_api') }}");
        const services = await response.json();
        allServices = services; // Stocker pour le filtrage
        
        const select = document.getElementById('service_responsable');
        select.innerHTML = '<option value="">S√©lectionner un service...</option>';
        
        if (services && Array.isArray(services)) {
            services.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id; // Utiliser l'ID au lieu du libell√©
                option.textContent = `${service.code} - ${service.libelle}`;
                option.setAttribute('data-libelle', service.libelle); // Stocker le libell√© comme data attribute
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Erreur lors du chargement des services:', error);
        // Si l'API n'existe pas encore, on laisse le champ vide
    }
}

// Afficher les indicateurs
function displayIndicateurs(indicateurs) {
    const container = document.getElementById('indicators-list');
    
    if (indicateurs.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <h3 class="empty-state-title">Aucun indicateur de performance</h3>
                <p class="empty-state-message">
                    Vous n'avez pas encore d√©fini d'indicateurs de performance.<br>
                    Commencez par cr√©er votre premier indicateur pour mesurer et suivre vos r√©sultats.
                </p>
                <button class="empty-state-action" onclick="openCreateModal()">
                    <span>‚ûï</span>
                    <span>Cr√©er mon premier indicateur</span>
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = indicateurs.map(ind => `
        <article class="indicator-card" data-id="${ind.id}">
            <div class="indicator-top">
                <div class="indicator-icon">${getCategoryIcon(ind.categorie)}</div>
                <span class="indicator-category category-${ind.categorie.toLowerCase()}">${getCategoryLabel(ind.categorie)}</span>
            </div>

            <div class="indicator-header">
                <h3 class="indicator-title">${ind.nom}</h3>
                <div class="indicator-actions">
                    <button type="button" class="btn-action btn-premium btn-secondary btn-compact" onclick="editIndicateur(${ind.id})" title="Modifier">‚úèÔ∏è</button>
                    <button type="button" class="btn-action btn-premium btn-danger btn-compact" onclick="deleteIndicateur(${ind.id}, '${ind.nom.replace(/'/g, '&#39;')}')" title="Supprimer">üóëÔ∏è</button>
                </div>
            </div>

            <p class="indicator-description">${ind.description || 'Aucune description'}</p>

            <div class="indicator-value">
                <div class="current-value">${ind.valeur_actuelle || 0} ${ind.unite_mesure}</div>
                <div class="target-value">Cible&nbsp;: ${ind.valeur_cible} ${ind.unite_mesure}</div>
            </div>

            <div class="indicator-meta">
                <div class="meta-item">
                    <div class="meta-label">Fr√©quence</div>
                    <div class="meta-value">${getFrequenceLabel(ind.frequence_mesure)}</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Source</div>
                    <div class="meta-value">${ind.source_donnees || 'Non d√©finie'}</div>
                </div>
            </div>
        </article>
    `).join('');
}

// Fonctions pour g√©rer les modales
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('show');
        document.body.classList.add('modal-open');
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('show');
        document.body.classList.remove('modal-open');
    }
}

// Ouvrir le modal de cr√©ation
function openCreateModal() {
    editingIndicateurId = null;
    document.getElementById('modalTitle').textContent = 'Nouvel Indicateur';
    document.getElementById('indicatorForm').reset();
    showModal('indicatorModal');
}

// Modifier un indicateur
function editIndicateur(id) {
    const indicateur = currentIndicateurs.find(ind => ind.id === id);
    if (!indicateur) return;
    
    editingIndicateurId = id;
    document.getElementById('modalTitle').textContent = 'Modifier l\'Indicateur';
    
    // Remplir le formulaire
    document.getElementById('indicatorId').value = indicateur.id;
    document.getElementById('nom').value = indicateur.nom;
    document.getElementById('description').value = indicateur.description || '';
    document.getElementById('categorie').value = indicateur.categorie;
    document.getElementById('frequence_mesure').value = indicateur.frequence_mesure;
    document.getElementById('valeur_cible').value = indicateur.valeur_cible;
    document.getElementById('valeur_actuelle').value = indicateur.valeur_actuelle;
    document.getElementById('unite_mesure').value = indicateur.unite_mesure;
    document.getElementById('seuil_alerte_min').value = indicateur.seuil_alerte_min || '';
    document.getElementById('seuil_alerte_max').value = indicateur.seuil_alerte_max || '';
    document.getElementById('source_donnees').value = indicateur.source_donnees || '';
    document.getElementById('commentaires').value = indicateur.commentaires || '';
    
    // Trouver l'ID du service √† partir du libell√©
    const serviceLibelle = indicateur.service_responsable || '';
    const serviceSelect = document.getElementById('service_responsable');
    for (let option of serviceSelect.options) {
        if (option.getAttribute('data-libelle') === serviceLibelle) {
            serviceSelect.value = option.value;
            break;
        }
    }
    
    // D√©clencher le filtrage des utilisateurs par service
    filterUsersByService();
    
    // Puis s√©lectionner le responsable
    setTimeout(() => {
        document.getElementById('responsable_id').value = indicateur.responsable_id;
    }, 200);
    
    showModal('indicatorModal');
}

// Supprimer un indicateur
async function deleteIndicateur(id, nom) {
    if (!confirm(`√ätes-vous s√ªr de vouloir supprimer l'indicateur "${nom}" ?\n\nCette action est irr√©versible.`)) {
        return;
    }
    
    try {
        showGlobalLoading('Suppression en cours...', 'Veuillez patienter');
        
        const response = await fetch(API_URLS.delete(id), {
            method: 'DELETE'
        });
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            loadIndicateurs();
        } else {
            showError(result.error);
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de la suppression');
    } finally {
        hideGlobalLoading();
    }
}

// Fermer le modal
function closeModal() {
    hideModal('indicatorModal');
    document.getElementById('indicatorForm').reset();
    editingIndicateurId = null;
}

// Soumettre le formulaire
document.getElementById('indicatorForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
        showGlobalLoading('Enregistrement en cours...', 'Veuillez patienter');
        
        const formData = new FormData(this);
        
        // Convertir l'ID du service en libell√© pour la sauvegarde
        const serviceSelect = document.getElementById('service_responsable');
        const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
        if (selectedOption && selectedOption.getAttribute('data-libelle')) {
            formData.set('service_responsable', selectedOption.getAttribute('data-libelle'));
        }
        
        const url = editingIndicateurId 
            ? API_URLS.update(editingIndicateurId)
            : API_URLS.create;
        const method = editingIndicateurId ? 'PUT' : 'POST';
        
        const response = await submitFormAsJson(url, formData, method, true);
        const result = await response.json();
        
        if (result.success) {
            showSuccess(result.message);
            closeModal();
            loadIndicateurs();
        } else {
            showError(result.error);
        }
    } catch (error) {
        console.error('Erreur:', error);
        showError('Erreur lors de l\'enregistrement');
    } finally {
        hideGlobalLoading();
    }
});

// Filtrer les indicateurs
function filterIndicateurs() {
    const searchInput = document.getElementById('search-input').value.toLowerCase();
    const categorieFilter = document.getElementById('filter-categorie').value;
    const frequenceFilter = document.getElementById('filter-frequence').value;
    
    let filteredIndicateurs = currentIndicateurs;
    
    // Filtre de recherche par nom ou description
    if (searchInput) {
        filteredIndicateurs = filteredIndicateurs.filter(ind => 
            ind.nom.toLowerCase().includes(searchInput) || 
            (ind.description && ind.description.toLowerCase().includes(searchInput))
        );
    }
    
    // Filtre par cat√©gorie
    if (categorieFilter) {
        filteredIndicateurs = filteredIndicateurs.filter(ind => ind.categorie === categorieFilter);
    }
    
    // Filtre par fr√©quence
    if (frequenceFilter) {
        filteredIndicateurs = filteredIndicateurs.filter(ind => ind.frequence_mesure === frequenceFilter);
    }
    
    displayIndicateurs(filteredIndicateurs);
}

// Fonctions utilitaires
function getCategoryLabel(categorie) {
    const labels = {
        'QUALITE': 'Qualit√©',
        'EFFICACITE': 'Efficacit√©',
        'FINANCIER': 'Financier',
        'RH': 'RH',
        'OPERATIONNEL': 'Op√©rationnel'
    };
    return labels[categorie] || categorie;
}

function getCategoryIcon(categorie) {
    const icons = {
        'QUALITE': '‚≠ê',
        'EFFICACITE': '‚ö°',
        'FINANCIER': 'üí∞',
        'RH': 'üë•',
        'OPERATIONNEL': '‚öôÔ∏è'
    };
    return icons[categorie] || 'üìä';
}

function getFrequenceLabel(frequence) {
    const labels = {
        'JOURNALIER': 'Journalier',
        'HEBDOMADAIRE': 'Hebdomadaire',
        'MENSUEL': 'Mensuel',
        'TRIMESTRIEL': 'Trimestriel',
        'ANNUEL': 'Annuel'
    };
    return labels[frequence] || frequence;
}
</script>
{% endblock %}
