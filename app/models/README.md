# üóÉÔ∏è Dossier Models - Structure des Donn√©es

## ü§î C'est Quoi ?

Le dossier `models/` d√©finit la **structure de vos tables** en base de donn√©es. Chaque mod√®le = une table.

### üèóÔ∏è Analogie Simple

Imaginez un formulaire papier :

- üìã **Mod√®le** = Le formulaire vierge (d√©finit les champs)
- ‚úèÔ∏è **Instance** = Un formulaire rempli (les donn√©es)
- üóÑÔ∏è **Table DB** = Le classeur qui range tous les formulaires

**Exemple :**

```
Mod√®le User (formulaire vierge) :
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ID:     _________   ‚îÇ
‚îÇ Email:  _________   ‚îÇ
‚îÇ Nom:    _________   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Instance User (formulaire rempli) :
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ID:     1           ‚îÇ
‚îÇ Email:  john@ex.com ‚îÇ
‚îÇ Nom:    John Doe    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìÅ Structure

```
app/models/
‚îú‚îÄ‚îÄ __init__.py       ‚Üê Exports de tous les mod√®les
‚îú‚îÄ‚îÄ user.py           ‚Üê Mod√®le User
‚îî‚îÄ‚îÄ session.py        ‚Üê Mod√®le UserSession (multi-device)
```

**Convention :** Un fichier = Un mod√®le

---

## üìã Mod√®le User Expliqu√©

### Code Actuel

```python
from typing import Optional
from sqlmodel import SQLModel, Field

class User(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    email: str = Field(unique=True, index=True)
    full_name: str | None = None
    hashed_password: str
    is_active: bool = Field(default=True)
    is_superuser: bool = Field(default=False)
```

### Ligne par Ligne

```python
class User(SQLModel, table=True):
# ‚Üë      ‚Üë        ‚Üë
# Nom    H√©ritage table=True ‚Üí Cr√©er une table en DB
```

**Champs :**

| Champ | Type | Description | Contrainte |
|-------|------|-------------|------------|
| `id` | `int` | Identifiant unique | Primary Key, Auto-incr√©ment√© |
| `email` | `str` | Email de l'utilisateur | Unique, Index√© |
| `full_name` | `str \| None` | Nom complet | Optionnel |
| `hashed_password` | `str` | Mot de passe hash√© | Obligatoire |
| `is_active` | `bool` | Compte actif ? | Default: True |
| `is_superuser` | `bool` | Est admin ? | Default: False |

---

## üìã Mod√®le UserSession Expliqu√©

### Code Actuel

```python
from typing import Optional
from sqlmodel import SQLModel, Field
from datetime import datetime, timedelta
import secrets

class UserSession(SQLModel, table=True):
    __tablename__ = "user_sessions"
    
    id: Optional[int] = Field(default=None, primary_key=True)
    session_token: str = Field(unique=True, index=True, max_length=255)
    user_id: int = Field(foreign_key="user.id", index=True)
    ip_address: Optional[str] = Field(default=None, max_length=45)
    user_agent: Optional[str] = Field(default=None, max_length=500)
    device_info: Optional[str] = Field(default=None, max_length=255)
    created_at: datetime = Field(default_factory=datetime.now)
    last_activity: datetime = Field(default_factory=datetime.now)
    expires_at: datetime = Field(default_factory=lambda: datetime.now() + timedelta(days=7))
    is_active: bool = Field(default=True)
```

### Ligne par Ligne

**Champs :**

| Champ | Type | Description | Contrainte |
|-------|------|-------------|------------|
| `id` | `int` | Identifiant unique | Primary Key, Auto-incr√©ment√© |
| `session_token` | `str` | Token unique de session | Unique, Index√©, 255 caract√®res |
| `user_id` | `int` | ID de l'utilisateur | Foreign Key vers `user.id`, Index√© |
| `ip_address` | `str \| None` | Adresse IP du client | Optionnel, max 45 caract√®res (IPv6) |
| `user_agent` | `str \| None` | User-Agent du navigateur | Optionnel, max 500 caract√®res |
| `device_info` | `str \| None` | Info device (ex: "Chrome on Windows") | Optionnel, max 255 caract√®res |
| `created_at` | `datetime` | Date de cr√©ation | Auto-g√©n√©r√© |
| `last_activity` | `datetime` | Derni√®re activit√© | Mis √† jour automatiquement |
| `expires_at` | `datetime` | Date d'expiration | Default: 7 jours |
| `is_active` | `bool` | Session active ? | Default: True |

### M√©thodes du Mod√®le

```python
# G√©n√©rer un token s√©curis√©
@staticmethod
def generate_token() -> str:
    return secrets.token_urlsafe(32)

# V√©rifier si la session est expir√©e
def is_expired(self) -> bool:
    return datetime.now() > self.expires_at

# Rafra√Æchir la session
def refresh(self, days: int = 7):
    self.last_activity = datetime.now()
    self.expires_at = datetime.now() + timedelta(days=days)

# D√©sactiver la session (logout)
def deactivate(self):
    self.is_active = False
```

### Pourquoi un Mod√®le Session ?

**Avantages :**
- ‚úÖ **Multi-device** : Un utilisateur peut avoir plusieurs sessions actives (bureau, mobile, tablette)
- ‚úÖ **S√©curit√©** : Tokens s√©curis√©s g√©n√©r√©s avec `secrets.token_urlsafe()`
- ‚úÖ **Tracking** : Savoir d'o√π se connecte l'utilisateur (IP, device)
- ‚úÖ **Expiration** : Sessions qui expirent automatiquement
- ‚úÖ **Gestion** : L'utilisateur peut voir et d√©connecter ses appareils

**Utilisation :**

```python
from app.models.session import UserSession
from app.services.session_service import SessionService

# Cr√©er une session
user_session = SessionService.create_session(
    db_session=session,
    user=user,
    request=request,
    remember_me=True  # 30 jours au lieu de 7
)

# V√©rifier une session
user = SessionService.get_user_from_session(session, session_token)

# Lister les sessions actives
sessions = SessionService.get_active_sessions(session, user.id)
for s in sessions:
    print(f"- {s.device_info} (derni√®re activit√©: {s.last_activity})")
```

---

## üéØ R√¥le des Mod√®les

### 1Ô∏è‚É£ D√©finir la Structure de la Table

```python
class User(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    email: str = Field(unique=True)

# ‚Üí Cr√©e cette table SQL :
CREATE TABLE user (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email VARCHAR UNIQUE NOT NULL
);
```

### 2Ô∏è‚É£ Cr√©er des Instances

```python
# Cr√©er un utilisateur
user = User(
    email="john@example.com",
    full_name="John Doe",
    hashed_password="hashed...",
    is_active=True
)

# user est une instance du mod√®le User
```

### 3Ô∏è‚É£ Interagir avec la DB

```python
from sqlmodel import Session
from app.db import engine

with Session(engine) as session:
    # Cr√©er
    user = User(email="test@test.com")
    session.add(user)
    session.commit()
    
    # Lire
    users = session.exec(select(User)).all()
    
    # Modifier
    user.email = "new@email.com"
    session.add(user)
    session.commit()
    
    # Supprimer
    session.delete(user)
    session.commit()
```

---

## üîß Field() - Options Avanc√©es

### Cl√©s Primaires

```python
id: int | None = Field(default=None, primary_key=True)
#                      ‚Üë              ‚Üë
#                      Auto-g√©n√©r√©    Cl√© primaire
```

### Unique (Pas de Doublons)

```python
email: str = Field(unique=True)
# ‚Üí Impossible d'avoir 2 users avec le m√™me email
```

### Index (Performance)

```python
email: str = Field(index=True)
# ‚Üí Recherches par email plus rapides
```

### Valeurs par D√©faut

```python
is_active: bool = Field(default=True)
# ‚Üí Si non sp√©cifi√©, is_active=True automatiquement
```

### Optionnel

```python
full_name: str | None = None
#                       ‚Üë
#                       Peut √™tre None (NULL en SQL)
```

### Contraintes Personnalis√©es

```python
age: int = Field(ge=0, le=150)
# ge = greater or equal (>=)
# le = less or equal (<=)

price: float = Field(gt=0)
# gt = greater than (>)

username: str = Field(min_length=3, max_length=50)
```

---

## üí° Cr√©er un Nouveau Mod√®le

### √âtape 1 : Cr√©er le Fichier

```bash
touch app/models/product.py
```

### √âtape 2 : D√©finir le Mod√®le

```python
# app/models/product.py

from typing import Optional
from sqlmodel import SQLModel, Field
from datetime import datetime

class Product(SQLModel, table=True):
    """Mod√®le pour les produits"""
    
    # Cl√© primaire
    id: Optional[int] = Field(default=None, primary_key=True)
    
    # Informations de base
    name: str = Field(min_length=1, max_length=200)
    description: str | None = None
    price: float = Field(gt=0)  # Prix > 0
    
    # Stock
    stock: int = Field(default=0, ge=0)  # Stock >= 0
    
    # Cat√©gorie
    category: str | None = None
    
    # Statut
    is_available: bool = Field(default=True)
    
    # Timestamps
    created_at: datetime = Field(default_factory=datetime.now)
    updated_at: datetime = Field(default_factory=datetime.now)
```

### √âtape 3 : Exporter dans __init__.py

```python
# app/models/__init__.py

from app.models.user import User
from app.models.product import Product  # ‚Üê Ajouter

__all__ = ["User", "Product"]
```

### √âtape 4 : Cr√©er la Table

```python
# Cr√©er toutes les tables
from app.db import init_db

init_db()
# ‚Üí Table 'product' cr√©√©e !
```

---

## üîó Relations entre Mod√®les

### One-to-Many (Un √† Plusieurs)

```python
# Un utilisateur a plusieurs articles

class User(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    email: str
    
    # Relation (optionnel, pour faciliter l'acc√®s)
    # articles: list["Article"] = Relationship(back_populates="author")

class Article(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    title: str
    
    # Cl√© √©trang√®re
    user_id: int = Field(foreign_key="user.id")
    
    # Relation (optionnel)
    # author: User = Relationship(back_populates="articles")
```

**Usage :**
```python
# Acc√©der aux articles d'un user
user = session.get(User, 1)
articles = session.exec(
    select(Article).where(Article.user_id == user.id)
).all()
```

---

## üé® Bonnes Pratiques

### ‚úÖ DO (√Ä Faire)

1. **Noms au singulier**
   ```python
   # ‚úÖ Bon
   class User(SQLModel, table=True):
       ...
   
   # ‚ùå Mauvais
   class Users(SQLModel, table=True):
       ...
   ```

2. **Type hints clairs**
   ```python
   # ‚úÖ Bon
   email: str
   age: int | None
   created_at: datetime
   
   # ‚ùå Mauvais
   email: str = None  # Confus, optionnel ou pas ?
   ```

3. **Valeurs par d√©faut sens√©es**
   ```python
   # ‚úÖ Bon
   is_active: bool = Field(default=True)
   created_at: datetime = Field(default_factory=datetime.now)
   
   # ‚ùå Mauvais
   is_active: bool  # Pas de d√©faut, obligatoire √† sp√©cifier
   ```

4. **Index sur les champs recherch√©s**
   ```python
   # ‚úÖ Bon
   email: str = Field(index=True)
   # ‚Üí Recherches par email rapides
   ```

5. **Contraintes de validation**
   ```python
   # ‚úÖ Bon
   price: float = Field(gt=0)  # Prix > 0
   age: int = Field(ge=0, le=150)  # 0 <= age <= 150
   ```

---

### ‚ùå DON'T (√Ä √âviter)

1. **‚ùå Mots de passe en clair**
   ```python
   # ‚ùå DANGEREUX
   password: str
   
   # ‚úÖ S√âCURIS√â
   hashed_password: str
   ```

2. **‚ùå Pas de primary key**
   ```python
   # ‚ùå Mauvais
   class User(SQLModel, table=True):
       email: str
       # Pas d'ID !
   
   # ‚úÖ Bon
   class User(SQLModel, table=True):
       id: int | None = Field(default=None, primary_key=True)
       email: str
   ```

3. **‚ùå Logique m√©tier dans le mod√®le**
   ```python
   # ‚ùå √âviter
   class User(SQLModel, table=True):
       email: str
       
       def send_welcome_email(self):
           # Logique m√©tier ‚Üí mettre dans services/
   
   # ‚úÖ Mod√®le = Structure de donn√©es uniquement
   ```

---

## üìä SQLModel vs Pydantic

### Diff√©rence Cl√©

```python
# SQLModel (table=True) ‚Üí Table en DB
class User(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    email: str

# SQLModel (table=False) ‚Üí Pas de table (juste validation)
class UserUpdate(SQLModel):
    email: str | None = None
    full_name: str | None = None

# Pydantic ‚Üí Validation seulement
class UserCreate(BaseModel):
    email: EmailStr
    password: str
```

**Usage :**
- `table=True` ‚Üí Mod√®le DB (stockage)
- `table=False` ou Pydantic ‚Üí Sch√©ma (validation)

---

## üîÑ Workflow Complet

### De la D√©finition √† l'Utilisation

```
1. D√âFINIR LE MOD√àLE
   ‚Üì
   class User(SQLModel, table=True):
       id: int | None = ...
       email: str = ...

2. CR√âER LA TABLE
   ‚Üì
   init_db()
   ‚Üí CREATE TABLE user (...)

3. UTILISER DANS L'API
   ‚Üì
   @router.post("/users")
   async def create_user(...):
       user = User(email=...)
       session.add(user)
       session.commit()

4. STOCK√â EN BASE
   ‚Üì
   SQLite: app.db
   PostgreSQL: base distante
```

---

## üéØ Exemple Complet : Mod√®le Article

```python
# app/models/article.py

from typing import Optional
from sqlmodel import SQLModel, Field
from datetime import datetime

class Article(SQLModel, table=True):
    """
    Mod√®le pour les articles de blog
    """
    
    # Identifiant
    id: Optional[int] = Field(default=None, primary_key=True)
    
    # Contenu
    title: str = Field(min_length=1, max_length=200, index=True)
    slug: str = Field(unique=True, index=True)
    content: str
    excerpt: str | None = Field(default=None, max_length=500)
    
    # M√©tadonn√©es
    author_id: int = Field(foreign_key="user.id")
    category: str | None = None
    tags: str | None = None  # "python,fastapi,tutorial"
    
    # Visibilit√©
    is_published: bool = Field(default=False)
    is_featured: bool = Field(default=False)
    
    # SEO
    meta_title: str | None = None
    meta_description: str | None = None
    
    # Statistiques
    views_count: int = Field(default=0, ge=0)
    likes_count: int = Field(default=0, ge=0)
    
    # Dates
    created_at: datetime = Field(default_factory=datetime.now)
    updated_at: datetime = Field(default_factory=datetime.now)
    published_at: datetime | None = None
```

**Table g√©n√©r√©e :**
```sql
CREATE TABLE article (
    id INTEGER PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    slug VARCHAR UNIQUE NOT NULL,
    content TEXT NOT NULL,
    author_id INTEGER NOT NULL,
    is_published BOOLEAN DEFAULT FALSE,
    views_count INTEGER DEFAULT 0,
    created_at DATETIME NOT NULL,
    ...
    FOREIGN KEY (author_id) REFERENCES user(id)
);
```

---

## üÜò Probl√®mes Courants

### Table d√©j√† existe

```python
sqlalchemy.exc.OperationalError: table user already exists
```

**Cause :** `init_db()` appel√© plusieurs fois

**Solution :**
```python
# V√©rifier avant de cr√©er
from sqlmodel import SQLModel

# Supprimer toutes les tables (ATTENTION : perte de donn√©es !)
SQLModel.metadata.drop_all(engine)

# Recr√©er
SQLModel.metadata.create_all(engine)
```

---

### Contrainte unique viol√©e

```python
sqlalchemy.exc.IntegrityError: UNIQUE constraint failed: user.email
```

**Cause :** Tentative de cr√©er 2 users avec le m√™me email

**Solution :**
```python
from sqlalchemy.exc import IntegrityError

try:
    session.add(user)
    session.commit()
except IntegrityError:
    session.rollback()
    raise HTTPException(409, detail="Email d√©j√† utilis√©")
```

---

### Modifier le Mod√®le apr√®s Cr√©ation

```python
# Si vous modifiez un mod√®le apr√®s que la table existe :

# Option 1 : Migrations (recommand√© en production)
# ‚Üí Utiliser Alembic

# Option 2 : Recr√©er la table (dev seulement)
# 1. Supprimer le fichier app.db
# 2. Relancer init_db()
```

---

## üìö Types de Champs Courants

### Texte

```python
# Texte court
name: str = Field(max_length=100)

# Texte long
description: str  # Pas de limite

# Email (validation)
from pydantic import EmailStr
email: EmailStr
```

### Nombres

```python
# Entier
age: int = Field(ge=0, le=150)

# D√©cimal
price: float = Field(gt=0)

# Grand nombre
population: int
```

### Bool√©ens

```python
is_active: bool = Field(default=True)
is_admin: bool = Field(default=False)
```

### Dates

```python
from datetime import datetime, date

# Date et heure
created_at: datetime = Field(default_factory=datetime.now)

# Date seulement
birth_date: date | None = None
```

### Optionnel

```python
# Peut √™tre None
full_name: str | None = None
description: str | None = None

# Obligatoire
email: str  # Doit √™tre fourni
```

---

## üîó Relations (Avanc√©)

### One-to-Many avec Relationship

```python
from sqlmodel import Relationship

class User(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    email: str
    
    # Relation : Un user a plusieurs articles
    articles: list["Article"] = Relationship(back_populates="author")

class Article(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    title: str
    user_id: int = Field(foreign_key="user.id")
    
    # Relation : Un article a un auteur
    author: User = Relationship(back_populates="articles")
```

**Usage :**
```python
user = session.get(User, 1)
print(user.articles)  # Liste des articles
# ‚Üí Pas besoin de requ√™te s√©par√©e !
```

---

## üéØ Ajouter un Nouveau Mod√®le

### Exemple : Product

```python
# 1. Cr√©er app/models/product.py
from typing import Optional
from sqlmodel import SQLModel, Field

class Product(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    name: str = Field(min_length=1, max_length=200)
    price: float = Field(gt=0)
    stock: int = Field(default=0, ge=0)
    is_available: bool = Field(default=True)

# 2. Exporter dans app/models/__init__.py
from app.models.product import Product

__all__ = ["User", "Product"]

# 3. Cr√©er la table
from app.db import init_db
init_db()

# 4. Utiliser dans l'API
from app.models.product import Product

@router.post("/products")
async def create_product(name: str, price: float, session: Session = Depends(get_session)):
    product = Product(name=name, price=price)
    session.add(product)
    session.commit()
    return product
```

---

## üß™ Tester les Mod√®les

```python
# tests/unit/test_models.py

from app.models.user import User
from app.core.security import get_password_hash

def test_create_user(session):
    """Test la cr√©ation d'un utilisateur"""
    user = User(
        email="test@example.com",
        full_name="Test User",
        hashed_password=get_password_hash("password123")
    )
    
    session.add(user)
    session.commit()
    session.refresh(user)
    
    # V√©rifications
    assert user.id is not None  # ID g√©n√©r√©
    assert user.email == "test@example.com"
    assert user.is_active is True  # Valeur par d√©faut
    assert user.is_superuser is False  # Valeur par d√©faut
```

---

## üìä Models vs Schemas

### Diff√©rence Fondamentale

| Aspect | Models | Schemas |
|--------|--------|---------|
| **R√¥le** | Structure de la **table DB** | Validation des **donn√©es entrantes** |
| **H√©ritage** | `SQLModel, table=True` | `BaseModel` ou `SQLModel` |
| **Dossier** | `app/models/` | `app/schemas/` |
| **Contient** | Tous les champs de la table | Seulement les champs n√©cessaires |
| **Exemple** | `User` (avec id, created_at, etc.) | `UserCreate` (email, password) |

**Exemple :**

```python
# MODEL (table DB compl√®te)
class User(SQLModel, table=True):
    id: int | None
    email: str
    hashed_password: str
    is_active: bool
    created_at: datetime

# SCHEMA (validation cr√©ation)
class UserCreate(BaseModel):
    email: EmailStr        # ‚Üê Seulement ce que l'utilisateur fournit
    password: str          # ‚Üê Pas hash√© encore
    # Pas d'id, pas de created_at
```

---

## ‚ú® R√©sum√©

| Aspect | Valeur |
|--------|--------|
| **R√¥le** | üóÉÔ∏è D√©finir la structure des tables DB |
| **Fichiers** | Un fichier = Un mod√®le = Une table |
| **H√©ritage** | `SQLModel, table=True` |
| **Champs** | Type hints + Field() |
| **Contraintes** | unique, index, default, ge, le, etc. |
| **Cr√©ation** | `init_db()` |
| **Usage** | CRUD via Session |

---

## üéØ Pour Votre Boilerplate

### ‚úÖ Mod√®le User Inclus

- ‚úÖ Structure compl√®te
- ‚úÖ Champs de s√©curit√© (hashed_password, is_active)
- ‚úÖ Contraintes (email unique, index√©)
- ‚úÖ Valeurs par d√©faut

### üöÄ R√©utilisation

```bash
# Nouveau projet ?
cp app/models/user.py nouveau_projet/app/models/

# Base solide pour commencer !
# Ajoutez vos propres mod√®les (Product, Order, etc.)
```

---

**üóÉÔ∏è Les models = Le plan architectural de votre base de donn√©es !**

