# CD - DÃ©ploiement Production
# DÃ©ploiement manuel en production (nÃ©cessite approbation)

name: CD - Production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Taper "DEPLOY" pour confirmer'
        required: true
        default: ''

jobs:
  check-confirmation:
    name: VÃ©rification Confirmation
    runs-on: ubuntu-latest
    
    steps:
    - name: âœ… VÃ©rifier la confirmation
      run: |
        if [ "${{ github.event.inputs.confirm }}" != "DEPLOY" ]; then
          echo "âŒ Confirmation incorrecte. Tapez exactement 'DEPLOY'"
          exit 1
        fi
        echo "âœ… Confirmation validÃ©e"

  tests-pre-deploy:
    name: Tests PrÃ©-DÃ©ploiement
    runs-on: ubuntu-latest
    needs: check-confirmation
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸ Configuration Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    
    - name: ğŸ“¦ Installation
      run: |
        pip install uv
        uv sync
    
    - name: ğŸ§ª Tous les tests
      run: |
        uv run pytest -v --tb=short
    
    - name: ğŸ”’ Scan sÃ©curitÃ©
      run: |
        pip install bandit safety
        bandit -r app/
        safety check

  deploy-production:
    name: DÃ©ploiement Production
    runs-on: ubuntu-latest
    needs: tests-pre-deploy
    
    environment:
      name: production
      url: https://mondomaine.com
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ğŸš€ DÃ©ploiement vers Production (SSH)
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.PROD_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          cd /var/www/mppeep
          
          # Backup
          cp app.db backups/backup_$(date +%Y%m%d_%H%M%S).db
          
          # Mise Ã  jour
          git pull origin main
          .venv/bin/uv sync
          
          # Migrations
          .venv/bin/python -c "from app.db.session import init_db; init_db()"
          
          # RedÃ©marrage
          sudo systemctl restart mppeep-prod
    
    - name: â³ Attendre le dÃ©marrage
      run: sleep 15
    
    - name: ğŸ¥ Health Check Production
      run: |
        for i in {1..5}; do
          response=$(curl -s -o /dev/null -w "%{http_code}" https://mondomaine.com/api/v1/ping)
          
          if [ $response -eq 200 ]; then
            echo "âœ… Production opÃ©rationnelle (tentative $i/5)"
            exit 0
          fi
          
          echo "â³ Tentative $i/5 - Attente 5s..."
          sleep 5
        done
        
        echo "âŒ Production ne rÃ©pond pas aprÃ¨s 5 tentatives"
        exit 1
    
    - name: ğŸ“¢ Notification SuccÃ¨s
      if: success()
      uses: 8398a7/action-slack@v3
      with:
        status: 'success'
        text: 'ğŸ‰ DÃ©ploiement Production RÃ‰USSI !'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
    
    - name: ğŸš¨ Notification Ã‰chec
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: 'failure'
        text: 'ğŸš¨ DÃ©ploiement Production Ã‰CHOUÃ‰ !'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}

